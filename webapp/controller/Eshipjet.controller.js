sap.ui.define([
    "sap/ui/Device",
    "sap/ui/core/mvc/Controller",
    "sap/ui/model/json/JSONModel",
    "sap/m/Popover",
    "sap/m/Button",
    "sap/m/library",
    "sap/m/MessageToast",
    "sap/ui/core/BusyIndicator",
    "sap/m/Dialog",
    "sap/ui/core/format/DateFormat",
    "sap/ui/core/Fragment",
    "sap/ui/export/Spreadsheet",
    "../model/formatter",
    "sap/ui/model/Filter",
    "sap/ui/model/FilterOperator",
    "sap/ui/core/library",
    "sap/m/MessageBox",
    "sap/ui/core/routing/History"
], function (Device, Controller, JSONModel, Popover, Button, library, MessageToast, BusyIndicator, Dialog, DateFormat, Fragment, Spreadsheet, formatter, Filter, FilterOperator, CoreLibrary, MessageBox, History) {
    "use strict";

    var ButtonType = library.ButtonType,
        PlacementType = library.PlacementType,
        oController, oResourceBundle, eshipjetModel, oShipperCopilotModel;
    const SortOrder = CoreLibrary.SortOrder;
    
    return Controller.extend("com.eshipjetcopy.zeshipjetcopy.controller.Eshipjet", {
        formatter: formatter,
        onInit: function () {
             var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/commonValues/showPlant", false);
            // this.onGetCarrierCatalogData();
            // this.onGetCarrierAccoData();

            // this.getMasterData();
            // var sAudioPath = sap.ui.require.toUrl("com/eshipjetcopy/zeshipjetcopy/audio/Lock.mp3");
            // var audio = new Audio(sAudioPath);
            // audio.play();

            
            var oTimerModel = new sap.ui.model.json.JSONModel({
                hours: "00",
                minutes: "00",
                seconds: "00"
            });
            this.getView().setModel(oTimerModel, "timerModel");

            var seconds = 0, minutes = 0, hours = 0;

            this.timerInterval = setInterval(() => {
                seconds++;

                if (seconds === 60) {
                    seconds = 0;
                    minutes++;
                }

                if (minutes === 60) {
                    minutes = 0;
                    hours++;
                }

                this.getView().getModel("timerModel").setData({
                    hours: hours.toString().padStart(2, "0"),
                    minutes: minutes.toString().padStart(2, "0"),
                    seconds: seconds.toString().padStart(2, "0")
                });
            }, 1000);

            this.getView().addEventDelegate({ 
                onkeydown: function (oEvent) {                // <- oEvent is provided here
            if (oEvent.key === "F2" || oEvent.keyCode === 113 || oEvent.which === 113) {
                oEvent.preventDefault();
                var oBtn = this.byId("idShipNowBtn");
                if (oBtn && oBtn.getEnabled() && oBtn.getVisible()) {
                oBtn.firePress();
                }
            }
            }.bind(this)                                  // <- keep controller context
         }, this);

            this._pageSize = 50;
            this._currentPage = 1;
            this.setupFreightQuotePagination();

            var oModel = new JSONModel(sap.ui.require.toUrl("com/eshipjetcopy/zeshipjetcopy/model/data.json"));
            this.getView().setModel(oModel);
            oController = this;
            // Initialize a JSON model to store chat messages
            var obj = {
                "messages": [],
                "listState": false,
                "iconState": true
            }
            const oShipperCopilotModel = new JSONModel(obj);
            this.getView().setModel(oShipperCopilotModel, "ShipperCopilotModel");
            this.getView().getModel("ShipperCopilotModel").setSizeLimit(9999999);   
            oResourceBundle = this.getOwnerComponent().getModel("i18n").getResourceBundle();
            this._setToggleButtonTooltip(!Device.system.desktop);
            
            var ShipNowDataModel = {
                "sapShipmentID": "",
                "ShipToCONTACT": "",
                "ShipToCOMPANY": "",
                "ShipToPHONE": "",
                "ShipToEMAIL": "",
                "ShipToCITY": "",
                "ShipToSTATE": "",
                "ShipToCOUNTRY": "",
                "ShipToZIPCODE": "",
                "ShipToADDRESS_LINE1": "",
                "ShipToADDRESS_LINE2": "",
                "ShipToADDRESS_LINE3": ""
            };
            var ShipNowDataModel = new JSONModel(ShipNowDataModel);
            this.getOwnerComponent().setModel(ShipNowDataModel, "ShipNowDataModel");
            oController.oBusyDialog = new sap.m.BusyDialog({});
            this.getOwnerComponent().getRouter().getRoute("RouteEshipjet").attachPatternMatched(this._handleRouteMatched, this);
            // oController.readAPIProductSrvModel();
            // oController.ShippingTypeDropdownData();

        //    var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var userId = "";
            var userName = "Guest";  // default

            // Check if app is running in Fiori Launchpad
            if (sap.ushell && sap.ushell.Container && sap.ushell.Container.getUser) {
                userId = sap.ushell.Container.getUser().getId();
                
                if (userId && userId.toUpperCase() !== "DEFAULT_USER") {
                    userName = userId.split('.')[0].toLowerCase();
                    userName = userName.charAt(0).toUpperCase() + userName.slice(1);
                }
            }

            eshipjetModel.setProperty("/userName", userName);


            // oController.getTodayShipments();
            // oController.getManifestHeaderForTodaysShipmentCount();
            oController.getManifestHeaderForTodaysShipmentCount();
            // oController.onPackSectionEmptyRows();
            function sanitizeDescription(desc, maxLength = 40) {
                if (!desc) return "";

                // Remove commas and other invalid characters
                desc = desc.replace(/,/g, " ");  
                desc = desc.replace(/[^a-zA-Z0-9 .\-]/g, "");

                // Trim to max length allowed by OData metadata (40 assumed)
                return desc.substring(0, maxLength);
            }
        },

        readAPIProductSrvModel:function(){
            var APIProductSrvModel = oController.getOwnerComponent().getModel("APIProductSrvModel");
            var oFilter = new sap.ui.model.Filter("ProductType", sap.ui.model.FilterOperator.EQ, "VERP");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");

            APIProductSrvModel.read("/A_Product", {
                filters: [oFilter],
                success:function(oResult){
                    eshipjetModel.setProperty("/packageMaterial", oResult.results)
                },
                error:function(oError){
                    console.log(oError);
                }
            })
        },

        ShippingTypeDropdownData:function(){
            var ShipReadDataSrvModel = oController.getOwnerComponent().getModel("ShipReadDataSrvModel");
            eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            ShipReadDataSrvModel.read("/ShippingTypeSet", {               
                success:function(response){
                    eshipjetModel.setProperty("/ShipMethodSet",response.results);
                },
                error:function(oError){
                    console.log(oError);
                }
            })

        },
        onPackSectionEmptyRows:function(){
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aHandlingUnits = eshipjetModel.getProperty("/HandlingUnits") || [];
            var aPackAddProductTable = eshipjetModel.getProperty("/commonValues/packAddProductTable") || [];
            var aBusinessPartnersTable = eshipjetModel.getProperty("/BusinessPartners") || [];

            // If HandlingUnits has less than 6 items, add empty rows
            while (aPackAddProductTable.length < 4) {
                aPackAddProductTable.push({ SerialNo: "" });
            }

            while (aHandlingUnits.length < 6) {
                aHandlingUnits.push(
                    { SerialNumber: "", SAPHUID: "" }
                );
            }
            
            // while (aBusinessPartnersTable.length < 5) {
            //     aBusinessPartnersTable.push(
            //         { PartnerType: "Ship From", "FullName": "Eshipjet Software Inc.", "BusinessPartnerName1":"Steve Marsh", "StreetName":"5717 Legacy", "HouseNumber":"Suite 250", "Region":"Plano", "CityName":"TX", "PostalCode":"75024", "Country":"US", "PhoneNumber":"(888) 464-2360", "email":"info@eshipjet.ai" },
            //         { PartnerType: "Shipper", "FullName": "Eshipjet Software Inc.", "BusinessPartnerName1":"Steve Marsh", "StreetName":"5717 Legacy", "HouseNumber":"Suite 250", "Region":"Plano", "CityName":"TX", "PostalCode":"75024", "Country":"US", "PhoneNumber":"(888) 464-2360", "email":"info@eshipjet.ai" },
            //         { PartnerType: "Freight Forwarder", "FullName": "", "BusinessPartnerName1":"", "StreetName":"", "HouseNumber":"", "Region":"", "CityName":"", "PostalCode":"", "Country":"", "PhoneNumber":"", "email":""  },
            //         { PartnerType: "Importer", "FullName": "", "BusinessPartnerName1":"", "StreetName":"", "HouseNumber":"", "Region":"", "CityName":"", "PostalCode":"", "Country":"", "PhoneNumber":"", "email":""  },
            //         { PartnerType: "Third Party", "FullName": "", "BusinessPartnerName1":"", "StreetName":"", "HouseNumber":"", "Region":"", "CityName":"", "PostalCode":"", "Country":"", "PhoneNumber":"", "email":""  }
            //     );
            // }

            // eshipjetModel.setProperty("/BusinessPartners", aBusinessPartnersTable);
            
            eshipjetModel.setProperty("/commonValues/packAddProductTable", aPackAddProductTable);
            eshipjetModel.setProperty("/HandlingUnits", aHandlingUnits);

            var HandlingUnits = eshipjetModel.getProperty("/HandlingUnits");
            var HandlingUnitsLength = 0;
            for(var i=0; i<HandlingUnits.length; i++){
                if(HandlingUnits[i].SAPHUID !== ""){
                    HandlingUnitsLength += 1
                }
            };
            eshipjetModel.setProperty("/HandlingUnitsLength", HandlingUnitsLength);
        },

        getMasterData:function(){           
            var obj = {
                "locationid": "1001",
                "formname": "shipments",
                        "type": "modules",
                        "defaultmodules": [
                            "erp",
                            "location",
                            "ordertypes",
                            "dimensions",
                            "countrylist",
                            "shipmentstatuses",
                            "costcenter",
                            "products",
                            "addressbook",
                            "packagetypes",
                            "carrierconfiguration",
                            "defaultconfiguration",
                            "eucountrylist",
                            "ltlclass"
                        ]
                    };
                    var sPath = "https://dev-api-v1.eshipjet.site/LocationMaster/defaultdata";
                    return new Promise((resolve, reject) => {
                        $.ajax({
                            url: sPath, // Replace with your API endpoint
                            method: "POST",
                            contentType: "application/json", // Set content type to JSON if sending JSON data
                            data: JSON.stringify(obj),
                            success: function (response) {
                                
                            },
                            error: function (error) {
                                // Handle error
                                oController.oBusyDialog.close();
                                reject(error);
                                console.log("Error:", error);
                            }
                        });
                    });
        },

        _handleRouteMatched:function(){           
            eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/pickupDate", new Date());
            eshipjetModel.setSizeLimit(9999999);           
        },

        onItemSelect: function (oEvent) {
            var oItem = oEvent.getParameter("item");
            var sKey = oItem.getKey();            
            // eshipjetModel.setSizeLimit(9999999);
            eshipjetModel.setProperty("/commonValues/sapDeliveryNumber",""); //80000001
            var oToolPage = this.byId("toolPage");
            oToolPage.setSideExpanded(false);
            eshipjetModel.setProperty("/shippingCharges",[]);
            eshipjetModel.setProperty("/shippingDocuments",[]);
            eshipjetModel.setProperty("/HandlingUnitItems",[]);
            eshipjetModel.setProperty("/HandlingUnits",[]);
            eshipjetModel.setProperty("/shippingDocuments",[]);
            eshipjetModel.setProperty("/BusinessPartners",[]);
            eshipjetModel.setProperty("/commonValues/ShipNowShipMethodSelectedKey","");
            eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey","");
            eshipjetModel.setProperty("/accountNumber","");
            eshipjetModel.setProperty("/trackingArray", []);
            eshipjetModel.setProperty("/pickAddProductTable",[]);
            eshipjetModel.setProperty("/HandlingUnits",[]);
            eshipjetModel.setProperty("/HandlingUnitItems",[]);
            if (sKey === "ShipperCopilot") {
                var obj = {
                    "messages": [],
                    "listState": false,
                    "iconState": true
                }
                oShipperCopilotModel = new JSONModel(obj);
                this.getView().setModel(oShipperCopilotModel, "ShipperCopilotModel");
                oShipperCopilotModel = this.getView().getModel("ShipperCopilotModel");
                eshipjetModel.setProperty("/commonValues/allViewsFooter", true);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
                eshipjetModel.setProperty("/commonValues/showDarkThemeSwitch", true);
                eshipjetModel.setProperty("/commonValues/darkTheme", true);
                document.body.classList.remove("dark-theme");
            } else if (sKey === "ScanShip") {
                eshipjetModel.setProperty("/commonValues/allViewsFooter", true);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
                eshipjetModel.setProperty("/commonValues/showDarkThemeSwitch", true);
                eshipjetModel.setProperty("/commonValues/darkTheme", true);
                document.body.classList.remove("dark-theme");

                eshipjetModel.setProperty("/sShipAndScan", "");
                eshipjetModel.setProperty("/scanShipTableData2", []);
                oController.getScanShipHistoryShipments();
                // this._handleDisplayScanShipTable();
            } else if (sKey === "Orders") {
                eshipjetModel.setProperty("/commonValues/toolPageHeader", false);
                eshipjetModel.setProperty("/commonValues/allViewsFooter", false);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
                eshipjetModel.setProperty("/commonValues/showDarkThemeSwitch", false);
                eshipjetModel.setProperty("/commonValues/darkTheme", false);
                document.body.classList.remove("dark-theme");
                oController.getOrdersHistoryShipments();
                // this._handleDisplayOrdersTable();
            } else if (sKey === "ShipRequestLabel") {
                eshipjetModel.setProperty("/commonValues/allViewsFooter", true);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
                eshipjetModel.setProperty("/commonValues/showDarkThemeSwitch", false);
                eshipjetModel.setProperty("/commonValues/darkTheme", false);
                document.body.classList.remove("dark-theme");
                // this._handleDisplayShipReqTable();
                oController.getShipReqLabelHistoryShipments();
            } else if (sKey === "ShipNow") {
                jQuery.sap.delayedCall(500, this, function() {
                    this.getView().byId("idSapDeliveryNumber").focus();
                });
                eshipjetModel.setProperty("/commonValues/OverallGoodsMovementStatus", "0");
                oController.onShipNowNavigateInitialProcess();
                var aBusinessPartnersTable = eshipjetModel.getProperty("/BusinessPartners") || [];
                while (aBusinessPartnersTable.length < 5) {
                    aBusinessPartnersTable.push(
                        { PartnerType: "Ship From", "FullName": "Eshipjet Software Inc.", "BusinessPartnerName1":"Steve Marsh", "StreetName":"5717 Legacy", "HouseNumber":"Suite 250", "Region":"Plano", "CityName":"TX", "PostalCode":"75024", "Country":"US", "PhoneNumber":"(888) 464-2360", "email":"info@eshipjet.ai" },
                        { PartnerType: "Shipper", "FullName": "Eshipjet Software Inc.", "BusinessPartnerName1":"Steve Marsh", "StreetName":"5717 Legacy", "HouseNumber":"Suite 250", "Region":"Plano", "CityName":"TX", "PostalCode":"75024", "Country":"US", "PhoneNumber":"(888) 464-2360", "email":"info@eshipjet.ai" },
                        { PartnerType: "Freight Forwarder", "FullName": "", "BusinessPartnerName1":"", "StreetName":"", "HouseNumber":"", "Region":"", "CityName":"", "PostalCode":"", "Country":"", "PhoneNumber":"", "email":""  },
                        { PartnerType: "Importer", "FullName": "", "BusinessPartnerName1":"", "StreetName":"", "HouseNumber":"", "Region":"", "CityName":"", "PostalCode":"", "Country":"", "PhoneNumber":"", "email":""  },
                        { PartnerType: "Third Party", "FullName": "", "BusinessPartnerName1":"", "StreetName":"", "HouseNumber":"", "Region":"", "CityName":"", "PostalCode":"", "Country":"", "PhoneNumber":"", "email":""  }
                    );
                }
                eshipjetModel.setProperty("/BusinessPartners", aBusinessPartnersTable);
                var oIconTabBar = this.byId("idIconTabBarFiori2");
                oIconTabBar.setSelectedKey("Pack");
                // ShipNowDataModel.setProperty("/ShipToAddress", "");
                // oController._handleDisplayShipNowPackTable();
                // this._handleDisplayShipNowProductsTable();
                // this._handleDisplayShipNowHandlingUnitTable();
            } else if (sKey === "QuoteNow") {
                eshipjetModel.setProperty("/commonValues/allViewsFooter", true);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
                eshipjetModel.setProperty("/commonValues/showDarkThemeSwitch", true);
                eshipjetModel.setProperty("/commonValues/darkTheme", true);
                document.body.classList.remove("dark-theme");
            } else if (sKey === "TrackNow") {
                this.getOrdersHistoryShipments();
                eshipjetModel.setProperty("/commonValues/toolPageHeader", false);
                eshipjetModel.setProperty("/commonValues/allViewsFooter", true);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
                eshipjetModel.setProperty("/commonValues/showDarkThemeSwitch", false);
                eshipjetModel.setProperty("/commonValues/darkTheme", false);
                document.body.classList.remove("dark-theme");
                // this._handleDisplayTrackNowTable();
            } else if (sKey === "Manifest") {
                eshipjetModel.setProperty("/commonValues/allViewsFooter", true);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
                eshipjetModel.setProperty("/commonValues/showDarkThemeSwitch", false);
                eshipjetModel.setProperty("/commonValues/darkTheme", false);
                document.body.classList.remove("dark-theme");
                this._handleDisplayManifestTable();
            } else if (sKey === "AESDirect") {
                eshipjetModel.setProperty("/commonValues/allViewsFooter", true);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
                eshipjetModel.setProperty("/commonValues/showDarkThemeSwitch", false);
                eshipjetModel.setProperty("/commonValues/darkTheme", false);
                document.body.classList.remove("dark-theme");
            } else if (sKey === "Dashboard") {
                eshipjetModel.setProperty("/commonValues/allViewsFooter", true);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
                eshipjetModel.setProperty("/commonValues/showDarkThemeSwitch", false);
                eshipjetModel.setProperty("/commonValues/darkTheme", false);
                document.body.classList.remove("dark-theme");
            } else if (sKey === "Reports") {
                eshipjetModel.setProperty("/commonValues/allViewsFooter", true);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
                eshipjetModel.setProperty("/commonValues/showDarkThemeSwitch", false);
                eshipjetModel.setProperty("/commonValues/darkTheme", false);
                document.body.classList.remove("dark-theme");
            } else if (sKey === "BatchShip") {
                eshipjetModel.setProperty("/commonValues/allViewsFooter", true);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
                eshipjetModel.setProperty("/commonValues/showDarkThemeSwitch", false);
                eshipjetModel.setProperty("/commonValues/darkTheme", false);
                document.body.classList.remove("dark-theme");
                this._handleDisplayBatchShipTable();
            } else if (sKey === "RoutingGuide") {
                eshipjetModel.setProperty("/commonValues/allViewsFooter", true);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
                eshipjetModel.setProperty("/commonValues/showDarkThemeSwitch", false);
                eshipjetModel.setProperty("/commonValues/darkTheme", false);
                document.body.classList.remove("dark-theme");
                // this._handleDisplayRoutingGuideTable();
            } else if (sKey === "FeightAuditAnalysis") {
                eshipjetModel.setProperty("/commonValues/allViewsFooter", true);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
                eshipjetModel.setProperty("/commonValues/showDarkThemeSwitch", false);
                eshipjetModel.setProperty("/commonValues/darkTheme", false);
                document.body.classList.remove("dark-theme");
                // this._handleDisplayRoutingGuideTable();
            }else if (sKey === "FreightQuoteOrders") {
                eshipjetModel.setProperty("/commonValues/toolPageHeader", false);
                eshipjetModel.setProperty("/commonValues/allViewsFooter", false);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
                eshipjetModel.setProperty("/commonValues/showDarkThemeSwitch", false);
                eshipjetModel.setProperty("/commonValues/darkTheme", false);
                document.body.classList.remove("dark-theme");
            }
            eshipjetModel.setProperty("/SideNavigation", false);
            this.byId("pageContainer").to(this.getView().createId(sKey));
        },
        
        onShipNowNavigateInitialProcess:function(){
            var ShipNowDataModel = oController.getView().getModel("ShipNowDataModel");
            eshipjetModel.setProperty("/sFromViewName", "SHIP_NOW");
            var obj = {
                "ShipFromCONTACT": "Steve Marsh",
                "ShipFromCOMPANY": "Eshipjet Software Inc.",
                "ShipFromPHONE": "(888) 464-2360",
                "ShipFromEMAIL": "info@eshipjet.ai",
                "ShipFromCITY": "Plano",
                "ShipFromSTATE": "TX",
                "ShipFromCOUNTRY": "US",
                "ShipFromZIPCODE": "75024",
                "ShipFromADDRESS_LINE1": "5717 Legacy",
                "ShipFromADDRESS_LINE2": "Suite 250",
                "LocationType": "Commercial"
            };
            ShipNowDataModel.setProperty("/ShipFromAddress", obj);           
            eshipjetModel.setProperty("/commonValues/toolPageHeader", false);
            eshipjetModel.setProperty("/commonValues/allViewsFooter", false);
            eshipjetModel.setProperty("/commonValues/shipNowViewFooter", true);
            eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
            eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
            eshipjetModel.setProperty("/commonValues/showDarkThemeSwitch", false);
            eshipjetModel.setProperty("/commonValues/darkTheme", false);
            document.body.classList.remove("dark-theme");
            eshipjetModel.setProperty("/commonValues/shipNowGetBtn", true);
            eshipjetModel.setProperty("/commonValues/OverallGoodsMovementStatus", "");
            eshipjetModel.setProperty("/commonValues/shipNowBtnStatus", true);
            eshipjetModel.setProperty("/commonValues/plant", "");
            eshipjetModel.setProperty("/commonValues/showPlant", false); // ðŸ‘ˆ Hide Plant
            oController.onPackSectionEmptyRows();
            // oController.getTodayShipments();
            var sFromScreen = eshipjetModel.getProperty("/sFromScreen");
            if(sFromScreen === "QUOTE_NOW"){
                oController.onShipNowGetPress()
            }

        },
        handleUserNamePress: function (event) {
            var oPopover = new Popover({
                showHeader: false,
                placement: PlacementType.Bottom,
                content: [
                    new Button({
                        text: 'Feedback',
                        type: ButtonType.Transparent
                    }),
                    new Button({
                        text: 'Help',
                        type: ButtonType.Transparent
                    }),
                    new Button({
                        text: 'Logout',
                        type: ButtonType.Transparent
                    })
                ]
            }).addStyleClass('sapMOTAPopover sapTntToolHeaderPopover');

            oPopover.openBy(event.getSource());
        },

        onSideNavButtonPress: function () {
            var oToolPage = this.byId("toolPage");
            var bSideExpanded = oToolPage.getSideExpanded();
            this._setToggleButtonTooltip(bSideExpanded);            
            var SideNavigation = eshipjetModel.getProperty("/SideNavigation");
            if (SideNavigation === true) {
                eshipjetModel.setProperty("/SideNavigation", false);
            } else if (SideNavigation === false) {
                eshipjetModel.setProperty("/SideNavigation", true);
            }
            oToolPage.setSideExpanded(!oToolPage.getSideExpanded());
        },

        _setToggleButtonTooltip: function (bLarge) {
            var oToggleButton = this.byId('sideNavigationToggleButton');
            if (bLarge) {
                oToggleButton.setTooltip('Large Size Navigation');
            } else {
                oToggleButton.setTooltip('Small Size Navigation');
            }
        },
            // shipper Copilot changes start
            onSendPress: async function () {
                oController.onOpenBusyDialog();
                oShipperCopilotModel = this.getView().getModel("ShipperCopilotModel");
                const sUserMessage = this.getView().byId("userInput").getValue();

                if (!sUserMessage) {
                    oController.onCloseBusyDialog();
                    MessageToast.show("Please enter a message.");
                    return;
                }
                const sNormalizedMessage = sUserMessage.toUpperCase();

                if (sNormalizedMessage === "SHOW ALL SHIPMENTS" || sNormalizedMessage === "SHOW ORDERS WITH OPEN STATUS") {
                    this.onPressAllShipments("ShowAllShipments");
                } else if (sNormalizedMessage === "SHOW COUNTRY WISE SHIPMENTS") {
                    this.onClickCountryWiseShipments();
                } else if (sNormalizedMessage === "SHOW FEDEX SHIPMENTS") {
                    this.onPressCarrierWiseShipments("FEDEX");
                } else if (sNormalizedMessage === "SHOW UPS SHIPMENTS") {
                    this.onPressCarrierWiseShipments("UPS");
                } 
                // else {
                //     MessageToast.show("Please enter a valid message.");
                // }
                oShipperCopilotModel.setProperty("/iconState", false);
                oShipperCopilotModel.setProperty("/listState", true);

                // Add the user's message to the chat list
                const aMessages = oShipperCopilotModel.getProperty("/messages");
                aMessages.push({ sender: "You", text: sUserMessage });
                oShipperCopilotModel.setProperty("/messages", aMessages);
                this.getView().byId("userInput").setValue("");

                                // Simulate a bot response after sending the user message
                try {
                    var sUserDeliveryNum = sUserMessage.split(" "), aResponse;
                    sUserDeliveryNum = sUserDeliveryNum[sUserDeliveryNum.length-1]
                    eshipjetModel.setProperty("/sShipAndScan", sUserDeliveryNum.trim());
                    if(sUserDeliveryNum && sUserDeliveryNum.length > 7){
                        aResponse = await oController.getManifestHeaderForScanShip(sUserMessage);
                    }else{
                        MessageToast.show("Please enter valid data");
                    }                 
                    oController.onCloseBusyDialog();                 
                } catch (error) {
                    if (error.responseText !== undefined) {
                        aMessages.push({ sender: "BotError", text: error.responseText });
                        oShipperCopilotModel.setProperty("/messages", aMessages);
                    }
                    //MessageToast.show("Error communicating with Copilot.");
                    oController.onCloseBusyDialog();
                }
                this._scrollToBottom();
            },

            _scrollToBottom: function() {
                var oScrollContainer = this.byId("ShipperCopilot");
                if (oScrollContainer) {
                    setTimeout(function() {
                        var oDomRef = oScrollContainer.getDomRef();
                        if (oDomRef) {
                            // Force reflow
                            oDomRef.style.display = 'none';
                            oDomRef.offsetHeight; // Trigger reflow
                            oDomRef.style.display = '';
                            
                            // Now scroll
                            oDomRef.scrollTop = oDomRef.scrollHeight;
                        }
                    }, 50);
                }
            },

            onPressCarrierWiseShipments: async function(oCarrier){
                oController.onOpenBusyDialog();
                var oShipperCopilotModel = this.getView().getModel("ShipperCopilotModel");
                var sCustomDataKey = oCarrier;
                var sResponse;
                
                try {
                    // Await the response first
                    sResponse = await oController._showAllShipmentsResponse();
                    sResponse = sResponse.filter(item => item.CarrierCode.trim() === sCustomDataKey);                        
                    oShipperCopilotModel.setProperty("/tableData", sResponse);
                    //await oController._createShipmentsTable(sResponse , sCustomDataKey);
                } catch (error) {
                    oController.onCloseBusyDialog();
                    
                    var aMessages = oShipperCopilotModel.getProperty("/messages") || [];
                    if (error.responseText !== undefined) {
                        aMessages.push({ sender: "BotError", text: error.responseText });
                        oShipperCopilotModel.setProperty("/messages", aMessages);
                    }
                    return;
                }

                //var oShipperCopilotModel = this.getView().getModel("ShipperCopilotModel");
                var sUserMessage, sBotMessage;
                if(sCustomDataKey === "FEDEX"){
                    sUserMessage = "Show FedEx Shipments";
                }else if(sCustomDataKey === "UPS"){
                    sUserMessage = "Show UPS Shipments";
                }
                oShipperCopilotModel.setProperty("/iconState", false);
                oShipperCopilotModel.setProperty("/listState", true);

                // Add the user's message to the chat list
                var aMessages = oShipperCopilotModel.getProperty("/messages") || [];
                // aMessages.push({ sender: "You", text: sUserMessage });
                // oShipperCopilotModel.setProperty("/messages", aMessages);
                this.getView().byId("userInput").setValue("");

                if (sResponse && sResponse.length !== 0) {
                    oShipperCopilotModel.setProperty("/showAllShipmentsTable", true);
                   
                    if(sCustomDataKey === "FEDEX"){
                        sBotMessage = "Here are all the FedEx shipments:";
                    }else if(sCustomDataKey === "UPS"){
                         sBotMessage = "Here are all the UPS shipments:"
                    }
                    aMessages.push({
                                sender: "Bot",
                                text: sBotMessage,
                                tableData: sResponse,
                                hasTableData: true,
                                hasTrackTableData:false,
                                hasCountryTableData: false,
                                isUserText: false,
                                isBotImage: false
                            });
                    oShipperCopilotModel.setProperty("/messages", aMessages);
                } else {
                    var aError = sResponse.Errors || [];
                    if (aError.length !== 0) {
                        aMessages.push({ sender: "BotError", text: aError[0] });
                        oShipperCopilotModel.setProperty("/messages", aMessages);
                    }
                }

                oController.onCloseBusyDialog();
            },

            // Simulate bot response for testing purposes
            _simulateBotResponse: function (sMessage) {            
                var obj = {
                    "message": sMessage // Match DeliveryNo in the message if needed
                }
                var sPath = "https://eshipjet-demo-srv-hvacbxf0fqapdpgd.francecentral-01.azurewebsites.net/copilot/v1/bot/process";

                const oShipperCopilotModel = oController.getView().getModel("ShipperCopilotModel");
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: sPath, // Replace with your API endpoint
                        method: "POST",
                        contentType: "application/json", // Set content type to JSON if sending JSON data
                        data: JSON.stringify(obj),
                        success: function (response) {
                            // Handle successful response
                            resolve(response);
                            console.log("Success:", response);
                        },
                        error: function (error) {
                            // Handle error
                            reject(error);
                            console.log("Error:", error);
                        }
                    });
                });
            },

            onZoomImage: function (oEvent) {
                var dataUrl = oEvent.getSource().getBindingContext("ShipperCopilotModel").getObject().imageSrc;
                if (!this._oDialog) {
                    this._oImage = new sap.m.Image({
                        class: "sapUiSmallMargin",
                        width: "100%",
                        height: "100%"
                    });

                    this._oDialog = new sap.m.Dialog({
                        title: "Ship Image",
                        contentWidth: "30%",
                        contentHeight: "80%",
                        content: [this._oImage],
                        endButton: new sap.m.Button({
                            text: "Close",
                            press: function () {
                                this._oDialog.close();
                            }.bind(this)
                        })
                    });
                }

                this._oImage.setSrc(dataUrl);
                this._oDialog.open();
            },

            
            onDownloadAllShipmentsExcel: function (aData) {
                var ShipperCopilotModel = this.getView().getModel("ShipperCopilotModel");
                var rows = ShipperCopilotModel.getProperty("/tableData");

                var oDateFormat = sap.ui.core.format.DateFormat.getDateTimeInstance({
                    pattern: "MM/dd/yyyy HH:mm"
                });
            
                var formattedRows = rows.map(function (row) {
                    return {
                        ...row,
                        Createddate: row.Createddate ? oDateFormat.format(new Date(row.Createddate)) : "",
                        DateAdded: row.DateAdded ? oDateFormat.format(new Date(row.DateAdded)) : "" 
                    };
                });
                var oSettings = {
                    workbook: {
                        columns: [
                            { label: "Request ID", property: "Vbeln" },
                            { label: "Created Date", property: "Createddate" },
                            { label: "Ship Date", property: "DateAdded" },
                            { label: "Shipment Type", property: "Shipmenttype" },
                            { label: "Carrier Name", property: "CarrierCode" },
                            { label: "Service Level", property: "CarrierDesc" },
                            { label: "Tracking Number", property: "TrackingNumber" },
                            { label: "Status", property: "DeliveryStatus" },
                            { label: "Ship To Company", property: "RecCompany" },
                            { label: "Ship To Contact", property: "RecContact" },
                            { label: "Ship To Address Line 1", property: "RecAddress1" },
                            { label: "Ship To City", property: "RecCity" },
                            { label: "Ship To State", property: "Region" },
                            { label: "Ship To Country", property: "RecCountry" },
                            { label: "Ship To Zipcode", property: "RecPostalcode" },
                            { label: "Ship To Phone", property: "RecPhone" },
                            { label: "Ship To Email", property: "Emailaddress" },
                            { label: "Requester Name", property: "RecContact" },
                            { label: "Connected To", property: "DateAdded" },
                            { label: "Order Type", property: "Shipmentid" },
                            { label: "Priority Level", property: "Priorityalert" },
                            { label: "RF ID", property: "Reference1" }
                        ]
                    },
                    dataSource: formattedRows,
                    fileName: 'All_Shipments',
                    Worker: true
                };
                var oSpreadsheet = new Spreadsheet(oSettings);
                oSpreadsheet.build().finally(function () {
                    oSpreadsheet.destroy();
                });
            },


            _showAllShipmentsResponse:function(){
                var oManifestSrvModel = this.getOwnerComponent().getModel("ManifestSrvModel");
                return new Promise(function (resolve, reject) {
                    oManifestSrvModel.read("/EshipjetManfestSet", {
                        success: function (oResponse) {
                            var last15Records = oResponse.results.slice(-100);
                            resolve(last15Records); // Resolve with data
                        },
                        error: function (oError) {
                            reject(oError); // Reject with error
                        }
                    });
                });
            },

            onPressAllShipments: async function (oEvent) {
                oController.onOpenBusyDialog();
                var oShipperCopilotModel = this.getView().getModel("ShipperCopilotModel");
                var sCustomDataKey, sResponse;
                if(oEvent === "ShowAllShipments"){
                    sCustomDataKey = oEvent;
                }else{
                    sCustomDataKey = oEvent.getSource().getCustomData()[0].getKey();
                }
                
                try {
                    // Await the response first
                    sResponse = await oController._showAllShipmentsResponse();
                    if(sCustomDataKey === "OrderStatus"){
                        sResponse = sResponse.filter(item => item.Shipmenttype.trim() === "O");                        
                    }
                    oShipperCopilotModel.setProperty("/tableData", sResponse);
                    //await oController._createShipmentsTable(sResponse , sCustomDataKey);
                } catch (error) {
                    oController.onCloseBusyDialog();
                    
                    var aMessages = oShipperCopilotModel.getProperty("/messages") || [];
                    if (error.responseText !== undefined) {
                        aMessages.push({ sender: "BotError", text: error.responseText });
                        oShipperCopilotModel.setProperty("/messages", aMessages);
                    }
                    return;
                }

                //var oShipperCopilotModel = this.getView().getModel("ShipperCopilotModel");
                var sUserMessage, sBotMessage;
                if(sCustomDataKey === "ShowAllShipments"){
                    sUserMessage = "Show All Shipments";
                }else if(sCustomDataKey === "OrderStatus"){
                    sUserMessage = "show orders with open status";
                }
                oShipperCopilotModel.setProperty("/iconState", false);
                oShipperCopilotModel.setProperty("/listState", true);

                // Add the user's message to the chat list
                var aMessages = oShipperCopilotModel.getProperty("/messages") || [];
                aMessages.push({ sender: "You", text: sUserMessage });
                oShipperCopilotModel.setProperty("/messages", aMessages);
                this.getView().byId("userInput").setValue("");

                if (sResponse && sResponse.length !== 0) {
                    oShipperCopilotModel.setProperty("/showAllShipmentsTable", true);
                   
                    if(sCustomDataKey === "ShowAllShipments"){
                        sBotMessage = "Here are all the shipments:";
                    }else if(sCustomDataKey === "OrderStatus"){
                         sBotMessage = "Details found for - show orders with open status:"
                    }
                    aMessages.push({
                                sender: "Bot",
                                text: sBotMessage,
                                tableData: sResponse,
                                hasTableData: true,
                                hasTrackTableData:false,
                                hasCountryTableData: false,
                                isUserText: false,
                                isBotImage: false
                            });
                    oShipperCopilotModel.setProperty("/messages", aMessages);
                } else {
                    var aError = sResponse.Errors || [];
                    if (aError.length !== 0) {
                        aMessages.push({ sender: "BotError", text: aError[0] });
                        oShipperCopilotModel.setProperty("/messages", aMessages);
                    }
                }

                oController.onCloseBusyDialog();

            },
                onClickCountryWiseShipments: async function(){
                    oController.onOpenBusyDialog();
                    var oShipperCopilotModel = this.getView().getModel("ShipperCopilotModel");
                    var sResponse, aShipmetsResponse = oShipperCopilotModel.getProperty("/tableData");
                    try {
                        // Await the response first
                        if(!aShipmetsResponse || aShipmetsResponse.length == 0){
                            sResponse = await oController._showAllShipmentsResponse();
                            oShipperCopilotModel.setProperty("/tableData", sResponse);
                        }else{
                            sResponse = oShipperCopilotModel.getProperty("/tableData");
                        } 
                        let groupedData = sResponse.reduce((result, item) => {
                            if (!result[item.FromCountry]) {
                                result[item.FromCountry] = [];
                            }
                            result[item.FromCountry].push(item);
                            return result;
                            }, {});
                      // Convert JSON into an array with country and count
                            let formattedResponse = Object.keys(groupedData).map(FromCountry => ({
                                country: FromCountry,
                                count: groupedData[FromCountry].length
                            }));                        
                            formattedResponse = formattedResponse.filter(item => item.country.trim() !== ""); // removing empty country
                                                      
                            var sUserMessage = "show me country wise shipments";
                            oShipperCopilotModel.setProperty("/iconState", false);
                            oShipperCopilotModel.setProperty("/listState", true);
            
                            // Add the user's message to the chat list
                            var aMessages = oShipperCopilotModel.getProperty("/messages") || [];
                            aMessages.push({ sender: "You", text: sUserMessage});
                            oShipperCopilotModel.setProperty("/messages", aMessages);
                            this.getView().byId("userInput").setValue("");
            
                            if (sResponse && sResponse.length !== 0) {
                                oShipperCopilotModel.setProperty("/showAllShipmentsTable", true);
                                aMessages.push({
                                    sender: "Bot",
                                    text: "Details found for country wise shipments:",
                                    CountryTableData: formattedResponse,
                                    hasCountryTableData: true,
                                    hasTableData:false,
                                    hasTrackTableData:false,
                                    isUserText: false,
                                    isBotImage: false
                                });
                                oShipperCopilotModel.setProperty("/messages", aMessages);
                            } else {
                                    var aError = sResponse.Errors || [];
                                    if (aError.length !== 0) {
                                        aMessages.push({ sender: "BotError", text: aError[0] });
                                        oShipperCopilotModel.setProperty("/messages", aMessages);
                                    }
                            }
                    }catch (error) {
                        oController.onCloseBusyDialog();                    
                        var aMessages = oShipperCopilotModel.getProperty("/messages") || [];
                        if (error.responseText !== undefined) {
                            aMessages.push({ sender: "BotError", text: error.responseText });
                            oShipperCopilotModel.setProperty("/messages", aMessages);
                        }
                        return;
                    }                  
                    oController.onCloseBusyDialog();     
                },              
            // Shipper Copilot Changes end

        // Ship Now changes starts here

        // onShipNowHUColumnConfigPress:function(oEvent){
        //     var oButton = oEvent.getSource(),
        //         oView = this.getView();
        //     if (!this._pShipNowHUColumnConfigPopover) {
        //         this._pShipNowHUColumnConfigPopover = Fragment.load({
        //             id: oView.getId(),
        //             name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.ShipNowHUColumnConfig",
        //             controller: this
        //         }).then(function (oPopover) {
        //             oView.addDependent(oPopover);
        //             return oPopover;
        //         });
        //     }
        //     this._pShipNowHUColumnConfigPopover.then(function (oPopover) {
        //         oController.ShipNowHUColumnConfigVisiblity();
        //         oPopover.openBy(oButton);
        //     });
        // },

        // ShipNowHUColumnConfigVisiblity: function () {
        //     var oView = oController.getView();
        //     var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
        //     var aColumns = eshipjetModel.getProperty("/ShipNowHandlingUnitTableColumns");
        //     var oShipNowHUColumnConfigTable = oView.byId("myShipNowHUColumnConfigSelectId");
        //     var aTableItems = oShipNowHUColumnConfigTable.getItems();

        //     aColumns.map(function (oColObj) {
        //         aTableItems.map(function (oItem) {
        //             if (oColObj.name === oItem.getBindingContext("eshipjetModel").getObject().name && oColObj.visible) {
        //                 oItem.setSelected(true);
        //             }
        //         });
        //     });
        // },

        // onShipNowHUColumnConfigNameSearch: function (oEvent) {
        //     var aFilters = [];
        //     var sQuery = oEvent.getSource().getValue();
        //     if (sQuery && sQuery.length > 0) {
        //         var filter = new Filter("label", FilterOperator.Contains, sQuery);
        //         aFilters.push(filter);
        //     }
        //     // update list binding
        //     var oList = oController.getView().byId("myShipNowHUColumnConfigSelectId");
        //     var oBinding = oList.getBinding("items");
        //     oBinding.filter(aFilters, "Application");
        // },

        // onShipNowHUColumnConfigSelectOkPress: function () {
        //     var oView = this.getView();
        //     var oShipNowHUColumnConfigTable = oView.byId("myShipNowHUColumnConfigSelectId");
        //     var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
        //     var oShipNowHUColumnConfigTableItems = oShipNowHUColumnConfigTable.getItems();
        //     var aColumnsData = eshipjetModel.getProperty("/ShipNowHandlingUnitTableColumns");
        //     oShipNowHUColumnConfigTableItems.map(function (oTableItems) {
        //         aColumnsData.map(function (oColObj) {
        //             if (oTableItems.getBindingContext("eshipjetModel").getObject().name === oColObj.name) {
        //                 if (oTableItems.getSelected()) {
        //                     oColObj.visible = true;
        //                 } else {
        //                     oColObj.visible = false;
        //                 }
        //             }
        //         })
        //     });
        //     eshipjetModel.updateBindings(true);
        //     this._pShipNowHUColumnConfigPopover.then(function (oPopover) {
        //         oPopover.close();
        //     });
        // },
        // onShipNowHUColumnConfigSelectClosePress: function () {
        //     this._pShipNowHUColumnConfigPopover.then(function (oPopover) {
        //         oPopover.close();
        //     });
        // },


        onShipNowHUColumnConfigPress: function (oEvent) {
            const oButton = oEvent.getSource();
            const oView = this.getView();
        
            if (!this._pShipNowHUColumnConfigPopover) {
                this._pShipNowHUColumnConfigPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.ShipNowHUColumnConfig",
                    controller: this
                }).then((oPopover) => {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
        
            this._pShipNowHUColumnConfigPopover.then((oPopover) => {
                this._syncShipNowHUColumnSelections();
                oPopover.openBy(oButton);
            });
        },
        
        _syncShipNowHUColumnSelections: function () {
            const oView = this.getView();
            const oModel = this.getOwnerComponent().getModel("eshipjetModel");
            const aColumns = oModel.getProperty("/ShipNowHandlingUnitTableColumns");
            const oTable = oView.byId("myShipNowHUColumnConfigSelectId");
        
            if (!oTable) return;
        
            oTable.getItems().forEach((oItem) => {
                const oItemData = oItem.getBindingContext("eshipjetModel").getObject();
                const oCol = aColumns.find(col => col.name === oItemData.name);
                oItem.setSelected(!!oCol?.visible);
            });
        },
        
        onShipNowHUColumnConfigNameSearch: function (oEvent) {
            const sQuery = oEvent.getSource().getValue();
            const aFilters = [];
        
            if (sQuery) {
                aFilters.push(new Filter("label", FilterOperator.Contains, sQuery));
            }
        
            const oTable = this.getView().byId("myShipNowHUColumnConfigSelectId");
            const oBinding = oTable.getBinding("items");
            oBinding.filter(aFilters, "Application");
        },
        
        onShipNowHUColumnConfigSelectOkPress: function () {
            const oView = this.getView();
            const oTable = oView.byId("myShipNowHUColumnConfigSelectId");
            const oModel = this.getOwnerComponent().getModel("eshipjetModel");
            const aItems = oTable.getItems();
            const aColumns = oModel.getProperty("/ShipNowHandlingUnitTableColumns");
        
            aItems.forEach((oItem) => {
                const oData = oItem.getBindingContext("eshipjetModel").getObject();
                const oCol = aColumns.find(col => col.name === oData.name);
                if (oCol) {
                    oCol.visible = oItem.getSelected();
                }
            });
        
            oModel.updateBindings(true);
        
            this._pShipNowHUColumnConfigPopover.then((oPopover) => {
                oPopover.close();
            });
        },
        
        onShipNowHUColumnConfigSelectClosePress: function () {
            if (this._pShipNowHUColumnConfigPopover) {
                this._pShipNowHUColumnConfigPopover.then((oPopover) => {
                    oPopover.close();
                });
            }
        },
        

        _handleDisplayShipNowPackTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var ShipNowProductsTableColumns = eshipjetModel.getData().ShipNowProductsTableColumns;
            const oTable = oView.byId("idShipNowPackTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < ShipNowProductsTableColumns.length; i++) {
                if (ShipNowProductsTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/ShipNowProductsTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().name;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "CreatedDate" || columnName === "ShipDate") {
                    var DateTxt = new sap.m.Text({
                        text: {
                            path: 'BatchShipTableDataModel>ShipDate',
                            formatter: formatter.formatDate  // Attach the formatter dynamically
                        },
                        wrapping: false
                    });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/commonValues/packAddProductTable");
        },

        // openShipNowPrdctColNamesPopover: function (oEvent) {
        //     var oButton = oEvent.getSource(),
        //         oView = this.getView();
        //     if (!this._pShipNowPrdctPopover) {
        //         this._pShipNowPrdctPopover = Fragment.load({
        //             id: oView.getId(),
        //             name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.ShipNowPrdctTableColumns",
        //             controller: this
        //         }).then(function (oPopover) {
        //             oView.addDependent(oPopover);
        //             return oPopover;
        //         });
        //     }
        //     this._pShipNowPrdctPopover.then(function (oPopover) {
        //         oController.ShipNowPrdctColumnsVisiblity();
        //         oPopover.openBy(oButton);
        //     });
        // },

        // ShipNowPrdctColumnsVisiblity: function () {
        //     var oView = oController.getView();
        //     var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
        //     var aColumns = eshipjetModel.getProperty("/ShipNowProductsTableColumns");
        //     var oShipNowPrdTable =  oView.byId("myShipNowPrdColumnSelectId") || 
        //                             sap.ui.getCore().byId(oView.createId("myShipNowPrdColumnSelectId"));
        //     var aTableItems = oShipNowPrdTable.getItems();

        //     aColumns.map(function (oColObj) {
        //         aTableItems.map(function (oItem) {
        //             if (oColObj.name === oItem.getBindingContext("eshipjetModel").getObject().name && oColObj.visible) {
        //                 oItem.setSelected(true);
        //             }
        //         });
        //     });
        // },
        // onShipNowPrdColSelectOkPress: function () {
        //     var oView = this.getView()
        //     var oShipNowPrdTable = oView.byId("myShipNowPrdColumnSelectId");
        //     var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
        //     var oShipNowPrdTableItems = oShipNowPrdTable.getItems();
        //     var aColumnsData = eshipjetModel.getProperty("/ShipNowProductsTableColumns");
        //     oShipNowPrdTableItems.map(function (oTableItems) {
        //         aColumnsData.map(function (oColObj) {
        //             if (oTableItems.getBindingContext("eshipjetModel").getObject().name === oColObj.name) {
        //                 if (oTableItems.getSelected()) {
        //                     oColObj.visible = true;
        //                 } else {
        //                     oColObj.visible = false;
        //                 }
        //             }
        //         })
        //     });
        //     eshipjetModel.updateBindings(true);
        //     // this._handleDisplayShipNowPackTable();
        //     this._pShipNowPrdctPopover.then(function (oPopover) {
        //         oPopover.close();
        //     });
        // },
        // onShipNowPrdColSelectClosePress: function () {
        //     this._pShipNowPrdctPopover.then(function (oPopover) {
        //         oPopover.close();
        //     });
        // },
// after version change code here down 
        openShipNowPrdctColNamesPopover: function (oEvent) {
            const oButton = oEvent.getSource();
            const oView = this.getView();
            const that = this;
        
            if (!this._pShipNowPrdctPopover) {
                this._pShipNowPrdctPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.ShipNowPrdctTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
        
            this._pShipNowPrdctPopover.then(function (oPopover) {
                that._syncShipNowPrdctColumnSelections();
                oPopover.openBy(oButton);
            });
            
        },
        onShipNowPrdColSelectClosePress: function () {
            if (this._pShipNowPrdctPopover) {
                this._pShipNowPrdctPopover.then(function (oPopover) {
                    oPopover.close();
                });
            }
        },
        
        
        _syncShipNowPrdctColumnSelections: function () {
            const oTable = Fragment.byId(this.getView().getId(), "myShipNowPrdColumnSelectId");
            if (!oTable) return;
        
            const aItems = oTable.getItems();
            aItems.forEach(function (oItem) {
                const oContext = oItem.getBindingContext("eshipjetModel");
                if (oContext) {
                    const oData = oContext.getObject();
                    oItem.setSelected(oData.visible === true);
                }
            });
        },
        

        onShipNowPrdColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = Fragment.byId(this.getView().getId(), "myShipNowPrdColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");
        },

        onShipNowPrdColSelectOkPress: function () {
            const oTable = Fragment.byId(this.getView().getId(), "myShipNowPrdColumnSelectId");
            const oModel = this.getOwnerComponent().getModel("eshipjetModel");
            const aColumns = oModel.getProperty("/ShipNowProductsTableColumns");
        
            // Update visibility from selection
            oTable.getItems().forEach(function (oItem) {
                const oContext = oItem.getBindingContext("eshipjetModel");
                if (oContext) {
                    const oData = oContext.getObject();
                    oData.visible = oItem.getSelected();
                }
            });
        
            oModel.refresh(true);
        
            this._pShipNowPrdctPopover.then(function (oPopover) {
                oPopover.close();
            });
            
        },
        
        


        onPartialQtyChange:function(oEvent){
            var currObjItemNetWeight = parseInt(oEvent.getSource().getBindingContext("eshipjetModel").getObject().ItemNetWeight);
            var currValue = parseInt(oEvent.getParameters().value);
            if(currValue > currObjItemNetWeight){
                var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
                var sPathArray = oEvent.getSource().getBindingContext("eshipjetModel").sPath.split("/");                
                var obj = eshipjetModel.getProperty("/commonValues/packAddProductTable")[sPathArray[sPathArray.length - 1]];
                obj["partialQty"] = 0;
                MessageBox.warning("Partial quantity cannot be greater than balance quantity.");
            }
        },

        onShipNowPrdctDltPress:function(oEvent){
            MessageBox.warning("Are you sure you want to delete HU?", {
                actions: [MessageBox.Action.OK, MessageBox.Action.CANCEL],
                emphasizedAction: MessageBox.Action.OK,
                onClose: function (sAction) {
                    if(sAction === "OK"){
                        oController.onConfirmShipNowPrdctDltPress(oEvent);
                    }
                }
            });
        },

        onConfirmShipNowPrdctDltPress:function(oEvent){            
            var packAddProductTable = eshipjetModel.getProperty("/commonValues/packAddProductTable");
            var sPath = oEvent.getSource().getBindingContext("eshipjetModel").sPath.split("/");
            var idx = parseInt(sPath[sPath.length-1]);
            packAddProductTable.splice(idx, 1);
            for(var i=0; i<packAddProductTable.length; i++){
                packAddProductTable[i]["SerialNo"] = i+1;
            };
            eshipjetModel.updateBindings(true);
        },

        onShipNowAllPrdctsDltPress:function(oEvent){
            MessageBox.warning("Are you sure you want to delete all the product?", {
                actions: [MessageBox.Action.OK, MessageBox.Action.CANCEL],
                emphasizedAction: MessageBox.Action.OK,
                onClose: function (sAction) {
                    if(sAction === "OK"){
                        oController.onConfirmShipNowAllPrdctsDltPress(oEvent);
                    }
                }
            });
        },

        onConfirmShipNowAllPrdctsDltPress:function(oEvent){
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/commonValues/packAddProductTable", []);
        },
        
        onShipNowHandlingUnitDelPress:function(oEvent){
            MessageBox.warning("Are you sure you want to delete this product?", {
                actions: [MessageBox.Action.OK, MessageBox.Action.CANCEL],
                emphasizedAction: MessageBox.Action.OK,
                onClose: function (sAction) {
                    if(sAction === "OK"){
                        oController.onConfirmShipNowHandlingUnitDelPress(oEvent);
                    }
                }
            });
        },

        onConfirmShipNowHandlingUnitDelPress:function(oEvent){
            oController.onOpenBusyDialog();
            var oCurrObj = oEvent.getSource().getBindingContext("eshipjetModel").getObject();
            var oPayload = {
                "Vbeln" : oCurrObj.HandlingUnitReferenceDocument,
                "HuNo" : oCurrObj.HandlingUnitExternalID
            };
        
            var sPath = "/HuDeleteSet('" + oCurrObj.HandlingUnitReferenceDocument + "')";
            var ShipReadDataSrvModel = oController.getOwnerComponent().getModel("ShipReadDataSrvModel");
            ShipReadDataSrvModel.create("/HuDeleteSet", oPayload, {
                success:function(oData){
                    console.log("Success:", oData);
                    sap.m.MessageToast.show("Handling unit deleted successfully.");
                    oController.readProductsData(oCurrObj.HandlingUnitReferenceDocument);
                    oController.onCloseBusyDialog();
                },
                error:function(oError){
                    var errMsg = JSON.parse(oError.responseText).error.message.value;
                    sap.m.MessageBox.error(errMsg);
                    oController.onCloseBusyDialog();
                }
            });
            // var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            // var HandlingUnits = eshipjetModel.getData().HandlingUnits;
            // var sPath = oEvent.getSource().getBindingContext("eshipjetModel").sPath.split("/");
            // var idx = parseInt(sPath[sPath.length-1]);
            // var packAddProductTable = eshipjetModel.getData().packAddProductTable;
            // for(var i=0; i<oCurrObj.ItemsInfo.length; i++){
            //     for(var j=0; j<packAddProductTable.length; j++){
            //         if(oCurrObj.ItemsInfo[i].DeliveryDocument === packAddProductTable[j].DeliveryDocument){
            //             packAddProductTable[i].ItemNetWeight += oCurrObj.ItemsInfo[i].ItemWeight;
            //         }else{
            //             // oCurrObj.ItemsInfo[i]["SerialNo"] = packAddProductTable.length + 1;
            //             // packAddProductTable.push(oCurrObj.ItemsInfo[i]);
            //         }
            //     };
            // };
            
            // HandlingUnits.splice(idx, 1);
            // for(var i=0; i<HandlingUnits.length; i++){
            //     HandlingUnits[i]["SerialNumber"] = i+1;
            // };
            // eshipjetModel.updateBindings(true);
        },

        readProductsData:function(sDeveliveryNumber){
            var oDeliveryModel = oController.getView().getModel("OutBoundDeliveryModel");
            var aOutBoundDelveryFilter = [], aProductTable = [];
            aOutBoundDelveryFilter.push(new Filter("DeliveryDocument", "EQ", sDeveliveryNumber));
            oDeliveryModel.read("/A_OutbDeliveryItem",{
                filters: aOutBoundDelveryFilter,
                success:function(oData){
                    if(oData && oData.results && oData.results.length > 0){
                        for(var i = 0; i < oData.results.length; i++){
                            oData.results[i]["SerialNumber"] = i+1;
                            oData.results[i]["ItemWeightUnit"] = "10X12X12";
                            oData.results[i]["BalanceQty"] = oData.results[i].ActualDeliveryQuantity;
                            aProductTable.push(oData.results[i]);
                        };
                        var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
                        eshipjetModel.setProperty("/commonValues/packAddProductTable",aProductTable);
                        oController.getSalesOrder(aProductTable);
                        oController.readHUDataSet(sDeveliveryNumber);
                    }
                },
                error: function(oErr){
                    console.log(oErr);
                    oController.oBusyDialog.close();
                }
            });
        },

        onShipNowAllHandlingUnitDelPress:function(oEvent){
            MessageBox.warning("Are you sure you want to delete all packed items?", {
                actions: [MessageBox.Action.OK, MessageBox.Action.CANCEL],
                emphasizedAction: MessageBox.Action.OK,
                onClose: function (sAction) {
                    if(sAction === "OK"){
                        oController.onConfirmShipNowAllHandlingUnitDelPress(oEvent);
                    }
                }
            });
        },

        onConfirmShipNowAllHandlingUnitDelPress:function(oEvent){
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var HandlingUnits = eshipjetModel.getData().HandlingUnits;
            var packAddProductTable = eshipjetModel.getProperty("/commonValues/packAddProductTable");

            HandlingUnits.forEach(oDeletedData => {
               oDeletedData.ItemsInfo.forEach(item => {
                    var matchingDelivery = packAddProductTable.find(delivery => 
                        String(delivery.DeliveryDocument) === String(item.DeliveryDocument)
                    );
        
                    if (matchingDelivery) {
                        matchingDelivery.ItemNetWeight = (matchingDelivery.ItemNetWeight || 0) + (item.ItemWeight || 0);
                    } else {
                        packAddProductTable.push(item);
                    }
                });
            });
        
            eshipjetModel.setProperty("/HandlingUnits", []);
            eshipjetModel.setProperty("/commonValues/packAddProductTable", packAddProductTable);
            eshipjetModel.refresh(true);
        
            MessageToast.show("All items removed and weight updated.");
        },

         onShipNowNewPress:function(){
            // oController.onOpenBusyDialog();
            oController.getView().setBusy(true);
            var ShipNowDataModel = oController.getView().getModel("ShipNowDataModel");
            var shipFromObj = {
                "ShipFromCONTACT": "Steve Marsh",
                "ShipFromCOMPANY": "Eshipjet Software Inc.",
                "ShipFromPHONE": "(888) 464-2360",
                "ShipFromEMAIL": "info@eshipjet.ai",
                "ShipFromCITY": "Plano",
                "ShipFromSTATE": "TX",
                "ShipFromCOUNTRY": "US",
                "ShipFromZIPCODE": "75024",
                "ShipFromADDRESS_LINE1": "5717 Legacy",
                "ShipFromADDRESS_LINE2": "Suite 250",
                "LocationType": "Commercial"
            };
            eshipjetModel.setProperty("/to_HandlingUnitHeaderDelivery/results", []);
            
            eshipjetModel.setProperty("/GetDeliveryData/to_Items/results", []);
            eshipjetModel.setProperty("/GetDeliveryData/to_ShipToParty", {});
            eshipjetModel.setProperty("/shipNowShipFromInputStatus", false);
            ShipNowDataModel.setProperty("/ShipFromAddress", shipFromObj);            
            ShipNowDataModel.setProperty("/ShipFromAddressType", "");
            ShipNowDataModel.setProperty("/ShipToAddress", {});
            eshipjetModel.setProperty("/ShipFromAddress", {});
            eshipjetModel.setProperty("/to_HandlingUnitHeaderDelivery/results", {});
            eshipjetModel.setProperty("/ShipToAddress", {});
            eshipjetModel.setProperty("/BusinessPartners", []);
            eshipjetModel.setProperty("/InternationalDetails/shipFromTaxNo", "");
            eshipjetModel.setProperty("/trackingArray", []);
            eshipjetModel.setProperty("/shippingCharges",[]);
            eshipjetModel.setProperty("/shippingDocuments",[]);
            eshipjetModel.setProperty("/HandlingUnitItems",[]);
            eshipjetModel.setProperty("/HandlingUnits",[]);
            eshipjetModel.setProperty("/ShipNowHandlingUnits",[]); 
            eshipjetModel.setProperty("/sFromViewName", "SHIP_NOW");
            eshipjetModel.setProperty("/selectPaymentType", "");
            eshipjetModel.setProperty("/invoiceNo", "");
            eshipjetModel.setProperty("/documentsLength", false);
            eshipjetModel.setProperty("/shippingChargesLength", false);
            eshipjetModel.setProperty("/trackingLength", false);
            eshipjetModel.setProperty("/hideTrackPackDetails", true);
            eshipjetModel.setProperty("/PGI_STATUS", "");
            eshipjetModel.setProperty("/CarrierCode", "");
            
             // Clear values
            eshipjetModel.setProperty("/commonValues/plant", "");
            eshipjetModel.setProperty("/commonValues/showPlant", false); // ðŸ‘ˆ Hide Plant
            var oCommonValues = {
                sapDeliveryNumber :"",
                ShipNowShipMethodSelectedKey:"",
                ShipNowShipsrvNameSelectedKey:"",
                ShipNowSelectedServiceName:"",
                accountNumber:"",
                packAddProductTable:[],
                toolPageHeader: false,
                allViewsFooter: false,
                shipNowViewFooter: true,
                createShipReqViewFooter : false,
                routingGuidFooter : false,
                showDarkThemeSwitch :false,
                darkTheme: false,
                shipNowGanderWhiteSelect:false,
                shipNowGetBtn:true,
                OverallGoodsMovementStatus: "0",
                shipNowABFSelect : false,
                shipNowARTEXFineArtSrvSelect : false,
                shipNowATLASFineArtSelect : false,
                shipNowBrinksFineArtSelect:false,
                shipNowCrownFineArtSelect: false,
                shipNowDHLSelect : false,
                shipNowDTDCSelect : false,
                shipNowFedExSelect : false,
                shipNowFastFarwarderSelect : false,
                shipNowFedExFreightSelect : false,
                shipNowJPMorganChaseInternalSelect:false,
                "shipNowMalca_AmitSelect":false,
                shipNowMoviGroupSelect: false,
                shipNowOtherSelect:false,
                shipNowRLSelect :false,
                shipNowTheArmorySelect :false,
                shipNowUPSSelect:false,
                shipNowBtnStatus :true,
                shipNowUSPSSelect:false,
                shipNowVoidSelect: false,
                shipNowVoidSelectSave:true,
                shipNowVoidSelectShipNow: true,
                showShipType: false,
                SalesOrder: "",
                PurchaseOrder: "",
                lengthOfDimensions: "",
                widthOfDimensions: "",
                heightOfDimensions: "",
                ShippingPoint: false,
                plant: "",
                showPlant: false
            };
            // eshipjetModel.setProperty("/commonValues/OverallGoodsMovementStatus", "0");
            eshipjetModel.setProperty("/commonValues", oCommonValues);        
            eshipjetModel.setProperty("/accountNumber", "");
            jQuery.sap.delayedCall(500, this, function() {
                this.getView().byId("idSapDeliveryNumber").focus();
            });
            oController.onPackSectionEmptyRows();     
            var oIconTabBar = this.byId("idIconTabBarFiori2");
            oIconTabBar.setSelectedKey("Pack");       
            // oController.onCloseBusyDialog();
            oController.getView().setBusy(false);
            var aBusinessPartnersTable = eshipjetModel.getProperty("/BusinessPartners") || [];
            while (aBusinessPartnersTable.length < 5) {
            aBusinessPartnersTable.push(
                { PartnerType: "Ship From", "FullName": "Eshipjet Software Inc.", "BusinessPartnerName1":"Steve Marsh", "StreetName":"5717 Legacy", "HouseNumber":"Suite 250", "Region":"Plano", "CityName":"TX", "PostalCode":"75024", "Country":"US", "PhoneNumber":"(888) 464-2360", "email":"info@eshipjet.ai" },
                { PartnerType: "Shipper", "FullName": "Eshipjet Software Inc.", "BusinessPartnerName1":"Steve Marsh", "StreetName":"5717 Legacy", "HouseNumber":"Suite 250", "Region":"Plano", "CityName":"TX", "PostalCode":"75024", "Country":"US", "PhoneNumber":"(888) 464-2360", "email":"info@eshipjet.ai" },
                { PartnerType: "Freight Forwarder", "FullName": "", "BusinessPartnerName1":"", "StreetName":"", "HouseNumber":"", "Region":"", "CityName":"", "PostalCode":"", "Country":"", "PhoneNumber":"", "email":""  },
                { PartnerType: "Importer", "FullName": "", "BusinessPartnerName1":"", "StreetName":"", "HouseNumber":"", "Region":"", "CityName":"", "PostalCode":"", "Country":"", "PhoneNumber":"", "email":""  },
                { PartnerType: "Third Party", "FullName": "", "BusinessPartnerName1":"", "StreetName":"", "HouseNumber":"", "Region":"", "CityName":"", "PostalCode":"", "Country":"", "PhoneNumber":"", "email":""  }
            );
        }

        eshipjetModel.setProperty("/BusinessPartners", aBusinessPartnersTable);

            // var sAudioPath = sap.ui.require.toUrl("com/eshipjetcopy/zeshipjetcopy/audio/clearSound.mp3");
            // var audio = new Audio(sAudioPath);
            // audio.play();
        },

        onShipNowClosePress:function(){
            var sKey = "Dashboard";            
            // eshipjetModel.setSizeLimit(9999999);
            eshipjetModel.setProperty("/commonValues/sapDeliveryNumber",""); //80000001
             var ShipNowDataModel = oController.getView().getModel("ShipNowDataModel");
            var shipFromObj = {
                "ShipFromCONTACT": "Steve Marsh",
                "ShipFromCOMPANY": "Eshipjet Software Inc.",
                "ShipFromPHONE": "(888) 464-2360",
                "ShipFromEMAIL": "info@eshipjet.ai",
                "ShipFromCITY": "Plano",
                "ShipFromSTATE": "TX",
                "ShipFromCOUNTRY": "US",
                "ShipFromZIPCODE": "75024",
                "ShipFromADDRESS_LINE1": "5717 Legacy",
                "ShipFromADDRESS_LINE2": "Suite 250",
                "LocationType": "Commercial"
            };
            ShipNowDataModel.setProperty("/ShipFromAddress", shipFromObj); 
            eshipjetModel.setProperty("/BusinessPartners", []);
            eshipjetModel.setProperty("/commonValues/ShipNowShipMethodSelectedKey", "");
            eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey", "");
            eshipjetModel.setProperty("/accountNumber", "");
            eshipjetModel.setProperty("/commonValues/packAddProductTable", []);
            eshipjetModel.setProperty("/InternationalDetails/shipFromTaxNo", "");
            eshipjetModel.setProperty("/InternationalDetails/shipFromTaxNo", "");
            eshipjetModel.setProperty("/trackingArray", []);
            eshipjetModel.setProperty("/commonValues/shipNowVoidSelect", false);
            eshipjetModel.setProperty("/commonValues/shipNowVoidSelectSave" , true);
            eshipjetModel.setProperty("/commonValues/shipNowVoidSelectShipNow" , true);
            eshipjetModel.setProperty("/commonValues/showShipType" , false);
            eshipjetModel.setProperty("/commonValues/ShippingPoint" , false);
            eshipjetModel.setProperty("/commonValues/plant" , "");
            eshipjetModel.setProperty("/commonValues/PurchaseOrder" , "");
            eshipjetModel.setProperty("/selectPaymentType", "");
            eshipjetModel.setProperty("/invoiceNo", "");
            eshipjetModel.setProperty("/shipNowShipFromInputStatus", false);
            var ShipNowDataModel = oController.getView().getModel("ShipNowDataModel");
            ShipNowDataModel.setProperty("/ShipToAddress", {});
            eshipjetModel.setProperty("/PGI_STATUS", "");

            eshipjetModel.setProperty("/to_HandlingUnitHeaderDelivery/results", {});
            eshipjetModel.setProperty("/ShipFromData", {});
            eshipjetModel.setProperty("/ShipToData", {});
            eshipjetModel.setProperty("/GetDeliveryData/to_Items/results", []);
            eshipjetModel.setProperty("/to_HandlingUnitHeaderDelivery/results", []);
            eshipjetModel.setProperty("/HandlingUnitsLength", "0");
            eshipjetModel.setProperty("/commonValues/shipNowBtnStatus", true);


            var oToolPage = this.byId("toolPage");
            oToolPage.setSideExpanded(false);
            eshipjetModel.setProperty("/shippingCharges",[]);
            eshipjetModel.setProperty("/shippingDocuments",[]);
            eshipjetModel.setProperty("/HandlingUnitItems",[]);
            eshipjetModel.setProperty("/HandlingUnits",[]);
            eshipjetModel.setProperty("/documentsLength", false);
            eshipjetModel.setProperty("/shippingChargesLength", false);
            eshipjetModel.setProperty("/trackingLength", false);
            if (sKey === "Dashboard") {
                eshipjetModel.setProperty("/commonValues/toolPageHeader", true);
                eshipjetModel.setProperty("/commonValues/allViewsFooter", true);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
                eshipjetModel.setProperty("/commonValues/showDarkThemeSwitch", false);
                eshipjetModel.setProperty("/commonValues/darkTheme", false);
                document.body.classList.remove("dark-theme");
            }
            eshipjetModel.setProperty("/SideNavigation", false);
            this.byId("pageContainer").to(this.getView().createId(sKey));
        },

        onOrdersClosePress:function(){
            var sKey = "Dashboard";
            eshipjetModel.setProperty("/SideNavigation", false);
            this.byId("pageContainer").to(this.getView().createId(sKey));
            eshipjetModel.setProperty("/commonValues/toolPageHeader", true);
        },
        onSearchOrder: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
        
            // Get the table and binding
            var oTable = this.byId("idOrdersTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    // Example: filter on Plant, OrderID, CustomerName (add fields as needed)
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("Plant", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("Vbeln", sap.ui.model.FilterOperator.Contains, sQuery),
                           // new sap.ui.model.Filter("SAP Delivery Number", sap.ui.model.FilterOperator.Contains, sQuery),
                           new sap.ui.model.Filter("Carriertype", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("CarrierCode", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("Shipmentid", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("CarrierDesc", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("ShipmentType", sap.ui.model.FilterOperator.Contains, sQuery),
                            // new sap.ui.model.Filter("Totalpkg", sap.ui.model.FilterOperator.Contains, sQuery),
                            //new sap.ui.model.Filter("DateAdded", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("TrackingNumber", sap.ui.model.FilterOperator.Contains, sQuery),
                             new sap.ui.model.Filter("Shipprocess", sap.ui.model.FilterOperator.Contains, sQuery),
                            // new sap.ui.model.Filter("ExpDelDate", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("RecContact", sap.ui.model.FilterOperator.Contains, sQuery),
                             new sap.ui.model.Filter("RecCompany", sap.ui.model.FilterOperator.Contains, sQuery),
                             new sap.ui.model.Filter("RecCity", sap.ui.model.FilterOperator.Contains, sQuery),
                             new sap.ui.model.Filter("RecRegion", sap.ui.model.FilterOperator.Contains, sQuery),
                             new sap.ui.model.Filter("RecPostalcode", sap.ui.model.FilterOperator.Contains, sQuery),
                             new sap.ui.model.Filter("RecCountry", sap.ui.model.FilterOperator.Contains, sQuery),
                            // new sap.ui.model.Filter("RecPhone", sap.ui.model.FilterOperator.Contains, sQuery),
                             new sap.ui.model.Filter("Emailaddress", sap.ui.model.FilterOperator.Contains, sQuery),
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },
        

        onSearchTrack: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
        
            // Get the table and binding
            var oTable = this.byId("idTrackNowTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    // Example: filter on Plant, OrderID, CustomerName (add fields as needed)
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("Plant", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("Vbeln", sap.ui.model.FilterOperator.Contains, sQuery),
                            // new sap.ui.model.Filter("SAP Delivery Number", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("Carriertype", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("CarrierCode", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("Shipmentid", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("CarrierDesc", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("ShipmentType", sap.ui.model.FilterOperator.Contains, sQuery),
                            // new sap.ui.model.Filter("Totalpkg", sap.ui.model.FilterOperator.Contains, sQuery),
                            //new sap.ui.model.Filter("DateAdded", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("TrackingNumber", sap.ui.model.FilterOperator.Contains, sQuery),
                             new sap.ui.model.Filter("Shipprocess", sap.ui.model.FilterOperator.Contains, sQuery),
                            // new sap.ui.model.Filter("ExpDelDate", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("RecContact", sap.ui.model.FilterOperator.Contains, sQuery),
                             new sap.ui.model.Filter("RecCompany", sap.ui.model.FilterOperator.Contains, sQuery),
                             new sap.ui.model.Filter("RecCity", sap.ui.model.FilterOperator.Contains, sQuery),
                             new sap.ui.model.Filter("RecRegion", sap.ui.model.FilterOperator.Contains, sQuery),
                             new sap.ui.model.Filter("RecPostalcode", sap.ui.model.FilterOperator.Contains, sQuery),
                             new sap.ui.model.Filter("RecCountry", sap.ui.model.FilterOperator.Contains, sQuery),
                            // new sap.ui.model.Filter("RecPhone", sap.ui.model.FilterOperator.Contains, sQuery),
                             new sap.ui.model.Filter("Emailaddress", sap.ui.model.FilterOperator.Contains, sQuery),
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },

        onSearchShipReqLabel: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
        
            // Get the table and binding
            var oTable = this.byId("idShipReqsTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("Plant", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("RecCity", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("Vbeln", sap.ui.model.FilterOperator.Contains, sQuery),
                            // new sap.ui.model.Filter("Createddate", sap.ui.model.FilterOperator.Contains, sQuery),
                            // new sap.ui.model.Filter("DateAdded", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("Carriertype", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("CarrierCode", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("CarrierDesc", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("TrackingNumber", sap.ui.model.FilterOperator.Contains, sQuery),
                            // new sap.ui.model.Filter("DeliveryStatus", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("RecContact", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("RecCompany", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("RecAddress1", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("RecRegion", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("RecPostalcode", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("RecCountry", sap.ui.model.FilterOperator.Contains, sQuery),
                            // new sap.ui.model.Filter("RecPhone", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("Emailaddress", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("Shipprocess", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("Packagetype", sap.ui.model.FilterOperator.Contains, sQuery)
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },

        onShipNowPress:function(){
            var GetDeliveryData = eshipjetModel.getProperty("/GetDeliveryData");
            if(GetDeliveryData.Warehouse === ""){
                oController.onShipNowWithOutEWMCall();
            }else{
                oController.onShipNowWithEWMCall();
            }
        },


       onShipNowWithEWMCall: async function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var carrier = eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey");
            var serviceId = eshipjetModel.getProperty("/commonValues/ShipNowShipsrvNameSelectedKey");
            var sDeliveryNo = eshipjetModel.getProperty("/commonValues/sapDeliveryNumber");
            var GetDeliveryData = eshipjetModel.getProperty("/GetDeliveryData");
            var selectedCarrierAccountsData = eshipjetModel.getProperty("/selectedCarrierAccountsData");

             if (!carrier || !serviceId) {
                sap.m.MessageBox.error("Carrier Name & Service Name are mandatory. Please select.");
                return;
            };

            
            var oSelectedCarrierData = eshipjetModel.getProperty("/oSelectedCarrierData");
            if (oSelectedCarrierData.CarrierType === "LTL") {
                const oTable = this.byId("idShipNowPackTable");
                const aRows = oTable.getBinding("rows").getContexts().map(c => c.getObject());
                const hasBalance = aRows.some(row => row.BalanceQty > 0);
                if (hasBalance) {
                    MessageBox.warning("Packing is Mandatory For LTL carrier, Please Pack all products.");
                    return;
                }
            }
            
            // if (oSelectedCarrierData.CarrierType === "Parcel") {
            //     const oTable = this.byId("idShipNowPackTable");
            //     const aRows = oTable.getBinding("rows").getContexts().map(c => c.getObject());

            //     if (aRows.length > 0) {
            //         await oController.packParcelProductsWithEWM();   // <-- Perfect wait
            //     }
            // }
            var ShippingPoint = GetDeliveryData.ShippingPoint;
            var currentDateTime = new Date().toISOString();
            var CreationDate = new Date(GetDeliveryData.CreationDate);
            var ShipToData = eshipjetModel.getProperty("/ShipToData");
            var GetDeliveryData = eshipjetModel.getProperty("/GetDeliveryData");
            var ShipToData = eshipjetModel.getProperty("/ShipToData");
            var formattedCreationDate = CreationDate.getFullYear() + "-" +
                String(CreationDate.getMonth() + 1).padStart(2, '0') + "-" +
                String(CreationDate.getDate()).padStart(2, '0') + "T" +
                String(CreationDate.getHours()).padStart(2, '0') + ":" +
                String(CreationDate.getMinutes()).padStart(2, '0') + ":" +
                String(CreationDate.getSeconds()).padStart(2, '0') + "." +
                String(CreationDate.getMilliseconds()).padStart(3, '0');
            var to_DeliveryDocumentItem = eshipjetModel.getProperty("/to_DeliveryDocumentItem");
            var to_HandlingUnitHeaderDelivery = eshipjetModel.getProperty("/to_HandlingUnitHeaderDelivery/results");
            var packagesArray = [];
            var huNums = "";

            var lengthOfDimensions = eshipjetModel.getProperty("/commonValues/lengthOfDimensions");
            var widthOfDimensions = eshipjetModel.getProperty("/commonValues/widthOfDimensions");
            var heightOfDimensions = eshipjetModel.getProperty("/commonValues/heightOfDimensions");
            var dimension = lengthOfDimensions + "X" + widthOfDimensions + "X" + heightOfDimensions
            
               var huSubItems = to_HandlingUnitHeaderDelivery;
                for(var j=0; j<huSubItems.length; j++){
                    var ItemsInfo = [];
                    var item = {
                       "Product":huSubItems[j].Material,
						 "ItemNo": huSubItems[j].HandlingUnitInternalID,
                         "ItCa": huSubItems[j].Material,
                        "P": "C",
                        "W": "C",
                        "ProductCode": huSubItems[j].HandlingUnitExternalId,
                        "ProductNo": huSubItems[j].HandlingUnitExternalId,
                        "Description": huSubItems[j].MaterialName,
                        "epc": "",
                        "dimension": dimension,
                        "totalQuantity": huSubItems[j].HandlingUnitQuantity,
                        "balanceQuantity": huSubItems[j].HandlingUnitQuantity,
                        "partialQuantity": huSubItems[j].HandlingUnitTypeOfContent,
                        "s": false,
                        "isDG": false,
                        "unitWeight": to_HandlingUnitHeaderDelivery[j].GrossWeight,
                        "unitCost": "",
                        "HTSCode": "",
                        "CountryofMFR": "US",
                        "UOM": huSubItems[j].UnitOfMeasureDimension,
                        "Meins": "CV",
                        "Currency": "USD",
                        "LicenseNo": "",
                        "ECCN": "null",
                        "erpPackageId": "",
                        "opT1": "",
                        "opT2": "",
                        "materialNumber": "10110",
                        "materialNumber": huSubItems[j].HandlingUnitExternalId,
                        "IsSerial": false,
                        "hasError": false,
                        "IsSelectedFromPopup": true,
                        "Quantity": huSubItems[j].HandlingUnitQuantity,
                        "Partial": huSubItems[j].HandlingUnitQuantity,
                        "Balance": huSubItems[j].HandlingUnitQuantity,
                        "Vbeln": GetDeliveryData.DeliveryDocument,
                        "serialCount": "3",
                        "serialDiffCount": "3",
                        "SerialNumbers": []
                    }
                    ItemsInfo.push(item);
                }

                for(var i=0; i<to_HandlingUnitHeaderDelivery.length; i++){
                    huNums = huNums + "," + to_HandlingUnitHeaderDelivery[i].HandlingUnitExternalId;
                    eshipjetModel.setProperty("/invoiceNo", huNums);

                    var packageObj =  {
                        "ItemsInfo": ItemsInfo,
                        "SpecialServices": {},
                        "Weightunits": "LB",
                        "DimensionUnits": "IN",
                        "Sno": i+1,
                        "HU": to_HandlingUnitHeaderDelivery[i].HandlingUnitExternalId,
                        "Weight": to_HandlingUnitHeaderDelivery[i].GrossWeight,
                        "packageMaterial": "PALLET",
                        "CreatedBy": "KUMAR",
                        "CreatedDate": formattedCreationDate,
                        "Dimension": dimension,
                        "PackageSpecialServiceTyeps": [],
                        "PackageLevelSpecialServices": {
                            "Signature_optionType": "1"
                        }
                    }
                    packagesArray.push(packageObj);
                };

            oController.onOpenBusyDialog();
            sap.m.MessageToast.show("Ship Now triggered!");
            var currentDate = new Date();
            var shipDate = currentDate.toISOString();
            var  ShipmentLevelSpecialServices;
            eshipjetModel.setProperty("/commonValues/shipNowGetBtn", true);
            var sapDeliveryNumber = eshipjetModel.getProperty("/commonValues/sapDeliveryNumber");
            var carrier = eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey");
            var serviceId = eshipjetModel.getProperty("/commonValues/ShipNowShipsrvNameSelectedKey");
            var carrierServicesDropDownData = eshipjetModel.getProperty("/carrierServicesDropDownData");
            for(var i=0; i<carrierServicesDropDownData.length; i++){
                if(carrierServicesDropDownData[i].ErpServId === serviceId){
                    eshipjetModel.setProperty("/selectedServiceNamesData", carrierServicesDropDownData[i]);
                }
            }
            var selectedServiceNamesData = eshipjetModel.getProperty("/selectedServiceNamesData");
            var ServiceIdUG = selectedServiceNamesData.ErpServId;
            var ServiceCode = selectedServiceNamesData.ServCode;
            var id = selectedCarrierAccountsData.UserId || "";
            var password = selectedCarrierAccountsData.Password || "";
            var accountNumber = selectedCarrierAccountsData.AcntNmbr || "";
            var serviceName = selectedServiceNamesData.ServDesc || "";
            var AccessKey = selectedCarrierAccountsData.AccessKey || "";
            var CarrierType = selectedCarrierAccountsData.CarrierType || "";
            var ConnectionType = selectedCarrierAccountsData.ConnectionType || "";
            var HubId = selectedCarrierAccountsData.HubId || "";
            var LabelType = selectedCarrierAccountsData.LabelType || "";
            var PodUrl = selectedCarrierAccountsData.PodUrl || "";
            var RateQuote = selectedCarrierAccountsData.RateQuote || "";
            var RateUrl = selectedCarrierAccountsData.RateUrl || "";
            var ShipUrl = selectedCarrierAccountsData.ShipUrl || "";
            var TokenUrl = selectedCarrierAccountsData.TokenUrl || "";
            var TrackUrl = selectedCarrierAccountsData.TrackUrl || "";
            var VoidUrl = selectedCarrierAccountsData.VoidUrl || "";
            if(serviceId === "Z7"){
                serviceId = "ZA";
            };
            if(serviceName === "11" || serviceName === "07" || serviceName === "08" || serviceName === "54" || serviceName === "65" || serviceName === "93" || serviceId === "UJ" || serviceId === "UM" || serviceId === "UH" || serviceId === "UK" || serviceId === "UQ"){
                serviceName = "03";
                serviceId = "03";
            };

            if(carrier.toUpperCase() === "FEDEX"){
                ShipmentLevelSpecialServices = {
                    "EmailNotification": {
                        "CONTACT": "Plant 1710 as Business Partner",
                        "RecipientTypes": "RECIPIENT",
                        "EMAIL": "info@eshipjet.ai",
                        "EventTypes": [
                            "ON_DELIVERY",
                            "ON_EXCEPTION",
                            "ON_SHIPMENT",
                            "ON_TENDER"
                        ]
                    }
                }
            }else{
                ShipmentLevelSpecialServices = {
                    "SaturdayDelivery": false,
                    "HomeDelivery": false
                }
            }
            var Notes = eshipjetModel.getProperty("/Notes")
            Notes.push({
                "date": new Date(),
                "name": eshipjetModel.getProperty("/userName"),
                "notes": "Shipped Successfully"
            });
            var obj = {
                    "HeaderInfo": {
                        "FeederSystem": "SAP Cloud 6.0",
                        "DocumentNumber": GetDeliveryData.DeliveryDocument,
                        "DocumentType": GetDeliveryData.DeliveryDocumentType,
                        "ShipDate": currentDateTime,
                        "CreatedDate": formattedCreationDate,
                        "ShipmentType": GetDeliveryData.ShippingType,
                        "Location": ShippingPoint,
                        "ERP": "SAP ERP 6.0 EHP7",
                        "TotalWeight": "020",
                        "InsuranceAmount": "",
                        "InsuranceCurrency": "",
                        "Currency": "",
                        "Incoterm": GetDeliveryData.IncotermsClassification,
                        "Notes": "",
                        "Description": "",
                        "IsDutiable": false,
                        "SONumber": "",
                        "PONumber": "",
                        "InvoiceNo": "",
                        "PGISTATUS": "No",
                        "PICKSTATUS": "Yes",
                        "FCMToken": "",
                        "Status": "Open",
                        "ShipType": serviceId,
                        "shipType": serviceId,
                        "shipmentIDFlag": false,
                        "licencePlate": "",
                        "CreatedUser": GetDeliveryData.CreatedByUser,
                        "BilledUser": GetDeliveryData.CreatedByUser,
                        "UserID": GetDeliveryData.CreatedByUser?.toUpperCase() || "USER",
                        "SAPUserID": GetDeliveryData.CreatedByUser?.toUpperCase() || "USER",
                        "PackageCount": eshipjetModel.getProperty("/HandlingUnitsLength") || 0
                    },
                    "CompanyId": "CP000000001",
                    "ShipTo": {
                        "COMPANY": "Plant 1710 as Business Partner",
                        "CONTACT": "Plant 1710 as Business Partner",
                        "ADDRESS_LINE1": "Deer Creek",
                        "ADDRESS_LINE2": "3475",
                        "ADDRESS_LINE3": null,
                        "CITY": "Palo Alto",
                        "STATE": "CA",
                        "ZIPCODE": "94304-1355",
                        "COUNTRY": "US",
                        "PHONE": "999 777 3475",
                        "EMAIL": "info@eshipjet.ai",
                        "AddressType": "Commercial",
                        "TAXID": null,
                        "VAT": null,
                        "EORI": null,
                        "LocationType": null
                    },
                    "SoldTo": {
                        "COMPANY": "Plant 1710 as Business Partner",
                        "CONTACT": "Plant 1710 as Business Partner",
                        "ADDRESS_LINE1": "Deer Creek",
                        "ADDRESS_LINE2": "3475",
                        "ADDRESS_LINE3": null,
                        "CITY": "Palo Alto",
                        "STATE": "CA",
                        "ZIPCODE": "94304-1355",
                        "COUNTRY": "US",
                        "PHONE": "999 777 3475",
                        "EMAIL": "Megan.Ashby@McKesson.com",
                        "AddressType": "Commercial",
                        "TAXID": "",
                        "VAT": "",
                        "EORI": "",
                        "LocationType": ""
                    },
                    "id": 5445,
                    "shiprequest_id": 5348,
                    "ShipmentLevelSpecialServices": ShipmentLevelSpecialServices,
                    "InternationalDetails": {},
                    "Packages": packagesArray,
                    "Notes": Notes,
                    "CarrierDetails": {
                        "Carrier": carrier,
                        "CarrierType": "Parcel",
                        "ServiceName": ServiceCode,
                        "carrierServicez3": carrier.toUpperCase() + " Parc",
                        "ServiceNameMapping": carrier.toUpperCase() + " Parcel",
                        "PaymentType": "SENDER",
                        "ShippingAccount": accountNumber,
                        "BillingAccount": "89W74E",
                        "BillingCountry": "US",
                        "BillingZipCode": "94304-1355",
                        "StageLocation": "1001",
                        "PurchaseOrder": " 04",
                        "SalesOrder": "1066",
                        "ServiceID": ServiceIdUG,
                        "Reference1": GetDeliveryData.DeliveryDocument,
                        "Custgrp2": "G01 3P-1 w Routing Guide",
                        "Reference2": "",
                        "Reference3": "",
                        "Reference4": "",
                        "Note": "",
                        "UserId": id,
                        "Password": password,
                        "AccessKey": AccessKey,
                        "ConnectionType": ConnectionType,
                        "CostCenterName": "Cost Center 2",
                        "ShipURL": ShipUrl,
                        "TrackURL": "",
                        "TokenURL": "",
                        "RateURL": "",
                        "VoidURL": "",
                        "ShipfromCountry": "",
                        "ShipToCountry": "",
                        "ERPServiceID": ServiceIdUG,
                        "MeterId": "",
                        "Freight": "",
                        "HazMat": [],
                        "LabelType": "ZPL",
                    },
                    
                    
                    
                    "ShipFrom": {
                        "COMPANY": "Eshipjet Software Inc.",
                        "CONTACT": "Steve Marsh",
                        "ADDRESS_LINE1": "5717 Legacy",
                        "ADDRESS_LINE2": "Suite 250",
                        "ADDRESS_LINE3": "",
                        "CITY": "Plano",
                        "STATE": "TX",
                        "ZIPCODE": "75024",
                        "COUNTRY": "US",
                        "PHONE": "(888) 464-2360",
                        "EMAIL": "info@eshipjet.ai",
                        "AddressType": "",
                        "TAXID": "",
                        "VAT": "",
                        "EORI": "",
                        "LocationType": "",
                        "HSNShipment": false
                    },
                    "Shipper": {
                        "COMPANY": "Eshipjet Software Inc.",
                        "CONTACT": "Steve Marsh",
                        "ADDRESS_LINE1": "5717 Legacy",
                        "ADDRESS_LINE2": "Suite 250",
                        "ADDRESS_LINE3": "",
                        "CITY": "Plano",
                        "STATE": "TX",
                        "ZIPCODE": "75024",
                        "COUNTRY": "US",
                        "PHONE": "(888) 464-2360",
                        "EMAIL": "info@eshipjet.ai",
                        "AddressType": "Commercial",
                        "TAXID": "",
                        "VAT": "",
                        "EORI": "",
                        "LocationType": "",
                        "HSNShipment": false
                    }
                };

            var productTable = eshipjetModel.getProperty("/to_DeliveryDocumentItem");
            if (productTable && productTable.length > 0) {
                $.each(productTable, function (index, itm) {
                    if (itm.BalanceQty > 0) {
                        for (var i = 0; i < itm.BalanceQty; i++) {
                            var packObj = {
                                "ItemsInfo": [],
                                "SpecialServices": {},
                                "Weightunits": "LB",
                                "DimensionUnits": "IN",
                                "Sno": i+1,
                                "HU": "",
                                "Weight": "",
                                "Dimension": dimension,
                                "PackageSpecialServiceTyeps": [],
                                "PackageLevelSpecialServices": {
                                    "Signature_optionType": "1"
                                }
                            };
                            packObj.HU = itm.DeliveryDocument;
                            packObj.Weight = itm.ItemNetWeight;
                            packagesArray.push(jQuery.extend(true, {}, packObj));
                            packObj = {};
                        }
                    }
                });
                obj["Packages"] = packagesArray;
            }

            var sPath;
            if (carrier === "ABFS") {
                sPath = "https://carrier-api-v1.eshipjet.site/ABF";
            }else if (carrier === "SAIA") {
                sPath = "https://carrier-api-v1.eshipjet.site/generic";
            } else {
                sPath = "https://carrier-api-v1.eshipjet.site/" + carrier;
            }

                      // var sPath = "https://eshipjet-stg-scpn-byargfehdgdtf8f3.francecentral-01.azurewebsites.net/FedEx";
                    let myPromise =  new Promise((resolve, reject) => {
                        $.ajax({
                            url: sPath,
                            method: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(obj),
                            success: function (response) {
                                resolve(response);
                                if(response && response.status === "Success"){
                                    eshipjetModel.setProperty("/ShipNowPostResponse", response);
                                    if(response.Packages.length > 0){
                                        var trackingArray = [];

                                        var ShipNowShipsrvNameSelectedKey = eshipjetModel.getProperty("/commonValues/ShipNowShipsrvNameSelectedKey");
                                        var serviceNameDropdown = eshipjetModel.getProperty("/serviceNameDropdown");
                                        for(var i=0; i<serviceNameDropdown.length; i++){
                                            if(serviceNameDropdown[i].serviceCode === ShipNowShipsrvNameSelectedKey){
                                                var serviceName = serviceNameDropdown[i].serviceName;
                                            }
                                        }
                                // Below code is for Tracking   
                                        for(var i=0; i<response.Packages.length; i++){
                                            var trackingObj = {
                                                "COMPANY": response.Shipper.COMPANY,
                                                "ConsolidationId": response.HeaderInfo.ConsolidationId,
                                                "DocumentNumber": response.HeaderInfo.DocumentNumber,
                                                "CreatedDate": response.HeaderInfo.CreatedDate,
                                                "ShipDate": response.HeaderInfo.ShipDate,
                                                "ShipmentType": response.HeaderInfo.ShipmentType,
                                                "CarrierCode": response.CarrierDetails.Carrier,
                                                "ERPCarrierID": serviceName,
                                                "ServiceName" : eshipjetModel.getProperty("/carrierServiceName_dis"),
                                                "TrackingNumber": response.Packages[i].TrackingNumber,
                                                "TrackingStatus": response.TrackingStatus,
                                                "SHIP_TO_CONTACT": response.ShipTo.CONTACT,
                                                "SHIP_TO_COMPANY": response.ShipTo.COMPANY,
                                                "SHIP_TO_ADDRESS_LINE1": response.ShipTo.ADDRESS_LINE1,
                                                "SHIP_TO_STATE": response.ShipTo.STATE,
                                                "SHIP_TO_CITY": response.ShipTo.CITY,
                                                "SHIP_TO_ZIPCODE": response.ShipTo.ZIPCODE,
                                                "SHIP_TO_COUNTRY": response.ShipTo.COUNTRY,
                                                "SHIP_TO_EMAIL": response.ShipTo.UpdatedUser,
                                                "RequesterName": response.ShipFrom.EMAIL,
                                                "ConnectedTo": "SAP ECC 6.0",
                                                "orderType": "Delivery Number"
                                            };
                                            trackingArray.push(trackingObj);
                                            eshipjetModel.setProperty("/trackingArray", trackingArray);
                                            if(trackingArray.length > 0){
                                                eshipjetModel.setProperty("/trackingLength", true);
                                            }
                                        }
                                    }
                                    if(response && response.shippingDocuments && response.shippingDocuments.length > 0 ){
                                        var shippingDocuments = response.shippingDocuments;
                                        var ashippingDocuments = [];
                                        for(var i=0; i<shippingDocuments.length; i++){
                                            if(shippingDocuments[i].docName !== ""){
                                                ashippingDocuments.push(
                                                    {
                                                        "srNo": i+1,
                                                        "contentType": shippingDocuments[i].contentType,
                                                        "copiesToPrint": shippingDocuments[i].copiesToPrint,
                                                        "docName": shippingDocuments[i].docName,
                                                        "docProvider": shippingDocuments[i].docProvider,
                                                        "docType": shippingDocuments[i].docType,
                                                        "encodedLabel": shippingDocuments[i].encodedLabel,
                                                })
                                            }
                                        }
                                        eshipjetModel.setProperty("/shippingDocuments", ashippingDocuments);
                                        if(ashippingDocuments.length > 0){
                                            eshipjetModel.setProperty("/documentsLength", true);
                                        }
                                    }
                                    if(response && response.shippingCharges && response.shippingCharges.length > 0 ){
                                        var shippingCharges = response.shippingCharges;
                                        var oShippingCharges = [];
                                        for(var i=0; i<shippingCharges.length; i++){
                                            if(shippingCharges[i].description === "Discount Freight"){
                                                var discount = shippingCharges[i].amount * 0.20;
                                                var discountFreightAmount = shippingCharges[i].amount - discount;
                                                var obj = {
                                                    "serialNo": i + 1,
                                                    "description": shippingCharges[i].description,
                                                    "amount": discountFreightAmount,
                                                    "currency": shippingCharges[i].currency
                                                };
                                            }else{
                                                var obj = {
                                                    "serialNo": i + 1,
                                                    "description": shippingCharges[i].description,
                                                    "amount": shippingCharges[i].amount,
                                                    "currency": shippingCharges[i].currency
                                                };
                                            }
                                            oShippingCharges.push(obj);
                                        }
                                        eshipjetModel.setProperty("/shippingCharges", oShippingCharges);
                                        if(oShippingCharges.length > 0){
                                            eshipjetModel.setProperty("/shippingChargesLength", true);
                                        }
                                    }

                                    oController.ApiOutboundDeliverySrvData(response);
                                    oController.onPostGoodsIssuePress(sDeliveryNo);      

                                }else if(response && response.status === "Error"){
                                    var sError = "Shipment process failed reasons:\n";
                                    if(response && response.Errors && response.Errors.length > 0){
                                        response.Errors.forEach(function(item){
                                            sError = sError + item+"\n";
                                        });                               
                                    }
                                    sap.m.MessageBox.error(sError);
                                    oController.onCloseBusyDialog();
                                }
                            },
                            error: function (error) {
                                // MessageBox.warning(error.responseText);
                                MessageBox.warning(error.statusText);
                                console.log("Error:", error);
                                oController.onCloseBusyDialog();
                                reject(error);
                            }
                        });                 
            },
            function(error) {
                   
            });          

        },
       
        onShipNowWithOutEWMCall: async function () {       
            var GetDeliveryDataModel = oController.getOwnerComponent().getModel("GetDeliveryDataModel");
            var oMainModel = oController.getOwnerComponent().getModel("CARRIERS_SRV");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var carrier = eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey");
            var serviceId = eshipjetModel.getProperty("/commonValues/ShipNowShipsrvNameSelectedKey");
            var ShipFromData = eshipjetModel.getProperty("/ShipFromData");
            var sDeliveryNo = eshipjetModel.getProperty("/commonValues/sapDeliveryNumber");
            var ShipToData = eshipjetModel.getProperty("/ShipToData");
            var GetDeliveryData = eshipjetModel.getProperty("/GetDeliveryData");
            var selectedCarrierAccountsData = eshipjetModel.getProperty("/selectedCarrierAccountsData");

             if (!carrier || !serviceId) {
                sap.m.MessageBox.error("Carrier Name & Service Name are mandatory. Please select.");
                return;
            };

           
            
            var oSelectedCarrierData = eshipjetModel.getProperty("/oSelectedCarrierData");
            if (oSelectedCarrierData.CarrierType === "LTL") {
                const oTable = this.byId("idShipNowPackTable");
                const aRows = oTable.getBinding("rows").getContexts().map(c => c.getObject());
                const hasBalance = aRows.some(row => row.BalanceQty > 0);
                if (hasBalance) {
                    MessageBox.warning("Packing is Mandatory For LTL carrier, Please Pack all products.");
                    return;
                }
            }
            
            if (oSelectedCarrierData.CarrierType === "Parcel") {
                const oTable = this.byId("idShipNowPackTable");
                const aRows = oTable.getBinding("rows").getContexts().map(c => c.getObject());

                if (aRows.length > 0) {
                    await oController.packParcelProducts();   // <-- Perfect wait
                }
            }
            var ShippingPoint = GetDeliveryData.ShippingPoint;
            var currentDateTime = new Date().toISOString();
            var CreationDate = new Date(GetDeliveryData.CreationDate);
            var ShipToData = eshipjetModel.getProperty("/ShipToData");
            var GetDeliveryData = eshipjetModel.getProperty("/GetDeliveryData");
            var ShipToData = eshipjetModel.getProperty("/ShipToData");
            var formattedCreationDate = CreationDate.getFullYear() + "-" +
                String(CreationDate.getMonth() + 1).padStart(2, '0') + "-" +
                String(CreationDate.getDate()).padStart(2, '0') + "T" +
                String(CreationDate.getHours()).padStart(2, '0') + ":" +
                String(CreationDate.getMinutes()).padStart(2, '0') + ":" +
                String(CreationDate.getSeconds()).padStart(2, '0') + "." +
                String(CreationDate.getMilliseconds()).padStart(3, '0');
            var to_DeliveryDocumentItem = eshipjetModel.getProperty("/to_DeliveryDocumentItem");
            var to_HandlingUnitHeaderDelivery = eshipjetModel.getProperty("/to_HandlingUnitHeaderDelivery/results");
            var packagesArray = [];
            var huNums = "";

            var lengthOfDimensions = eshipjetModel.getProperty("/commonValues/lengthOfDimensions");
            var widthOfDimensions = eshipjetModel.getProperty("/commonValues/widthOfDimensions");
            var heightOfDimensions = eshipjetModel.getProperty("/commonValues/heightOfDimensions");
            var dimension = lengthOfDimensions + "X" + widthOfDimensions + "X" + heightOfDimensions


            for(var i=0; i<to_HandlingUnitHeaderDelivery.length; i++){
                var huSubItems = to_HandlingUnitHeaderDelivery[i].to_HandlingUnitItemDelivery.results;
                var ItemsInfo = [];
                
                huNums = huNums + "," + to_HandlingUnitHeaderDelivery[i].HandlingUnitExternalId;
                eshipjetModel.setProperty("/invoiceNo", huNums);
               
                for(var j=0; j<huSubItems.length; j++){
                    var item = {
                       "Product":huSubItems[j].HandlingUnitInternalId,
						 "ItemNo": huSubItems[j].HandlingUnitInternalId,
                         "ItCa": huSubItems[j].Material,
                        "P": "C",
                        "W": "C",
                        "ProductCode": huSubItems[j].HandlingUnitExternalId,
                        "ProductNo": huSubItems[j].HandlingUnitExternalId,
                        "Description": huSubItems[j].MaterialName,
                        "epc": "",
                        
                        "dimension": dimension,
                        "totalQuantity": huSubItems[j].HandlingUnitQuantity,
                        "balanceQuantity": huSubItems[j].HandlingUnitQuantity,
                        "partialQuantity": huSubItems[j].HandlingUnitTypeOfContent,
                         "s": false,
                        "isDG": false,
                        "unitWeight": to_HandlingUnitHeaderDelivery[i].GrossWeight,
                        "unitCost": "",
                        "HTSCode": "",
                        "CountryofMFR": "US",
                        "UOM": huSubItems[j].UnitOfMeasureDimension,
                        "Meins": "CV",
                        "Currency": "USD",
                        "LicenseNo": "",
                        "ECCN": "null",
                        "erpPackageId": "",
                        "opT1": "",
                        "opT2": "",
                        "materialNumber": "10110",
                        "materialNumber": huSubItems[j].HandlingUnitExternalId,
                        "IsSerial": false,
                        "hasError": false,
                        "IsSelectedFromPopup": true,
                        "Quantity": huSubItems[j].HandlingUnitQuantity,
                        "Partial": huSubItems[j].HandlingUnitQuantity,
                        "Balance": huSubItems[j].HandlingUnitQuantity,
                        "Vbeln": GetDeliveryData.DeliveryDocument,
                        "serialCount": "3",
                        "serialDiffCount": "3",
                        "SerialNumbers": []
                        
                    }
                    ItemsInfo.push(item);
                };

                var packageObj =  {
                    "ItemsInfo": ItemsInfo,
                    "SpecialServices": {},
                    "Weightunits": "LB",
                    "DimensionUnits": "IN",
                    "Sno": i+1,
                    "HU": to_HandlingUnitHeaderDelivery[i].HandlingUnitExternalID,
                    "Weight": to_HandlingUnitHeaderDelivery[i].NetWeight,
                    "packageMaterial": "Your Package",
                    "CreatedBy": "KUMAR",
                    "CreatedDate": formattedCreationDate,
                    "Dimension": dimension,
                    "PackageSpecialServiceTyeps": [],
                    "PackageLevelSpecialServices": {
                        "Signature_optionType": "1"
                    }
                }
                packagesArray.push(packageObj);
            };
            oController.onOpenBusyDialog();
            sap.m.MessageToast.show("Ship Now triggered!");
            var currentDate = new Date();
            var shipDate = currentDate.toISOString();
            var  ShipmentLevelSpecialServices;
            eshipjetModel.setProperty("/commonValues/shipNowGetBtn", true);
            var sapDeliveryNumber = eshipjetModel.getProperty("/commonValues/sapDeliveryNumber");
            var carrier = eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey");
            var serviceId = eshipjetModel.getProperty("/commonValues/ShipNowShipsrvNameSelectedKey");
            var carrierServicesDropDownData = eshipjetModel.getProperty("/carrierServicesDropDownData");
            for(var i=0; i<carrierServicesDropDownData.length; i++){
                if(carrierServicesDropDownData[i].ErpServId === serviceId){
                    eshipjetModel.setProperty("/selectedServiceNamesData", carrierServicesDropDownData[i]);
                }
            }
            var selectedServiceNamesData = eshipjetModel.getProperty("/selectedServiceNamesData");
            var ServiceIdUG = selectedServiceNamesData.ErpServId;
            var ServiceCode = selectedServiceNamesData.ServCode;
            var id = selectedCarrierAccountsData.UserId || "";
            var password = selectedCarrierAccountsData.Password || "";
            var accountNumber = selectedCarrierAccountsData.AcntNmbr || "";
            var serviceName = selectedServiceNamesData.ServDesc || "";
            var AccessKey = selectedCarrierAccountsData.AccessKey || "";
            var CarrierType = selectedCarrierAccountsData.CarrierType || "";
            var ConnectionType = selectedCarrierAccountsData.ConnectionType || "";
            var HubId = selectedCarrierAccountsData.HubId || "";
            var LabelType = selectedCarrierAccountsData.LabelType || "";
            var PodUrl = selectedCarrierAccountsData.PodUrl || "";
            var RateQuote = selectedCarrierAccountsData.RateQuote || "";
            var RateUrl = selectedCarrierAccountsData.RateUrl || "";
            var ShipUrl = selectedCarrierAccountsData.ShipUrl || "";
            var TokenUrl = selectedCarrierAccountsData.TokenUrl || "";
            var TrackUrl = selectedCarrierAccountsData.TrackUrl || "";
            var VoidUrl = selectedCarrierAccountsData.VoidUrl || "";
            if(serviceId === "Z7"){
                serviceId = "ZA";
            };
            if(serviceName === "11" || serviceName === "07" || serviceName === "08" || serviceName === "54" || serviceName === "65" || serviceName === "93" || serviceId === "UJ" || serviceId === "UM" || serviceId === "UH" || serviceId === "UK" || serviceId === "UQ"){
                serviceName = "03";
                serviceId = "03";
            };

            if(carrier.toUpperCase() === "FEDEX"){
                ShipmentLevelSpecialServices = {
                    "EmailNotification": {
                        "CONTACT": "Plant 1710 as Business Partner",
                        "RecipientTypes": "RECIPIENT",
                        "EMAIL": "info@eshipjet.ai",
                        "EventTypes": [
                            "ON_DELIVERY",
                            "ON_EXCEPTION",
                            "ON_SHIPMENT",
                            "ON_TENDER"
                        ]
                    }
                }
            }else{
                ShipmentLevelSpecialServices = {
                    "SaturdayDelivery": false,
                    "HomeDelivery": false
                }
            }


            // var AccessKey = "";
            // var billingAccNumber = "";
            // if(carrier && carrier.toUpperCase() === "UPS"){
            //     id = "6ljUpEbuu1OlOk7ow932lsxXHISUET0WKjTn59GzQ5MRdEbA";  
            //     password = "ioZmsfcbrzlWfGh7wGMhqHL6sY4EAaKzZObullipni0cEGJGChjFmGpkcdCWQynK";
            //     accountNumber = "B24W72";
            //     billingAccNumber = "89W74E";
            //     serviceName = "03"
            //     Signature_optionType = eshipjetModel.getProperty("/UpsSignatureSelectedKey");
            // }else if(carrier && carrier.toUpperCase() === "FEDEX"){
            //      id = "l70c717f3eaf284dc9af42169e93874b6e";
            //      password = "7f271bf486084e8f8073945bb7e6a020";
            //      accountNumber = "740561073";
            //      billingAccNumber = "740561073";
            //      serviceName = "FEDEX_GROUND"
            //      Signature_optionType = eshipjetModel.getProperty("/fedExSignature_optionType");
            // }else if(carrier && carrier.toUpperCase() === "DHL"){
            //      id = "apT2vB7mV1qR1b";
            //      password = "U#3mO^1vY!5mT@0j";
            // }else if(carrier && carrier.toUpperCase() === "USPS"){
            //     id = "3087617";
            //     password = "October2024!";
            // }else if(carrier && carrier.toUpperCase() === "ABFS" || carrier && carrier.toUpperCase() === "SAIA" ){
            //     id = "ABFESHIPJET";
            //     password = "Legacy!@3";
            //     AccessKey= "JVG9SX85";
            // }
            var Notes = eshipjetModel.getProperty("/Notes")
            Notes.push({
                "date": new Date(),
                "name": eshipjetModel.getProperty("/userName"),
                "notes": "Shipped Successfully"
            });
            var obj = {
                    "HeaderInfo": {
                        "FeederSystem": "SAP Cloud 6.0",
                        "DocumentNumber": GetDeliveryData.DeliveryDocument,
                        "DocumentType": GetDeliveryData.DeliveryDocumentType,
                        "ShipDate": currentDateTime,
                        "CreatedDate": formattedCreationDate,
                        "ShipmentType": GetDeliveryData.ShippingType,
                        "Location": ShippingPoint,
                        "ERP": "SAP ERP 6.0 EHP7",
                        "TotalWeight": "020",
                        "InsuranceAmount": "",
                        "InsuranceCurrency": "",
                        "Currency": "",
                        "Incoterm": GetDeliveryData.IncotermsClassification,
                        "Notes": "",
                        "Description": "",
                        "IsDutiable": false,
                        "SONumber": "",
                        "PONumber": "",
                        "InvoiceNo": "",
                        "PGISTATUS": "No",
                        "PICKSTATUS": "Yes",
                        "FCMToken": "",
                        "Status": "Open",
                        "ShipType": serviceId,
                        "shipType": serviceId,
                        "shipmentIDFlag": false,
                        "licencePlate": "",
                        "CreatedUser": GetDeliveryData.CreatedByUser,
                        "BilledUser": GetDeliveryData.CreatedByUser,
                        "UserID": GetDeliveryData.CreatedByUser?.toUpperCase() || "USER",
                        "SAPUserID": GetDeliveryData.CreatedByUser?.toUpperCase() || "USER",
                        "PackageCount": eshipjetModel.getProperty("/HandlingUnitsLength") || 0
                    },
                    "CompanyId": "CP000000001",
                    "ShipTo": {
                        "COMPANY": "Plant 1710 as Business Partner",
                        "CONTACT": "Plant 1710 as Business Partner",
                        "ADDRESS_LINE1": "Deer Creek",
                        "ADDRESS_LINE2": "3475",
                        "ADDRESS_LINE3": null,
                        "CITY": "Palo Alto",
                        "STATE": "CA",
                        "ZIPCODE": "94304-1355",
                        "COUNTRY": "US",
                        "PHONE": "999 777 3475",
                        "EMAIL": "info@eshipjet.ai",
                        "AddressType": "Commercial",
                        "TAXID": null,
                        "VAT": null,
                        "EORI": null,
                        "LocationType": null
                    },
                    "SoldTo": {
                        "COMPANY": "Plant 1710 as Business Partner",
                        "CONTACT": "Plant 1710 as Business Partner",
                        "ADDRESS_LINE1": "Deer Creek",
                        "ADDRESS_LINE2": "3475",
                        "ADDRESS_LINE3": null,
                        "CITY": "Palo Alto",
                        "STATE": "CA",
                        "ZIPCODE": "94304-1355",
                        "COUNTRY": "US",
                        "PHONE": "999 777 3475",
                        "EMAIL": "Megan.Ashby@McKesson.com",
                        "AddressType": "Commercial",
                        "TAXID": "",
                        "VAT": "",
                        "EORI": "",
                        "LocationType": ""
                    },
                    "id": 5445,
                    "shiprequest_id": 5348,
                    "ShipmentLevelSpecialServices": ShipmentLevelSpecialServices,
                    "InternationalDetails": {},
                    "Packages": packagesArray,
                    "Notes": Notes,
                    "CarrierDetails": {
                        "Carrier": carrier,
                        "CarrierType": "Parcel",
                        "ServiceName": ServiceCode,
                        "carrierServicez3": carrier.toUpperCase() + " Parc",
                        "ServiceNameMapping": carrier.toUpperCase() + " Parcel",
                        "PaymentType": "SENDER",
                        "ShippingAccount": accountNumber,
                        "BillingAccount": "89W74E",
                        "BillingCountry": "US",
                        "BillingZipCode": "94304-1355",
                        "StageLocation": "1001",
                        "PurchaseOrder": " 04",
                        "SalesOrder": "1066",
                        "ServiceID": ServiceIdUG,
                        "Reference1": GetDeliveryData.DeliveryDocument,
                        "Custgrp2": "G01 3P-1 w Routing Guide",
                        "Reference2": "",
                        "Reference3": "",
                        "Reference4": "",
                        "Note": "",
                        "UserId": id,
                        "Password": password,
                        "AccessKey": AccessKey,
                        "ConnectionType": ConnectionType,
                        "CostCenterName": "Cost Center 2",
                        "ShipURL": ShipUrl,
                        "TrackURL": "",
                        "TokenURL": "",
                        "RateURL": "",
                        "VoidURL": "",
                        "ShipfromCountry": "",
                        "ShipToCountry": "",
                        "ERPServiceID": ServiceIdUG,
                        "MeterId": "",
                        "Freight": "",
                        "HazMat": [],
                        "LabelType": "ZPL",
                    },
                    
                    
                    
                    "ShipFrom": {
                        "COMPANY": "Eshipjet Software Inc.",
                        "CONTACT": "Steve Marsh",
                        "ADDRESS_LINE1": "5717 Legacy",
                        "ADDRESS_LINE2": "Suite 250",
                        "ADDRESS_LINE3": "",
                        "CITY": "Plano",
                        "STATE": "TX",
                        "ZIPCODE": "75024",
                        "COUNTRY": "US",
                        "PHONE": "(888) 464-2360",
                        "EMAIL": "info@eshipjet.ai",
                        "AddressType": "",
                        "TAXID": "",
                        "VAT": "",
                        "EORI": "",
                        "LocationType": "",
                        "HSNShipment": false
                    },
                    "Shipper": {
                        "COMPANY": "Eshipjet Software Inc.",
                        "CONTACT": "Steve Marsh",
                        "ADDRESS_LINE1": "5717 Legacy",
                        "ADDRESS_LINE2": "Suite 250",
                        "ADDRESS_LINE3": "",
                        "CITY": "Plano",
                        "STATE": "TX",
                        "ZIPCODE": "75024",
                        "COUNTRY": "US",
                        "PHONE": "(888) 464-2360",
                        "EMAIL": "info@eshipjet.ai",
                        "AddressType": "Commercial",
                        "TAXID": "",
                        "VAT": "",
                        "EORI": "",
                        "LocationType": "",
                        "HSNShipment": false
                    }
                };

            var productTable = eshipjetModel.getProperty("/to_DeliveryDocumentItem");
            if (productTable && productTable.length > 0) {
                $.each(productTable, function (index, itm) {
                    if (itm.BalanceQty > 0) {
                        for (var i = 0; i < itm.BalanceQty; i++) {
                            var packObj = {
                                "ItemsInfo": [],
                                "SpecialServices": {},
                                "Weightunits": "LB",
                                "DimensionUnits": "IN",
                                "Sno": i+1,
                                "HU": "",
                                "Weight": "",
                                "Dimension": dimension,
                                "PackageSpecialServiceTyeps": [],
                                "PackageLevelSpecialServices": {
                                    "Signature_optionType": "1"
                                }
                            };
                            packObj.HU = itm.DeliveryDocument;
                            packObj.Weight = itm.ItemNetWeight;
                            packagesArray.push(jQuery.extend(true, {}, packObj));
                            packObj = {};
                        }
                    }
                });
                obj["Packages"] = packagesArray;
            }

            var sPath;
            if (carrier === "ABFS") {
                sPath = "https://carrier-api-v1.eshipjet.site/ABF";
            }else if (carrier === "SAIA") {
                sPath = "https://carrier-api-v1.eshipjet.site/generic";
            } else {
                sPath = "https://carrier-api-v1.eshipjet.site/" + carrier;
            }

                      // var sPath = "https://eshipjet-stg-scpn-byargfehdgdtf8f3.francecentral-01.azurewebsites.net/FedEx";
                    let myPromise =  new Promise((resolve, reject) => {
                        $.ajax({
                            url: sPath,
                            method: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(obj),
                            success: function (response) {
                                resolve(response);
                                if(response && response.status === "Success"){
                                    eshipjetModel.setProperty("/ShipNowPostResponse", response);
                                    if(response.Packages.length > 0){
                                        var trackingArray = [];

                                        var ShipNowShipsrvNameSelectedKey = eshipjetModel.getProperty("/commonValues/ShipNowShipsrvNameSelectedKey");
                                        var serviceNameDropdown = eshipjetModel.getProperty("/serviceNameDropdown");
                                        for(var i=0; i<serviceNameDropdown.length; i++){
                                            if(serviceNameDropdown[i].serviceCode === ShipNowShipsrvNameSelectedKey){
                                                var serviceName = serviceNameDropdown[i].serviceName;
                                            }
                                        }
                                // Below code is for Tracking   
                                        for(var i=0; i<response.Packages.length; i++){
                                            var trackingObj = {
                                                "COMPANY": response.Shipper.COMPANY,
                                                "ConsolidationId": response.HeaderInfo.ConsolidationId,
                                                "DocumentNumber": response.HeaderInfo.DocumentNumber,
                                                "CreatedDate": response.HeaderInfo.CreatedDate,
                                                "ShipDate": response.HeaderInfo.ShipDate,
                                                "ShipmentType": response.HeaderInfo.ShipmentType,
                                                "CarrierCode": response.CarrierDetails.Carrier,
                                                "ERPCarrierID": serviceName,
                                                "ServiceName" : eshipjetModel.getProperty("/carrierServiceName_dis"),
                                                "TrackingNumber": response.Packages[i].TrackingNumber,
                                                "TrackingStatus": response.TrackingStatus,
                                                "SHIP_TO_CONTACT": response.ShipTo.CONTACT,
                                                "SHIP_TO_COMPANY": response.ShipTo.COMPANY,
                                                "SHIP_TO_ADDRESS_LINE1": response.ShipTo.ADDRESS_LINE1,
                                                "SHIP_TO_STATE": response.ShipTo.STATE,
                                                "SHIP_TO_CITY": response.ShipTo.CITY,
                                                "SHIP_TO_ZIPCODE": response.ShipTo.ZIPCODE,
                                                "SHIP_TO_COUNTRY": response.ShipTo.COUNTRY,
                                                "SHIP_TO_EMAIL": response.ShipTo.UpdatedUser,
                                                "RequesterName": response.ShipFrom.EMAIL,
                                                "ConnectedTo": "SAP ECC 6.0",
                                                "orderType": "Delivery Number"
                                            };
                                            trackingArray.push(trackingObj);
                                            eshipjetModel.setProperty("/trackingArray", trackingArray);
                                            if(trackingArray.length > 0){
                                                eshipjetModel.setProperty("/trackingLength", true);
                                            }
                                        }
                                    }
                                    // if(response && response.shippingCharges && response.shippingCharges.length > 0 ){
                                    //     eshipjetModel.setProperty("/shippingCharges", response.shippingCharges);
                                    // }

                            // Below code is for Documents
                                    if(response && response.shippingDocuments && response.shippingDocuments.length > 0 ){
                                        var shippingDocuments = response.shippingDocuments;
                                        var ashippingDocuments = [];
                                        for(var i=0; i<shippingDocuments.length; i++){
                                            if(shippingDocuments[i].docName !== ""){
                                                ashippingDocuments.push(
                                                    {
                                                        "srNo": i+1,
                                                        "contentType": shippingDocuments[i].contentType,
                                                        "copiesToPrint": shippingDocuments[i].copiesToPrint,
                                                        "docName": shippingDocuments[i].docName,
                                                        "docProvider": shippingDocuments[i].docProvider,
                                                        "docType": shippingDocuments[i].docType,
                                                        "encodedLabel": shippingDocuments[i].encodedLabel,
                                                })
                                            }
                                        }
                                        eshipjetModel.setProperty("/shippingDocuments", ashippingDocuments);
                                        if(ashippingDocuments.length > 0){
                                            eshipjetModel.setProperty("/documentsLength", true);
                                        }
                                    }
                            // Below code is for Charges
                                    if(response && response.shippingCharges && response.shippingCharges.length > 0 ){
                                        var shippingCharges = response.shippingCharges;
                                        var oShippingCharges = [];
                                        for(var i=0; i<shippingCharges.length; i++){
                                            if(shippingCharges[i].description === "Discount Freight"){
                                                var discount = shippingCharges[i].amount * 0.20;
                                                var discountFreightAmount = shippingCharges[i].amount - discount;
                                                var obj = {
                                                    "serialNo": i + 1,
                                                    "description": shippingCharges[i].description,
                                                    "amount": discountFreightAmount,
                                                    "currency": shippingCharges[i].currency
                                                };
                                            }else{
                                                var obj = {
                                                    "serialNo": i + 1,
                                                    "description": shippingCharges[i].description,
                                                    "amount": shippingCharges[i].amount,
                                                    "currency": shippingCharges[i].currency
                                                };
                                            }
                                            oShippingCharges.push(obj);
                                        }
                                        eshipjetModel.setProperty("/shippingCharges", oShippingCharges);
                                        if(oShippingCharges.length > 0){
                                            eshipjetModel.setProperty("/shippingChargesLength", true);
                                        }
                                    }


                                    //post to manifest service
                                    // oController.getManifestData(response);
                                    
                                    //    oController.updateManifestHeaderSet();
                                    oController.ApiOutboundDeliverySrvData(response);
                                     oController.onPostGoodsIssuePress(sDeliveryNo);      
                                    // oController.showLabelAfterShipmentSuccess(response);

                                }else if(response && response.status === "Error"){
                                    var sError = "Shipment process failed reasons:\n";
                                    if(response && response.Errors && response.Errors.length > 0){
                                        response.Errors.forEach(function(item){
                                            sError = sError + item+"\n";
                                        });                               
                                    }
                                    sap.m.MessageBox.error(sError);
                                    oController.onCloseBusyDialog();
                                }
                            },
                            error: function (error) {
                                // MessageBox.warning(error.responseText);
                                MessageBox.warning(error.statusText);
                                console.log("Error:", error);
                                oController.onCloseBusyDialog();
                                reject(error);
                            }
                        });
                    // });
                    
                    // myPromise.then(
                    //     function(response) {
                    //         oController.updateManifestHeaderSet();
                    //          //oController.FreightQuoteUpdatedSrvData();
                    //         // var myOutbounddeliveryPromise = new Promise((resolve, reject) => {                            
                    //         //     oController.ApiOutboundDeliverySrvData(resolve, reject, response);
                    //         // });
                    //         // myOutbounddeliveryPromise.then(function(){
                              
                    //         //     oController.onCloseBusyDialog();
                    //         // });                                              
                    //     },
                    //     function(error) {
                    //         oController.onCloseBusyDialog();
                    //     // myDisplayer(error);
                    //     }
                    // );                  
            },
            function(error) {
                   
            });          

        },

getManifestHeaderForTodaysShipmentCount: function () {
    oController.onOpenBusyDialog();
    var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
    var ManifestSrvModel = oController.getOwnerComponent().getModel("ManifestModel");

    ManifestSrvModel.read("/Manifest_detSet", {
        success: function (response) {
            oController.onCloseBusyDialog();

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Filter entries created today
            const todaysShipments = (response.results || []).filter(item => {
                if (!item.CreatedOn) return false;

                const dateObj = oController._formatSAPDate(item.CreatedOn);
                if (!dateObj) return false;

                dateObj.setHours(0, 0, 0, 0);
                return dateObj.getTime() === today.getTime();
            });

            // â­ S = Unique Vbeln â†’ One shipment, even if multiple rows exist
            const uniqueShipments = new Set(
                todaysShipments.map(item => item.Vbeln)
            );
            eshipjetModel.setProperty("/todaysShipmentCount", uniqueShipments.size);

            // â­ P = Unique HandlingUnits â†’ Count packages
            const uniquePackages = new Set(
                todaysShipments.map(item => item.HandlingUnit)
            );
            eshipjetModel.setProperty("/todaysTotalPackagesCount", uniquePackages.size);

        },
        error: function (error) {
            oController.onCloseBusyDialog();
            var oResponse = JSON.parse(error.responseText);
            var sMessage = oResponse?.error?.error?.message?.value || "Unknown error occurred";
            sap.m.MessageBox.error(sMessage);
        }
    });
},


_formatSAPDate: function (sapDate) {
    if (!sapDate) return null;

    // Works for /Date(1763970978775)/ format
    var match = sapDate.match(/\/Date\((\d+)\)\//);
    if (match && match[1]) {
        return new Date(parseInt(match[1], 10));
    }

    // Normal ISO date fallback
    return new Date(sapDate);
},
formatNumberForSAP: function(value) {
    if (!value) return "0";

    // convert to number
    var num = Number(value);
    if (isNaN(num)) return "0";

    // remove decimal by multiplying
    var noDecimal = Math.round(num * 100);  // 418.74 â†’ 41874

    return String(noDecimal);
},
cleanWeight: function (val) {
    if (val === null || val === undefined || val === "") {
        return "0.00";
    }
    return Number(val.toString().trim()).toFixed(2);
},

formatNumberForSAP: function (value) {
    if (!value) return "0";

    var num = Number(value);
    if (isNaN(num)) return "0";

    // Removes decimals for SAP NUMC/DEC fields
    var noDecimal = Math.round(num * 100);  // 418.74 â†’ 41874

    return String(noDecimal);
},

formatNumberForSAP: function (val) {
    if (val === null || val === undefined || val === "") return "0.00";
    return Number(val).toFixed(2);
},



onManifestCreatePress: function () {

    var oController = this;
    var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
    var GetDeliveryData = eshipjetModel.getProperty("/GetDeliveryData") || {};

    if (GetDeliveryData.Warehouse === "" || !GetDeliveryData.Warehouse) {
        // NON EWM FLOW
        oController.updateManifestWithoutEWM();
    } else {
        // EWM FLOW
        oController.updateManifestWithEWM();
    }
},


            updateManifestWithoutEWM: function (labelURL, packingSlipURL, billOfLadingURL) {
                var oController = this;
                var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
                var ManifestModel = oController.getOwnerComponent().getModel("ManifestModel");
                var ShipNowResponse = eshipjetModel.getProperty("/ShipNowPostResponse");
                var status = eshipjetModel.getProperty("/PGIStatus");   // <-- NEW
                ManifestModel.setUseBatch(true); // Enable batch mode
                ManifestModel.setDeferredGroups(["batchGroup1"]);
                var selectedServiceNamesData = eshipjetModel.getProperty("/selectedServiceNamesData");
                var sapDeliveryNumber = eshipjetModel.getProperty("/commonValues/sapDeliveryNumber");
                var shippingDocuments = eshipjetModel.getProperty("/shippingDocuments") || [];
                var shippingCharges = eshipjetModel.getProperty("/shippingCharges") || [];
                var GetDeliveryData = eshipjetModel.getProperty("/GetDeliveryData") || {};
                var ServiceName = selectedServiceNamesData.ServDesc || "";
                var ServiceNameId = eshipjetModel.getProperty("/ShipNowShipMethodSelectedKey") || {};
                var shipFrom = eshipjetModel.getProperty("/ShipFromAddress") || {};

                


                var FreightAmt, DiscountAmt;

                // NEW FIELDS
                var ShippingChargeDescription1, ShippingCharges1, ShippingCurrency1;
                var ShippingChargesDescription2, ShippingCharges2, ShippingChargesCurrency2;
                var ShippingChargesDescription3, ShippingCharges3, ShippingChargesCurrency3;
                var ShippingChargesDescription4, ShippingCharges4, ShippingChargesCurrency4;
                var ShippingChargesDescription5, ShippingCharges5, ShippingChargesCurrency5;

                if (shippingCharges && shippingCharges.length > 0) {

                    // === FREIGHT ===
                    var freightAmtObj = shippingCharges.find(item => item.description === "Published Freight");
                    FreightAmt = freightAmtObj ? freightAmtObj.amount.toString() : null;

                    // === DISCOUNT FREIGHT ===
                    var discountAmtObj = shippingCharges.find(item => item.description === "Discount Freight");
                    DiscountAmt = discountAmtObj ? discountAmtObj.amount.toString() : null;

                    // === REMAINING CHARGES (FOR 1â€“5) ===
                    var remainingCharges = shippingCharges.filter(d =>
                        d.description !== "Published Freight" &&
                        d.description !== "Discount Freight" &&
                        d.description !== undefined
                    );

                    // SLOT 1
                    if (remainingCharges[0] !== undefined) {
                        ShippingChargeDescription1 = remainingCharges[0].description || null;
                        ShippingCharges1 = remainingCharges[0].amount !== undefined ? remainingCharges[0].amount.toString() : null;
                        ShippingCurrency1 = remainingCharges[0].currency || null;
                    }

                    // SLOT 2
                    if (remainingCharges[1] !== undefined) {
                        ShippingChargesDescription2 = remainingCharges[1].description || null;
                        ShippingCharges2 = remainingCharges[1].amount !== undefined ? Number(remainingCharges[1].amount).toFixed(2) : null;
                        ShippingChargesCurrency2 = remainingCharges[1].currency || null;
                    }

                    // SLOT 3
                    if (remainingCharges[2] !== undefined) {
                        ShippingChargesDescription3 = remainingCharges[2].description || null;
                        ShippingCharges3 = remainingCharges[2].amount !== undefined ? Number(remainingCharges[2].amount).toFixed(2) : null;
                        ShippingChargesCurrency3 = remainingCharges[2].currency || null;
                    }

                    // SLOT 4
                    if (remainingCharges[3] !== undefined) {
                        ShippingChargesDescription4 = remainingCharges[3].description || null;
                        ShippingCharges4 = remainingCharges[3].amount !== undefined ? Number(remainingCharges[3].amount).toFixed(2) : null;
                        ShippingChargesCurrency4 = remainingCharges[3].currency || null;
                    }

                    // SLOT 5
                    if (remainingCharges[4] !== undefined) {
                        ShippingChargesDescription5 = remainingCharges[4].description || null;
                        ShippingCharges5 = remainingCharges[4].amount !== undefined ? Number(remainingCharges[4].amount).toFixed(2) : null;
                        ShippingChargesCurrency5 = remainingCharges[4].currency || null;
                    }
                }


                // âœ… Extract Freight & Discount
                var publishedFreight = 0, discountFreight = 0;
                for (var i = 0; i < shippingCharges.length; i++) {
                    if (shippingCharges[i].description === "Published Freight") {
                        publishedFreight = shippingCharges[i].amount;
                    } else if (shippingCharges[i].description === "Discount Freight") {
                        discountFreight = shippingCharges[i].amount;
                    }
                }
                function fixNumber(val) {
                        return val ? Number(val).toFixed(2) : "0.00";
                    }


                var labelDocs = shippingDocuments.filter(item => item.contentType.toUpperCase() === "LABEL");
                var packingSlipObj = shippingDocuments.find(item => item.contentType === "Packing Slip");
                var PACKING_SLIP = packingSlipObj ? packingSlipObj.docName : "";
                var billOfLadingObj = shippingDocuments.find(item => item.contentType === "Bill of Lading");
                var BILL_OF_LADING = "";
                if(billOfLadingObj !== undefined){
                    BILL_OF_LADING = billOfLadingObj.docName;
                }

                eshipjetModel.setProperty("/PublishedFreight", publishedFreight);
                eshipjetModel.setProperty("/DiscountFreight", discountFreight);
                // âœ… Format date and time
                var dateAdded = `/Date(${new Date().getTime()})/`;
                const date = new Date();
                const hours = String(date.getHours()).padStart(2, "0");
                const minutes = String(date.getMinutes()).padStart(2, "0");
                const seconds = String(date.getSeconds()).padStart(2, "0");
                const timeAdded = new Date().toISOString().split('T')[0];
                var trackingArray = eshipjetModel.getProperty("/trackingArray");
                // âœ… Loop through documents and prepare batch create requests
                var batchGroupId = "batchGroup1";
                // var totalCharges = ShipNowResponse.shippingCharges?.[0]?.ShipmentCharges?.TotalCharges?.MonetaryValue || "0";
                // var totalCurrency = ShipNowResponse.shippingCharges?.[0]?.ShipmentCharges?.TotalCharges?.CurrencyCode || "";
                var SHIP_METHOD = eshipjetModel.getProperty("/SHIP_METHOD");
                var freightId    = ShipNowResponse?.FreightId || "";
                var sapFreightId = ShipNowResponse?.SapFreightId || "";
                var freightDesc  = ShipNowResponse?.FreightDescription || "Freight Charges";
                var docData = ShipNowResponse.shippingDocuments?.[i] || {};
                let shipPartner = GetDeliveryData.to_DeliveryDocumentPartner?.results?.find(
                        p => p.PartnerFunction === "SH"
                    );
                    let addr = shipPartner?.to_Address2 || {};
                 function sanitizeDescription(desc, maxLength = 40) {
                    if (!desc) return "";

                    // Allow only letters, numbers and space
                    desc = desc.replace(/[^a-zA-Z0-9 ]/g, "");

                    // Replace multiple spaces with single space
                    desc = desc.replace(/\s+/g, " ");

                    // Trim length
                    return desc.substring(0, maxLength).trim();
                }       
                  var handlingUnitsData = eshipjetModel.getProperty("/to_HandlingUnitHeaderDelivery/results");

                labelDocs.forEach(function (doc, i) {
    
                            var oPayload = {
                                "Vbeln": sapDeliveryNumber,
                                "GUID": eshipjetModel.getProperty("/GU_ID"),
                                "Count": (i + 1).toString(),
                                "Posnr": GetDeliveryData.to_HandlingUnitHeaderDelivery?.results?.[0]?.DeliveryDocumentItem || "000010",
                                "Plant": GetDeliveryData.ShippingPoint,

                                "Totalpkg": String(GetDeliveryData.to_HandlingUnitHeaderDelivery.results.length || 0).padStart(5, '0'),
                                "HandlingUnit": handlingUnitsData[i]?.HandlingUnitExternalId ?? "",
                                "Weight":handlingUnitsData[i]?.GrossWeight ?? "",

                                "SalesOrder": GetDeliveryData.SalesOrder || "0000000000",
                                "PurchaseOrder": GetDeliveryData.PurchaseOrder || sapDeliveryNumber,

                                "TrackingNumber": trackingArray?.[0]?.TrackingNumber || "",
                                "Mastertracking": "99999999",

                                "Carriertype": eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey") || "",
                                "CarrierDesc": eshipjetModel.getProperty("/commonValues/ShipNowShipsrvNameSelectedKey") || "",
                                "ServiceName": ServiceName,
                                "ShipMethod": eshipjetModel.oData.CarrierType,
                                "Paymentcode": SHIP_METHOD || "",
                                // "Paymentcode": ShipNowResponse?.PaymentType || "",
                                "Shipperacct": ShipNowResponse?.CarrierDetails?.ShippingAccount || "",
                                "Accountnumber": ShipNowResponse?.CarrierDetails?.ShippingAccount || "",

                                "Dimensions": ShipNowResponse?.Dimension || "10X10X10",
                                // "FreightAmt": oController.formatNumberForSAP(publishedFreight),
                                // "DiscountAmt": oController.formatNumberForSAP(discountFreight),

                                "FreightAmt": fixNumber(FreightAmt),
                                "DiscountAmt": fixNumber(DiscountAmt),

                                "ShippingChargeDescription1": ShippingChargeDescription1 || "",
                                "ShippingCharges1": ShippingCharges1 || "",
                                "ShippingCurrency1": ShippingCurrency1 || "",

                                "ShippingChargesDescription2": ShippingChargesDescription2 || "",
                                "ShippingCharges2": ShippingCharges2 || "",
                                "ShippingChargesCurrency2": ShippingChargesCurrency2 || "",

                                "ShippingChargesDescription3": ShippingChargesDescription3 || "",
                                "ShippingCharges3": ShippingCharges3 || "",
                                "ShippingChargesCurrency3": ShippingChargesCurrency3 || "",

                                "ShippingChargesDescription4": ShippingChargesDescription4 || "",
                                "ShippingCharges4": ShippingCharges4 || "",
                                "ShippingChargesCurrency4": ShippingChargesCurrency4 || "",

                                "ShippingChargesDescription5": ShippingChargesDescription5 || "",
                                "ShippingCharges5": ShippingCharges5 || "",
                                "ShippingChargesCurrency5": ShippingChargesCurrency5 || "",
                                
                                "eShipjetPGIStatus" : status || "",
                                "eShipjetPickStatus":"C",

                                // SHIPPING CHARGES
                                // -------------------------
                               "ShippingChargesFreightId": freightId,
                               "ShippingChargesSapFreightId": sapFreightId,
                                // "ShippingChargesDescription": freightDesc,
                                // "ShippingCharges": oController.formatNumberForSAP(totalCharges),
                                // "ShippingChargesCurrency": totalCurrency,
                                // -------------------------
                                "ShipStatus": "Shipped",
                               
                                "PackingSlip": PACKING_SLIP || "",
                                "DocName": doc.fileName || "",
                                "Label": doc.contentType === "Label" ? (doc.encodedLabel || "") : "",
                                "BillofLading": BILL_OF_LADING || "",

                                // "ShipFromContact": "Plant 1 US",
                                // "ShipFromCompany": "Plant 1 US",
                                // "ShipFromAddressLine1": "Deer Creek",
                                // "ShipFromAddressLine2": "3475",
                                // "ShipFromCity": "Palo Alto",
                                // "ShipFromState": "CA",
                                // "ShipFromCountry": "US",
                                // "ShipFromPostalcode": "94304-1355",
                                // "ShipFromEmail": "noreply@sap.com",
                                // "ShipFromPhoneNumber": "(800) 123-4567",


                                "ShipFromContact": shipFrom.ShipFromCONTACT || "",
                                "ShipFromCompany": shipFrom.ShipFromCOMPANY || "",
                                "ShipFromAddressLine1": shipFrom.ShipFromADDRESS_LINE1 || "",
                                "ShipFromAddressLine2": shipFrom.ShipFromADDRESS_LINE2 || "",
                                "ShipFromCity": shipFrom.ShipFromCITY || "",
                                "ShipFromState": shipFrom.ShipFromSTATE || "",
                                "ShipFromCountry": shipFrom.ShipFromCOUNTRY || "",
                                "ShipFromPostalcode": shipFrom.ShipFromZIPCODE || "",
                                "ShipFromEmail": shipFrom.ShipFromEMAIL || "",
                                "ShipFromPhoneNumber": shipFrom.ShipFromPHONE || "",


                                // -------------------------
                                // SHIP TO
                                // -------------------------
                                //  "ShipToContact": shipToAddr?.BusinessPartnerName1 || "",
                                //     "ShipToCompany": shipToAddr?.BusinessPartnerName1 || "",
                                //     "ShipToAddressLine1": shipToAddr?.StreetName || "",
                                //     "ShipToAddressLine2": shipToAddr?.AdditionalStreetPrefixName || "",
                                //     "ShipToCity": shipToAddr?.CityName || "",
                                //     "ShipToState": shipToAddr?.Region || "",
                                //     "ShipToCountry": shipToAddr?.Country || "",
                                //     "ShipToPostalcode": shipToAddr?.PostalCode || "",
                                //     "ShipToEmail": shipToAddr?.EmailAddress || "",
                                //     "ShipToPhoneNumber": shipToAddr?.PhoneNumber || "",

                                // -------------------------
                                // HARD-CODED SHIP TO DATA
                                // -------------------------
                                "ShipToContact": ShipNowResponse.ShipTo?.CONTACT || "",
                                "ShipToCompany": ShipNowResponse.ShipTo?.COMPANY || "",
                                "ShipToAddressLine1": ShipNowResponse.ShipTo?.ADDRESS_LINE1 || "",
                                "ShipToAddressLine2": ShipNowResponse.ShipTo?.ADDRESS_LINE2 || "",
                                "ShipToCity": ShipNowResponse.ShipTo?.CITY || "",
                                "ShipToState": ShipNowResponse.ShipTo?.STATE || "",
                                "ShipToCountry": ShipNowResponse.ShipTo?.COUNTRY || "",
                                "ShipToPostalcode": ShipNowResponse.ShipTo?.ZIPCODE || "",
                                "ShipToEmail": ShipNowResponse.ShipTo?.EMAIL || "",
                                "ShipToPhoneNumber": ShipNowResponse.ShipTo?.PHONE || "",

                                // "Country":GetDeliveryData.to_SoldToParty?.Country,

                                // -------------------------
                                // PRODUCT INFO
                                // -------------------------
                                "ProductCode":  ShipNowResponse.Packages[i].ItemsInfo[0].ItCa || "",
                                "ProductDescription": sanitizeDescription(
                                        ShipNowResponse?.Packages?.[i]?.ItemsInfo?.[0]?.Description || ""
                                ),

                                "ProductQuantity": ShipNowResponse.Packages[i].ItemsInfo[0].totalQuantity || "",
                                // "ProductUnitOfMeasurement": GetDeliveryData.to_Items?.results?.[i]?.UnitOfMeasureDimension || "",
                                "ProductUnitOfMeasurement": ShipNowResponse.Packages[i].ItemsInfo[0].UOM ||  "CV",
                                // -------------------------
                              
                                // DOCUMENTS
                                "ShippingDocumentProvider": doc.docProvider || "",
                                "ShippingDocumentId":  "",
                                "ShippingDocumentSapOutputType": doc.contentType || "",
                                "ShippingDocumentDescription": doc.docType || "",
                                "ShippingDocumentType": doc.docType || "",

                                // -------------------------
                                // CREATED & CHANGED
                                // -------------------------
                                // "CancTstamp": "",
                                // "CreatedOn": dateAdded,
                                // "CreatedBy": eshipjetModel.getProperty("/userName") || "SYSTEM",
                                "LastChangedOn": timeAdded,
                                "LastChangedBy": eshipjetModel.getProperty("/userName") || "SYSTEM"
                            };


                    // Add each request to batch group
                    ManifestModel.create("/Manifest_detSet", oPayload, {
                        groupId: batchGroupId,
                        changeSetId: "changeset1"
                    });
                });

                oController.onOpenBusyDialog();

                // âœ… Submit all batched requests
                ManifestModel.submitChanges({
                    groupId: batchGroupId,
                    success: function (oData, oResponse) {
                        var bError = false;
                         oController.getManifestHeaderForTodaysShipmentCount();
                         oController.onShipNowNewPress();
                        // Check for errors in each response
                        if (oData.__batchResponses) {
                            oData.__batchResponses.forEach(function (batch) {
                                if (batch.response && batch.response.statusCode >= 400) {
                                    bError = true;
                                }
                            });
                        }

                        if (!bError) {
                            sap.m.MessageToast.show("All shipment records created successfully!");
                            // oController.getTodayShipments();
                            oController.createPostGoodsIssue(sapDeliveryNumber);

                            var sFromViewName = eshipjetModel.getProperty("/sFromViewName");
                            if (sFromViewName === "SCAN_SHIP") {
                                oController.getScanShipHistoryShipments();
                            }
                        } else {
                            sap.m.MessageBox.error("Some batch requests failed. Please check logs.");
                        }

                        oController.onCloseBusyDialog();
                    },
                    error: function (oError) {
                        var errMsg = "";
                        try {
                            errMsg = JSON.parse(oError.responseText).error.message.value;
                        } catch (e) {
                            errMsg = "Batch submission failed.";
                        }
                        sap.m.MessageBox.error(errMsg);
                        oController.onCloseBusyDialog();
                    }
                });
            },

            cleanQuantity: function (val) {
    if (val === null || val === undefined) {
        return "0.000";
    }

    var num = parseFloat(String(val).trim());
    return isNaN(num) ? "0.000" : num.toFixed(3);
},

            
            updateManifestWithEWM: function (labelURL, packingSlipURL, billOfLadingURL) {
                var oController = this;
                var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
                var ManifestModel = oController.getOwnerComponent().getModel("ManifestModel");
                var ShipNowResponse = eshipjetModel.getProperty("/ShipNowPostResponse");
                var status = eshipjetModel.getProperty("/PGIStatus");   // <-- NEW
                ManifestModel.setUseBatch(true); // Enable batch mode
                ManifestModel.setDeferredGroups(["batchGroup1"]);
                var selectedServiceNamesData = eshipjetModel.getProperty("/selectedServiceNamesData");
                var sapDeliveryNumber = eshipjetModel.getProperty("/commonValues/sapDeliveryNumber");
                var shippingDocuments = eshipjetModel.getProperty("/shippingDocuments") || [];
                var shippingCharges = eshipjetModel.getProperty("/shippingCharges") || [];
                var GetDeliveryData = eshipjetModel.getProperty("/GetDeliveryData") || {};
                var ServiceName = selectedServiceNamesData.ServDesc || "";
                var ServiceNameId = eshipjetModel.getProperty("/ShipNowShipMethodSelectedKey") || {};
                var shipFrom = eshipjetModel.getProperty("/ShipFromAddress") || {};

                


                var FreightAmt, DiscountAmt;

                // NEW FIELDS
                var ShippingChargeDescription1, ShippingCharges1, ShippingCurrency1;
                var ShippingChargesDescription2, ShippingCharges2, ShippingChargesCurrency2;
                var ShippingChargesDescription3, ShippingCharges3, ShippingChargesCurrency3;
                var ShippingChargesDescription4, ShippingCharges4, ShippingChargesCurrency4;
                var ShippingChargesDescription5, ShippingCharges5, ShippingChargesCurrency5;

                if (shippingCharges && shippingCharges.length > 0) {

                    // === FREIGHT ===
                    var freightAmtObj = shippingCharges.find(item => item.description === "Published Freight");
                    FreightAmt = freightAmtObj ? freightAmtObj.amount.toString() : null;

                    // === DISCOUNT FREIGHT ===
                    var discountAmtObj = shippingCharges.find(item => item.description === "Discount Freight");
                    DiscountAmt = discountAmtObj ? discountAmtObj.amount.toString() : null;

                    // === REMAINING CHARGES (FOR 1â€“5) ===
                    var remainingCharges = shippingCharges.filter(d =>
                        d.description !== "Published Freight" &&
                        d.description !== "Discount Freight" &&
                        d.description !== undefined
                    );

                    // SLOT 1
                    if (remainingCharges[0] !== undefined) {
                        ShippingChargeDescription1 = remainingCharges[0].description || null;
                        ShippingCharges1 = remainingCharges[0].amount !== undefined ? remainingCharges[0].amount.toString() : null;
                        ShippingCurrency1 = remainingCharges[0].currency || null;
                    }

                    // SLOT 2
                    if (remainingCharges[1] !== undefined) {
                        ShippingChargesDescription2 = remainingCharges[1].description || null;
                        ShippingCharges2 = remainingCharges[1].amount !== undefined ? Number(remainingCharges[1].amount).toFixed(2) : null;
                        ShippingChargesCurrency2 = remainingCharges[1].currency || null;
                    }

                    // SLOT 3
                    if (remainingCharges[2] !== undefined) {
                        ShippingChargesDescription3 = remainingCharges[2].description || null;
                        ShippingCharges3 = remainingCharges[2].amount !== undefined ? Number(remainingCharges[2].amount).toFixed(2) : null;
                        ShippingChargesCurrency3 = remainingCharges[2].currency || null;
                    }

                    // SLOT 4
                    if (remainingCharges[3] !== undefined) {
                        ShippingChargesDescription4 = remainingCharges[3].description || null;
                        ShippingCharges4 = remainingCharges[3].amount !== undefined ? Number(remainingCharges[3].amount).toFixed(2) : null;
                        ShippingChargesCurrency4 = remainingCharges[3].currency || null;
                    }

                    // SLOT 5
                    if (remainingCharges[4] !== undefined) {
                        ShippingChargesDescription5 = remainingCharges[4].description || null;
                        ShippingCharges5 = remainingCharges[4].amount !== undefined ? Number(remainingCharges[4].amount).toFixed(2) : null;
                        ShippingChargesCurrency5 = remainingCharges[4].currency || null;
                    }
                }


                // âœ… Extract Freight & Discount
                var publishedFreight = 0, discountFreight = 0;
                for (var i = 0; i < shippingCharges.length; i++) {
                    if (shippingCharges[i].description === "Published Freight") {
                        publishedFreight = shippingCharges[i].amount;
                    } else if (shippingCharges[i].description === "Discount Freight") {
                        discountFreight = shippingCharges[i].amount;
                    }
                }
                function fixNumber(val) {
                        return val ? Number(val).toFixed(2) : "0.00";
                    }


                var labelDocs = shippingDocuments.filter(item => item.contentType.toUpperCase() === "LABEL");
                var packingSlipObj = shippingDocuments.find(item => item.contentType === "Packing Slip");
                var PACKING_SLIP = packingSlipObj ? packingSlipObj.docName : "";
                var billOfLadingObj = shippingDocuments.find(item => item.contentType === "Bill of Lading");
                var BILL_OF_LADING = "";
                if(billOfLadingObj !== undefined){
                    BILL_OF_LADING = billOfLadingObj.docName;
                }

                eshipjetModel.setProperty("/PublishedFreight", publishedFreight);
                eshipjetModel.setProperty("/DiscountFreight", discountFreight);
                // âœ… Format date and time
                var dateAdded = `/Date(${new Date().getTime()})/`;
                const date = new Date();
                const hours = String(date.getHours()).padStart(2, "0");
                const minutes = String(date.getMinutes()).padStart(2, "0");
                const seconds = String(date.getSeconds()).padStart(2, "0");
                const timeAdded = new Date().toISOString().split('T')[0];
                var trackingArray = eshipjetModel.getProperty("/trackingArray");
                // âœ… Loop through documents and prepare batch create requests
                var batchGroupId = "batchGroup1";
                // var totalCharges = ShipNowResponse.shippingCharges?.[0]?.ShipmentCharges?.TotalCharges?.MonetaryValue || "0";
                // var totalCurrency = ShipNowResponse.shippingCharges?.[0]?.ShipmentCharges?.TotalCharges?.CurrencyCode || "";
                var SHIP_METHOD = eshipjetModel.getProperty("/SHIP_METHOD");
                var freightId    = ShipNowResponse?.FreightId || "";
                var sapFreightId = ShipNowResponse?.SapFreightId || "";
                var freightDesc  = ShipNowResponse?.FreightDescription || "Freight Charges";
                var docData = ShipNowResponse.shippingDocuments?.[i] || {};
                let shipPartner = GetDeliveryData.to_DeliveryDocumentPartner?.results?.find(
                        p => p.PartnerFunction === "SH"
                    );
                    let addr = shipPartner?.to_Address2 || {};
                 function sanitizeDescription(desc, maxLength = 40) {
                    if (!desc) return "";

                    // Allow only letters, numbers and space
                    desc = desc.replace(/[^a-zA-Z0-9 ]/g, "");

                    // Replace multiple spaces with single space
                    desc = desc.replace(/\s+/g, " ");

                    // Trim length
                    return desc.substring(0, maxLength).trim();
                }       
                  var handlingUnitsData = eshipjetModel.getProperty("/to_HandlingUnitHeaderDelivery/results");

                labelDocs.forEach(function (doc, i) {
    
                            var oPayload = {
                                "Vbeln": sapDeliveryNumber,
                                "GUID": eshipjetModel.getProperty("/GU_ID"),
                                "Count": (i + 1).toString(),
                                "Posnr": GetDeliveryData.to_HandlingUnitHeaderDelivery?.results?.[0]?.DeliveryDocumentItem || "000010",
                                "Plant": GetDeliveryData.ShippingPoint,

                                "Totalpkg": String(GetDeliveryData.to_HandlingUnitHeaderDelivery.results.length || 0).padStart(5, '0'),
                                "HandlingUnit": handlingUnitsData[i]?.HandlingUnitExternalId ?? "",
                               "Weight": oController.cleanWeight(
    handlingUnitsData[i]?.GrossWeight
),


                                "SalesOrder": GetDeliveryData.SalesOrder || "0000000000",
                                "PurchaseOrder": GetDeliveryData.PurchaseOrder || sapDeliveryNumber,

                                "TrackingNumber": trackingArray?.[0]?.TrackingNumber || "",
                                "Mastertracking": "99999999",

                                "Carriertype": eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey") || "",
                                "CarrierDesc": eshipjetModel.getProperty("/commonValues/ShipNowShipsrvNameSelectedKey") || "",
                                "ServiceName": ServiceName,
                                "ShipMethod": eshipjetModel.oData.CarrierType,
                                "Paymentcode": SHIP_METHOD || "",
                                // "Paymentcode": ShipNowResponse?.PaymentType || "",
                                "Shipperacct": ShipNowResponse?.CarrierDetails?.ShippingAccount || "",
                                "Accountnumber": ShipNowResponse?.CarrierDetails?.ShippingAccount || "",

                                "Dimensions": ShipNowResponse?.Dimension || "10X10X10",
                                // "FreightAmt": oController.formatNumberForSAP(publishedFreight),
                                // "DiscountAmt": oController.formatNumberForSAP(discountFreight),

                                "FreightAmt": fixNumber(FreightAmt),
                                "DiscountAmt": fixNumber(DiscountAmt),

                                "ShippingChargeDescription1": ShippingChargeDescription1 || "",
                                "ShippingCharges1": ShippingCharges1 || "",
                                "ShippingCurrency1": ShippingCurrency1 || "",

                                "ShippingChargesDescription2": ShippingChargesDescription2 || "",
                                "ShippingCharges2": ShippingCharges2 || "",
                                "ShippingChargesCurrency2": ShippingChargesCurrency2 || "",

                                "ShippingChargesDescription3": ShippingChargesDescription3 || "",
                                "ShippingCharges3": ShippingCharges3 || "",
                                "ShippingChargesCurrency3": ShippingChargesCurrency3 || "",

                                "ShippingChargesDescription4": ShippingChargesDescription4 || "",
                                "ShippingCharges4": ShippingCharges4 || "",
                                "ShippingChargesCurrency4": ShippingChargesCurrency4 || "",

                                "ShippingChargesDescription5": ShippingChargesDescription5 || "",
                                "ShippingCharges5": ShippingCharges5 || "",
                                "ShippingChargesCurrency5": ShippingChargesCurrency5 || "",
                                
                                "eShipjetPGIStatus" : status || "",
                                "eShipjetPickStatus":"C",

                                // SHIPPING CHARGES
                                // -------------------------
                               "ShippingChargesFreightId": freightId,
                               "ShippingChargesSapFreightId": sapFreightId,
                                // "ShippingChargesDescription": freightDesc,
                                // "ShippingCharges": oController.formatNumberForSAP(totalCharges),
                                // "ShippingChargesCurrency": totalCurrency,
                                // -------------------------
                                "ShipStatus": "Shipped",
                               
                                "PackingSlip": PACKING_SLIP || "",
                                "DocName": doc.fileName || "",
                                "Label": doc.contentType === "Label" ? (doc.encodedLabel || "") : "",
                                "BillofLading": BILL_OF_LADING || "",

                                // "ShipFromContact": "Plant 1 US",
                                // "ShipFromCompany": "Plant 1 US",
                                // "ShipFromAddressLine1": "Deer Creek",
                                // "ShipFromAddressLine2": "3475",
                                // "ShipFromCity": "Palo Alto",
                                // "ShipFromState": "CA",
                                // "ShipFromCountry": "US",
                                // "ShipFromPostalcode": "94304-1355",
                                // "ShipFromEmail": "noreply@sap.com",
                                // "ShipFromPhoneNumber": "(800) 123-4567",


                                "ShipFromContact": shipFrom.ShipFromCONTACT || "",
                                "ShipFromCompany": shipFrom.ShipFromCOMPANY || "",
                                "ShipFromAddressLine1": shipFrom.ShipFromADDRESS_LINE1 || "",
                                "ShipFromAddressLine2": shipFrom.ShipFromADDRESS_LINE2 || "",
                                "ShipFromCity": shipFrom.ShipFromCITY || "",
                                "ShipFromState": shipFrom.ShipFromSTATE || "",
                                "ShipFromCountry": shipFrom.ShipFromCOUNTRY || "",
                                "ShipFromPostalcode": shipFrom.ShipFromZIPCODE || "",
                                "ShipFromEmail": shipFrom.ShipFromEMAIL || "",
                                "ShipFromPhoneNumber": shipFrom.ShipFromPHONE || "",


                                // -------------------------
                                // SHIP TO
                                // -------------------------
                                //  "ShipToContact": shipToAddr?.BusinessPartnerName1 || "",
                                //     "ShipToCompany": shipToAddr?.BusinessPartnerName1 || "",
                                //     "ShipToAddressLine1": shipToAddr?.StreetName || "",
                                //     "ShipToAddressLine2": shipToAddr?.AdditionalStreetPrefixName || "",
                                //     "ShipToCity": shipToAddr?.CityName || "",
                                //     "ShipToState": shipToAddr?.Region || "",
                                //     "ShipToCountry": shipToAddr?.Country || "",
                                //     "ShipToPostalcode": shipToAddr?.PostalCode || "",
                                //     "ShipToEmail": shipToAddr?.EmailAddress || "",
                                //     "ShipToPhoneNumber": shipToAddr?.PhoneNumber || "",

                                // -------------------------
                                // HARD-CODED SHIP TO DATA
                                // -------------------------
                                "ShipToContact": ShipNowResponse.ShipTo?.CONTACT || "",
                                "ShipToCompany": ShipNowResponse.ShipTo?.COMPANY || "",
                                "ShipToAddressLine1": ShipNowResponse.ShipTo?.ADDRESS_LINE1 || "",
                                "ShipToAddressLine2": ShipNowResponse.ShipTo?.ADDRESS_LINE2 || "",
                                "ShipToCity": ShipNowResponse.ShipTo?.CITY || "",
                                "ShipToState": ShipNowResponse.ShipTo?.STATE || "",
                                "ShipToCountry": ShipNowResponse.ShipTo?.COUNTRY || "",
                                "ShipToPostalcode": ShipNowResponse.ShipTo?.ZIPCODE || "",
                                "ShipToEmail": ShipNowResponse.ShipTo?.EMAIL || "",
                                "ShipToPhoneNumber": ShipNowResponse.ShipTo?.PHONE || "",

                                // "Country":GetDeliveryData.to_SoldToParty?.Country,

                                // -------------------------
                                // PRODUCT INFO
                                // -------------------------
                                "ProductCode":  ShipNowResponse.Packages[i].ItemsInfo[0].ItCa || "",
                                "ProductDescription": sanitizeDescription(
                                        ShipNowResponse?.Packages?.[i]?.ItemsInfo?.[0]?.Description || ""
                                ),

                                "ProductQuantity": oController.cleanQuantity(ShipNowResponse?.Packages?.[i]?.ItemsInfo?.[0]?.totalQuantity),
                                // "ProductUnitOfMeasurement": GetDeliveryData.to_Items?.results?.[i]?.UnitOfMeasureDimension || "",
                                "ProductUnitOfMeasurement": ShipNowResponse.Packages[i].ItemsInfo[0].UOM ||  "CV",
                                // -------------------------
                              
                                // DOCUMENTS
                                "ShippingDocumentProvider": doc.docProvider || "",
                                "ShippingDocumentId":  "",
                                "ShippingDocumentSapOutputType": doc.contentType || "",
                                "ShippingDocumentDescription": doc.docType || "",
                                "ShippingDocumentType": doc.docType || "",

                                // -------------------------
                                // CREATED & CHANGED
                                // -------------------------
                                // "CancTstamp": "",
                                // "CreatedOn": dateAdded,
                                // "CreatedBy": eshipjetModel.getProperty("/userName") || "SYSTEM",
                                "LastChangedOn": timeAdded,
                                "LastChangedBy": eshipjetModel.getProperty("/userName") || "SYSTEM"
                            };


                    // Add each request to batch group
                    ManifestModel.create("/Manifest_detSet", oPayload, {
                        groupId: batchGroupId,
                        changeSetId: "changeset1"
                    });
                });

                oController.onOpenBusyDialog();

                // âœ… Submit all batched requests
                ManifestModel.submitChanges({
                    groupId: batchGroupId,
                    success: function (oData, oResponse) {
                        var bError = false;
                         oController.getManifestHeaderForTodaysShipmentCount();
                         oController.onShipNowNewPress();
                        // Check for errors in each response
                        if (oData.__batchResponses) {
                            oData.__batchResponses.forEach(function (batch) {
                                if (batch.response && batch.response.statusCode >= 400) {
                                    bError = true;
                                }
                            });
                        }

                        if (!bError) {
                            sap.m.MessageToast.show("All shipment records created successfully!");
                            // oController.getTodayShipments();
                            oController.createPostGoodsIssue(sapDeliveryNumber);

                            var sFromViewName = eshipjetModel.getProperty("/sFromViewName");
                            if (sFromViewName === "SCAN_SHIP") {
                                oController.getScanShipHistoryShipments();
                            }
                        } else {
                            sap.m.MessageBox.error("Some batch requests failed. Please check logs.");
                        }

                        oController.onCloseBusyDialog();
                    },
                    error: function (oError) {
                        var errMsg = "";
                        try {
                            errMsg = JSON.parse(oError.responseText).error.message.value;
                        } catch (e) {
                            errMsg = "Batch submission failed.";
                        }
                        sap.m.MessageBox.error(errMsg);
                        oController.onCloseBusyDialog();
                    }
                });
            },


       createHandlingUnits:function(){
            oController.onOpenBusyDialog();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            // var HandlingUnits = eshipjetModel.getProperty("/HandlingUnits");

            var oPayload = {
                "HandlingUnitExternalID": "300000006",
                "Warehouse": "1710",
                "StockItemUUID": "00000000-0000-0000-0000-000000000001",
                "HandlingUnitItem": "1",
                "HandlingUnitReferenceDocument": "80000001",
                "HandlingUnitRefDocumentItem": "0000000010",
                "HandlingUnitQuantity": "10",
                "HandlingUnitQuantityUnit": "PC",
                "HandlingUnitAltUnitOfMeasure": "PC",
                "Material": "EWMS4-02",
                "ShelfLifeExpirationDate": null,
                "HandlingUnitGoodsReceiptDate": null,
                "to_HandlingUnit": [
                    {
                        "HandlingUnitExternalID": "300000006",
                        "Warehouse": "1710",
                        "PackagingMaterial": "EWMS4-WBTRO00",
                        "PackagingMaterialType": "YN03",
                        "Plant": "",
                        "StorageLocation": "",
                        "ShippingPoint": "1710",
                        "ParentHandlingUnitNumber": "",
                        "GrossWeight": 40.000,
                        "NetWeight": 40.000,
                        "HandlingUnitMaxWeight": 0.000,
                        "WeightUnit": "KG",
                        "HandlingUnitTareWeight": 0.000,
                        "HandlingUnitTareWeightUnit": "KG",
                        "GrossVolume": 30.000,
                        "HandlingUnitNetVolume": 30.000,
                        "VolumeUnit": "L",
                        "HandlingUnitTareVolume": 0.000,
                        "HandlingUnitTareVolumeUnit": "",
                        "HandlingUnitLength": 0.000,
                        "HandlingUnitWidth": 0.000,
                        "HandlingUnitHeight": 0.000,
                        "UnitOfMeasureDimension": "",
                        "HandlingUnitPackingObjectKey": "0080000001",
                        "HandlingUnitReferenceDocument": "80000001",
                        "CreatedByUser": "SOUJANYA.T",
                        "CreationDateTime": "2025-02-18T21:37:55",
                        "LastChangedByUser": "SOUJANYA.T",
                        "LastChangeDateTime": "2025-02-18T21:37:55",
                        "HandlingUnitProcessStatus": "B"
                      }
                ]
            };
            var sPath = "/HandlingUnit(HandlingUnitExternalID='300000006',Warehouse='1710',StockItemUUID=guid'0b246343-97f5-1edf-a498-b24e8bb93e0a')"

            var urlParameters = {
                "$expand": "to_HandlingUnitItem"
            };

            var OutBoundDeliveryModel = oController.getOwnerComponent().getModel("OutBoundDeliveryModel");
            OutBoundDeliveryModel.create(sPath, oPayload, {
                urlParameters: urlParameters,
                success: function (oData) {
                    MessageToast.show("Handling Unit Created Successfully");
                    console.log("Success:", oData);
                    oController.oBusyDialog.close();
                },
                error: function (oError) {
                    var errMsg = JSON.parse(oError.responseText).error.message.value;
                    sap.m.MessageBox.error(errMsg);
                    oController.oBusyDialog.close();
                }
            });
        },

        // createRecentShipments:function(response){
        //     var ShipDate = new Date(response.HeaderInfo.ShipDate);
        //     var timestamp = ShipDate.getTime();
        //     var ShipDate = `/Date(${timestamp})/`;

        //     var CreatedDate = new Date(response.HeaderInfo.CreatedDate);
        //     var timestamp = CreatedDate.getTime();
        //     var CreatedDate = `/Date(${timestamp})/`;

        //     var date = new Date();
        //     let hours = String(date.getHours()).padStart(2, '0');
        //     let minutes = String(date.getMinutes()).padStart(2, '0');
        //     let seconds = String(date.getSeconds()).padStart(2, '0');
        //     var timeAdded = `PT${hours}H${minutes}M${seconds}S`;

        //     var oPayload = {
        //         "Saturdaydel": false,
        //         "Residentialdel": false,
        //         "Priorityalert": false,
        //         "Satpickup": false,
        //         "Insidedel": false,
        //         "Insidepickup": false,
        //         "Liftgate": false,
        //         "Hold": false,
        //         "Dghazmat": false,
        //         "CodFlag": false,
        //         "Closeout": false,
        //         "Upsoffline": false,
        //         "ArrivalNotification": false,
        //         "Bsoflag": false,
        //         "Documents": false,
        //         "LimitedAccess": false,
        //         "Fedexonerate": false,
        //         "Tpc": false,
        //         "Crossdock": false,
        //         "Ddo": false,
        //         "Isc": false,
        //         "Appointment": false,
        //         "DateAdded": ShipDate,
        //         "Createddate": CreatedDate,
        //         "CancDt": null,
        //         "PodDate": null,
        //         "PodCurrentdate": null,
        //         "PodPickupdate": null,
        //         "ExpDelDate": null,
        //         "Scandate": null,
        //         "EtaDate": null,
        //         "CrossdockRecdate": null,
        //         "CrossdockShipdate": null,
        //         "WecloseDate": null,
        //         "PackageWeight": response.Packages[0].Weight,
        //         "Chargweight": "10.000",
        //         "Codamount": "100.000",
        //         "Customs": "0.000",
        //         "Freightamt": response.shippingCharges[0].amount.toString(),
        //         "Discountamt": response.shippingCharges[1].amount.toString(),
        //         "Insurance": "0.000",
        //         "Dryweight": "0.000",
        //         "Vbeln": response.HeaderInfo.DocumentNumber,
        //         "Posnr": "000010",
        //         "Plant": response.HeaderInfo.Location,
        //         "Shipmenttype": "",
        //         "Pkgcount": "00001",
        //         "MultiSeq": "",
        //         "MultiLegno": "",
        //         "Totalpkg": "00001",
        //         "HandlingUnit": "1",
        //         "SalesOrder": "34455",
        //         "PurchaseOrder": "233",
        //         "TrackingNumber": response.Packages[0].TrackingNumber,
        //         "Mastertracking": response.Packages[0].TrackingNumber,
        //         "Uspstracking": "",
        //         "Iorcode": "",
        //         "Externaldoc": "",
        //         "CarrierCode": response.CarrierDetails.Carrier,
        //         "Carriertype": response.CarrierDetails.Carrier,
        //         "CarrierDesc": response.CarrierDetails.Carrier,
        //         "Paymentcode": "SENDER",
        //         "Shipperacct": "4577788",
        //         "Accountnumber": "",
        //         "Dutytaxpaytype": "",
        //         "Dtaccountnumber": "",
        //         "Dimensions": response.Packages[0].Dimension,
        //         "Aesitn": "",
        //         "Vhilm": "",
        //         "Emailaddress": response.HeaderInfo.CreatedUser,
        //         "Signaturetype": "",
        //         "RecCompany": response.ShipTo.COMPANY,
        //         "RecContact": response.ShipTo.CONTACT,
        //         "RecAddress1": response.ShipTo.ADDRESS_LINE1,
        //         "RecAddress2": response.ShipTo.ADDRESS_LINE2,
        //         "RecAddress3": response.ShipTo.ADDRESS_LINE3,
        //         "RecCity": response.ShipTo.CITY,
        //         "RecRegion": "",
        //         "RecPostalcode": response.ShipTo.ZIPCODE,
        //         "RecCountry": response.ShipTo.COUNTRY,
        //         "RecPhone": response.ShipTo.PHONE,
        //         "Company": response.ShipFrom.COMPANY,
        //         "Contact": response.ShipFrom.CONTACT,
        //         "Address1": response.ShipFrom.ADDRESS_LINE1,
        //         "Address2": response.ShipFrom.ADDRESS_LINE2,
        //         "Address3": response.ShipFrom.ADDRESS_LINE3,
        //         "City": response.ShipFrom.CITY,
        //         "Region": "",
        //         "Postalcode": response.ShipFrom.ZIPCODE,
        //         "Country": response.ShipFrom.COUNTRY,
        //         "Phone": response.ShipFrom.PHONE,
        //         "Stceg": "",
        //         "PodSignature": "",
        //         "PodLocation": "",
        //         "PodActivity": "",
        //         "Podstatus": "",
        //         "Podcurrentstatus": "",
        //         "Podexpstatus": "",
        //         "Consolidation": "",
        //         "ReturnTrack": "",
        //         "FromCompany": response.ShipFrom.COMPANY,
        //         "FromContact": response.ShipFrom.CONTACT,
        //         "FromStreet": response.ShipFrom.ADDRESS_LINE1,
        //         "FromStreet2": response.ShipFrom.ADDRESS_LINE2,
        //         "Fromcity": response.ShipFrom.CITY,
        //         "FromRegion": "",
        //         "FromPostalcode": response.ShipFrom.ZIPCODE,
        //         "FromCountry": response.ShipFrom.COUNTRY,
        //         "FromPhone": response.ShipFrom.PHONE,
        //         "EnteredBy": "",
        //         "Sammg": "",
        //         "Lifnr": "",
        //         "Waerk": "",
        //         "Meabm": "",
        //         "Billoflading": "",
        //         "Ltlclass": "",
        //         "Ltlboxcount": "",
        //         "Ltlhutype": "",
        //         "Ltlpacktype": "",
        //         "Ltlnmfccode": "",
        //         "TpCompany": response.ShipTo.COMPANY,
        //         "TpContact": response.ShipTo.CONTACT,
        //         "TpStreet": response.ShipTo.ADDRESS_LINE1,
        //         "TpStreet2": response.ShipTo.ADDRESS_LINE2,
        //         "TpCity1": response.ShipTo.CITY,
        //         "TpRegion": "",
        //         "TpPostCode1": response.ShipTo.ZIPCODE,
        //         "TpCountry": response.ShipTo.COUNTRY,
        //         "TpPhone": response.ShipTo.PHONE,
        //         "EuClearance": "",
        //         "Reference1": "",
        //         "Reference2": "",
        //         "Kunnr": "",
        //         "Kunag": "",
        //         "Vkorg": "",
        //         "Werks": "",
        //         "Auart": "",
        //         "Lfart": "",
        //         "Description": "",
        //         "Shipprocess": "",
        //         "Venum": "",
        //         "Gewei": "",
        //         "Reasonforexport": "",
        //         "Addcomments": "",
        //         "DimensionFactor": "00000",
        //         "TransitDays": "000",
        //         "Delivery": "",
        //         "UpsEod": "",
        //         "Tcode": "",
        //         "Packagetype": "",
        //         "Manifestid": "",
        //         "Scac": "",
        //         "Sealnumber": "",
        //         "Trailerno": "",
        //         "Door": "",
        //         "Paperlessinv": "",
        //         "Tu": "",
        //         "Odo": "",
        //         "Scanflag": "",
        //         "Returntype": "",
        //         "Volumequote": "",
        //         "Truckno": "",
        //         "Container": "",
        //         "Pallets": "",
        //         "Seal": "",
        //         "Crossdockloc": "",
        //         "Ecsid": "",
        //         "Saleterms": "",
        //         "Iorpartner": "",
        //         "Iorcompany": "",
        //         "Iorcontact": "",
        //         "Ioraddress1": "",
        //         "Ioraddress2": "",
        //         "Iorcity": "",
        //         "Iorregion": "",
        //         "Iorpostalcode": "",
        //         "Iorcountry": "",
        //         "Iorphone": "",
        //         "SfOrderid": "",
        //         "CrossdockStatus": "",
        //         "CrossdockRecby": "",
        //         "CrossdockShipby": "",
        //         "EdiControlNo": "",
        //         "Edi997Status": "",
        //         "Shipmentid": "",
        //         "EodTimestamp": "",
        //         "Labelurl": "",
        //         "DgUrl": "",
        //         "Multi": "",
        //         "Legno": "",
        //         "Wemshipid": "",
        //         "Weshipid": "",
        //         "Wemanfid": "",
        //         "WeconsolManfid": "",
        //         "Weportcode": "",
        //         "Wecloseout": "",
        //         "WecloseBy": "",
        //         "Leg": "",
        //         "Knota": "",
        //         "Knotz": "",
        //         "DeliveryStatus": "",
        //         "Stagloc": "",
        //         "Licence": "",
        //         "Orate": "",
        //         "Ocarrier": "",
        //         "Accessorial": "",
        //         "Fuel": "",
        //         "Deliverynno": "",
        //         "TimeAdded": timeAdded,
        //         "CancTim": "PT00H00M00S",
        //         "PodTime": "PT00H00M00S",
        //         "PodCurrenttime": "PT00H00M00S",
        //         "PodPickuptime": "PT00H00M00S",
        //         "Scantime": "PT00H00M00S",
        //         "EtaTime": "PT00H00M00S",
        //         "CrossdockRectime": "PT00H00M00S",
        //         "CrossdockShiptime": "PT00H00M00S",
        //         "WecloseTime": "PT00H00M00S"
        //     };
        //     var ManifestSrvModel = oController.getOwnerComponent().getModel("ManifestSrvModel");
        //     ManifestSrvModel.create("/EshipjetManfestSet", oPayload, {
        //         success: function (oData) {
        //             console.log("Created Successfully", oData);
        //         },
        //         error: function (oError) {
        //             var errMsg = JSON.parse(oError.responseText).error.message.value
        //             sap.m.MessageBox.error(errMsg);
        //         }
        //     });

        //     // var oController = this;
        //     // var ManifestSrvModel = oController.getOwnerComponent().getModel("ManifestSrvModel");
        //     // var Vbeln = response.HeaderInfo.DocumentNumber;

        //     // // Construct the key filter for OData read
        //     // var sFilter = new sap.ui.model.Filter("Vbeln", sap.ui.model.FilterOperator.EQ, Vbeln);

        //     // // Read operation to check if Vbeln exists
        //     // ManifestSrvModel.read("/EshipjetManfestSet", {
        //     //     filters: [sFilter],
        //     //     success: function (oData) {
        //     //         var ShipDate = `/Date(${new Date(response.HeaderInfo.ShipDate).getTime()})/`;
        //     //         var CreatedDate = `/Date(${new Date(response.HeaderInfo.CreatedDate).getTime()})/`;
        //     //         var oPayload = {
        //     //             "Saturdaydel": false,
        //     //             "Residentialdel": false,
        //     //             "Priorityalert": false,
        //     //             "Satpickup": false,
        //     //             "Insidedel": false,
        //     //             "Insidepickup": false,
        //     //             "Liftgate": false,
        //     //             "Hold": false,
        //     //             "Dghazmat": false,
        //     //             "CodFlag": false,
        //     //             "Closeout": false,
        //     //             "Upsoffline": false,
        //     //             "ArrivalNotification": false,
        //     //             "Bsoflag": false,
        //     //             "Documents": false,
        //     //             "LimitedAccess": false,
        //     //             "Fedexonerate": false,
        //     //             "Tpc": false,
        //     //             "Crossdock": false,
        //     //             "Ddo": false,
        //     //             "Isc": false,
        //     //             "Appointment": false,
        //     //             "DateAdded": ShipDate,
        //     //             "Createddate": CreatedDate,
        //     //             "CancDt": null,
        //     //             "PodDate": null,
        //     //             "PodCurrentdate": null,
        //     //             "PodPickupdate": null,
        //     //             "ExpDelDate": null,
        //     //             "Scandate": null,
        //     //             "EtaDate": null,
        //     //             "CrossdockRecdate": null,
        //     //             "CrossdockShipdate": null,
        //     //             "WecloseDate": null,
        //     //             "PackageWeight": response.Packages[0].Weight,
        //     //             "Chargweight": "10.000",
        //     //             "Codamount": "100.000",
        //     //             "Customs": "0.000",
        //     //             "Freightamt": response.shippingCharges[0].amount.toString(),
        //     //             "Discountamt": response.shippingCharges[1].amount.toString(),
        //     //             "Insurance": "0.000",
        //     //             "Dryweight": "0.000",
        //     //             "Vbeln": response.HeaderInfo.DocumentNumber,
        //     //             "Posnr": "000010",
        //     //             "Plant": response.HeaderInfo.Location,
        //     //             "Shipmenttype": "",
        //     //             "Pkgcount": "00001",
        //     //             "MultiSeq": "",
        //     //             "MultiLegno": "",
        //     //             "Totalpkg": "00001",
        //     //             "HandlingUnit": "1",
        //     //             "SalesOrder": "34455",
        //     //             "PurchaseOrder": "233",
        //     //             "TrackingNumber": response.Packages[0].TrackingNumber,
        //     //             "Mastertracking": response.Packages[0].TrackingNumber,
        //     //             "Uspstracking": "",
        //     //             "Iorcode": "",
        //     //             "Externaldoc": "",
        //     //             "CarrierCode": response.CarrierDetails.Carrier,
        //     //             "Carriertype": response.CarrierDetails.Carrier,
        //     //             "CarrierDesc": response.CarrierDetails.Carrier,
        //     //             "Paymentcode": "SENDER",
        //     //             "Shipperacct": "4577788",
        //     //             "Accountnumber": "",
        //     //             "Dutytaxpaytype": "",
        //     //             "Dtaccountnumber": "",
        //     //             "Dimensions": response.Packages[0].Dimension,
        //     //             "Aesitn": "",
        //     //             "Vhilm": "",
        //     //             "Emailaddress": response.HeaderInfo.CreatedUser,
        //     //             "Signaturetype": "",
        //     //             "RecCompany": response.ShipTo.COMPANY,
        //     //             "RecContact": response.ShipTo.CONTACT,
        //     //             "RecAddress1": response.ShipTo.ADDRESS_LINE1,
        //     //             "RecAddress2": response.ShipTo.ADDRESS_LINE2,
        //     //             "RecAddress3": response.ShipTo.ADDRESS_LINE3,
        //     //             "RecCity": response.ShipTo.CITY,
        //     //             "RecRegion": "",
        //     //             "RecPostalcode": response.ShipTo.ZIPCODE,
        //     //             "RecCountry": response.ShipTo.COUNTRY,
        //     //             "RecPhone": response.ShipTo.PHONE,
        //     //             "Company": response.ShipFrom.COMPANY,
        //     //             "Contact": response.ShipFrom.CONTACT,
        //     //             "Address1": response.ShipFrom.ADDRESS_LINE1,
        //     //             "Address2": response.ShipFrom.ADDRESS_LINE2,
        //     //             "Address3": response.ShipFrom.ADDRESS_LINE3,
        //     //             "City": response.ShipFrom.CITY,
        //     //             "Region": "",
        //     //             "Postalcode": response.ShipFrom.ZIPCODE,
        //     //             "Country": response.ShipFrom.COUNTRY,
        //     //             "Phone": response.ShipFrom.PHONE,
        //     //             "Stceg": "",
        //     //             "PodSignature": "",
        //     //             "PodLocation": "",
        //     //             "PodActivity": "",
        //     //             "Podstatus": "",
        //     //             "Podcurrentstatus": "",
        //     //             "Podexpstatus": "",
        //     //             "Consolidation": "",
        //     //             "ReturnTrack": "",
        //     //             "FromCompany": response.ShipFrom.COMPANY,
        //     //             "FromContact": response.ShipFrom.CONTACT,
        //     //             "FromStreet": response.ShipFrom.ADDRESS_LINE1,
        //     //             "FromStreet2": response.ShipFrom.ADDRESS_LINE2,
        //     //             "Fromcity": response.ShipFrom.CITY,
        //     //             "FromRegion": "",
        //     //             "FromPostalcode": response.ShipFrom.ZIPCODE,
        //     //             "FromCountry": response.ShipFrom.COUNTRY,
        //     //             "FromPhone": response.ShipFrom.PHONE,
        //     //             "EnteredBy": "",
        //     //             "Sammg": "",
        //     //             "Lifnr": "",
        //     //             "Waerk": "",
        //     //             "Meabm": "",
        //     //             "Billoflading": "",
        //     //             "Ltlclass": "",
        //     //             "Ltlboxcount": "",
        //     //             "Ltlhutype": "",
        //     //             "Ltlpacktype": "",
        //     //             "Ltlnmfccode": "",
        //     //             "TpCompany": response.ShipTo.COMPANY,
        //     //             "TpContact": response.ShipTo.CONTACT,
        //     //             "TpStreet": response.ShipTo.ADDRESS_LINE1,
        //     //             "TpStreet2": response.ShipTo.ADDRESS_LINE2,
        //     //             "TpCity1": response.ShipTo.CITY,
        //     //             "TpRegion": "",
        //     //             "TpPostCode1": response.ShipTo.ZIPCODE,
        //     //             "TpCountry": response.ShipTo.COUNTRY,
        //     //             "TpPhone": response.ShipTo.PHONE,
        //     //             "EuClearance": "",
        //     //             "Reference1": "",
        //     //             "Reference2": "",
        //     //             "Kunnr": "",
        //     //             "Kunag": "",
        //     //             "Vkorg": "",
        //     //             "Werks": "",
        //     //             "Auart": "",
        //     //             "Lfart": "",
        //     //             "Description": "",
        //     //             "Shipprocess": "",
        //     //             "Venum": "",
        //     //             "Gewei": "",
        //     //             "Reasonforexport": "",
        //     //             "Addcomments": "",
        //     //             "DimensionFactor": "00000",
        //     //             "TransitDays": "000",
        //     //             "Delivery": "",
        //     //             "UpsEod": "",
        //     //             "Tcode": "",
        //     //             "Packagetype": "",
        //     //             "Manifestid": "",
        //     //             "Scac": "",
        //     //             "Sealnumber": "",
        //     //             "Trailerno": "",
        //     //             "Door": "",
        //     //             "Paperlessinv": "",
        //     //             "Tu": "",
        //     //             "Odo": "",
        //     //             "Scanflag": "",
        //     //             "Returntype": "",
        //     //             "Volumequote": "",
        //     //             "Truckno": "",
        //     //             "Container": "",
        //     //             "Pallets": "",
        //     //             "Seal": "",
        //     //             "Crossdockloc": "",
        //     //             "Ecsid": "",
        //     //             "Saleterms": "",
        //     //             "Iorpartner": "",
        //     //             "Iorcompany": "",
        //     //             "Iorcontact": "",
        //     //             "Ioraddress1": "",
        //     //             "Ioraddress2": "",
        //     //             "Iorcity": "",
        //     //             "Iorregion": "",
        //     //             "Iorpostalcode": "",
        //     //             "Iorcountry": "",
        //     //             "Iorphone": "",
        //     //             "SfOrderid": "",
        //     //             "CrossdockStatus": "",
        //     //             "CrossdockRecby": "",
        //     //             "CrossdockShipby": "",
        //     //             "EdiControlNo": "",
        //     //             "Edi997Status": "",
        //     //             "Shipmentid": "",
        //     //             "EodTimestamp": "",
        //     //             "Labelurl": "",
        //     //             "DgUrl": "",
        //     //             "Multi": "",
        //     //             "Legno": "",
        //     //             "Wemshipid": "",
        //     //             "Weshipid": "",
        //     //             "Wemanfid": "",
        //     //             "WeconsolManfid": "",
        //     //             "Weportcode": "",
        //     //             "Wecloseout": "",
        //     //             "WecloseBy": "",
        //     //             "Leg": "",
        //     //             "Knota": "",
        //     //             "Knotz": "",
        //     //             "DeliveryStatus": "",
        //     //             "Stagloc": "",
        //     //             "Licence": "",
        //     //             "Orate": "",
        //     //             "Ocarrier": "",
        //     //             "Accessorial": "",
        //     //             "Fuel": "",
        //     //             "Deliverynno": "",
        //     //             "TimeAdded": "PT00H00M00S",
        //     //             "CancTim": "PT00H00M00S",
        //     //             "PodTime": "PT00H00M00S",
        //     //             "PodCurrenttime": "PT00H00M00S",
        //     //             "PodPickuptime": "PT00H00M00S",
        //     //             "Scantime": "PT00H00M00S",
        //     //             "EtaTime": "PT00H00M00S",
        //     //             "CrossdockRectime": "PT00H00M00S",
        //     //             "CrossdockShiptime": "PT00H00M00S",
        //     //             "WecloseTime": "PT00H00M00S"
        //     //         };
        //     //         if (oData.results.length > 0) {
        //     //             // If Vbeln exists, perform an update
        //     //             var sUpdatePath = `/EshipjetManfestSet('${Vbeln}')`;
        //     //             ManifestSrvModel.update(sUpdatePath, oPayload, {
        //     //                 success: function () {
        //     //                     sap.m.MessageToast.show("Shipment updated successfully");
        //     //                 },
        //     //                 error: function (oError) {
        //     //                     var errMsg = JSON.parse(oError.responseText).error.message.value;
        //     //                     sap.m.MessageBox.error(errMsg);
        //     //                 }
        //     //             });
        //     //         } else {
        //     //             // If Vbeln does not exist, perform a create
        //     //             ManifestSrvModel.create("/EshipjetManfestSet", oPayload, {
        //     //                 success: function (oData) {
        //     //                     sap.m.MessageToast.show("Shipment created successfully");
        //     //                 },
        //     //                 error: function (oError) {
        //     //                     var errMsg = JSON.parse(oError.responseText).error.message.value;
        //     //                     sap.m.MessageBox.error(errMsg);
        //     //                 }
        //     //             });
        //     //         }
        //     //     },
        //     //     error: function (oError) {
        //     //         var errMsg = JSON.parse(oError.responseText).error.message.value;
        //     //         sap.m.MessageBox.error("Error checking existing shipment: " + errMsg);
        //     //     }
        //     // });
        // },


       showLabelAfterShipmentSuccess: function (response) {

    var oController = this;
    var oView = this.getView();
    oController.onOpenBusyDialog();

    var eshipjetModel = oView.getModel("eshipjetModel");
    var shippingDocuments = eshipjetModel.getProperty("/shippingDocuments");

    var oCarousel = new sap.m.Carousel({});
    var aZplList = [];

    // -------------------------------
    // STEP 1: Loop PDF / PNG / ZPL
    // -------------------------------
    for (var i = 0; i < shippingDocuments.length; i++) {

        var doc = shippingDocuments[i];
        var docType = doc.docType.toUpperCase();
        var contentType = doc.contentType.toUpperCase();

        // Skip Packing Slip & Bill of Lading
        var skipDoc = (contentType === "PACKING SLIP" || contentType === "BILL OF LADING");
        if (skipDoc) continue;

        // PDF
        if (docType === "PDF") {
            oCarousel.addPage(
                new sap.ui.core.HTML({
                    content: "<iframe src='" + doc.docName + "' width='500px' height='600px'></iframe>"
                })
            );
        }

        // PNG
        else if (docType === "PNG") {
            oCarousel.addPage(
                new sap.m.Image({
                    src: doc.docName,
                    width: "500px",
                    height: "620px",
                    class: "sapUiSmallMargin"
                })
            );
        }

        // ZPL / ZPLII
        else if (docType === "ZPL" || docType === "ZPLII") {

            var encoded = response.shippingDocuments[i]?.encodedLabel;
            if (encoded) {
                aZplList.push(encoded);
            }
        }
    }

    // If ZPL exists â†’ convert sequentially
    if (aZplList.length > 0) {

        // -----------------------
        // STEP 2: Sequential convert
        // -----------------------
        const convertAllSequentially = async () => {

            let results = [];

            for (let k = 0; k < aZplList.length; k++) {

                // Avoid Labelary throttling
                await new Promise(res => setTimeout(res, 1000));

                try {
                    const pngUrl = await oController.convertZplToPng(aZplList[k]);
                    results.push(pngUrl);
                } catch (err) {
                    console.error("ZPL conversion failed:", err);
                }
            }
            return results;
        };

        convertAllSequentially().then(aPngUrls => {

            // Add converted ZPL PNGs
            aPngUrls.forEach(url => {
                oCarousel.addPage(
                    new sap.m.Image({
                        src: url,
                        width: "500px",
                        height: "620px"
                    })
                );
            });

            // Display final dialog
            oController.creatingCarouseltodisplay(oCarousel);
            oController.openDialogWithCarousel();
            // oController.updateManifestHeaderSet();
            oController.onCloseBusyDialog();

        });

    } else {

        // No ZPL â†’ normal flow
        oController.creatingCarouseltodisplay(oCarousel);
        oController.openDialogWithCarousel();
        oController.updateManifestHeaderSet();
        oController.onCloseBusyDialog();
    }
},

// -------------------------------------------
// CREATE DIALOG WITH CAROUSEL
// -------------------------------------------
creatingCarouseltodisplay: function (oCarousel) {

    var oController = this;

    var oDeclineButton = new sap.m.Button({
        icon: "sap-icon://decline",
        type: "Transparent",
        class: "Decline_Btn ship-now-decline_btn",
        press: function () {
            this.onShipmentLabelDialogClosePress();
        }.bind(this)
    });

    var oCustomHeader = new sap.m.Toolbar({
        content: [
            new sap.m.Title({ text: "Carrier Label", level: "H2" }),
            new sap.m.ToolbarSpacer(),
            oDeclineButton
        ]
    });

    this.openDialogWithCarousel = function () {

        oController._dialogContent = oCarousel;

        oController._oShipmentSuccessLabelDialog = new sap.m.Dialog({
            customHeader: oCustomHeader,
            contentWidth: "500px",
            contentHeight: "620px",
            resizable: true,
            content: [oController._dialogContent]
        });

        oController.getView().addDependent(oController._oShipmentSuccessLabelDialog);
        oController._oShipmentSuccessLabelDialog.open();
        oController.onCloseBusyDialog();
    };
},

// -------------------------------------------
// ZPL â†’ PNG (Labelary API)
// -------------------------------------------
convertZplToPng: function (zplData) {
    return new Promise((resolve, reject) => {

        if (!zplData) return reject("No ZPL data");

        $.ajax({
            url: "https://api.labelary.com/v1/printers/8dpmm/labels/4x6/0/",
            type: "POST",
            data: zplData,
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
            },
            xhrFields: {
                responseType: "arraybuffer"
            },
            processData: false,
            success: function (data) {

                var blob = new Blob([data], { type: "image/png" });
                var url = URL.createObjectURL(blob);
                resolve(url);
            },
            error: function (xhr) {
                reject(xhr?.responseText || "ZPL conversion error");
            }
        });
    });
},

        
        arrayBufferToBase64:function(buffer) {
            var binary = '';
            var bytes = new Uint8Array(buffer);
            var len = bytes.byteLength;
            for (var i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        },

        onShipmentLabelDialogClosePress: function () {
            oController._oShipmentSuccessLabelDialog.close();
            var ShipNowDataModel = oController.getView().getModel("ShipNowDataModel");
            var shipFromObj = {
                "ShipFromCONTACT": "",
                "ShipFromCOMPANY": "",
                "ShipFromPHONE": "",
                "ShipFromEMAIL": "",
                "ShipFromCITY": "",
                "ShipFromSTATE": "",
                "ShipFromCOUNTRY": "",
                "ShipFromZIPCODE": "",
                "ShipFromADDRESS_LINE1": "",
                "ShipFromADDRESS_LINE2": "",
                "ShipFromADDRESS_LINE3": ""
            }
            ShipNowDataModel.setProperty("/ShipFromAddress", shipFromObj);
            ShipNowDataModel.setProperty("/ShipFromAddressType", "");
            ShipNowDataModel.setProperty("/ShipToAddress", {});
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            
            eshipjetModel.setProperty("/commonValues/sapDeliveryNumber","");
            // eshipjetModel.setProperty("/BusinessPartners", []);
            eshipjetModel.setProperty("/ShipFromAddress", {});
            eshipjetModel.setProperty("/ShipToAddress", {});
            eshipjetModel.setProperty("/HandlingUnits",[]);
            eshipjetModel.setProperty("/ShipNowHandlingUnits",[]); 

            eshipjetModel.setProperty("/commonValues/ShipNowShipMethodSelectedKey", "");
            eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey", "");
            eshipjetModel.setProperty("/accountNumber", "");
            eshipjetModel.setProperty("/commonValues/packAddProductTable", []);
            eshipjetModel.setProperty("/InternationalDetails/shipFromTaxNo", "");
            eshipjetModel.setProperty("/InternationalDetails/shipFromTaxNo", "");
            eshipjetModel.setProperty("/trackingArray", []);
            eshipjetModel.setProperty("/shippingCharges",[]);
            eshipjetModel.setProperty("/shippingDocuments",[]);
            eshipjetModel.setProperty("/HandlingUnitItems",[]);
            eshipjetModel.setProperty("/HandlingUnits",[]);
            eshipjetModel.setProperty("/GetDeliveryData/to_HandlingUnitHeaderDelivery/results",[]);
            // eshipjetModel.setProperty("/commonValues/toolPageHeader", false);
            // eshipjetModel.setProperty("/commonValues/allViewsFooter", false);
            // eshipjetModel.setProperty("/commonValues/shipNowViewFooter", true);
            eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
            eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
            eshipjetModel.setProperty("/showDarkThemeSwitch", false);
            eshipjetModel.setProperty("/commonValues/darkTheme", false);
            eshipjetModel.setProperty("/commonValues/OverallGoodsMovementStatus", "");
            eshipjetModel.setProperty("/commonValues/showShipType", false);
            eshipjetModel.setProperty("/commonValues/SalesOrder", "");
            eshipjetModel.setProperty("/commonValues/PurchaseOrder" , "");
            eshipjetModel.setProperty("/selectPaymentType", "");
            eshipjetModel.setProperty("/shipNowShipFromInputStatus", false);

            jQuery.sap.delayedCall(500, this, function() {
                this.getView().byId("idSapDeliveryNumber").focus();
            });
            
            this.onPackSectionEmptyRows();
            // this.byId("idAfterShipmentLabelDialog").close();
            // this.onCloseBusyDialog();


            eshipjetModel.setProperty("/GetDeliveryData/to_Items/results", []);
            eshipjetModel.setProperty("/GetDeliveryData/to_ShipToParty", {});
            eshipjetModel.setProperty("/sFromViewName", "SHIP_NOW");
            eshipjetModel.setProperty("/invoiceNo", "");
            eshipjetModel.setProperty("/documentsLength", false);
            eshipjetModel.setProperty("/shippingChargesLength", false);
            eshipjetModel.setProperty("/trackingLength", false);
            eshipjetModel.setProperty("/hideTrackPackDetails", true);
            var oCommonValues = {
                sapDeliveryNumber :"",
                ShipNowShipMethodSelectedKey:"",
                ShipNowShipsrvNameSelectedKey:"",
                ShipNowSelectedServiceName:"",
                accountNumber:"",
                packAddProductTable:[],
                toolPageHeader: false,
                allViewsFooter: false,
                shipNowViewFooter: true,
                createShipReqViewFooter : false,
                routingGuidFooter : false,
                showDarkThemeSwitch :false,
                darkTheme: false,
                shipNowGanderWhiteSelect:false,
                shipNowGetBtn:true,
                OverallGoodsMovementStatus: "0",
                shipNowABFSelect : false,
                shipNowARTEXFineArtSrvSelect : false,
                shipNowATLASFineArtSelect : false,
                shipNowBrinksFineArtSelect:false,
                shipNowCrownFineArtSelect: false,
                shipNowDHLSelect : false,
                shipNowDTDCSelect : false,
                shipNowFedExSelect : false,
                shipNowFastFarwarderSelect : false,
                shipNowFedExFreightSelect : false,
                shipNowJPMorganChaseInternalSelect:false,
                "shipNowMalca_AmitSelect":false,
                shipNowMoviGroupSelect: false,
                shipNowOtherSelect:false,
                shipNowRLSelect :false,
                shipNowTheArmorySelect :false,
                shipNowUPSSelect:false,
                shipNowBtnStatus :true,
                shipNowUSPSSelect:false,
                shipNowVoidSelect: false,
                shipNowVoidSelectSave:true,
                shipNowVoidSelectShipNow: true,
                showShipType: false,
                SalesOrder: "",
                PurchaseOrder: "",
                lengthOfDimensions: "",
                widthOfDimensions: "",
                heightOfDimensions: "",
                ShippingPoint: false,
                plant: ""
            };
            eshipjetModel.setProperty("/commonValues", oCommonValues);
            oController.onPackSectionEmptyRows();     
            var oIconTabBar = this.byId("idIconTabBarFiori2");
            oIconTabBar.setSelectedKey("Pack");       
            // oController.onCloseBusyDialog();
            oController.getView().setBusy(false);

            var aBusinessPartnersTable = eshipjetModel.getProperty("/BusinessPartners") || [];
            while (aBusinessPartnersTable.length < 5) {
            aBusinessPartnersTable.push(
                { PartnerType: "Ship From", "FullName": "Eshipjet Software Inc.", "BusinessPartnerName1":"Steve Marsh", "StreetName":"5717 Legacy", "HouseNumber":"Suite 250", "Region":"Plano", "CityName":"TX", "PostalCode":"75024", "Country":"US", "PhoneNumber":"(888) 464-2360", "email":"info@eshipjet.ai" },
                { PartnerType: "Shipper", "FullName": "Eshipjet Software Inc.", "BusinessPartnerName1":"Steve Marsh", "StreetName":"5717 Legacy", "HouseNumber":"Suite 250", "Region":"Plano", "CityName":"TX", "PostalCode":"75024", "Country":"US", "PhoneNumber":"(888) 464-2360", "email":"info@eshipjet.ai" },
                { PartnerType: "Freight Forwarder", "FullName": "", "BusinessPartnerName1":"", "StreetName":"", "HouseNumber":"", "Region":"", "CityName":"", "PostalCode":"", "Country":"", "PhoneNumber":"", "email":""  },
                { PartnerType: "Importer", "FullName": "", "BusinessPartnerName1":"", "StreetName":"", "HouseNumber":"", "Region":"", "CityName":"", "PostalCode":"", "Country":"", "PhoneNumber":"", "email":""  },
                { PartnerType: "Third Party", "FullName": "", "BusinessPartnerName1":"", "StreetName":"", "HouseNumber":"", "Region":"", "CityName":"", "PostalCode":"", "Country":"", "PhoneNumber":"", "email":""  }
            );
        }

        eshipjetModel.setProperty("/BusinessPartners", aBusinessPartnersTable);

        },

        
onShippingDocumentsViewPress: async function (oEvent) {

    const oController = this;
    const eshipjetModel = this.getView().getModel("eshipjetModel");
    const tepmShippingDocs = eshipjetModel.getProperty("/tepmShippingDocs") || [];
    const currentObj = oEvent.getSource()
        .getBindingContext("eshipjetModel")
        .getObject();

    const docType = currentObj.docType?.toUpperCase();
    const contentType = currentObj.contentType?.toUpperCase();

    let hasZpl = false;
    let aZplDocs = [];

    // Dialog title
    oController._contentType =
        currentObj.contentType === "Label" ? "Carrier Label" : currentObj.contentType;

    const oCarousel = new sap.m.Carousel({});

    // =====================================================
    // 1ï¸âƒ£ PDF / PNG LABELS
    // =====================================================
    if (contentType === "LABEL") {

        tepmShippingDocs.forEach(doc => {

            const dType = doc.docType?.toUpperCase();
            const cType = doc.contentType?.toUpperCase();

            // PDF Label
            if (dType === "PDF" && cType === "LABEL") {
                oCarousel.addPage(
                    new sap.ui.core.HTML({
                        content: `<iframe src="${doc.docName}" width="500px" height="600px"></iframe>`
                    })
                );
            }

            // PNG Label
            else if (dType === "PNG" && cType === "LABEL") {
                oCarousel.addPage(
                    new sap.m.Image({
                        src: doc.docName,
                        width: "500px",
                        height: "620px",
                        class: "sapUiSmallMargin"
                    })
                );
            }

            // ZPL Labels
            else if ((dType === "ZPL" || dType === "ZPLII" || dType === "TXT") && doc.encodedLabel) {
                hasZpl = true;
                aZplDocs.push(doc);
            }
        });
    }

    // =====================================================
    // 2ï¸âƒ£ PACKING SLIP
    // =====================================================
    else if (docType === "PDF" && contentType === "PACKING SLIP") {
        oCarousel.addPage(
            new sap.ui.core.HTML({
                content: `<iframe src="${currentObj.docName}" width="500px" height="600px"></iframe>`
            })
        );
    }

    // =====================================================
    // 3ï¸âƒ£ BILL OF LADING
    // =====================================================
    else if (docType === "PDF" && contentType === "BILL OF LADING") {
        oCarousel.addPage(
            new sap.ui.core.HTML({
                content: `<iframe src="${currentObj.docName}" width="500px" height="600px"></iframe>`
            })
        );
    }

    // =====================================================
    // 4ï¸âƒ£ NO DATA GUARD
    // =====================================================
    if (!hasZpl && oCarousel.getPages().length === 0) {
        sap.m.MessageToast.show(currentObj.contentType + " doesn't exist");
        return;
    }

    // =====================================================
    // 5ï¸âƒ£ ZPL â†’ PNG (SEQUENTIAL WITH RETRY)
    // =====================================================
    async function convertZplSequentially(zplDocs) {

        for (const doc of zplDocs) {

            let attempts = 0;
            let imgUrl = null;

            while (attempts < 2 && !imgUrl) {
                try {
                    imgUrl = await oController.convertZplToPng(doc.encodedLabel);

                    oCarousel.addPage(
                        new sap.m.Image({
                            src: imgUrl,
                            width: "500px",
                            height: "650px"
                        })
                    );
                } catch (e) {
                    attempts++;
                    await new Promise(r => setTimeout(r, 300));
                }
            }

            await new Promise(r => setTimeout(r, 200));
        }
    }

    if (hasZpl && aZplDocs.length) {
        await convertZplSequentially(aZplDocs);
    }

    // =====================================================
    // 6ï¸âƒ£ OPEN DIALOG (SAME AS FIRST APP)
    // =====================================================
    const oCloseIcon = new sap.m.Button({
        icon: "sap-icon://decline",
        type: "Transparent",
        press: () => oDialog.close()
    });

    const oHeader = new sap.m.Toolbar({
        content: [
            new sap.m.Title({ text: oController._contentType, level: "H3" }),
            new sap.m.ToolbarSpacer(),
            oCloseIcon
        ]
    });

    const oFooter = new sap.m.Toolbar({
        content: [
            new sap.m.Button({
                text: "Close",
                press: () => oDialog.close()
            }).addStyleClass("Ship-Now-toolbar1__button_red"),
            new sap.m.ToolbarSpacer(),
            new sap.m.Button({
                text: "Print",
                press: () => window.print()
            }).addStyleClass("Ship-Now-toolbar1__button_green")
        ]
    });

    const oDialog = new sap.m.Dialog({
        customHeader: oHeader,
        content: [
            new sap.m.ScrollContainer({
                vertical: true,
                content: [oCarousel]
            })
        ],
        footer: oFooter,
        contentWidth: "520px",
        contentHeight: "720px",
        resizable: true,
        draggable: true
    });

    oController.getView().addDependent(oDialog);
    oDialog.open();
},

   onToggleProductTableRows: function () {
            const oTable = this.byId("idShipNowPackTable");
            const oBtn = this.byId("idToggleRowsBtn");
            const isExpanded = oTable.getVisibleRowCount() > 4;
            if (isExpanded) {
                // Collapse
                eshipjetModel.setProperty("/expandTableOn", true);
                eshipjetModel.setProperty("/expandProductTableOn", true);
                eshipjetModel.setProperty("/expandHUTableOn", true);
                oTable.setVisibleRowCount(4);
                oBtn.setIcon("sap-icon://inspect");
            } else {
                // Expand
                eshipjetModel.setProperty("/expandTableOn", false);
                eshipjetModel.setProperty("/expandProductTableOn", true);
                eshipjetModel.setProperty("/expandHUTableOn", false);
                oTable.setVisibleRowCount(20);
                oBtn.setIcon("sap-icon://inspect-down");
            }
        },
         onToggleHandlingUnitsTableRows: function () {
            const oTable = this.byId("idShipNowHandlingUnitTable");
            const oBtn = this.byId("idToggleHURowsBtn");
            const isExpanded = oTable.getVisibleRowCount() > 6;
            if (isExpanded) {
                // Collapse
                eshipjetModel.setProperty("/expandTableOn", true);
                eshipjetModel.setProperty("/expandProductTableOn", true);
                eshipjetModel.setProperty("/expandHUTableOn", true);
                oTable.setVisibleRowCount(6);
                oBtn.setIcon("sap-icon://inspect");
            } else {
                // Expand
                eshipjetModel.setProperty("/expandTableOn", false);
                eshipjetModel.setProperty("/expandProductTableOn", false);
                eshipjetModel.setProperty("/expandHUTableOn", true);
                oTable.setVisibleRowCount(20);
                oBtn.setIcon("sap-icon://inspect-down");
            }
        },


        // getManifestData:function(response){
        //     var ManifestSrvModel = oController.getOwnerComponent().getModel("ManifestSrvModel");
        //     // var sDeveliveryNumber = eshipjetModel.getProperty("/sapDeliveryNumber");
        //     // var plant = response.ShipTo.COMPANY.split(" ")[1]
        //     // var ShipDate = `/Date(${new Date(response.HeaderInfo.ShipDate).getTime()})/`
        //     // var Createddate = `/Date(${new Date(response.HeaderInfo.CreatedDate).getTime()})/`
        //     var hours = 2;
        //     var minutes = 30;
        //     var seconds = 45;
        //     //var TimeAdded = `PT${String(hours).padStart(2, '0')}H${String(minutes).padStart(2, '0')}M${String(seconds).padStart(2, '0')}S`;

        //     var Residentialdel;
        //     if(response.ShipTo === "Residential"){
        //         Residentialdel = true;
        //     }else{
        //         Residentialdel = false;
        //     }
        //     var obj = 
        //     {
        //         "Vbeln": "80000001",
        //         "Posnr": "000010",
        //         "Plant": "1710",
        //         "TimeAdded": "PT00H00M00S",
        //         "Pkgcount": "00001",
        //         "Totalpkg": "00001",
        //         "HandlingUnit": "1",
        //         "SalesOrder": "34455",
        //         "PurchaseOrder": "233",
        //         "TrackingNumber": "890000890",
        //         "Mastertracking": "890000890",
        //         "PackageWeight": "10.000",
        //         "Chargweight": "10.000",
        //         "CarrierCode": "FEDEX",
        //         "Carriertype": "FEDEX",
        //         "CarrierDesc": "FEDEX",
        //         "Paymentcode": "SENDER",
        //         "Shipperacct": "4577788",
        //         "Dimensions": "10X10X19",
        //         "Codamount": "100.000",
        //         "Freightamt": "40.000",
        //         "Discountamt": "40.000",
        //         "Saturdaydel": false,
        //         "Residentialdel": false,
        //         "Priorityalert": false,
        //         "Satpickup": false,
        //         "Insidedel": false,
        //         "Insidepickup": false,
        //         "Liftgate": false,
        //         "Hold": false,
        //         "Dghazmat": false,
        //         "CancDt": null,
        //         "CancTim": "PT00H00M00S",
        //         "PodDate": null,
        //         "PodTime": "PT00H00M00S",
        //         "PodCurrentdate": null,
        //         "PodCurrenttime": "PT00H00M00S",
        //         "PodPickupdate": null,
        //         "PodPickuptime": "PT00H00M00S",
        //         "CodFlag": false,
        //         "Closeout": false,
        //         "ExpDelDate": null,
        //         "Upsoffline": false,
        //         "ArrivalNotification": false,
        //         "Bsoflag": false,
        //         "Documents": false,
        //         "LimitedAccess": false,
        //         "Fedexonerate": false,
        //         "Tpc": false,
        //         "Scandate": null,
        //         "Scantime": "PT00H00M00S",
        //         "EtaDate": null,
        //         "EtaTime": "PT00H00M00S",
        //         "Crossdock": false,
        //         "CrossdockRecdate": null,
        //         "CrossdockRectime": "PT00H00M00S",
        //         "CrossdockShipdate": null,
        //         "CrossdockShiptime": "PT00H00M00S",
        //         "Ddo": false,
        //         "Isc": false,
        //         "WecloseDate": null,
        //         "WecloseTime": "PT00H00M00S",
        //         "Appointment": false,
        //     };
        //     ManifestSrvModel.create("/EshipjetManfestSet", obj, {
        //         success:function(oRes){

        //         },
        //         error(oErr){

        //         }
        //     });
        // },



        onShipNowGetPress1: async function () {            
            var sDeveliveryNumber = eshipjetModel.getProperty("/commonValues/sapDeliveryNumber");
            eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey","");
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
            eshipjetModel.setProperty("/shippingCharges", []);
            eshipjetModel.setProperty("/shippingDocuments", []);
            eshipjetModel.setProperty("/trackingArray", []);
            eshipjetModel.setProperty("/commonValues/ShipNowShipMethodSelectedKey","");
            eshipjetModel.setProperty("/commonValues/accountNumber","");    
            eshipjetModel.setProperty("/commonValues/OverallGoodsMovementStatus", "");
            eshipjetModel.setProperty("/commonValues/shipNowBtnStatus", true);
            eshipjetModel.setProperty("/selectPaymentType", "Sender");
            eshipjetModel.setProperty("/shipNowShipFromInputStatus", true);
            var myPromise = new Promise(function(myResolve, myReject) {
                oController.shipNowData(sDeveliveryNumber, "ShipNow", myResolve);                                                    
            });
            await myPromise;
            var ShipNowShipMethodSelectedKey = eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey");
            var carrierName = ShipNowShipMethodSelectedKey.toUpperCase();
            if(carrierName === "UPS" || carrierName === "FEDEX" || carrierName === "USPS"){
                eshipjetModel.setProperty("/hideTrackPackDetails", false);
            }else{
                eshipjetModel.setProperty("/hideTrackPackDetails", true);
                eshipjetModel.setProperty("/commonValues/lengthOfDimensions", "40");
                eshipjetModel.setProperty("/commonValues/widthOfDimensions", "48");
                eshipjetModel.setProperty("/commonValues/heightOfDimensions", "");
            }
        },

        onDeliveryNumberLiveChange: function (oEvent) {
            var input = oEvent.getSource();
            var value = oEvent.getParameter("value");
          
            // Allow only digits
            var cleanValue = value.replace(/[^0-9]/g, '');
          
            // Update input field only if the value changed
            if (value !== cleanValue) {
              input.setValue(cleanValue);
            }
          },


        onOpenBusyDialog: function () {
            if (!oController._pBusyDialog) {
				oController._pBusyDialog = Fragment.load({
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.BusyDialog",
					controller: oController
				}).then(function (oBusyDialog) {
					oController.getView().addDependent(oBusyDialog);
					//syncStyleClass("sapUiSizeCompact", this.getView(), oBusyDialog);
					return oBusyDialog;
				}.bind(oController));
			}

			oController._pBusyDialog.then(function(oBusyDialog) {
				oBusyDialog.open();				
			}.bind(oController));
        },

        onCloseBusyDialog:function(oEvent){
            //this.byId("idBusyDialog").close();
            this._pBusyDialog.then(function(oBusyDialog) {
                oBusyDialog.close();
            });
        },     

        shipNowData:function(sDeveliveryNumber ,sFromMenu, myResolve){
            // var oDeliveryModel = oController.getView().getModel("OutBoundDeliveryModel");                    
            // var oHandlingUnitModel = oController.getView().getModel("HandlingUnitModel");           
            // var sPath = "/A_OutbDeliveryHeader('"+ sDeveliveryNumber +"')/to_DeliveryDocumentPartner";
            // var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            // if(sDeveliveryNumber && sDeveliveryNumber.length >= 7){
            //     oController.onOpenBusyDialog();
                
            //     var path = "/A_OutbDeliveryHeader('"+ sDeveliveryNumber +"')"
            //     oDeliveryModel.read(path,{
            //         urlParameters: {
            //             "$expand": "to_DeliveryDocumentItem,to_DeliveryDocumentPartner"
            //         },
            //         success:function(oData){                        
            //             oController.etag = oData.__metadata.etag;
            //             oController.ShippingType = oData.ShippingType;
            //             eshipjetModel.setProperty("/PlantCode",oData.ShippingPoint);
            //             eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey", oData.ShippingType);
            //             if(oData.ShippingType !== "" && oData.ShippingType !== undefined){
            //                 eshipjetModel.setProperty("/commonValues/showShipType", true);
            //             }
            //             eshipjetModel.setProperty("/commonValues/OverallGoodsMovementStatus", oData.OverallGoodsMovementStatus);
            //             oController.getManifestHeaderForCharges(sDeveliveryNumber);
            //         },
            //         error: function(oErr){
            //             oController.onCloseBusyDialog();
            //         }
            //     });

            //     oDeliveryModel.read(sPath,{
            //         // urlParameters: {
            //         //     "$expand": "to_DeliveryDocumentItem,to_DeliveryDocumentPartner"
            //         // },
            //         success:function(oData){
            //             if(oData){                      
            //                 oController._getShipToAddress(oData.results, sDeveliveryNumber, sFromMenu);
            //             }
            //             myResolve();
            //         },
            //         error: function(oErr){                        
            //             console.log(oErr);
            //             myResolve();
            //             oController.onCloseBusyDialog();
            //         }
            //     });

               
            //     //var promise = new promise(function(resolved, rejected){
            //         var aOutBoundDelveryFilter = [], aProductTable = [];
            //         aOutBoundDelveryFilter.push(new Filter("DeliveryDocument", "EQ", sDeveliveryNumber));
            //         oDeliveryModel.read("/A_OutbDeliveryItem",{
            //             filters: aOutBoundDelveryFilter,
            //             success:function(oData){
            //                 if(oData && oData.results && oData.results.length > 0){
            //                     for(var i = 0; i < oData.results.length; i++){
            //                         oData.results[i]["SerialNumber"] = i+1;
            //                         oData.results[i]["ItemWeightUnit"] = "10X12X12";
            //                         oData.results[i]["BalanceQty"] = oData.results[i].ActualDeliveryQuantity;
            //                         aProductTable.push(oData.results[i]);
            //                     };
            //                     var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            //                     eshipjetModel.setProperty("/commonValues/packAddProductTable",aProductTable);
            //                     oController.getSalesOrder(aProductTable);
            //                     oController.readHUDataSet(sDeveliveryNumber)
            //                 }
            //             },
            //             error: function(oErr){
            //                 console.log(oErr);
            //                 oController.onCloseBusyDialog();
            //             }
            //         });
                
            // }

            oController.onOpenBusyDialog();
            var oDeliveryModel = oController.getView().getModel("OutBoundDeliveryModel");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");

            if (sDeveliveryNumber && sDeveliveryNumber.length >= 7) {
                oController.onOpenBusyDialog();

                // Header Promise
                let headerPromise = new Promise((resolve, reject) => {
                    var path = "/A_OutbDeliveryHeader('" + sDeveliveryNumber + "')";
                    oDeliveryModel.read(path, {
                        urlParameters: {
                            "$expand": "to_DeliveryDocumentItem,to_DeliveryDocumentPartner"
                        },
                        success: function (oData) {
                            oController.etag = oData.__metadata.etag;
                            oController.ShippingType = oData.ShippingType;
                            eshipjetModel.setProperty("/PlantCode", oData.ShippingPoint);
                            eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey", oData.ShippingType);
                            eshipjetModel.setProperty("/commonValues/plant", oData.ShippingPoint);
                            if (oData.ShippingType !== "" && oData.ShippingType !== undefined) {
                                eshipjetModel.setProperty("/commonValues/showShipType", true);
                            }
                            if (oData.ShippingPoint !== "" && oData.ShippingPoint !== undefined) {
                                eshipjetModel.setProperty("/commonValues/ShippingPoint", true);
                            }
                            eshipjetModel.setProperty("/commonValues/OverallGoodsMovementStatus", oData.OverallGoodsMovementStatus);

                            // Call and wait for getManifestHeaderForCharges
                            Promise.resolve().then(() => {
                                oController.getManifestHeaderForCharges(sDeveliveryNumber);
                                resolve();
                            });
                        },
                        error: function (oErr) {
                            oController.onCloseBusyDialog();
                            reject(oErr);
                        }
                    });
                });

                // Partner Promise
                let partnerPromise = new Promise((resolve, reject) => {
                    var sPath = "/A_OutbDeliveryHeader('" + sDeveliveryNumber + "')/to_DeliveryDocumentPartner";
                    oDeliveryModel.read(sPath, {
                        success: function (oData) {
                            if (oData) {
                                Promise.resolve().then(() => {
                                    oController._getShipToAddress(oData.results, sDeveliveryNumber, sFromMenu);
                                    resolve();
                                });
                            } else {
                                resolve();
                            }
                        },
                        error: function (oErr) {
                            oController.onCloseBusyDialog();
                            reject(oErr);
                        }
                    });
                });

                // Item Promise with getSalesOrder and readHUDataSet
                let itemPromise = new Promise((resolve, reject) => {
                    var aOutBoundDelveryFilter = [new Filter("DeliveryDocument", "EQ", sDeveliveryNumber)];
                    var aProductTable = [];
                    oDeliveryModel.read("/A_OutbDeliveryItem", {
                        filters: aOutBoundDelveryFilter,
                        success: function (oData) {
                            if (oData && oData.results && oData.results.length > 0) {
                                for (var i = 0; i < oData.results.length; i++) {
                                    oData.results[i]["SerialNumber"] = i + 1;
                                    oData.results[i]["ItemWeightUnit"] = "10X12X12";
                                    oData.results[i]["BalanceQty"] = oData.results[i].ActualDeliveryQuantity;
                                    aProductTable.push(oData.results[i]);
                                }
                                eshipjetModel.setProperty("/commonValues/packAddProductTable", aProductTable);

                                // Wait for both functions to finish before resolving itemPromise
                                Promise.all([
                                    Promise.resolve().then(() => oController.getSalesOrder(aProductTable)),
                                    // Promise.resolve().then(() => oController.getHandlingUnit(sDeveliveryNumber))
                                ]).then(resolve);
                            } else {
                                resolve();
                            }
                        },
                        error: function (oErr) {
                            oController.onCloseBusyDialog();
                            reject(oErr);
                        }
                    });
                });

                // After all promises are resolved
                Promise.all([headerPromise, partnerPromise, itemPromise])
                    .then(() => {
                        myResolve(); // All done
                    })
                    .catch((error) => {
                        console.error("Error in one of the reads or internal calls:", error);
                    });
            }
        },

        // getManifestHeaderForCharges:function(sDeveliveryNumber){
        //     oController.onOpenBusyDialog();
        //     var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
        //     var ManifestSrvModel = oController.getOwnerComponent().getModel("ManifestModel");
        //     var aFilters = [
        //         new sap.ui.model.Filter("Vbeln", sap.ui.model.FilterOperator.EQ, sDeveliveryNumber)
        //     ];

        //     ManifestSrvModel.read("/Manifest_detSet",{
        //         filters: aFilters,
        //         success:function(response){
        //             eshipjetModel.setProperty("/getManifestHeader", response.results);
                    
        //             if (response && response.results.length > 0) {
        //             // oController.onShopNowShipMethodChangeFromQuoteNow(response.results[0].CarrierCode, response.results[0].CarrierDesc);
        //                 // Apply filtering after receiving the response
        //                 var aFilteredData = response.results.filter(function (item) {
        //                     return item.Vbeln === sDeveliveryNumber;
        //                 });
        //                 var OverallGoodsMovementStatus = eshipjetModel.getProperty("/commonValues/OverallGoodsMovementStatus");
        //                 var shipNowStatus = true;
        //                 var shipNowVoidStatus = false;
        //                 var shipNowVoidStatusSave = true;
        //                 var shipNowVoidStatusShipNow = true;
        //                 if(response.results.length > 0){
        //                     shipNowStatus = false;
        //                     shipNowVoidStatus = true;
        //                     shipNowVoidStatusSave = false;
        //                     shipNowVoidStatusShipNow = false;
        //                 };
        //                 eshipjetModel.setProperty("/commonValues/shipNowBtnStatus", shipNowStatus);
        //                 eshipjetModel.setProperty("/commonValues/shipNowVoidSelect", shipNowVoidStatus);
        //                 eshipjetModel.setProperty("/commonValues/shipNowVoidSelectSave", shipNowVoidStatusSave);
        //                 eshipjetModel.setProperty("/commonValues/shipNowVoidSelectShipNow", shipNowVoidStatusShipNow);
        //                 if(aFilteredData && aFilteredData.length > 0){
        //                     var aShippingCharges = [
        //                         { "serialNo": "1", "description": "Freight Amount", "amount": parseInt(aFilteredData[0].FreightAmt).toFixed(2), "currency": "USD" },
        //                         { "serialNo": "2", "description": "Discount Amount", "amount": parseInt(aFilteredData[0].DiscountAmt).toFixed(2), "currency": "USD" },
        //                         { "serialNo": "3", "description": "Fuel", "amount": aFilteredData[0].Fuel && aFilteredData[0].Fuel !== "" ? parseFloat(aFilteredData[0].Fuel).toFixed(2) : "0.00", "currency": "USD" }
        //                     ];
        //                     eshipjetModel.setProperty("/shippingCharges", aShippingCharges);
        //                     eshipjetModel.setProperty("/shippingChargesArrayLength", aShippingCharges.length);
        //                     if(aShippingCharges.length > 0){
        //                         eshipjetModel.setProperty("/shippingChargesLength", true);
        //                     }
        //                     var shippingDocuments = response.shippingDocuments;
        //                     var ashippingDocuments = [];
        //                     var tepmShippingDocs = [];

        //                     var freight = parseFloat(aFilteredData[0].Freightamt) || 0;
        //                     var fuel = parseFloat(aFilteredData[0].Fuel) || 0;
        //                     var totalAmount = (freight + fuel).toFixed(2);

        //                     eshipjetModel.setProperty("/totalFreightFuel", totalAmount);

        //                     tepmShippingDocs.push({
        //                         "srNo": 1,
        //                         "contentType": "Label",
        //                         "copiesToPrint": 1,
        //                         "encodedLabel": aFilteredData[0].Label,
        //                         "docProvider": aFilteredData[0].Carriertype,
        //                         "docType": aFilteredData[0].Labelurl.split(".")[aFilteredData[0].Labelurl.split(".").length-1],
        //                         "docName": aFilteredData[0].Labelurl,
        //                     });
                            
        //                     for(var i=0; i<aFilteredData.length; i++){
        //                         var obj = {
        //                                 "srNo": i+1,
        //                                 "contentType": "Label",
        //                                 "copiesToPrint": 1,
        //                                 "encodedLabel": aFilteredData[i].Label,
        //                                 "docProvider": aFilteredData[i].Carriertype,
        //                                 "docType": aFilteredData[i].Labelurl.split(".")[aFilteredData[i].Labelurl.split(".").length-1],
        //                                 "docName": aFilteredData[i].Labelurl,
        //                         };
                                
        //                         ashippingDocuments.push(obj);
        //                     }

        //                 if(aFilteredData[0].PackURL !== "" && aFilteredData[0].PackURL !== undefined){
        //                     var packObj = {
        //                         "srNo": 2,
        //                         "contentType": "Packing Slip",
        //                         "copiesToPrint": 1,
        //                         "encodedLabel": aFilteredData[0].Label,
        //                         "docProvider": "Eshipjet",
        //                         "docType": aFilteredData[0].PackURL.split(".")[aFilteredData[0].PackURL.split(".").length-1],
        //                         "docName": aFilteredData[0].PackURL,
        //                     };
        //                     tepmShippingDocs.push(packObj);
        //                 }
        //                 if(aFilteredData[0].BolURL !== "" && aFilteredData[0].BolURL !== undefined){    
        //                     var billOfLading = {
        //                             "srNo": 3,
        //                             "contentType": "Bill Of lading",
        //                             "copiesToPrint": 1,
        //                             "encodedLabel": "",
        //                             "docProvider": "Eshipjet",
        //                             "docType": aFilteredData[0].BolURL.split(".")[aFilteredData[0].BolURL.split(".").length-1],
        //                             "docName": aFilteredData[0].BolURL,
        //                     }
        //                     tepmShippingDocs.push(billOfLading);
        //                 }
                        
        //                     eshipjetModel.setProperty("/shippingDocuments", tepmShippingDocs);
        //                     eshipjetModel.setProperty("/tepmShippingDocs", ashippingDocuments );
        //                     eshipjetModel.setProperty("/shippingDocumentsLength", tepmShippingDocs.length);
        //                     if(ashippingDocuments.length > 0){
        //                         eshipjetModel.setProperty("/documentsLength", true);
        //                     };

        //                     var trackingArray = [];
        //                     for(var i=0; i<aFilteredData.length; i++){
        //                         var trackingObj = {
        //                             "Plant":aFilteredData[i].Plant,
        //                             "Delivery": aFilteredData[i].Delivery,
        //                             "CarrierCode": aFilteredData[i].CarrierCode,
        //                             "Shipmentid": aFilteredData[i].Shipmentid,
        //                             "ServiceID": aFilteredData[i].CarrierDesc,
        //                             "ServiceName": aFilteredData[i].CarrierDesc,
        //                             "Shipmenttype": aFilteredData[i].Shipmenttype,
        //                             "PGI": "Successful",
        //                             "ShipDate": aFilteredData[i].Createddate,
        //                             "DateAdded": aFilteredData[i].DateAdded,
        //                             "TrackingNumber": aFilteredData[i].TrackingNumber,
        //                             "TrackingStatus": aFilteredData[i].Shipprocess,
        //                             "SAPUserID": "KUMAR"
        //                         };
        //                         trackingArray.push(trackingObj);
        //                         eshipjetModel.setProperty("/trackingArray", trackingArray);
        //                         eshipjetModel.setProperty("/trackingArrayLength", trackingArray.length);
        //                         if(trackingArray.length > 0){
        //                             eshipjetModel.setProperty("/trackingLength", true);
        //                         }
        //                     }
        //                     eshipjetModel.updateBindings(true);

        //                     var invoiceNums = "";
        //                     aFilteredData.forEach(function(item, idx) {
        //                         if (idx === 0) {
        //                             invoiceNums = item.HandlingUnit;
        //                         } else {
        //                             invoiceNums = invoiceNums + ", " + item.HandlingUnit;
        //                         }
        //                     });
        //                     eshipjetModel.setProperty("/invoiceNo", invoiceNums);
                            
        //                 }

        //                 var ShipNowShipMethodSelectedKey = eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey");
        //                 var carrierName = ShipNowShipMethodSelectedKey.toUpperCase();
        //                 if(carrierName === "UPS" || carrierName === "FEDEX" || carrierName === "USPS"){
        //                     eshipjetModel.setProperty("/hideTrackPackDetails", false);
        //                 }else{
        //                     eshipjetModel.setProperty("/hideTrackPackDetails", true);
        //                     eshipjetModel.setProperty("/commonValues/lengthOfDimensions", "40");
        //                     eshipjetModel.setProperty("/commonValues/widthOfDimensions", "48");
        //                     eshipjetModel.setProperty("/commonValues/heightOfDimensions", "");
        //                 }
        //                 oController.getHandlingUnit(sDeveliveryNumber);
        //                 oController.checkPostGoodsIssueStatus(sDeveliveryNumber);
        //             }
        //             // oController.onCloseBusyDialog();
        //         },
        //         error: function(error){
        //             MessageBox.warning(error.responseText);
        //             oController.onCloseBusyDialog();
        //         }
        //     });
        // },

  getManifestHeaderForCharges: function (sDeliveryNumber) {
    const oController = this;
    oController.onOpenBusyDialog();
    // oController.onShipNowNewPress();
    const eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
    var sDeveliveryNumber = eshipjetModel.getProperty("/commonValues/sapDeliveryNumber");
    const ManifestSrvModel = oController.getOwnerComponent().getModel("ManifestModel");

    ManifestSrvModel.read("/Manifest_detSet", {
        success: function (oData) {
            const aFilteredResults = oData.results.filter(item => item.Vbeln === sDeveliveryNumber);
            console.log("Manifest_detSet Success:", oData);

            if (!aFilteredResults || aFilteredResults.length === 0) {
                // MessageToast.show("No Manifest data found for delivery " + sDeveliveryNumber);
                eshipjetModel.setProperty("/shippingCharges", []);
                eshipjetModel.setProperty("/shippingDocuments", []);
                eshipjetModel.setProperty("/shippingChargesLength", false);
                eshipjetModel.setProperty("/documentsLength", false);
                oController.onCloseBusyDialog();
                return;
            }else if(aFilteredResults.length !== 0){
                var shipNowStatus = true;
                var shipNowVoidStatus = false;
                var shipNowVoidStatusSave = true;
                var shipNowVoidStatusShipNow = true;
                if(aFilteredResults.length > 0){
                    shipNowStatus = false;
                    shipNowVoidStatus = true;
                    shipNowVoidStatusSave = false;
                    shipNowVoidStatusShipNow = false;
                };
                eshipjetModel.setProperty("/commonValues/shipNowBtnStatus", shipNowStatus);
                eshipjetModel.setProperty("/commonValues/shipNowVoidSelect", shipNowVoidStatus);
                eshipjetModel.setProperty("/commonValues/shipNowVoidSelectSave", shipNowVoidStatusSave);
                eshipjetModel.setProperty("/commonValues/shipNowVoidSelectShipNow", shipNowVoidStatusShipNow);
                // // --- SHIPPING CHARGES ---
                // const freight = parseFloat(aFilteredResults[0].FreightAmt) || 0;
                // const discount = parseFloat(aFilteredResults[0].DiscountAmt) || 0;
                // const fuel = parseFloat(aFilteredResults[0].Fuel) || 0;

                // const aShippingCharges = [
                //     { serialNo: "1", description: "Freight Amount", amount: freight.toFixed(2), currency: "USD" },
                //     { serialNo: "2", description: "Discount Amount", amount: discount.toFixed(2), currency: "USD" },
                //     { serialNo: "3", description: "Fuel", amount: fuel.toFixed(2), currency: "USD" }
                // ];

                // eshipjetModel.setProperty("/shippingCharges", aShippingCharges);
                // eshipjetModel.setProperty("/shippingChargesArrayLength", aShippingCharges.length);
                // eshipjetModel.setProperty("/shippingChargesLength", aShippingCharges.length > 0);
                // eshipjetModel.setProperty("/totalFreightFuel", (freight + fuel - discount).toFixed(2));


                    // ---------------------------------------------------
                    // SHIPPING CHARGES (Manifest - using new field names)
                    // ---------------------------------------------------
                    var m = aFilteredResults[0];   // Manifest record


                    // -----------------------------
                    // BUSINESS PARTNERS MAPPING
                    // -----------------------------
                    var BusinessPartners = [];

                    var SoldToParty = {
                        PartnerType: "Sold-To-Party",
                        PartnerID: "",                                     // You can map real ID if you have it
                        CompanyName: aFilteredResults[0].ShipToCompany || "",
                        ContactName: aFilteredResults[0].ShipToContact || "",
                        AddressLine1: aFilteredResults[0].ShipToAddressLine1 || "",
                        AddressLine1: aFilteredResults[0].ShipToAddressLine2 || "",
                        City: aFilteredResults[0].ShipToCity || "",
                        State: aFilteredResults[0].ShipToState || "",
                        PostalCode: aFilteredResults[0].ShipToPostalcode || "",
                        Country: aFilteredResults[0].ShipToCountry || "",
                        PhoneNumber: aFilteredResults[0].ShipToPhoneNumber || "",
                        EmailAddress: aFilteredResults[0].ShipToEmail || ""
                    };

                    var ShipToParty = {
                        PartnerType: "Ship-to Party",
                        PartnerID: "",                                     // You can map real ID if you have it
                        CompanyName: aFilteredResults[0].ShipToCompany || "",
                        ContactName: aFilteredResults[0].ShipToContact || "",
                        AddressLine1: aFilteredResults[0].ShipToAddressLine1 || "",
                        AddressLine1: aFilteredResults[0].ShipToAddressLine2 || "",
                        City: aFilteredResults[0].ShipToCity || "",
                        State: aFilteredResults[0].ShipToState || "",
                        PostalCode: aFilteredResults[0].ShipToPostalcode || "",
                        Country: aFilteredResults[0].ShipToCountry || "",
                        PhoneNumber: aFilteredResults[0].ShipToPhoneNumber || "",
                        EmailAddress: aFilteredResults[0].ShipToEmail || ""
                    };

                    // Push to array
                    BusinessPartners.push(SoldToParty);
                    BusinessPartners.push(ShipToParty);

                    // Set model
                    eshipjetModel.setProperty("/BusinessPartners", BusinessPartners);

                    console.log("Business Partners:", BusinessPartners);


                var aShippingCharges = [
                    {
                        description: "Freight Amount",
                        amount: m.FreightAmt ? Number(m.FreightAmt).toFixed(2) : null,
                        currency: "USD"
                    },
                    {
                        description: "Discount Amount",
                        amount: m.DiscountAmt ? Number(m.DiscountAmt).toFixed(2) : null,
                        currency: "USD"
                    },
                    {
                        description: m.ShippingChargeDescription1 || null,
                        amount: m.ShippingCharges1 && m.ShippingCharges1 !== "0.00" ? Number(m.ShippingCharges1).toFixed(2) : null,
                        currency: m.ShippingCurrency1 || null
                    },
                    {
                        description: m.ShippingChargesDescription2 || null,
                        amount: m.ShippingCharges2 && m.ShippingCharges2 !== "0.00" ? Number(m.ShippingCharges2).toFixed(2) : null,
                        currency: m.ShippingChargesCurrency2 || null
                    },
                    {
                        description: m.ShippingChargesDescription3 || null,
                        amount: m.ShippingCharges3 && m.ShippingCharges3 !== "0.00" ? Number(m.ShippingCharges3).toFixed(2) : null,
                        currency: m.ShippingChargesCurrency3 || null
                    },
                    {
                        description: m.ShippingChargesDescription4 || null,
                        amount: m.ShippingCharges4 && m.ShippingCharges4 !== "0.00" ? Number(m.ShippingCharges4).toFixed(2) : null,
                        currency: m.ShippingChargesCurrency4 || null
                    },
                    {
                        description: m.ShippingChargesDescription5 || null,
                        amount: m.ShippingCharges5 && m.ShippingCharges5 !== "0.00" ? Number(m.ShippingCharges5).toFixed(2) : null,
                        currency: m.ShippingChargesCurrency5 || null
                    }
                ];

                // Filter out empty rows
                aShippingCharges = aShippingCharges.filter(item =>
                    item.description &&
                    item.amount &&
                    item.currency
                );

                // Update model
                eshipjetModel.setProperty("/shippingCharges", aShippingCharges);
                eshipjetModel.setProperty("/shippingChargesArrayLength", aShippingCharges.length);
                eshipjetModel.setProperty("/shippingChargesLength", aShippingCharges.length > 0);

                // -----------------------------------------
                // TOTAL FREIGHT + FUEL - DISCOUNT (Manifest)
                // -----------------------------------------
                var freightVal = Number(m.FreightAmt || 0);
                var discountVal = Number(m.DiscountAmt || 0);

                // Fuel may come from ShippingCharges1..5, find "Fuel Surcharge"
                var fuelVal = 0;

                aShippingCharges.forEach(sc => {
                    if (sc.description && sc.description.toLowerCase().includes("fuel")) {
                        fuelVal = Number(sc.amount || 0);
                    }
                });

                // FINAL TOTAL
                var totalFF = (freightVal + fuelVal - discountVal).toFixed(2);

                eshipjetModel.setProperty("/totalFreightFuel", totalFF);

            


                // --- DOCUMENTS ---
                const aDocuments = [];
                var tepmShippingDocs = [];

                    // ZPL label
                    if (aFilteredResults[0].Label && aFilteredResults[0].Label.trim() !== "") {
                        aDocuments.push({
                            srNo: 1,
                            contentType: "Label",
                            docProvider: aFilteredResults[0].Carriertype || "",
                            docType: "ZPL",
                            docName: aFilteredResults[0].Label,
                            encodedLabel: aFilteredResults[0].Label
                        });
                    }

                    // Packing Slip
                    if (aFilteredResults[0].PackingSlip && aFilteredResults[0].PackingSlip !== "") {
                        aDocuments.push({
                            srNo: 2,
                            contentType: "Packing Slip",
                            docProvider: "Eshipjet",
                            docType: "PDF",
                            docName: aFilteredResults[0].PackingSlip
                        });
                    }

                    // Bill of Lading
                    if (aFilteredResults[0].BillofLading && aFilteredResults[0].BillofLading !== "") {
                        aDocuments.push({
                            srNo: 3,
                            contentType: "Bill of Lading",
                            docProvider: "Eshipjet",
                            docType: "PDF",
                            docName: aFilteredResults[0].BillofLading
                        });
                    }

                aFilteredResults.forEach((item, idx) => {
                    // ZPL label
                    if (item.Label && item.Label.trim() !== "") {
                        tepmShippingDocs.push({
                            srNo: idx + 1,
                            contentType: "Label",
                            docProvider: item.Carriertype || "",
                            docType: "ZPL",
                            docName: item.Label,
                            encodedLabel: item.Label
                        });
                    }
                });

                console.log("Documents generated:", aDocuments);

                eshipjetModel.setProperty("/shippingDocuments", aDocuments);
                eshipjetModel.setProperty("/tepmShippingDocs", tepmShippingDocs);
                eshipjetModel.setProperty("/shippingDocumentsLength", aDocuments.length);
                eshipjetModel.setProperty("/documentsLength", aDocuments.length > 0);

                var trackingArray = [];
                for(var i=0; i<aFilteredResults.length; i++){
                    var trackingObj = {
                        "Plant":aFilteredResults[i].Plant,
                        "Delivery": aFilteredResults[i].Vbeln,
                        "CarrierCode": aFilteredResults[i].Carriertype,
                        "Shipmentid": aFilteredResults[i].ServiceName,
                        "ServiceID": aFilteredResults[i].CarrierDesc,
                        "ServiceName": aFilteredResults[i].CarrierDesc,
                        "Shipmenttype": aFilteredResults[i].CarrierDesc,
                        "PGI": "Successful",
                        "ShipDate": aFilteredResults[i].CreatedOn,
                        "DateAdded": aFilteredResults[i].CreatedOn,
                        "TrackingNumber": aFilteredResults[i].TrackingNumber,
                        "TrackingStatus": aFilteredResults[i].ShipStatus,
                        "SAPUserID": "KUMAR"
                    };
                    trackingArray.push(trackingObj);
                    eshipjetModel.setProperty("/trackingArray", trackingArray);
                    eshipjetModel.setProperty("/trackingArrayLength", trackingArray.length);
                    if(trackingArray.length > 0){
                        eshipjetModel.setProperty("/trackingLength", true);
                    }
                }

                // PACK HU MAPPING
                var aManifestHUs = aFilteredResults.map(function(item, idx) {
                    return {
                        SerialNumber: idx + 1,
                        HandlingUnitExternalID: item.HandlingUnit,
                        CreatedByUser: item.CreatedBy,
                        GrossWeight: "",                      // optional
                        Dimensions: item.Dimensions,
                        HandlingUnitPackingObjectType: item.Totalpkg,
                        HandlingUnitInternalID: "",
                        Hunumber: item.Hunumber,
                        HandlingUnitIsClosed: true,
                        PackagingMaterial: "",
                        HuLabel: "",
                        GrossWeight: item.Weight
                    };
                });

                eshipjetModel.setProperty("/ShipNowHandlingUnits", aManifestHUs);


               // -----------------------------------------
                // SHIP FROM (MANIFEST FLOW)
                // -----------------------------------------
                var m = aFilteredResults[0];

                var ShipFrom = {
                        ShipFromCOMPANY: m.ShipFromCompany || "",
                        ShipFromCONTACT: m.ShipFromContact || "",
                        ShipFromADDRESS_LINE1: m.ShipFromAddressLine1 || "",
                        ShipFromADDRESS_LINE2: m.ShipFromAddressLine2 || "",
                        ShipFromCITY: m.ShipFromCity || "",
                        ShipFromSTATE: m.ShipFromState || "",
                        ShipFromZIPCODE: m.ShipFromPostalcode || "",
                        ShipFromCOUNTRY: m.ShipFromCountry || "",
                        ShipFromPHONE: m.ShipFromPhoneNumber || "",
                        ShipFromEMAIL: m.ShipFromEmail || ""
                    };
                    eshipjetModel.setProperty("/ShipFromAddress", ShipFrom);


                // -----------------------------------------
                // SHIP TO (MANIFEST FLOW)
                // -----------------------------------------
                var ShipTo = {
                        BusinessPartnerName1: m.ShipToContact || "",
                        FullName: m.ShipToCompany || m.ShipToContact || "",
                        StreetName: m.ShipToAddressLine1 || "",
                        HouseNumber: m.ShipToAddressLine1 || "",
                        CityName: m.ShipToCity || "",
                        Region: m.ShipToState || "",
                        PostalCode: m.ShipToPostalcode || "",
                        Country: m.ShipToCountry || "",
                        PhoneNumber: m.ShipToPhoneNumber || "",
                        EMAIL: m.ShipToEmail && m.ShipToEmail.trim() !== ""
                            ? m.ShipToEmail
                            : "info@eshipjet.ai"
                    };
                    eshipjetModel.setProperty("/ShipToAddress", ShipTo);



                eshipjetModel.setProperty("/carrierNamesDropDownData", [
                        { CarrierCode: m.Carriertype }   // UPS
                    ]);

                    // Auto-select carrier
                    eshipjetModel.setProperty("/commonValues/ShipNowShipMethodSelectedKey", m.Carriertype);

                    eshipjetModel.setProperty("/carrierServicesDropDownData", [
                    {
                        ErpServId: m.ServiceName,   // "UPS Ground"
                        ServDesc: m.ServiceName     // visible text
                    }
                ]);

                // Auto-select service
                eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey", m.ServiceName);

                eshipjetModel.setProperty("/accountNumber", m.Accountnumber || "");
                
                eshipjetModel.setProperty("/selectPaymentType", m.Paymentcode || "Sender");

                eshipjetModel.setProperty("/currentDeliveryNumber", m.Vbeln);

                eshipjetModel.setProperty("/PGI_STATUS", m.eShipjetPGIStatus || "");

                eshipjetModel.setProperty("/manifestGUID", m.GUID || "");

                // -----------------------------
                // SET PLANT (for recent shipment)
                // -----------------------------
                var m = aFilteredResults[0];

                // Backend field where Plant comes (adjust name if different)
                var manifestPlant = m.Plant || m.ShipmentPlant || m.SHIPFROMPLANT || "";  

                if (manifestPlant) {
                    eshipjetModel.setProperty("/commonValues/plant", manifestPlant);
                    eshipjetModel.setProperty("/commonValues/showPlant", true);
                } else {
                    eshipjetModel.setProperty("/commonValues/showPlant", false);
                }

                eshipjetModel.setProperty("/HandlingUnitsLength", m.Totalpkgs || 0);


                    // ----------------------
                    // MAP HU DATA FOR SHIPNOW UI
                    // ----------------------
                    var handlingUnitsArray = aFilteredResults.map(item => ({
                        HandlingUnitExternalId: item.HandlingUnit?.trim() || "",
                        CreatedByUser: item.CreatedBy || "",
                        GrossWeight: item.GrossWeight || 10,

                        HandlingUnitLength: item.Length || 10,
                        HandlingUnitWidth: item.Width || 12,
                        HandlingUnitHeight: item.Height || 12,

                        HandlingUnitPackingObjectType: item.Totalpkg || "",   // Box Count
                        HandlingUnitInternalID: item.Hunumber || "",          // Class
                        TrackingNumber: item.TrackingNumber || "",

                        PackagingMaterial: item.Carriertype || "",            // Packaging Material
                        Material: item.ProductCode || "",
                        MaterialName: item.ProductDescription || "",
                        HandlingUnitQuantity: item.ProductQuantity || 0,
                        HandlingUnitQuantityUnit: item.ProductUnitOfMeasurement || "",

                        CARRIER_TYPE: item.Carriertype,
                        SERVICE_NAME: item.ServiceName,
                        CARRIER_DESC: item.CarrierDesc
                    }));

                    // ðŸ”„ Reset before updating
                    eshipjetModel.setProperty("/to_HandlingUnitHeaderDelivery", { results: [] });

                    // âœ… Update ShipNow HU table data
                    eshipjetModel.setProperty("/to_HandlingUnitHeaderDelivery/results", handlingUnitsArray);

                    // Count of HUs
                    eshipjetModel.setProperty("/HandlingUnitsLength", handlingUnitsArray.length);

                    console.log("Updated HU Data:", handlingUnitsArray);
                     oController.onPackSectionEmptyRows();

                    // ---------------------------
                    // PICK STATUS (Recent Shipment)
                    // ---------------------------
                    var pickStatus = aFilteredResults[0].eShipjetPickStatus || "";

                    eshipjetModel.setProperty("/commonValues/OverallGoodsMovementStatus", pickStatus);

                

                   var grossWeight = aFilteredResults?.[0]?.Weight || "";
                    eshipjetModel.setProperty("/GrossWeight", grossWeight);


                    // -------------------------------------------------
                    // PRODUCT DETAILS FOR HU DIALOG (Recent Shipment)
                    // -------------------------------------------------
                    var handlingUnitItems = [];

                    aFilteredResults.forEach(function (item) {
                        handlingUnitItems.push({
                            Material: item.ProductCode || "",                 // Product Code
                            MaterialName: item.ProductDescription || "",             // Description
                            HandlingUnitQuantity: item.ProductQuantity || 0,  // Quantity
                            HandlingUnitQuantityUnit: item.ProductUnitOfMeasurement || ""   // UOM
                        });
                    });

                    // Set to model for fragment binding
                    eshipjetModel.setProperty("/handlingUnitItems", handlingUnitItems);
                    eshipjetModel.updateBindings(true);











                eshipjetModel.updateBindings(true);

                var invoiceNums = "";
                aFilteredResults.forEach(function(item, idx) {
                    if (idx === 0) {
                        invoiceNums = item.HandlingUnit;
                    } else {
                        invoiceNums = invoiceNums + ", " + item.HandlingUnit;
                    }
                });
                eshipjetModel.setProperty("/invoiceNo", invoiceNums);
                eshipjetModel.updateBindings(true);
            }
            oController.onCloseBusyDialog();
        },
        error: function (err) {
            console.error("âŒ Manifest_detSet Error:", err);
            MessageBox.error("Failed to load manifest data. Check console for details.");
            oController.onCloseBusyDialog();
        }
    });
},

      
        getHandlingUnit:function(sapDeliveryNumber){
            var CreateHUSrvModel = oController.getOwnerComponent().getModel("CreateHUSrvModel");
            let aFilters = [] ;
            aFilters.push(new Filter("Delivery", "EQ", sapDeliveryNumber));
            CreateHUSrvModel.read("/HUDETAILSSet",{
                filters: aFilters,
                success:function(oData){
                    if(oData && oData.results && oData.results.length > 0){
                        var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
                        // eshipjetModel.setProperty("/HandlingUnitItems",oData.results);
                        var aProductTableData = eshipjetModel.getProperty("/to_DeliveryDocumentItem");
                        aProductTableData.forEach(function(obj, idx){
                            if(obj.DeliveryDocumentItem !== undefined){
                                var count = 0;
                                oData.results.forEach(function(huObj){
                                    if(parseInt(obj.DeliveryDocumentItem) === parseInt(huObj.Itemno)){
                                        count += parseInt(huObj.Qty);
                                    }
                                });
                                var qty = parseInt(obj.ActualDeliveryQuantity) - count;
                                if(qty === 0){
                                    aProductTableData.splice(idx, 1);
                                }else{
                                    obj.BalanceQty = qty;
                                }
                            }
                        });

                        eshipjetModel.updateBindings(true);

                        var getManifestHeader = eshipjetModel.getProperty("/getManifestHeader");
                        if(oData && oData.results && oData.results.length > 0){
                            for(var i = 0; i < oData.results.length; i++){
                                oData.results[i]["SerialNumber"] = i + 1;
                            };

                            var allHUsArray = oData.results.map(function (r) {
                                return {
                                    HandlingUnitExternalId : r.Hunumber,
                                    CreatedByUser      : r.CreatedByUser || "",
                                    GrossWeight  : r.Totalweight,
                                    HandlingUnitPackingObjectType     : r.Delivery,
                                    HandlingUnitInternalID          : r.Meins,
                                    PackagingMaterial     : parseFloat(r.Pacmatnr),
                                    Material       : r.Delmatnr,
                                    MaterialName       : r.Maktx,
                                    HandlingUnitQuantity  : r.Qty,
                                    HandlingUnitQuantityUnit : r.Meins
                                };
                            });

                            if(getManifestHeader && getManifestHeader.length > 0){
                                for(var i=0; i<getManifestHeader.length; i++){
                                    oData.results[i]["TrackingNumber"] = getManifestHeader[i].TrackingNumber;
                                    oData.results[i]["CarrierCode"] = eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey");
                                }
                            };
                            // eshipjetModel.setProperty("/HandlingUnits", oData.results);
                            
                            eshipjetModel.setProperty("/to_HandlingUnitHeaderDelivery", { results: [] });
                            eshipjetModel.setProperty("/to_HandlingUnitHeaderDelivery/results", allHUsArray);
                        }else{
                            eshipjetModel.setProperty("/to_HandlingUnitHeaderDelivery", { results: [] });
                            eshipjetModel.setProperty("/to_HandlingUnitHeaderDelivery/results", []);
                        }
                    }
                    // oController.onPackSectionEmptyRows();
                    oController.onCloseBusyDialog();
                },
                error: function(oErr){
                    MessageBox.warning(error.responseText);
                    oController.onCloseBusyDialog();
                }
            });
        },
        getSalesOrder:function(aProductTable){
            var oSalesOrderModel = oController.getOwnerComponent().getModel("SalesOrderModel");            
            var sPath = "", aFilters = [] ;
            for (var i = 0; i < aProductTable.length; i++) {               
                aFilters.push(new Filter("SalesOrder", "EQ", aProductTable[i].ReferenceSDDocument));              
            }
            oSalesOrderModel.read("/A_SalesOrderItem",{
                filters: aFilters,
                success:function(oData){
                    if(oData && oData.results && oData.results.length > 0){
                        eshipjetModel.setProperty("/SalesOrderItems", oData.results);
                        eshipjetModel.setProperty("/commonValues/SalesOrder", oData.results[0].SalesOrder);
                        eshipjetModel.setProperty("/commonValues/PurchaseOrder", oData.results[0].PurchaseOrderByCustomer);
                    }
                },
                error: function(oErr){
                    var err = oErr;
                }
            });
        },
        
        _getShipToAddress:function(aResults, sDocNumber, sFromMenu){
            var oDeliveryModel = oController.getView().getModel("OutBoundDeliveryModel");
            var oShipNowModel = oController.getView().getModel("ShipNowDataModel");
            oDeliveryModel.setDeferredGroups(["addressDefferedgroupID"]);
            oDeliveryModel.setUseBatch(true);
            var batchChanges = [], aBusinessPartnerTable = [], promise1;
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var sPath = "";
            promise1 = new Promise((resolve, reject) => {    
                var Supplier;
                aResults.sort((a, b) => b.PartnerFunction.localeCompare(a.PartnerFunction)); 
                if(aResults && aResults.length > 0){
                    Supplier = aResults[2].Supplier
                };
                eshipjetModel.setProperty("/commonValues/ShipNowShipMethodSelectedKey", Supplier);
                oController.onShopNowShipMethodAfterChange(Supplier);
                for (var i = 0; i < aResults.length; i++) {               
                    sPath = "/A_OutbDeliveryHeader('"+ sDocNumber +"')/to_DeliveryDocumentPartner(PartnerFunction='"+ aResults[i].PartnerFunction + "',SDDocument='"+ sDocNumber +"')/to_Address";
                    oDeliveryModel.read(sPath,{ "groupId":"addressDefferedgroupID", "merge":false});                               
                }
                oDeliveryModel.submitChanges({
                    "groupId":"addressDefferedgroupID",
                    success: function(oData){
                        //oController.oBusyDialog.close();
                        if(oData &&  oData.__batchResponses &&  oData.__batchResponses.length > 0){
                            oData.__batchResponses.map(function(currentValue, index, arr){
                                if(index == 0){
                                    currentValue.data["PartnerType"]  = "Ship From";
                                    currentValue.data["FullName"]  = "Steve Marsh";
                                    currentValue.data["BusinessPartnerName1"]  = "Eshipjet Software Inc.";
                                    currentValue.data["StreetName"]  = "5717 Legacy";
                                    currentValue.data["HouseNumber"]  = "Suite 250";
                                    currentValue.data["Region"]  = "TX";
                                    currentValue.data["CityName"]  = "Plano";
                                    currentValue.data["PostalCode"]  = "75024";
                                    currentValue.data["Country"]  = "US";
                                    currentValue.data["email"]  = "info@eshipjet.ai";
                                }else if(index == 1){
                                    currentValue.data["PartnerType"]  = "Ship To";
                                }else {
                                    currentValue.data["PartnerType"]  = "Freight Forwarder";
                                }
                                aBusinessPartnerTable.push(currentValue.data);                           
                            });
                                                    
                            var  Obj = {
                                "ShipFromCONTACT": "Steve Marsh",
                                "ShipFromCOMPANY": "Eshipjet Software Inc.",
                                "ShipFromPHONE": "(888) 464-2360",
                                "ShipFromEMAIL": "info@eshipjet.ai",
                                "ShipFromCITY": "Plano",
                                "ShipFromSTATE": "TX",
                                "ShipFromCOUNTRY": "US",
                                "ShipFromZIPCODE": "75024",
                                "ShipFromADDRESS_LINE1": "5717 Legacy",
                                "ShipFromADDRESS_LINE2": "Suite 250",
                                "ShipFromADDRESS_LINE3": "",
                                "LocationType": "Commercial"
                            };
                            oShipNowModel.setProperty("/ShipFromAddress",Obj);
                            aBusinessPartnerTable[1]["LocationType"] = "Commercial"
                            oShipNowModel.setProperty("/ShipToAddress",aBusinessPartnerTable[1]);
                            eshipjetModel.setProperty("/BusinessPartners",aBusinessPartnerTable);
                            eshipjetModel.setProperty("/InternationalDetails/shipFromTaxNo",aBusinessPartnerTable[0].TaxJurisdiction);
                            oShipNowModel.updateBindings(true);
                            eshipjetModel.updateBindings(true);
                        }
                    resolve();
                    eshipjetModel.setProperty("/commonValues/shipNowGetBtn", false);      
                }, error: function(oErr){
                    resolve();
                    oController.onCloseBusyDialog();
                    console.log(oErr);
                }});                
            });  
            Promise.all([promise1]).then((values) => {
                // invoking Shipping Rates from "Quote Now" Screen
                let sFromScreen = eshipjetModel.getProperty("/sFromViewName");
                if(sFromScreen === "QUOTE_NOW"){
                    var getShipRatePromise = new Promise((resolve, reject) => {
                        oController.onOpenBusyDialog();
                        oController.onShipRateRequest(resolve, reject, "QUOTE_NOW");
                    });
                }
                // if(sFromMenu === "ScanAndShip"){
                //     oController.onShipNowPress();
                // }    
            });
        },

        onPackPress1:function(){
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            var Notes = eshipjetModel.getProperty("/Notes")
            Notes.push({
                "date": new Date(),
                "name": eshipjetModel.getProperty("/userName"),
                "notes": "Items are packed sucessfully"
            });

            var productTable = this.byId("idShipNowPackTable");
            var selectedItems = productTable.getSelectedIndices();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var selectedPackageMat = eshipjetModel.getProperty("/selectedPackageMat");

            var packAddProductTable = eshipjetModel.getProperty("/commonValues/packAddProductTable");
            var tableCount = 0;

            packAddProductTable.forEach(function(item) {
                if (item.Material) {
                    tableCount += 1;
                }
            });
            if(selectedPackageMat === ""){
                MessageBox.warning("Please Select Package Material");
            }else if(selectedItems.length !== 0 && tableCount !== 1){
                MessageBox.warning("Please Select atleast one record from Product Table");
            }else{
                var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
                var totalWeight = 0;
                var ItemsInfo = [];
                for (var i = 0; i < 1; i++) {
                    var currentObj = productTable.getContextByIndex(i).getObject();
                    if(currentObj.partialQty === "" || currentObj.partialQty === undefined){
                        MessageBox.warning("Please add partial quantity for at least one valid product.");
                    }else{
                        oController.onOpenBusyDialog();
                        var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
                        var sapDeliveryNumber = eshipjetModel.getProperty("/commonValues/sapDeliveryNumber");
                        var partialQty = eshipjetModel.getProperty("/partialQty");
                        var Material = eshipjetModel.getProperty("/Material");
                        var pkgMaterial = eshipjetModel.getProperty("/selectedPackageMat")

                        var oPayload = {
                            "Pacmatnr": "EWMS4-WBTRO00",
                            "Delivery": sapDeliveryNumber,
                            "Qty": currentObj.partialQty,
                            "Itemno": "10"
                        };
                        
                        var CreateHUSrvModel = oController.getOwnerComponent().getModel("CreateHUSrvModel");
                        CreateHUSrvModel.create("/HUHEADERSet", oPayload, {
                            success: function (oData) {
                                // oController.readHUDataSet(sapDeliveryNumber);
                                MessageToast.show("Handling Unit Created Successfully");
                                currentObj.partialQty = "";
                                eshipjetModel.updateBindings(true);
                                oController.getHandlingUnit(sapDeliveryNumber);
                                // oController.onCloseBusyDialog();

                                // var sAudioPath = sap.ui.require.toUrl("com/eshipjetcopy/zeshipjetcopy/audio/PackToHU.mp3");
                                // var audio = new Audio(sAudioPath);
                                // audio.play();
                            },
                            error: function (oError) {
                                // var errMsg = JSON.parse(oError.responseText).error.message.value;
                                var errMsg = new DOMParser().parseFromString(oError.responseText, "text/xml").getElementsByTagName("message")[0].textContent;
                                sap.m.MessageBox.error(errMsg);
                                oController.onCloseBusyDialog();
                            }
                        });

                        // var oPayload = {
                        //     "Vbeln": sapDeliveryNumber,
                        //     "Posnr": "000010",
                        //     "Matnr": currentObj.Material,
                        //     "Qty": currentObj.partialQty,
                        //     "Humatnr": selectedPackageMat
                        // };
                        
                        // var ShipReadDataSrvModel = oController.getOwnerComponent().getModel("ShipReadDataSrvModel");
                        // ShipReadDataSrvModel.create("/HuDataSet", oPayload, {
                        //     success: function (oData) {
                        //         oController.readHUDataSet(sapDeliveryNumber);
                        //         MessageToast.show("Handling Unit Created Successfully");
                        //         currentObj.partialQty = "";
                        //         eshipjetModel.updateBindings(true);
                        //         // oController.onCloseBusyDialog();

                        //         // var sAudioPath = sap.ui.require.toUrl("com/eshipjetcopy/zeshipjetcopy/audio/PackToHU.mp3");
                        //         // var audio = new Audio(sAudioPath);
                        //         // audio.play();
                        //     },
                        //     error: function (oError) {
                        //         // var errMsg = JSON.parse(oError.responseText).error.message.value;
                        //         var errMsg = new DOMParser().parseFromString(oError.responseText, "text/xml").getElementsByTagName("message")[0].textContent;
                        //         sap.m.MessageBox.error(errMsg);
                        //         oController.onCloseBusyDialog();
                        //     }
                        // });
                    }        
                }
            }
        },

        onMultiPackPress: function () {
            var oController = this;
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            var Notes = eshipjetModel.getProperty("/Notes");
            Notes.push({
                "date": new Date(),
                "name": eshipjetModel.getProperty("/userName"),
                "notes": "Items are packed successfully"
            });
        
            var productTable = this.byId("idShipNowPackTable");
            var selectedItems = productTable.getSelectedIndices();
            var selectedPackageMat = eshipjetModel.getProperty("/selectedPackageMat");
        
            if (selectedPackageMat === "") {
                MessageBox.warning("Please Select Package Material");
                return;
            } else if (selectedItems.length === 0) {
                MessageBox.warning("Please Select at least one record from Product Table");
                return;
            }
        
            var sapDeliveryNumber = eshipjetModel.getProperty("/commonValues/sapDeliveryNumber");
            var pkgMaterial = eshipjetModel.getProperty("/selectedPackageMat");
            var CreateHUSrvModel = this.getOwnerComponent().getModel("CreateHUSrvModel");
        
            // Enable batch mode
            CreateHUSrvModel.setUseBatch(true);
            CreateHUSrvModel.setDeferredGroups(["batchGroup1"]);
            var mParameters = {
                groupId: "batchGroup1"
            };
        
            var hasError = false;
        
            for (var i = 0; i < selectedItems.length; i++) {
                var context = productTable.getContextByIndex(selectedItems[i]);
                var currentObj = context.getObject();
        
                var partialQty = currentObj.partialQty;
                var BalanceQty = currentObj.BalanceQty;
        
                if (!partialQty || partialQty <= 0) {
                    hasError = true;
                    MessageBox.warning("Please enter a valid partial quantity for all selected products.");
                    break;
                }
        
                var times = Math.floor(BalanceQty / partialQty);
                if (times === 0) {
                    hasError = true;
                    MessageBox.warning("Partial quantity is more than the Balance quantity for one of the items.");
                    break;
                }
        
                for (var j = 0; j < times; j++) {
                    var oPayload = {
                        "Pacmatnr": "EWMS4-WBTRO00",
                        "Delivery": sapDeliveryNumber,
                        "Qty": partialQty,
                        "Itemno": "10"
                    };
                    CreateHUSrvModel.create("/HUHEADERSet", oPayload, mParameters);
                }
            }
        
            if (!hasError) {
                oController.onOpenBusyDialog();
        
                CreateHUSrvModel.submitChanges({
                    groupId: "batchGroup1",
                    success: function (oData, oResponse) {
                        MessageToast.show("Handling Units Created Successfully");
                        for (var k = 0; k < selectedItems.length; k++) {
                            var obj = productTable.getContextByIndex(selectedItems[k]).getObject();
                            obj.partialQty = ""; // Clear input field
                        }
                        eshipjetModel.updateBindings(true);
                        oController.getHandlingUnit(sapDeliveryNumber);
                        oController.onCloseBusyDialog();
                    },
                    error: function (oError) {
                        var errMsg = new DOMParser().parseFromString(oError.responseText, "text/xml").getElementsByTagName("message")[0].textContent;
                        MessageBox.error(errMsg);
                        oController.onCloseBusyDialog();
                    }
                });
            }
        },

        readNewHUDataSet:function(oData){
            let oFilter, aHandlingUnits = [];
            oFilter = [];
            oFilter.push(new Filter("Delivery", "EQ", oData.Delivery));
            oFilter.push(new Filter("Hunumber", "EQ", oData.Hunumber));
            oFilter.push(new Filter("Itemno", "EQ", oData.Itemno));
            var CreateHUSrvModel = oController.getOwnerComponent().getModel("CreateHUSrvModel");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            CreateHUSrvModel.read("/HUDETAILSSet",{
                filters: oFilter,
                success:function(oData){
                    var getManifestHeader = eshipjetModel.getProperty("/getManifestHeader");
                    if(oData && oData.results && oData.results.length > 0){
                        for(var i = 0; i < oData.results.length; i++){
                            oData.results[i]["SerialNumber"] = i + 1;
                            aHandlingUnits.push(oData.results[i]);
                            oData.results[i]["boxCount"] = "1";
                        };
                        eshipjetModel.setProperty("/HandlingUnits", aHandlingUnits);

                        var HandlingUnits = eshipjetModel.getProperty("/HandlingUnits");
                        if(getManifestHeader && getManifestHeader.length > 0){
                            for(var i=0; i<getManifestHeader.length; i++){
                                HandlingUnits[i]["TrackingNumber"] = getManifestHeader[i].TrackingNumber;
                                HandlingUnits[i]["CarrierCode"] = eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey");
                            }
                        };

                    }else{
                        eshipjetModel.setProperty("/HandlingUnits", aHandlingUnits);
                        oController.onPackSectionEmptyRows();
                    }
                    var sFromScreen = eshipjetModel.getProperty("/sFromViewName");
                    if(sFromScreen !== "QUOTE_NOW"){
                        oController.onCloseBusyDialog();
                    }
                    if(sFromScreen === "SCAN_SHIP"){
                        oController.onShipNowPress();
                    } 
                },
                error: function(oErr){
                    console.log(oErr);                        
                    oController.onCloseBusyDialog();
                }
            });
        },

        readHUDataSet:function(sapDeliveryNumber){
            let oFilter, aHandlingUnits = [];
            oFilter = [];
            oFilter.push(new Filter("HandlingUnitReferenceDocument", "EQ", sapDeliveryNumber));
            var oHandlingUnitModel = oController.getOwnerComponent().getModel("HandlingUnitModel");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            oHandlingUnitModel.read("/HandlingUnit",{
                urlParameters: {
                    "$expand": "to_HandlingUnitItem"
                },
                filters: oFilter,
                success:function(oData){
                    var getManifestHeader = eshipjetModel.getProperty("/getManifestHeader");
                    if(oData && oData.results && oData.results.length > 0){
                        for(var i = 0; i < oData.results.length; i++){
                            oData.results[i]["SerialNumber"] = i + 1;
                            aHandlingUnits.push(oData.results[i]);
                            oData.results[i]["boxCount"] = "1";
                        };
                        eshipjetModel.setProperty("/HandlingUnits", aHandlingUnits);
                        oController.getHandlingUnit(aHandlingUnits);
                        // oController.readNewHUDataSet(aHandlingUnits);

                        var HandlingUnits = eshipjetModel.getProperty("/HandlingUnits");
                        if(getManifestHeader && getManifestHeader.length > 0){
                            for(var i=0; i<getManifestHeader.length; i++){
                                HandlingUnits[i]["TrackingNumber"] = getManifestHeader[i].TrackingNumber;
                                HandlingUnits[i]["CarrierCode"] = eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey");
                            }
                        };

                    }else{
                        eshipjetModel.setProperty("/HandlingUnits", aHandlingUnits);
                        oController.onPackSectionEmptyRows();
                    }
                    var sFromScreen = eshipjetModel.getProperty("/sFromViewName");
                    if(sFromScreen !== "QUOTE_NOW"){
                        oController.onCloseBusyDialog();
                    }
                    if(sFromScreen === "SCAN_SHIP"){
                        oController.onShipNowPress();
                    } 
                },
                error: function(oErr){
                    console.log(oErr);                        
                    oController.onCloseBusyDialog();
                }
            });
        },

        onPackAllPress: function () {
            var oController = this;
            var oModel = this.getOwnerComponent().getModel("OutBoundDeliveryModel");
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            var currentHUList = eshipjetModel.getProperty("/ShipNowHandlingUnits") || [];
            var oTable = this.byId("idShipNowPackTable");
            var GetDeliveryData = eshipjetModel.getProperty("/GetDeliveryData");
            var packAddProductTable = GetDeliveryData.to_Items.results;
            var selectedPackageMat = eshipjetModel.getProperty("/selectedPackageMat");

            // ðŸŸ¡ Validate package material
            if (!selectedPackageMat || selectedPackageMat === "") {
                sap.m.MessageBox.warning("Please select Package Material");
                return;
            }

            // ðŸŸ¢ Add note
            var Notes = eshipjetModel.getProperty("/Notes");
            Notes.push({
                "date": new Date(),
                "name": eshipjetModel.getProperty("/userName"),
                "notes": "All Items are packed successfully"
            });
            eshipjetModel.updateBindings(true);

            // ðŸŸ¢ Filter only valid rows (with DeliveryDocument)
            var validItems = packAddProductTable.filter(function (item) {
                return item.DeliveryDocument !== undefined && item.BalanceQty > 0;
            });

            if (validItems.length === 0) {
                sap.m.MessageBox.warning("No valid items found to pack.");
                return;
            }

            // ðŸŸ¢ Start Busy Indicator
            oController.onOpenBusyDialog();

            // ðŸŸ¢ Prepare batch operations
            oModel.setUseBatch(true);
            oModel.setDeferredGroups(["isProjectUploadBatch"]);

            oModel.refreshSecurityToken(function () {
                // ðŸ”¹ 1. Create HU Header
                var headerDataObj = {
                    HandlingUnitExternalId: "$1",
                    PackagingMaterial: selectedPackageMat,
                    DeliveryDocument: GetDeliveryData.DeliveryDocument
                };

                oModel.create("/A_HandlingUnitHeaderDelivery", headerDataObj, {
                    groupId: "isProjectUploadBatch"
                });

                // ðŸ”¹ 2. Create HU Items for each line
                validItems.forEach(function (currentObj) {
                    var oItem = {
                        HandlingUnitExternalId: "$1", // link to the same HU
                        HandlingUnitTypeOfContent: "1",
                        DeliveryDocument: GetDeliveryData.DeliveryDocument,
                        DeliveryDocumentItem: currentObj.DeliveryDocumentItem,
                        HandlingUnitQuantity: currentObj.BalanceQty.toString(),
                        HandlingUnitQuantityUnit: currentObj.BaseUnit || "PC",
                        Material: currentObj.Material
                    };

                    oModel.create("/A_HandlingUnitItemDelivery", oItem, {
                        groupId: "isProjectUploadBatch"
                    });
                });

                // ðŸ”¹ 3. Submit batch
                oModel.submitChanges({
                    groupId: "isProjectUploadBatch",
                    success: function (oData) {
                        oController.readHUData();

                            // 2. Also update the table immediately (optimistic update)
                            var currentHUList = eshipjetModel.getProperty("/ShipNowHandlingUnits") || [];

                            // Add new HU header entry
                            var newHU = {
                                SerialNumber: currentHUList.length + 1,
                                HandlingUnitExternalID: "$1",     // backend will replace
                                CreatedByUser: eshipjetModel.getProperty("/userName") || "User",
                                GrossWeight: "",
                                Dimensions: "",
                                HandlingUnitPackingObjectType: selectedPackageMat || "",
                                HandlingUnitInternalID: "",
                                Hunumber: "",
                                HandlingUnitIsClosed: false,
                                PackagingMaterial: selectedPackageMat || "",
                                HuLabel: ""
                            };

                            currentHUList.push(newHU);

                            eshipjetModel.setProperty("/ShipNowHandlingUnits", currentHUList);
                            eshipjetModel.updateBindings(true);

                            oController.onCloseBusyDialog();
                            sap.m.MessageToast.show("All items packed successfully.");
                        // oController.readTodayHUData();
                        oController.onCloseBusyDialog();

                        sap.m.MessageToast.show("All items packed successfully.");
                        console.log("HU Batch created:", oData);
                    },
                    error: function (oError) {
                        oController.onCloseBusyDialog();
                        oController._showODataError(oError);
                    }
                });

            }, function (err) {
                oController.onCloseBusyDialog();
                console.error("CSRF token refresh failed:", err);
                sap.m.MessageBox.error("Could not fetch CSRF token!");
            });
        },

        // onShipNowCodEditPress:function(){
        //     var oView = this.getView();
        //     if (!this.byId("idCodEditDialog")) {
        //         Fragment.load({
        //             id: oView.getId(),
        //             name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.CodEditDialog",
        //             controller: this // Pass the controller for binding
        //         }).then(function (oCodEditDialog) {
        //             oView.addDependent(oCodEditDialog);
        //             oCodEditDialog.open();
        //         });
        //     } else {
        //         this.byId("idCodEditDialog").open(); // Open existing dialog
        //     }

            
        // },

        // onCodEditDialogCancelPress: function () {
        //     this.byId("idCodEditDialog").close();
        // },

       

        onDryIceEditPress: function (oEvent) {
            var oView = this.getView();
            var oSource = oEvent.getSource(); 
        
            if (!this._oDryIceEditDialog) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.DryIceEditDialog",
                    controller: this
                }).then(function (oPopover) {
                    this._oDryIceEditDialog = oPopover;
                    oView.addDependent(this._oDryIceEditDialog);
                    this._oDryIceEditDialog.openBy(oSource); 
                }.bind(this));
            } else {
                this._oDryIceEditDialog.openBy(oSource);
            }
        },
        
        onDryIceEditDialogClosePress: function () {
            if (this._oDryIceEditDialog) {
                this._oDryIceEditDialog.close();
            }
        },

        onOpenBatteryDialog: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenBatteryEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.FedExBatteryEditDialog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenBatteryEditDialog").open();
            }
        },

        onCloseBatteryDialog: function() {
            this.byId("_IDGenBatteryEditDialog").close();
        },

        onOpenFedExDeliveryIncAcceptDialog: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenFedExDeliveryIncAcceptEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.FedExDeliveryIncAcceptEditDialog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenFedExDeliveryIncAcceptEditDialog").open();
            }
        },

        onCloseFedExDeliveryIncAcceptDialog: function() {
            this.byId("_IDGenFedExDeliveryIncAcceptEditDialog").close();
        },

        onOpenFedExBrokerSelectDialog: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenFedExBrokerSelectEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.FedExBrokerSelectEditDialog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenFedExBrokerSelectEditDialog").open();
            }
        },

        onCloseFedExBrokerSelectDialog: function() {
            this.byId("_IDGenFedExBrokerSelectEditDialog").close();
        },


        onOpenAlcoholDialog: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenAlcoholEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.FedExAlcoholEditDialog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenAlcoholEditDialog").open();
            }
        },

        onCloseAlcoholDialog: function() {
            this.byId("_IDGenAlcoholEditDialog").close();
        },

         HUDialogPress: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenHULabelDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.HULabelDialog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenHULabelDialog").open();
            }
        },

        onCloseAlcoholDialog: function() {
            this.byId("_IDGenHULabelDialog").close();
        },

        onOpenFedExHoldAtLoctionEditDialog: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenFedExHoldAtLoctionEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.FedExHoldAtLoctionEditDialog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenFedExHoldAtLoctionEditDialog").open();
            }
        },

        onCloseHoldAtLoctionDialog: function() {
            this.byId("_IDGenFedExHoldAtLoctionEditDialog").close();
        },

        onOpenFedExETDDetailEditDialog: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenFedExETDDetailEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.FedExETDDetailEditDialog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenFedExETDDetailEditDialog").open();
            }
        },

        onCloseETDDetailDialog: function() {
            this.byId("_IDGenFedExETDDetailEditDialog").close();
        },

        onOpenFedexInternationalTrafficInArmsRegulationsDetailEditDialog: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenFedexInternationalTrafficInArmsRegulationsDetailEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.FedexInternationalTrafficInArmsRegulationsDetailEditDialog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenFedexInternationalTrafficInArmsRegulationsDetailEditDialog").open();
            }
        },

        onCloseFedexInternationalTrafficInArmsRegulationsDetailEditDialog: function() {
            this.byId("_IDGenFedexInternationalTrafficInArmsRegulationsDetailEditDialog").close();
        },


        onOpenFedexEmailReturnLabelEditDialog: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenFedExEmailReturnLabelEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.FedExEmailReturnLabelEditDialog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenFedExEmailReturnLabelEditDialog").open();
            }
        },

        onCloseFedexEmailReturnLabelEditDialog: function() {
            this.byId("_IDGenFedExEmailReturnLabelEditDialog").close();
        },

        onOpenFedexHomeDeliveryEditDialog: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenFedExHomeDeliveryEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.FedExHomeDeliveryEditDialog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenFedExHomeDeliveryEditDialog").open();
            }
        },

        onCloseFedexHomeDeliveryEditDialog: function() {
            this.byId("_IDGenFedExHomeDeliveryEditDialog").close();
        },

        onOpenFedexPendingShipmentDetailEditDialog: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenFedExPendingShipmentDetailEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.FedExPendingShipmentDetailEditDialog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenFedExPendingShipmentDetailEditDialog").open();
            }
        },

        onCloseFedexPendingShipmentDetailEditDialog: function() {
            this.byId("_IDGenFedExPendingShipmentDetailEditDialog").close();
        },


        onOpenFedexInternationalControlledExportEditDialog: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenFedExInternationalControlledExportEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.FedExInternationalControlledExportEditDialog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenFedExInternationalControlledExportEditDialog").open();
            }
        },

        onCloseFedexInternationalControlledExportEditDialog: function() {
            this.byId("_IDGenFedExInternationalControlledExportEditDialog").close();
        },

        onOpenFedexPrintReturnLabelEditDialog: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenFedExPrintReturnLabelEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.FedExPrintReturnLabelEditDialog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenFedExPrintReturnLabelEditDialog").open();
            }
        },

        onCloseFedexPrintReturnLabelEditDialog: function() {
            this.byId("_IDGenFedExPrintReturnLabelEditDialog").close();
        },

        onOpenFedexHomeDeliveryPremiumEditDialog: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenFedExHomeDeliveryPremiumEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.FedExHomeDeliveryPremiumEditDilog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenFedExHomeDeliveryPremiumEditDialog").open();
            }
        },

        onCloseFedexHomeDeliveryPremiumEditDialog: function() {
            this.byId("_IDGenFedExHomeDeliveryPremiumEditDialog").close();
        },

        onOpenFedexShipmentCODDetailEditDialog: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenFedExShipmentCODDetailEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.FedExShipmentCODDetailEditDialog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenFedExShipmentCODDetailEditDialog").open();
            }
        },

        onCloseFedexShipmentCODDetailEditDialog: function() {
            this.byId("_IDGenFedExShipmentCODDetailEditDialog").close();
        },

        onOpenFedexShipmentCODDetailEditDialog: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenFedExShipmentCODDetailEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.FedExShipmentCODDetailEditDialog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenFedExShipmentCODDetailEditDialog").open();
            }
        },

        onCloseFedexShipmentCODDetailEditDialog: function() {
            this.byId("_IDGenFedExShipmentCODDetailEditDialog").close();
        },

         onOpenUPSHazMatEditDialog: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenUPSHazMatEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.UPSHazMatEditDialog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenUPSHazMatEditDialog").open();
            }
        },

        onCloseUPSHazMatEditDialog: function() {
            this.byId("_IDGenUPSHazMatEditDialog").close();
        },


        onOpenUPSImportControlEditDialog: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenUPSImportControlEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.UPSImportControlEditDialog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenUPSImportControlEditDialog").open();
            }
        },

        onCloseUPSImportControlEditDialog: function() {
            this.byId("_IDGenUPSImportControlEditDialog").close();
        },

        onOpenUPSCODInformationEditDialog: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenUPSCODInformationEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.UPSCODInformationEditDialog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenUPSCODInformationEditDialog").open();
            }
        },

        onCloseUPSCODInformationEditDialog: function() {
            this.byId("_IDGenUPSCODInformationEditDialog").close();
        },
 
        
        onHoldAtLocationEditPress: function () {
            var oView = this.getView();
            if (!this.byId("idHoldAtLocationEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.HoldAtLocationEditDialog",
                    controller: this // Pass the controller for binding
                }).then(function (oHoldAtLocationEditDialog) {
                    oView.addDependent(oHoldAtLocationEditDialog);
                    oHoldAtLocationEditDialog.open();
                });
            } else {
                this.byId("idHoldAtLocationEditDialog").open(); // Open existing dialog
            }
        },

        onHoldAtLocationEditDialogClosePress: function () {
            this.byId("idHoldAtLocationEditDialog").close();
        },

        onReturnLabelEditPress: function () {
            var oView = this.getView();
            if (!this.byId("idReturnLabelEditDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.ReturnLabelEditDialog",
                    controller: this // Pass the controller for binding
                }).then(function (oReturnLabelEditDialog) {
                    oView.addDependent(oReturnLabelEditDialog);
                    oReturnLabelEditDialog.open();
                });
            } else {
                this.byId("idReturnLabelEditDialog").open(); // Open existing dialog
            }
        },

        onReturnLabelEditDialogClosePress: function () {
            this.byId("idReturnLabelEditDialog").close();
        },

        onShipNowDocPress:function(oEvent){
            var sLabel = oEvent.getSource().mProperties.text;
            var dataUrl = "https://eshipjetsatge.blob.core.windows.net/shipping-labels/" + sLabel;

            if (!oController._shipNowDocDialog) {
                oController._shipNowDocDialog = new Dialog({
                    title: "Ship Now Document",
                    contentWidth: "30%", // Adjust width as needed
                    contentHeight: "70%", // Adjust height as needed
                    content: new sap.m.Image({
                        class: "sapUiSmallMargin",
                        src: dataUrl,
                        width: "100%", // Full width of dialog content
                        height: "100%"
                    }),
                    endButton: new sap.m.Button({
                        text: "Close",
                        press: function () {
                            oController._shipNowDocDialog.close();
                        }.bind(oController)
                    })
                });
            }
            oController._shipNowDocDialog.open();
        },

        onSerialNumPress:function(oEvent){
            var currentObj = oEvent.getSource().getBindingContext("eshipjetModel").getObject();
            var serialNumberData = {
                "Vbeln": currentObj.HandlingUnitReferenceDocument
            };
            eshipjetModel.setProperty("/serialNumberData", serialNumberData);
            var oView = this.getView();
            if (!this.byId("_IDGenSerialNumberDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SerialNumberDialog",
                    controller: this
                }).then(function(oSerialNumberDialog) {
                    oView.addDependent(oSerialNumberDialog);
                    oSerialNumberDialog.open();
                });
            } else {
                this.byId("_IDGenSerialNumberDialog").open();
            }
        },

        onCloseSerialNumDialog:function(){
            this.byId("_IDGenSerialNumberDialog").close();
        },

        // Ship Now Changes End here

        // Scan & Ship Code Changes Start
        _handleDisplayShipNowProductsTable:function(){
            const oView = oController.getView();
            var columnName, label, oTemplate, oHboxControl;
            const oTable = oView.byId("idShipNowProductTable");
            oTable.setModel(eshipjetModel);
            var ShipNowProductsTableColumns = eshipjetModel.getProperty("/ShipNowProductsTableColumns");
            var count = 0;
            for (var i = 0; i < ShipNowProductsTableColumns.length; i++) {
                if (ShipNowProductsTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/ShipNowProductsTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().name;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "deleteIcon") {
                    var Btn1 = new sap.m.Button({ icon: "sap-icon://delete", type: "Transparent",
                        press: function (oEvent) {
                            oController.handleDownArrowPress(oEvent);
                        }
                    });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://delete", type: "Transparent",
                        press: function (oEvent) {
                            oController.handleDownArrowPress(oEvent);
                        }
                    });
                    return new sap.ui.table.Column({
                        label: Btn2,
                        template: Btn1,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    var template = new sap.m.Text({
                        text: {
                            path: columnName
                        }
                    });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: template,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/pickAddProductTable");
        },

        getScanShipHistoryShipments:function(){
            oController.onOpenBusyDialog();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var ManifestSrvModel = oController.getOwnerComponent().getModel("ManifestSrvModel");
            var RecentShipmentTab = eshipjetModel.getProperty("/RecentShipmentTab");
            ManifestSrvModel.read("/EshipjetManfestSet",{
                // urlParameters: {
                //     "$expand": "to_DeliveryDocumentItem,to_DeliveryDocumentPartner"
                // },
                success:function(response){
                    if (response && response.results.length > 0) {
                        // Get today's date info
                        const today = new Date();
                        const currentDate = today.getDate();
                        const currentMonth = today.getMonth(); // 0-based index
                        const currentYear = today.getFullYear();
        
                        // Filter to include only today's entries
                        const filteredResults = response.results.filter(item => {
                            const itemDate = new Date(item.DateAdded);
                            return itemDate.getDate() === currentDate &&
                                   itemDate.getMonth() === currentMonth &&
                                   itemDate.getFullYear() === currentYear;
                        });
        
                        // Sort filtered results by date and time
                        filteredResults.sort((a, b) => {
                            let dateA = new Date(a.DateAdded).getTime();
                            let dateB = new Date(b.DateAdded).getTime();
        
                            if (dateA !== dateB) {
                                return dateB - dateA; // Descending by date
                            }
        
                            return b.TimeAdded.ms - a.TimeAdded.ms; // Descending by time
                        });
        
                        // Normalize shipment type
                        filteredResults.forEach(item => {
                            let shipmentValue = item.Type || item.Shipmenttype || item.ShipmentType;
                            if (shipmentValue && typeof shipmentValue === "string") {
                                shipmentValue = shipmentValue.trim().toUpperCase();
                                item.Shipmenttype = shipmentValue === 'O' ? "Parcel" : "LTL";
                            } else {
                                item.Shipmenttype = "LTL";
                            }
                        });
        
                        // Set the filtered results to the model
                        eshipjetModel.setProperty("/scanShipTableData2", filteredResults);
                        eshipjetModel.setProperty("/TodayScanShipmentsLength", filteredResults.length);
                    }
                    oController.onCloseBusyDialog();
                },
                error: function(error){
                    MessageBox.warning(error.responseText);
                    oController.onCloseBusyDialog();
                }
            });
        },

        openShipNowProductsColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pShipNowProductsPopover) {
                this._pShipNowProductsPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.ShipNowProductsTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pShipNowProductsPopover.then(function (oPopover) {
                oController.ShipNowProductsColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        ShipNowProductsColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/ShipNowProductsTableColumns");
            var oShipNowProductsTable = oView.byId("myShipNowProductsColumnSelectId");
            var aTableItems = oShipNowProductsTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.name === oItem.getBindingContext("eshipjetModel").getObject().name && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onShipNowProductsColSelectOkPress: function () {
            var oView = this.getView()
            var oShipNowProductsTable = oView.byId("myShipNowProductsColumnSelectId");
            var eshipjetModel = oView.getModel("eshipjetModel");
            var oShipNowProductsTblItems = oShipNowProductsTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/ShipNowProductsTableColumns");
            oShipNowProductsTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().name === oColObj.name) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            this._handleDisplayShipNowProductsTable();
            this._pShipNowProductsPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onShipNowProductsColSelectClosePress: function () {
            this._pShipNowProductsPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onShipNowProductsColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myShipNowProductsColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },        

        _handleDisplayShipNowHandlingUnitTable:function(){
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            const oTable = oView.byId("idShipNowHandlingUnitTable");
            oTable.setModel(eshipjetModel);
            var ShipNowHandlingUnitTableColumns = eshipjetModel.getProperty("/ShipNowHandlingUnitTableColumns");
            var count = 0;
            for (var i = 0; i < ShipNowHandlingUnitTableColumns.length; i++) {
                if (ShipNowHandlingUnitTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/ShipNowHandlingUnitTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().name;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "DeleteIcon") {
                    var Btn1 = new sap.m.Button({ icon: "sap-icon://delete", type: "Critical" });
                    return new sap.ui.table.Column({
                        label: Btn1,
                        template: Btn1,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: Btn1
                    });
                } else if (columnName === "H.U."){
                    var template = new sap.m.Link({
                        text: {
                            path: columnName
                        }
                    });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: template,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "Weight"){
                    var template = new sap.m.Input({
                        value: {
                            path: columnName
                        }
                    });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: template,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "WeightUnits"){
                    var template = new sap.m.Input({
                        value: {
                            path: columnName
                        }
                    });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: template,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "Dimensions"){
                    var template = new sap.m.Input({
                        value: {
                            path: columnName
                        }
                    });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: template,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    var template = new sap.m.Text({
                        text: {
                            path: columnName
                        }
                    });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: template,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/HandlingUnits");
        },

        openShipNowHandlingUnitColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pShipNowHandlingUnitPopover) {
                this._pShipNowHandlingUnitPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.ShipNowHandlingUnitTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pShipNowHandlingUnitPopover.then(function (oPopover) {
                oController.ShipNowHandlingUnitColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        ShipNowHandlingUnitColumnsVisiblity: function () {
            var oView = oController.getView();            
            var aColumns = eshipjetModel.getProperty("/ShipNowHandlingUnitTableColumns");
            var oShipNowHandlingUnitTable = oView.byId("myShipNowHandlingUnitColumnSelectId");
            var aTableItems = oShipNowHandlingUnitTable.getItems();
            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.name === oItem.getBindingContext("eshipjetModel").getObject().name && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onShipNowHandlingUnitColSelectOkPress: function () {
            var oView = oController.getView()
            var oShipNowHandlingUnitTable = oView.byId("myShipNowHandlingUnitColumnSelectId");            
            var oShipNowHandlingUnitTblItems = oShipNowHandlingUnitTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/ShipNowHandlingUnitTableColumns");
            oShipNowHandlingUnitTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().name === oColObj.name) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            this._handleDisplayShipNowHandlingUnitTable();
            this._pShipNowHandlingUnitPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onShipNowHandlingUnitColSelectClosePress: function () {
            this._pShipNowHandlingUnitPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onShipNowHandlingUnitColNameSearch: function (oEvent) {
            let aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myShipNowHandlingUnitColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        _handleDisplayScanShipTable: function () {            
            const oView = oController.getView();
            var columnName, label, oTemplate, oHboxControl;
            var scanShipTableData = eshipjetModel.getProperty("/scanShipTableData");
            var ScanShipTableDataModel = new JSONModel(scanShipTableData);
            oController.getOwnerComponent().setModel(ScanShipTableDataModel, "ScanShipTableDataModel");
            var oTable = oView.byId("idScanAndShipTable");
            
            var ScanShipTableDataModel = oController.getOwnerComponent().getModel("ScanShipTableDataModel");
            oTable.setModel(ScanShipTableDataModel);
            var columns = ScanShipTableDataModel.getProperty("/columns");
            var count = 0;
            for (var i = 0; i < columns.length; i++) {
                if (columns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/columns", function (sId, oContext) {
                columnName = oContext.getObject().name;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "Ship Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            oController.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "CreatedDate" || columnName === "ShipDate") {
                    var template = new sap.m.Text({
                        text: {
                            path: columnName,
                            formatter: function (date) {
                                if (date) {
                                    var oDateFormat = sap.ui.core.format.DateFormat.getDateInstance({ pattern: "MM/dd/yyyy" });
                                    return oDateFormat.format(new Date(date));
                                }
                                return "";
                            }
                        }
                    });

                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: template,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    var template = new sap.m.Text({
                        text: {
                            path: columnName
                        }
                    });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: template,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/rows");
            oTable.updateBindings(true);
        },

        openScanShipColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
                var oController = this;
            if (!this._pScanPopover) {
                this._pScanPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ScanAndShip.ScanShipTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pScanPopover.then(function (oPopover) {
                oController._syncScanShipColumnSelections();
                oPopover.openBy(oButton);
            });
        },
        onScanShipColSelectClosePress: function () {
            var oPopover = Fragment.byId(this.getView().getId(), "myPopover");
            if (oPopover) {
                oPopover.close();
            }
        },
        
        _syncScanShipColumnSelections: function () {
            var oTable = Fragment.byId(this.getView().getId(), "myScanColumnSelectId");
            if (!oTable) return;
        
            var aItems = oTable.getItems();
            aItems.forEach(function (oItem) {
                var oContext = oItem.getBindingContext("eshipjetModel");
                if (oContext) {
                    var oData = oContext.getObject();
                    oItem.setSelected(oData.visible === true);
                }
            });
        },
        onScanShipColSelectOkPress: function () {
            var oTable = Fragment.byId(this.getView().getId(), "myScanColumnSelectId");
            var oModel = this.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = oModel.getProperty("/scanShipTableData1/scanShipColumns");
        
            oTable.getItems().forEach(function (oItem, iIndex) {
                var oContext = oItem.getBindingContext("eshipjetModel");
                if (oContext) {
                    var oData = oContext.getObject();
                    oData.visible = oItem.getSelected();
                }
            });
        
            oModel.refresh(true);
            this.onScanShipColSelectClosePress();
            // You may also call table rerender or update logic here
        },
        onScanShipColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myScanColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");
        },

        onScanShipSearchPress: async function () {
             oController.onOpenBusyDialog();            
            const sUserMessage = eshipjetModel.getProperty("/sShipAndScan");
            if (!sUserMessage) {
                MessageToast.show("Please Enter Request ID.");
                oController.oBusyDialog.close();
                return;
            }
             let myPromise = new Promise(function(myResolve, myReject) {
                // "Producing Code" (May take some time)
                oController.shipNowData(sUserMessage, "ScanAndShip", myResolve);                                     
                });                
                // "Consuming Code" (Must wait for a fulfilled Promise)
                myPromise.then(
                  function(value) { 
                    eshipjetModel.setProperty("/sShipAndScan","");
                    var obj = {
                        "message": "ship " + sUserMessage // Match DeliveryNo in the message if needed
                    };
                    var sPath = "https://eshipjet-demo-srv-hvacbxf0fqapdpgd.francecentral-01.azurewebsites.net/copilot/v1/bot/process";
                    return new Promise((resolve, reject) => {
                        $.ajax({
                            url: sPath, // Replace with your API endpoint
                            method: "POST",
                            contentType: "application/json", // Set content type to JSON if sending JSON data
                            data: JSON.stringify(obj),
                            success: function (response) {
                                if(response.Errors !== undefined){
                                    sap.m.MessageBox.error(response.Errors[0]);
                                }else{
                                var ScanShipTableDataModel = oController.getOwnerComponent().getModel("ScanShipTableDataModel");
                                // var sEncodedLabel   = response.shippingDocuments && response.shippingDocuments.length > 0 ? response.shippingDocuments[0].encodedLabel:"";
                                var aShippinDocs = response.shippingDocuments;
                                var aLabel = aShippinDocs.filter((obj) => obj.contentType === "Label");

                                var dataUrl;
                                if (aLabel.length !== 0 && aLabel !== undefined) {
                                    // sLabel = aLabel[0].encodedLabel;
                                    // var dataUrl = "data:image/png;base64," + sLabel;
                                    var sLabel = aLabel[0].docName;
                                    dataUrl = "https://eshipjetsatge.blob.core.windows.net/shipping-labels/" + sLabel;
                                }

                                var obj = {
                                    "sapShipmentID": response.HeaderInfo.DocumentNumber,
                                    "CreatedDate": response.HeaderInfo.CreatedDate,
                                    "ShipDate": response.HeaderInfo.ShipDate,
                                    "ShipmentType": response.HeaderInfo.ShipmentType,
                                    "shipMethod": response.CarrierDetails.Carrier,
                                    "ServiceName": response.CarrierDetails.ServiceName,
                                    "TrackingNumber": response.Packages[0].TrackingNumber,
                                    "status": response.status,
                                    "ShipToContact": response.ShipTo.CONTACT,
                                    "ShipToCompany": response.ShipTo.COMPANY,
                                    "ShipToAddressLine1": response.ShipTo.ADDRESS_LINE1,
                                    "shipToCity": response.ShipTo.CITY,
                                    "shipToState": response.ShipTo.STATE,
                                    "shipToCountry": response.ShipTo.COUNTRY,
                                    "shipToZipcode": response.ShipTo.ZIPCODE,
                                    "shipToPhone": response.ShipTo.PHONE,
                                    "shipToEmail": response.ShipTo.EMAIL,
                                    "requesterName": response.ShipFrom.EMAIL,
                                    "connectedTo": "Ship Request / Label",
                                    "orderType": response.HeaderInfo.DocumentType,
                                    "actions": "Ship Now",
                                    "downArrow": "sap-icon://megamenu",
                                    // "encodedLabel": "data:image/png;base64," + sEncodedLabel
                                    "encodedLabel": dataUrl
                                }

                                // that.encodedLabel = obj.encodedLabel;
                                var rows = ScanShipTableDataModel.getProperty("/rows");
                                if(rows){
                                    rows.push(obj);
                                }
                                ScanShipTableDataModel.updateBindings(true);
                                ScanShipTableDataModel.setProperty("/ScanShipTableLength", rows.length);
                                // Handle successful response
                                oController.oBusyDialog.close();
                                resolve(response);
                                console.log("Success:", response);
                            }
                            },
                            error: function (error) {
                                // Handle error
                                oController.oBusyDialog.close();
                                reject(error);
                                console.log("Error:", error);
                            }
                        });
                    });
                   }
                );                
        },

        scanShipFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pPopover) {
                this._pPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ScanAndShip.ScanShipFilterPopover",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    // oPopover.bindElement("/ProductCollection/0");
                    return oPopover;
                });
            }
            this._pPopover.then(function (oPopover) {
                oPopover.openBy(oButton);
            });
        },

        onScanShipFilterClosePress: function (oEvent) {
            this.byId("idScanAndShipPopover").close();
        },
        onScanShipFilterResetPress: function (oEvent) {
            this.byId("idScanAndShipPopover").close();
        },

        onScanShipFilterApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var sLocation = eshipjetModel.getProperty("/ScanLoctionName");
            var sCarrier = eshipjetModel.getProperty("/ScanCarrierFilter");
            var sStatus = eshipjetModel.getProperty("/ScanShipmentStatusFilter");
        
            if (sLocation) {
                aFilters.push(new sap.ui.model.Filter("Plant", sap.ui.model.FilterOperator.EQ, sLocation));
            }
            if (sCarrier) {
                aFilters.push(new sap.ui.model.Filter("Carriertype", sap.ui.model.FilterOperator.EQ, sCarrier));
            }
            if (sStatus) {
                aFilters.push(new sap.ui.model.Filter("Shipprocess", sap.ui.model.FilterOperator.EQ, sStatus));
            }
        
            var oTable = oView.byId("idScanAndShipTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter(aFilters);
                }
            }
        
            this.byId("idScanAndShipPopover").close();
        },
        onScanAndShipFilterResetPress: function () {
            var oView = this.getView();
        
            eshipjetModel.setProperty("/ScanLoctionName", "");
            eshipjetModel.setProperty("/ScanCarrierFilter", "");
            eshipjetModel.setProperty("/ScanShipmentStatusFilter", "");
        
            oView.byId("scanLocationComboId").setSelectedKey("");
            oView.byId("scanCarrierComboId").setSelectedKey("");
            oView.byId("scanStatusComboId").setSelectedKey("");
        
            // Clear filters
            var oTable = oView.byId("idScanAndShipTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter([]);
                }
            }
            this.byId("idScanShipFilterPopover").close();
        },
        

        

        onScanShipExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/scanShipTableData2");

            var oDateFormat = sap.ui.core.format.DateFormat.getDateTimeInstance({
                pattern: "MM/dd/yyyy HH:mm"
            });
        
            var formattedRows = rows.map(function (row) {
                return {
                    ...row,
                    DateAdded: row.DateAdded ? oDateFormat.format(new Date(row.DateAdded)) : "",
                    ExpDelDate: row.ExpDelDate ? oDateFormat.format(new Date(row.ExpDelDate)) : ""
                };
            });

            var oSettings = {
                workbook: {
                    columns: [
                        { label: "SAP Shipment ID", property: "Vbeln" },
                        { label: "Created Date", property: "DateAdded" },
                        { label: "Ship Date", property: "DateAdded" },
                        { label: "Shipment Type", property: "Shipmenttype" },
                        { label: "Carrier Name", property: "CarrierCode" },
                        { label: "Service Name", property: "CarrierDesc" },
                        { label: "Tracking Number", property: "TrackingNumber" },
                        { label: "Status", property: "Shipprocess" },
                        { label: "Ship To Contact", property: "RecContact" },
                        { label: "Ship To Company", property: "RecCompany" },
                        { label: "Ship To Address Line 1", property: "RecAddress1" },
                        { label: "Ship To City", property: "RecCity" },
                        { label: "Ship To State", property: "RecRegion" },
                        { label: "Ship To Country", property: "RecCountry" },
                        { label: "Ship To Zipcode", property: "RecPostalcode" },
                        { label: "Ship To Phone", property: "RecPhone" },
                        { label: "Ship To Email", property: "Emailaddress" },
                        { label: "Requester Name", property: "Contact" },
                        { label: "Connected To", property: "Contact" },
                        { label: "Order Type", property: "Shipmenttype" }
                    ]
                },
                dataSource: formattedRows,
                fileName: 'Scan_Ship_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },




        handleDownArrowPress: function (oEvent) {
            // var aPath = oEvent.getSource().getBindingContext().sPath.split("/");
            // var idx = parseInt(aPath[aPath.length - 1]);
            // var idx = parseInt(aPath[aPath.length - 1]);
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            var currentObj = oEvent.getSource().getBindingContext("eshipjetModel").getObject();
            eshipjetModel.setProperty("/Labelurl", currentObj.Labelurl);
            // var scanShipTableData = eshipjetModel.getProperty("/scanShipTableData");
            // this.encodedLabel = scanShipTableData.rows[idx].encodedLabel;
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._addPopover) {
                this._addPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ScanAndShip.ScanAndShipActPopover",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    // oPopover.bindElement("/ProductCollection/0");
                    return oPopover;
                });
            }
            this._addPopover.then(function (oPopover) {
                oPopover.openBy(oButton);
            });
        },

        handleSASActionPress: function (oEvent) {
            var title = oEvent.getSource().mProperties.title;
            if (title === "View") {
                oController.handleShowViewLabel();
            }
        },
        
        handleShowViewLabel: function () {
            if (!oController._oScanShipLabelDialog) {
                oController._oScanShipLabelDialog = new Dialog({
                    title: "Ship Image",
                    contentWidth: "30%", // Adjust width as needed
                    contentHeight: "80%", // Adjust height as needed
                    content: new sap.m.Image({
                        // class: "sapUiSmallMargin",
                        src: eshipjetModel.getProperty("/Labelurl"),
                        width: "100%", // Full width of dialog content
                        height: "100%"
                    }),
                    endButton: new sap.m.Button({
                        text: "Close",
                        press: function () {
                            oController._oScanShipLabelDialog.close();
                        }.bind(oController)
                    })
                });
            }else{
                oController._oScanShipLabelDialog = new Dialog({
                    title: "Ship Image",
                    contentWidth: "30%", // Adjust width as needed
                    contentHeight: "80%", // Adjust height as needed
                    content: new sap.m.Image({
                        // class: "sapUiSmallMargin",
                        src: eshipjetModel.getProperty("/Labelurl"),
                        width: "100%", // Full width of dialog content
                        height: "100%"
                    }),
                    endButton: new sap.m.Button({
                        text: "Close",
                        press: function () {
                            oController._oScanShipLabelDialog.close();
                        }.bind(oController)
                    })
                });
            };
            oController._oScanShipLabelDialog.open();
        },
        // Scan & Ship Changes End


        // Dashboard Tiles Changes Starts

        onTilePress: function (oEvent) {
            var oToolPage = this.byId("toolPage");
            oToolPage.setSideExpanded(false);
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            var tileTitle = oEvent.getParameters().domRef.innerText;
            if (tileTitle === "Orders") {
                // this._handleDisplayShipReqTable();
                oController.getShipReqLabelHistoryShipments();
                var sKey = "Orders";
                oController.getOrdersHistoryShipments();
                // eshipjetModel.setProperty("/commonValues/allViewsFooter", true);
                // eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
                // eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/commonValues/toolPageHeader", false);
                eshipjetModel.setProperty("/commonValues/allViewsFooter", false);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
                eshipjetModel.setProperty("/commonValues/showDarkThemeSwitch", false);
                eshipjetModel.setProperty("/commonValues/darkTheme", false);
                document.body.classList.remove("dark-theme");
                this.byId("pageContainer").to(this.getView().createId(sKey));
            } else if (tileTitle === "Ship Now") {
                var sKey = "ShipNow";
                eshipjetModel.setProperty("/commonValues/toolPageHeader", false);
                eshipjetModel.setProperty("/commonValues/allViewsFooter", false);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", true);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/sFromViewName", "SHIP_NOW");
                this.byId("pageContainer").to(this.getView().createId(sKey));
                var ShipNowDataModel = oController.getView().getModel("ShipNowDataModel");
                var obj = {
                    "ShipFromCONTACT": "Steve Marsh",
                    "ShipFromCOMPANY": "Eshipjet Software Inc.",
                    "ShipFromPHONE": "(888) 464-2360",
                    "ShipFromEMAIL": "info@eshipjet.ai",
                    "ShipFromCITY": "Plano",
                    "ShipFromSTATE": "TX",
                    "ShipFromCOUNTRY": "US",
                    "ShipFromZIPCODE": "75024",
                    "ShipFromADDRESS_LINE1": "5717 Legacy",
                    "ShipFromADDRESS_LINE2": "Suite 250",
                    "LocationType": "Commercial"
                };
                ShipNowDataModel.setProperty("/ShipFromAddress", obj);
                ShipNowDataModel.setProperty("/ShipToAddress", "");
                eshipjetModel.setProperty("/BusinessPartners", []);
                eshipjetModel.setProperty("/commonValues/shipNowGetBtn", true);
                eshipjetModel.setProperty("/commonValues/OverallGoodsMovementStatus", "0"); 
                eshipjetModel.setProperty("/commonValues/shipNowBtnStatus", true);
                eshipjetModel.setProperty("/commonValues/showShipType", false);
                eshipjetModel.setProperty("/commonValues/plant", "");
                eshipjetModel.setProperty("/commonValues/showPlant", false); // ðŸ‘ˆ Hide Plant
                jQuery.sap.delayedCall(500, this, function() {
                    this.getView().byId("idSapDeliveryNumber").focus();
                });

                var aBusinessPartnersTable = eshipjetModel.getProperty("/BusinessPartners") || [];
                while (aBusinessPartnersTable.length < 5) {
                    aBusinessPartnersTable.push(
                        { PartnerType: "Ship From", "FullName": "Eshipjet Software Inc.", "BusinessPartnerName1":"Steve Marsh", "StreetName":"5717 Legacy", "HouseNumber":"Suite 250", "Region":"Plano", "CityName":"TX", "PostalCode":"75024", "Country":"US", "PhoneNumber":"(888) 464-2360", "email":"info@eshipjet.ai" },
                        { PartnerType: "Shipper", "FullName": "Eshipjet Software Inc.", "BusinessPartnerName1":"Steve Marsh", "StreetName":"5717 Legacy", "HouseNumber":"Suite 250", "Region":"Plano", "CityName":"TX", "PostalCode":"75024", "Country":"US", "PhoneNumber":"(888) 464-2360", "email":"info@eshipjet.ai" },
                        { PartnerType: "Freight Forwarder", "FullName": "", "BusinessPartnerName1":"", "StreetName":"", "HouseNumber":"", "Region":"", "CityName":"", "PostalCode":"", "Country":"", "PhoneNumber":"", "email":""  },
                        { PartnerType: "Importer", "FullName": "", "BusinessPartnerName1":"", "StreetName":"", "HouseNumber":"", "Region":"", "CityName":"", "PostalCode":"", "Country":"", "PhoneNumber":"", "email":""  },
                        { PartnerType: "Third Party", "FullName": "", "BusinessPartnerName1":"", "StreetName":"", "HouseNumber":"", "Region":"", "CityName":"", "PostalCode":"", "Country":"", "PhoneNumber":"", "email":""  }
                    );
                }

                eshipjetModel.setProperty("/BusinessPartners", aBusinessPartnersTable);

                var oIconTabBar = this.byId("idIconTabBarFiori2");
                oIconTabBar.setSelectedKey("Pack");

                 oController.onPackSectionEmptyRows();
                // oController.getTodayShipments();
                // oController._handleDisplayShipNowPackTable();

            } else if (tileTitle === "Track Now") {
                // this._handleDisplayTrackNowTable();
                this.getOrdersHistoryShipments();
                var sKey = "TrackNow";
                eshipjetModel.setProperty("/commonValues/allViewsFooter", true);
                eshipjetModel.setProperty("/commonValues/toolPageHeader", false);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                this.byId("pageContainer").to(this.getView().createId(sKey));
                
            }
            var SideNavigation = eshipjetModel.getProperty("/SideNavigation");
            if (SideNavigation === true) {
                eshipjetModel.setProperty("/SideNavigation", false);
            }

        },

        // Dashboar Tiles Changes End

        // Order Changes Starts
        _handleDisplayOrdersTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var OrderTableData = eshipjetModel.getData().OrderTableData;
            var OrderTableDataModel = new JSONModel(OrderTableData);
            this.getView().setModel(OrderTableDataModel, "OrderTableDataModel");
            const oTable = oController.byId("idOrdersTable");
            oTable.setModel(OrderTableDataModel);
            var OrderTableDataModel = this.getView().getModel("OrderTableDataModel");
            var OrderColumns = OrderTableDataModel.getData().OrderColumns;
            var count = 0;
            for (var i = 0; i < OrderColumns.length; i++) {
                if (OrderColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/OrderColumns", function (sId, oContext) {
                columnName = oContext.getObject().name;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }


                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "Edit", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "CreatedDate" || columnName === "ShipDate") {
                    var DateTxt = new sap.m.Text({
                        text: {
                            path: 'OrderTableDataModel>ShipDate',
                            formatter: formatter.formatDate
                        },
                        wrapping: false
                    });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: DateTxt,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/orderRows");
        },

        // openOrderColNamesPopover: function (oEvent) {
        //     var oButton = oEvent.getSource(),
        //         oView = this.getView();
        //     if (!this._pOrderPopover) {
        //         this._pOrderPopover = Fragment.load({
        //             id: oView.getId(),
        //             name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.Orders.OrderTableColumns",
        //             controller: this
        //         }).then(function (oPopover) {
        //             oView.addDependent(oPopover);
        //             return oPopover;
        //         });
        //     }
        //     this._pOrderPopover.then(function (oPopover) {
        //         oController.OrderColumnsVisiblity();
        //         oPopover.openBy(oButton);
        //     });
        // },

        // OrderColumnsVisiblity: function () {
        //     var oView = oController.getView();
        //     var oOrderTableModel = oController.getOwnerComponent().getModel("eshipjetModel");
        //     var aColumns = oOrderTableModel.getProperty("/OrderTableData/OrderColumns");
        //     var oOrderTable = oView.byId("myOrderColumnSelectId");
        //     var aTableItems = oOrderTable.getItems();

        //     aColumns.map(function (oColObj) {
        //         aTableItems.map(function (oItem) {
        //             if (oColObj.name === oItem.getBindingContext("eshipjetModel").getObject().name && oColObj.visible) {
        //                 oItem.setSelected(true);
        //             }
        //         });
        //     });
        // },
        // onOrderColNameSearch: function (oEvent) {
        //     var aFilters = [];
        //     var sQuery = oEvent.getSource().getValue();
        //     if (sQuery && sQuery.length > 0) {
        //         var filter = new Filter("label", FilterOperator.Contains, sQuery);
        //         aFilters.push(filter);
        //     }
        //     // update list binding
        //     var oList = oController.getView().byId("myOrderColumnSelectId");
        //     var oBinding = oList.getBinding("items");
        //     oBinding.filter(aFilters, "Application");

        // },

        openOrderColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource();
            var oView = this.getView();
            var oController = this;
        
            if (!this._pOrderPopover) {
                this._pOrderPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.Orders.OrderTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
        
            this._pOrderPopover.then(function (oPopover) {
                oController._syncOrderColumnSelections();
                oPopover.openBy(oButton);
            });
        },
        
        _syncOrderColumnSelections: function () {
            var oTable = Fragment.byId(this.getView().getId(), "myOrderColumnSelectId");
            if (!oTable) return;
        
            var aItems = oTable.getItems();
            aItems.forEach(function (oItem) {
                var oContext = oItem.getBindingContext("eshipjetModel");
                if (oContext) {
                    var oData = oContext.getObject();
                    oItem.setSelected(oData.visible === true);
                }
            });
        },
        
        onOrderColNameSearch: function (oEvent) {
            var sQuery = oEvent.getSource().getValue();
            var oTable = Fragment.byId(this.getView().getId(), "myOrderColumnSelectId");
            if (!oTable) return;
        
            var oBinding = oTable.getBinding("items");
            var aFilters = [];
            if (sQuery) {
                aFilters.push(new Filter("label", FilterOperator.Contains, sQuery));
            }
            oBinding.filter(aFilters);
        },
        
        onOrderColSelectClosePress: function () {
            this._pOrderPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        
        onOrderColSelectOkPress: function () {
            var oTable = Fragment.byId(this.getView().getId(), "myOrderColumnSelectId");
            var oModel = this.getOwnerComponent().getModel("eshipjetModel");
        
            oTable.getItems().forEach(function (oItem) {
                var oContext = oItem.getBindingContext("eshipjetModel");
                if (oContext) {
                    var oData = oContext.getObject();
                    oData.visible = oItem.getSelected();
                }
            });
        
            oModel.refresh(true);
            this.onOrderColSelectClosePress();
            // optionally call refresh on your orders table
        },
        
        


        onOrderExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/allOrders");

            var oDateFormat = sap.ui.core.format.DateFormat.getDateTimeInstance({
                pattern: "MM/dd/yyyy HH:mm"
            });
        
            var formattedRows = rows.map(function (row) {
                return {
                    ...row,
                    DateAdded: row.DateAdded ? oDateFormat.format(new Date(row.DateAdded)) : "",
                    ExpDelDate: row.ExpDelDate ? oDateFormat.format(new Date(row.ExpDelDate)) : ""
                };
            });

            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Plant ID", property: "Plant" },
                        { label: "Order ID", property: "Vbeln" },
                        { label: "Created Date", property: "CreatedDate" },
                        { label: "Order Type", property: "SAP Delivery Number" },
                        { label: "Ship Method", property: "Carriertype" },
                        { label: "ERP Service ID", property: "CarrierCode" },
                        { label: "Ship Type", property: "Shipmentid" },
                        { label: "Service Name", property: "CarrierDesc" },
                        { label: "Type", property: "ShipmentType" },
                        { label: "Pkgs", property: "Totalpkg" },
                        { label: "PGI", property: "true" },
                        { label: "Ship Date-Time", property: "DateAdded" },
                        { label: "Tracking/Pro", property: "TrackingNumber" },
                        { label: "Status", property: "Shipprocess" },
                        { label: "Del'd Date-Time", property: "ExpDelDate" },
                        { label: "Ship To Contact", property: "RecContact" },
                        { label: "Ship To Company", property: "RecCompany" },
                        { label: "Ship To City", property: "RecCity" },
                        { label: "Ship To State", property: "RecRegion" },
                        { label: "Ship To Postal", property: "RecPostalcode" },
                        { label: "Ship To Country", property: "RecCountry" },
                        { label: "Ship To Phone", property: "RecPhone" },
                        { label: "Ship To Email", property: "Emailaddress" },
                        { label: "User ID", property: "" },
                        { label: "SAP User ID", property: "" },
                        { label: "Note", property: "" }
                    ]
                },
                dataSource: formattedRows,
                fileName: 'Orders_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },

        onoOrderColSelectOkPress: function () {
            var oView = this.getView();
            var oOrderTable = oView.byId("myOrderColumnSelectId");
            var eshipjetModel = oView.getModel("eshipjetModel");
            var oOrderTblItems = oOrderTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/OrderTableData/OrderColumns");
            var orderColSelectedCount = 0;
            oOrderTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().name === oColObj.name) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                            orderColSelectedCount += 1;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            console.log(orderColSelectedCount);
            eshipjetModel.setProperty("/orderColSelectedCount", orderColSelectedCount);
            eshipjetModel.updateBindings(true);
            // this._handleDisplayOrdersTable();
            this._pOrderPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onOrderColSelectClosePress: function () {
            this._pOrderPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        onOrdersFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._orderPopover) {
                this._orderPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.Orders.OrderFilterPopover",
                    controller: this
                }).then(function (orderPopover) {
                    oView.addDependent(orderPopover);
                    // orderPopover.bindElement("/ProductCollection/0");
                    return orderPopover;
                });
            }
            this._orderPopover.then(function (orderPopover) {
                orderPopover.openBy(oButton);
            });
        },
        onOrderFilterPopoverClosePress: function () {
            this.byId("idOrdersFilterPopover").close();
        },
        onOrderFilterPopoverResetPress: function () {
            this.byId("idOrdersFilterPopover").close();
        },
        
        onOrderFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var sLocation = eshipjetModel.getProperty("/orderLocationFilter");
            var sCarrier = eshipjetModel.getProperty("/orderCarrierFilter");
            var sStatus = eshipjetModel.getProperty("/orderShipmentStatusFilter");
        
            // Accessing DatePickers from the Fragment using View ID as fragment ID
            var oShipFrom = Fragment.byId(oView.getId(), "shipFromDateId");
            var oShipTo = Fragment.byId(oView.getId(), "shipToDateId");
        
            var dShipFrom = oShipFrom ? oShipFrom.getDateValue() : null;
            var dShipTo = oShipTo ? oShipTo.getDateValue() : null;
        
            if (sLocation) {
                aFilters.push(new sap.ui.model.Filter("Plant", sap.ui.model.FilterOperator.EQ, sLocation));
            }
            if (sCarrier) {
                aFilters.push(new sap.ui.model.Filter("Carriertype", sap.ui.model.FilterOperator.EQ, sCarrier));
            }
            if (sStatus) {
                aFilters.push(new sap.ui.model.Filter("Shipprocess", sap.ui.model.FilterOperator.EQ, sStatus));
            }
            if (dShipFrom && dShipTo) {
                aFilters.push(new sap.ui.model.Filter({
                    path: "DateAdded",
                    operator: sap.ui.model.FilterOperator.BT,
                    value1: dShipFrom,
                    value2: dShipTo
                }));
            }
        
            var oTable = oView.byId("idOrdersTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter(aFilters);
                }
            }
        
            this.byId("idOrdersFilterPopover").close();
        },
        
        onOrderFilterPopoverResetPress: function () {
            var oView = this.getView();
            var today = new Date();

            oView.byId("locationComboId").setSelectedKey("");
            oView.byId("shipFromDateId").setDateValue(null);
            oView.byId("shipToDateId").setDateValue(null);
            oView.byId("carrierComboId").setSelectedKey("");
            oView.byId("orderTypeComboId").setSelectedKey("");
            oView.byId("statusComboId").setSelectedKey("");
        
            // Reset table to show all
            var oModel = oView.getModel("eshipjetModel");
            oModel.setProperty("/filteredOrders", oModel.getProperty("/allOrders"));
            oView.byId("idOrdersTable").bindRows("eshipjetModel>/filteredOrders");
        },
       
     
        onOrderStstusBtnFilterPress: function (oEvent) {
            var oView = this.getView(); // Correct way
            var aFilterId = oEvent.getSource().getId().split("--");
            var oText = aFilterId[aFilterId.length - 1];
            var oFilterText;
            var oTable = Fragment.byId(oView.getId(), "idOrdersTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oText === "Shipped") {
                oFilterText = "SHIP";
            } else if (oText === "Cancelled") {
                oFilterText = "CANC";
            } else if (oText === "Open") {
                oFilterText = "Open";
            } else if (oText === "In-Transit") {
                oFilterText = "In-Transit";
            } else if (oText === "Received") {
                oFilterText = "Received";
            } else if (oText === "Total") {
                return oBinding.filter([]); // Show all
            }
        
            var oFilter = new sap.ui.model.Filter("Shipprocess", sap.ui.model.FilterOperator.EQ, oFilterText);
            oBinding.filter([oFilter]);
        },

        //pagination
        
      
        
        // Order Changes End


        // RoutingGuide Changes Starts

        _handleDisplayRoutingGuideTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var RoutingGuideTableData = eshipjetModel.getData().RoutingGuideTableData;
            var RoutingGuideTableDataModel = new JSONModel(RoutingGuideTableData);
            this.getView().setModel(RoutingGuideTableDataModel, "RoutingGuideTableDataModel");
            const oTable = oView.byId("idRoutingGuideTable1");
            oTable.setModel(RoutingGuideTableDataModel);
            var RoutingGuideTableDataModel = this.getView().getModel("RoutingGuideTableDataModel");
            var RoutingGuideColumns = RoutingGuideTableDataModel.getData().RoutingGuideColumns;
            var count = 0;
            for (var i = 0; i < RoutingGuideColumns.length; i++) {
                if (RoutingGuideolumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/RoutingGuideColumns", function (sId, oContext) {
                columnName = oContext.getObject().name;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }


                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "Edit", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "CreatedDate" || columnName === "ShipDate") {
                    var DateTxt = new sap.m.Text({
                        text: {
                            path: 'RoutingGuideTableDataModel>ShipDate',
                            formatter: formatter.formatDate
                        },
                        wrapping: false
                    });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: DateTxt,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/rows");
        },

        openRoutingGuideColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pRoutingGuidePopover) {
                this._pRoutingGuidePopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.RoutingGuide.RoutingGuideTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pRoutingGuidePopover.then(function (oPopover) {
                oController.RoutingGuideColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        RoutingGuideColumnsVisiblity: function () {
            var oView = oController.getView();
            var oRoutingGuideTableModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = oRoutingGuideTableModel.getProperty("/RoutingGuideTableData/RoutingGuideColumns");
            var oRoutingGuideTable = oView.byId("myRoutingGuideColumnSelectId");
            var aTableItems = oRoutingGuideTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.name === oItem.getBindingContext("RoutingGuideTableDataModel").getObject().name && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },
        onRoutingGuideColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myRoutingGuideColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onoRoutingGuideColSelectOkPress: function () {
            var oView = this.getView()
            var oRoutingGuideTable = oView.byId("myRoutingGuideColumnSelectId");
            var RoutingGuideTableDataModel = oView.getModel("RoutingGuideTableDataModel");
            var oRoutingGuideTblItems = oRoutingGuideTable.getItems();
            var aColumnsData = RoutingGuideTableDataModel.getProperty("/RoutingGuideColumns");
            oRoutingGuideTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("RoutingGuideTableDataModel").getObject().name === oColObj.name) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            RoutingGuideTableDataModel.updateBindings(true);
            this._handleDisplayRoutingGuidesTable();
            this._pRoutingGuidePopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onRoutingGuideColSelectClosePress: function () {
            this._pRoutingGuidePopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        onRoutingGuideFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._RoutingGuidePopover) {
                this._RoutingGuidePopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.RoutingGuide.RoutingGuideFilterPopover",
                    controller: this
                }).then(function (RoutingGuidePopover) {
                    oView.addDependent(RoutingGuidePopover);
                    // RoutingGuidePopover.bindElement("/ProductCollection/0");
                    return RoutingGuidePopover;
                });
            }
            this._RoutingGuidePopover.then(function (RoutingGuidePopover) {
                RoutingGuidePopover.openBy(oButton);
            });
        },
        onRoutingGuideFilterPopoverClosePress: function () {
            this.byId("idRoutingGuideFilterPopover").close();
        },
        onRoutingGuideFilterPopoverResetPress: function () {
            this.byId("idRoutingGuideFilterPopover").close();
        },
        onRoutingGuideFilterPopoverApplyPress: function () {
            this.byId("idRoutingGuideFilterPopover").close();
        },


        onRoutingGuidePress:function(){
            var oView = this.getView();
            var oToolPage = this.byId("toolPage");
            oToolPage.setSideExpanded(false);
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/commonValues/routingGuidFooter", true);
            var SideNavigation = eshipjetModel.getProperty("/SideNavigation");
            if (SideNavigation === true) {
                eshipjetModel.setProperty("/SideNavigation", false);
            }
            var oPageContainer = this.byId("pageContainer");
            oPageContainer.to(oView.createId("_ID_RoutingGuide_TableScrollContainer"));
        },

        onRoutingGuidSaveOptionsPress:function(oEvent){
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._RoutingGuideSaveOptionsPopover) {
                this._RoutingGuideSaveOptionsPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.RoutingGuide.RoutingGuideSaveOptions",
                    controller: this
                }).then(function (RoutingGuideSaveOptionsPopover) {
                    oView.addDependent(RoutingGuideSaveOptionsPopover);
                    // RoutingGuideSaveOptionsPopover.bindElement("/ProductCollection/0");
                    return RoutingGuideSaveOptionsPopover;
                });
            }
            this._RoutingGuideSaveOptionsPopover.then(function (RoutingGuideSaveOptionsPopover) {
                RoutingGuideSaveOptionsPopover.openBy(oButton);
            });
        },
//   first add row and Col in table pendding
        onRoutingGuideExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/RoutingGuideTableData/rows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Order ID", property: "orderID" },
                        { label: "Created Date", property: "CreatedDate" },
                        { label: "Ship Date", property: "ShipDate" },
                        { label: "Shipment Type", property: "ShipmentType" },
                        { label: "Ship Method", property: "shipMethod" },
                        { label: "Service Name", property: "ServiceName" },
                        { label: "Tracking Number", property: "TrackingNumber" },
                        { label: "Status", property: "status" },
                        { label: "Ship To Contact", property: "ShipToContact" },
                        { label: "Ship To Company", property: "ShipToCompany" },
                        { label: "Ship To AddressLine1", property: "ShipToAddressLine1" },
                        { label: "Ship To City", property: "shipToCity" },
                        { label: "Ship To State", property: "shipToState" },
                        { label: "Ship To Country", property: "shipToCountry" },
                        { label: "Ship To Zip", property: "shipToZip" },
                        { label: "Ship To Phone", property: "shipToPhone" },
                        { label: "Ship To Email", property: "shipToEmail" },
                        { label: "Requestor Name", property: "requesterName" },
                        { label: "Connected To", property: "connectedTo" },
                        { label: "Priority Level", property: "priorityLevel" },
                        { label: "Actions", property: "actions" },
                    ]
                },
                dataSource: rows,
                fileName: 'RoutingGide_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },
        // RoutingGuide Changes End

        // Ship Request/Lable Code Changes Starts


        onCreateShipReqClosePress:function(){
            var sKey = "ShipRequestLabel";
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            if (sKey === "ShipRequestLabel") {
                eshipjetModel.setProperty("/commonValues/toolPageHeader", true);
                eshipjetModel.setProperty("/commonValues/allViewsFooter", true);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
                eshipjetModel.setProperty("/showDarkThemeSwitch", false);
                eshipjetModel.setProperty("/commonValues/darkTheme", false);
                document.body.classList.remove("dark-theme");
                // this._handleDisplayShipReqTable();
                oController.getShipReqLabelHistoryShipments();
            }
            eshipjetModel.setProperty("/SideNavigation", false);
            this.byId("pageContainer").to(this.getView().createId(sKey));
        },

        _handleDisplayShipReqTable: function () {
            var that = this;
            oController.getShipReqLabelHistoryShipments();
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var ShipReqTableData = eshipjetModel.getData().ShipReqTableData;
            var ShipReqTableDataModel = new JSONModel(ShipReqTableData);
            this.getView().setModel(ShipReqTableDataModel, "ShipReqTableDataModel");
            const oTable = oView.byId("idShipReqsTable");
            oTable.setModel(ShipReqTableDataModel);
            var ShipReqTableDataModel = this.getView().getModel("ShipReqTableDataModel");
            var ShipReqColumns = ShipReqTableDataModel.getData().ShipReqColumns;
            var count = 0;
            for (var i = 0; i < ShipReqColumns.length; i++) {
                if (ShipReqColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/ShipReqColumns", function (sId, oContext) {
                columnName = oContext.getObject().name;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    minWidth = "150px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ 
                        text: "View Now", 
                        type: "Transparent",
                        press: function(oEvent){
                            oController.onViewNowPressBackToShipNow(oEvent);
                        }
                    });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "TrackingNumber") {
                    var Link = new sap.m.Link({
                        text: '{TrackingNumber}',
                        press: function (oEvent) {
                            that.onTrackingNumberPress(oEvent);
                        }
                    });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: Link,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "Createddate" || columnName === "CrossdockShipdate") {
                    var DateTxt = new sap.m.Text({
                        text: {
                            path: '{Createddate}',
                            formatter: formatter.formatDate  // Attach the formatter dynamically
                        },
                        wrapping: false
                    });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: DateTxt,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.setModel(eshipjetModel);
            oTable.bindRows("/RecentShipmentSetShipReqLabel");
        },

        onShipReqExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/RecentShipmentSetShipReqLabel");

            var oDateFormat = sap.ui.core.format.DateFormat.getDateTimeInstance({
                pattern: "MM/dd/yyyy HH:mm"
            });
        
            var formattedRows = rows.map(function (row) {
                return {
                    ...row,
                    Createddate: row.Createddate ? oDateFormat.format(new Date(row.Createddate)) : "",
                    DateAdded: row.DateAdded ? oDateFormat.format(new Date(row.DateAdded)) : ""
                };
            });

            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Location Id", property: "Plant" },
                        { label: "Location Name", property: "RecCity" },
                        { label: "Consolidation Id", property: "Consolidation" },
                        { label: "Delivery/handling Requests", property: "requestIdLabelId" },
                        { label: "EID", property: "EID" },
                        { label: "Created Date", property: "Createddate" },
                        { label: "Ship Date", property: "DateAdded" },
                        { label: "Shipment Type", property: "Carriertype" },
                        { label: "Ship Method", property: "CarrierCode" },
                        { label: "Ship Description", property: "CarrierDesc" },
                        { label: "Service Name", property: "CarrierDesc" },
                        { label: "Master Tracking Number", property: "TrackingNumber" },
                        { label: "Tracking Number", property: "TrackingNumber" },
                        { label: "Quote Status", property: "DeliveryStatus" },
                        { label: "Ship To Contact", property: "RecContact" },
                        { label: "Ship To Company", property: "RecCompany" },
                        { label: "Ship To Address Line 1", property: "RecAddress1" },
                        { label: "Ship To State", property: "RecRegion" },
                        { label: "Ship To City", property: "RecCity" },
                        { label: "Ship To Zip / Postal Code", property: "RecPostalcode" },
                        { label: "Ship To Country", property: "RecCountry" },
                        { label: "Ship To Phone", property: "RecPhone" },
                        { label: "Ship To Email", property: "Emailaddress" },
                        { label: "Requester Name", property: "RecContact" },
                        { label: "Connected To", property: "RecContact" },
                        { label: "Status", property: "DeliveryStatus" },
                        { label: "Order Type", property: "Packagetype" }
                    ]
                },
                dataSource: formattedRows,
                fileName: 'Ship_Request_Label_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },
            // Fixed ShipReqLabel Column Management Functions

            openShipReqColNamesPopover: function (oEvent) {
                var oButton = oEvent.getSource();
                var oView = this.getView();
                var oController = this;

                if (!this._pShipReqPopover) {
                    this._pShipReqPopover = Fragment.load({
                        id: oView.getId(),
                        name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipReqLabel.ShipReqTableColumns",
                        controller: this
                    }).then(function (oPopover) {
                        oView.addDependent(oPopover);
                        return oPopover;
                    });
                }

                this._pShipReqPopover.then(function (oPopover) {
                    oController._syncShipReqColumnSelections();
                    oPopover.openBy(oButton);
                });
            },

            _syncShipReqColumnSelections: function () {
                var oTable = Fragment.byId(this.getView().getId(), "myShipReqColumnSelectId");
                if (!oTable) return;

                var aItems = oTable.getItems();
                aItems.forEach(function (oItem) {
                    var oContext = oItem.getBindingContext("eshipjetModel");
                    if (oContext) {
                        var oData = oContext.getObject();
                        oItem.setSelected(oData.visible === true);
                    }
                });
            },

            onShipReqColNameSearch: function (oEvent) {
                var sQuery = oEvent.getSource().getValue();
                var oTable = Fragment.byId(this.getView().getId(), "myShipReqColumnSelectId");
                if (!oTable) return;

                var oBinding = oTable.getBinding("items");
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new Filter("label", FilterOperator.Contains, sQuery));
                }
                oBinding.filter(aFilters);
            },

            onShipReqColSelectClosePress: function () {
                this._pShipReqPopover.then(function (oPopover) {
                    oPopover.close();
                });
            },

            onShipReqColSelectOkPress: function () {
                var oTable = Fragment.byId(this.getView().getId(), "myShipReqColumnSelectId");
                var oModel = this.getOwnerComponent().getModel("eshipjetModel");
                var aColumns = oModel.getProperty("/ShipReqColumns");

                oTable.getItems().forEach(function (oItem, iIndex) {
                    var oContext = oItem.getBindingContext("eshipjetModel");
                    if (oContext) {
                        var oData = oContext.getObject();
                        oData.visible = oItem.getSelected();
                    }
                });

                oModel.refresh(true);
                this.onShipReqColSelectClosePress();
                // Optional: Call your specific table update logic here
                // this.getShipReqLabelHistoryShipments();
            },
            
            onShipReqFilterPopoverPress: function (oEvent) {
                var oButton = oEvent.getSource(),
                    oView = this.getView();
                // create popover
                if (!this._shipReqPopover) {
                    this._shipReqPopover = Fragment.load({
                        id: oView.getId(),
                        name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipReqLabel.ShipReqFilterPopover",
                        controller: this
                    }).then(function (shipReqPopover) {
                        oView.addDependent(shipReqPopover);
                        // shipReqPopover.bindElement("/ProductCollection/0");
                        return shipReqPopover;
                    });
                }
                this._shipReqPopover.then(function (shipReqPopover) {
                    shipReqPopover.openBy(oButton);
                });
            },
            onShipReqFilterPopoverClosePress: function () {
                this.byId("idShipReqFilterPopover").close();
            },

        onShipReqFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var oModel = oView.getModel("eshipjetModel");
        
            // Model-bound filters
            var sLocation = oModel.getProperty("/ShipReqLoctionName");
            var sCarrier = oModel.getProperty("/ShipReqCarrierFilter");
            var sStatus = oModel.getProperty("/ShipReqShipmentStatusFilter");
        
            // Input field filters
            var dShipFrom = oView.byId("shipFromDateId11").getDateValue();
            var dShipTo = oView.byId("shipToDateId11").getDateValue();
            var sVbeln = oView.byId("DeliveryNum1").getValue();
            var sRecCountry = oView.byId("ShipToCompany1").getValue();
            var sTrackingNumber = oView.byId("TrackingNumber1").getValue();
        
            if (sLocation) {
                aFilters.push(new sap.ui.model.Filter("Plant", sap.ui.model.FilterOperator.EQ, sLocation));
            }
            if (sCarrier) {
                aFilters.push(new sap.ui.model.Filter("Carriertype", sap.ui.model.FilterOperator.EQ, sCarrier));
            }
            if (sStatus) {
                aFilters.push(new sap.ui.model.Filter("Shipprocess", sap.ui.model.FilterOperator.EQ, sStatus));
            }
            if (dShipFrom && dShipTo) {
                aFilters.push(new sap.ui.model.Filter({
                    path: "DateAdded",
                    operator: sap.ui.model.FilterOperator.BT,
                    value1: dShipFrom,
                    value2: dShipTo
                }));
            }
            if (sVbeln) {
                aFilters.push(new sap.ui.model.Filter("Vbeln", sap.ui.model.FilterOperator.Contains, sVbeln));
            }
            if (sRecCountry) {
                aFilters.push(new sap.ui.model.Filter("RecCountry", sap.ui.model.FilterOperator.Contains, sRecCountry));
            }
            if (sTrackingNumber) {
                aFilters.push(new sap.ui.model.Filter("TrackingNumber", sap.ui.model.FilterOperator.Contains, sTrackingNumber));
            }
        
            var oTable = oView.byId("idShipReqsTable");
            var oBinding = oTable.getBinding("rows");
            oBinding.filter(aFilters);
        
            this.byId("idShipReqFilterPopover").close();
        },

        onShipReqFilterPopoverResetPress: function () {
            var oView = this.getView();
        
            // Reset UI fields
            oView.byId("locationComboId11").setSelectedKey("");
            oView.byId("shipFromDateId11").setDateValue(null);
            oView.byId("shipToDateId11").setDateValue(null);
            oView.byId("carrierComboId11").setSelectedKey("");
            oView.byId("statusComboId11").setSelectedKey("");
            oView.byId("DeliveryNum1").setValue("");
            oView.byId("ShipToCompany1").setValue("");
            oView.byId("TrackingNumber1").setValue("");
          // Remove all filters from table
            var oTable = oView.byId("idShipReqsTable");
            oTable.getBinding("rows").filter([]);
        },
        
        




        onSettingsPress: function (oEvent) {
            var that = this;
            
            if (!this._oPopover) {
                this._oPopover = new sap.m.Popover({
                    title: "Filter Columns",
                    placement: "Left",
                    contentWidth: "200px",
                    content: new sap.m.VBox({
                        items: [
                            new sap.m.CheckBox({
                                id: "cbSelectAll",
                                text: "Select All",
                                select: function (oEvent) {
                                    var bSelected = oEvent.getParameter("selected");
                                    that.toggleAllColumns(bSelected);
                                }
                            }),
                            new sap.m.CheckBox({ id: "cbShipMethodID", text: "Ship Method ID", selected: true }),
                            new sap.m.CheckBox({ id: "cbShipMethodDescription", text: "Ship Method Description", selected: true }),
                            new sap.m.CheckBox({ id: "cbCarrierEmail", text: "Carrier Email", selected: true }),
                            new sap.m.CheckBox({ id: "cbCarrierPhone", text: "Carrier Phone", selected: true }),
                            new sap.m.CheckBox({ id: "cbTotalFreightQuote", text: "Total Freight Quote", selected: true }),
                            new sap.m.CheckBox({ id: "cbTransitDays", text: "Transit Days", selected: true }),
                            new sap.m.CheckBox({ id: "cbQuoteStatus", text: "Quote Status", selected: true }),
                            new sap.m.CheckBox({ id: "cbReview", text: "Review", selected: true })
                        ]
                    }),
                    footer: new sap.m.Bar({
                        contentRight: [
                            new sap.m.Button({
                                text: "Apply",
                                type: "Emphasized",
                                press: function () {
                                    that.onFilterChange();
                                    that._oPopover.close();
                                }
                            }),
                           
                        ]
                    })
                });
                this.getView().addDependent(this._oPopover);
            }
        
            this._oPopover.openBy(oEvent.getSource());
        },
        
        toggleAllColumns: function (bSelected) {
            var aCheckBoxes = [
                "cbShipMethodID",
                "cbShipMethodDescription",
                "cbCarrierEmail",
                "cbCarrierPhone",
                "cbTotalFreightQuote",
                "cbTransitDays",
                "cbQuoteStatus",
                "cbReview"
            ];
        
            aCheckBoxes.forEach(function (sCheckBoxId) {
                var oCheckBox = sap.ui.getCore().byId(sCheckBoxId);
                if (oCheckBox) {
                    oCheckBox.setSelected(bSelected);
                }
            });
        },
        
        onFilterChange: function () {
            var aColumns = [
                "colShipMethodID",
                "colShipMethodDescription",
                "colCarrierEmail",
                "colCarrierPhone",
                "colTotalFreightQuote",
                "colTransitDays",
                "colQuoteStatus",
                "colReview"
            ];
        
            aColumns.forEach(function (sColumnId) {
                var oCheckBox = sap.ui.getCore().byId("cb" + sColumnId.replace("col", ""));
                var oColumn = this.getView().byId(sColumnId);
                if (oColumn && oCheckBox) {
                    oColumn.setVisible(oCheckBox.getSelected());
                }
            }.bind(this));
        }
        ,
        

        onCreateShipReqLabelPress: function () {
            var oView = this.getView();
            var oToolPage = this.byId("toolPage");
            oToolPage.setSideExpanded(false);
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            var SideNavigation = eshipjetModel.getProperty("/SideNavigation");
            if (SideNavigation === true) {
                eshipjetModel.setProperty("/SideNavigation", false);
            }
            var oPageContainer = this.byId("pageContainer");
            oPageContainer.to(oView.createId("_ID_CreateShipReqLabel_TableScrollContainer"));
            this._handleDisplayCreateShipReqTable();
            eshipjetModel.setProperty("/commonValues/toolPageHeader", false);
            eshipjetModel.setProperty("/commonValues/allViewsFooter", false);
            eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
            eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
            eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", true);
            var ShipNowDataModel = oController.getView().getModel("ShipNowDataModel");
            ShipNowDataModel.setProperty("/ShipFromAddress", "");
            ShipNowDataModel.setProperty("/ShipToAddress", "");
        },


        onCreateShipReqSavePress:function(){
            var ShipNowDataModel = oController.getView().getModel("ShipNowDataModel");
            var ShipFromAddress = ShipNowDataModel.getProperty("/ShipFromAddress");
            var ShipToAddress = ShipNowDataModel.getProperty("/ShipToAddress");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var ShipReqRows = eshipjetModel.getData().ShipReqTableData.ShipReqRows;
            var oCurrObj = {
                "locationName": "eshipJet Software Inc.",
                "requestIdLabelId": "DN000001385",
                "CreatedDate": "01/20/2025",
                "ShipDate": "01/21/2025",
                "shipMethod": eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey"),
                "ServiceName": eshipjetModel.getProperty("/commonValues/ShipNowShipsrvNameSelectedKey"),
                "TrackingNumber": null,
                "quoteStatus": "Sent for Clarifications",
                "ShipToContact": ShipToAddress.FullName,
                "ShipToCompany": ShipToAddress.BusinessPartnerName1,
                "shipToCity": ShipToAddress.CityName,
                "status": "Open",
                "shipToStateProvince": ShipToAddress.Region,
                "shipToZipPostalCode": ShipToAddress.PostalCode,
                "shipToCountry": ShipToAddress.Country,
                "shipToPhone": ShipToAddress.PhoneNumber,
                "shipToEmail": ShipToAddress.EMAIL
              };

              ShipReqRows.push(oCurrObj);
              eshipjetModel.updateBindings(true);

            ShipNowDataModel.setProperty("/ShipFromAddress", "");
            ShipNowDataModel.setProperty("/ShipToAddress", "");
        },


        _handleDisplayCreateShipReqTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var ShipReqTableData = eshipjetModel.getData().ShipReqTableData;
            var ShipReqTableDataModel = new JSONModel(ShipReqTableData);
            this.getView().setModel(ShipReqTableDataModel, "ShipReqTableDataModel");
            var oTable = oView.byId("idCreateShipReqTable");
            oTable.setModel(ShipReqTableDataModel);
            var ShipReqTableDataModel = this.getView().getModel("ShipReqTableDataModel");
            var CreateShipReqColumnsData = ShipReqTableDataModel.getData().CreateShipReqColumns;
            var count = 0;
            for (var i = 0; i < CreateShipReqColumnsData.length; i++) {
                if (CreateShipReqColumnsData[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/CreateShipReqColumns", function (sId, oContext) {
                columnName = oContext.getObject().name;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName != "actions") {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        hAlign: "Begin",
                        sortProperty: columnName
                    });
                }else if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ icon: "sap-icon://delete", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://delete", type: "Attention",
                        press: function (oEvent) {
                            MessageBox.warning("Are you sure you want to delete this record?", {
                                actions: [MessageBox.Action.OK, MessageBox.Action.CANCEL],
                                emphasizedAction: MessageBox.Action.OK,
                                onClose: function (sAction) {
                                    if(sAction === "OK"){
                                        oController.onCreateShipReqPrdTableDelPress(oEvent);
                                    }
                                }
                            });
                        }
                    });
                    oHBox.addItem(Btn2);
                    // oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: "100px",
                        hAlign: "Begin",
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/CreateShipReqRows");
        },

        onCreateShipReqPrdTableDelPress:function(oEvent){
            var sPath = oEvent.getSource().getBindingContext().sPath.split("/");
            var idx = parseInt(sPath[sPath.length-1]);
            var ShipReqTableDataModel = oController.getView().getModel("ShipReqTableDataModel");
            ShipReqTableDataModel.getData().CreateShipReqRows.splice(idx, 1);
            ShipReqTableDataModel.updateBindings(true);
        },

        openCreateShipReqColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pCreateShipReqPopover) {
                this._pCreateShipReqPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipReqLabel.CreateShipReqTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pCreateShipReqPopover.then(function (oPopover) {
                oController.CreateShipReqColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        CreateShipReqColumnsVisiblity: function () {
            var oView = oController.getView();
            var oCreateShipReqTableModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = oCreateShipReqTableModel.getProperty("/ShipReqTableData/CreateShipReqColumns");
            var oCreateShipReqTable = oView.byId("myCreateShipReqColumnSelectId");
            var aTableItems = oCreateShipReqTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.name === oItem.getBindingContext("ShipReqTableDataModel").getObject().name && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },
        onCreateShipReqColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myCreateShipReqColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onoCreateShipReqColSelectOkPress: function () {
            var oView = this.getView()
            var oCreateShipReqTable = oView.byId("myCreateShipReqColumnSelectId");
            var ShipReqTableDataModel = oView.getModel("ShipReqTableDataModel");
            var oCreateShipReqTblItems = oCreateShipReqTable.getItems();
            var aColumnsData = ShipReqTableDataModel.getProperty("/CreateShipReqColumns");
            oCreateShipReqTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("ShipReqTableDataModel").getObject().name === oColObj.name) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            ShipReqTableDataModel.updateBindings(true);
            this._handleDisplayCreateShipReqTable();
            this._pCreateShipReqPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onCreateShipReqColSelectClosePress: function () {
            this._pCreateShipReqPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        ShipReqActDownArrowPress: function (oEvent) {
            // var aPath = oEvent.getSource().getBindingContext().sPath.split("/");
            // var eshipjetModel = this.getView().getModel("eshipjetModel");
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._addPopover) {
                this._addPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipReqLabel.ShipReqActPopover",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    // oPopover.bindElement("/ProductCollection/0");
                    return oPopover;
                });
            }
            this._addPopover.then(function (oPopover) {
                oPopover.openBy(oButton);
            });
        },

        onShipmentChange : function(oEvent){
            var eshipjetModel =  this.getOwnerComponent().getModel("eshipjetModel");
            var shipmentTypeSelectedKey =  eshipjetModel.getData().shipmentTypeSelectedKey;
            var createShipReqSpecialSrvsShow = eshipjetModel.getProperty("/createShipReqSpecialSrvsShow");
            if (shipmentTypeSelectedKey === "business" && createShipReqSpecialSrvsShow){
                eshipjetModel.setProperty("/shipMethodKey", "" );
                eshipjetModel.setProperty("/ServiceNameSelectedKeys", "" );
                eshipjetModel.setProperty("/createShipReqBusinessSelect", false );
                eshipjetModel.setProperty("/createShipReqPersonalSelect", false );

            }else if(shipmentTypeSelectedKey === "personal" && createShipReqSpecialSrvsShow){
                eshipjetModel.setProperty("/shipMethodKey", "" );
                eshipjetModel.setProperty("/ServiceNameSelectedKeys", "" );
                eshipjetModel.setProperty("/createShipReqBusinessSelect", false );
                eshipjetModel.setProperty("/createShipReqPersonalSelect", true );

            }else if(shipmentTypeSelectedKey === "interbranch" && createShipReqSpecialSrvsShow){
                eshipjetModel.setProperty("/shipMethodKey", "JPMC" );
                eshipjetModel.setProperty("/ServiceNameSelectedKeys", "intraExpress" );
                eshipjetModel.setProperty("/createShipReqBusinessSelect", false );
                eshipjetModel.setProperty("/createShipReqPersonalSelect", false );

             }else if (shipmentTypeSelectedKey === "business" && createShipReqSpecialSrvsShow != true){
                eshipjetModel.setProperty("/shipMethodKey", "" );
                eshipjetModel.setProperty("/ServiceNameSelectedKeys", "" );
                eshipjetModel.setProperty("/createShipReqBusinessSelect", true );
                eshipjetModel.setProperty("/createShipReqPersonalSelect", false );

            }else if(shipmentTypeSelectedKey === "personal" && createShipReqSpecialSrvsShow != true){
                eshipjetModel.setProperty("/shipMethodKey", "" );
                eshipjetModel.setProperty("/ServiceNameSelectedKeys", "" );
                eshipjetModel.setProperty("/createShipReqBusinessSelect", true );
                eshipjetModel.setProperty("/createShipReqPersonalSelect", true );
                eshipjetModel.setProperty("/createShipReqSpecialSrvsShow", false );

            }else if(shipmentTypeSelectedKey === "interbranch" && createShipReqSpecialSrvsShow != true){
                eshipjetModel.setProperty("/shipMethodKey", "JPMC" );
                eshipjetModel.setProperty("/ServiceNameSelectedKeys", "intraExpress" );
                eshipjetModel.setProperty("/createShipReqBusinessSelect", false );
                eshipjetModel.setProperty("/createShipReqPersonalSelect", false );

             }

        },

        onCreateShipReqOrderTypeChange:function(oEvent){
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var ShipReqOrderType = eshipjetModel.getProperty("/ShipReqOrderType");
            var shipmentTypeSelectedKey =  eshipjetModel.getData().shipmentTypeSelectedKey;

            var createShipReqPersonalSelect = eshipjetModel.getProperty("/createShipReqPersonalSelect");
            if(ShipReqOrderType === "freight_quote" && shipmentTypeSelectedKey === "business"){
                eshipjetModel.setProperty("/createShipReqSpecialSrvsShow", true);
                eshipjetModel.setProperty("/createShipReqBusinessSelect", false);
                eshipjetModel.setProperty("/createShipReqPersonalSelect", false);
            }else if(ShipReqOrderType === "freight_quote" && shipmentTypeSelectedKey === "personal"){
                eshipjetModel.setProperty("/createShipReqSpecialSrvsShow", true);
                eshipjetModel.setProperty("/createShipReqBusinessSelect", false);
                eshipjetModel.setProperty("/createShipReqPersonalSelect", true);
            }else if(ShipReqOrderType === "freight_quote" && shipmentTypeSelectedKey === "interbranch"){
                eshipjetModel.setProperty("/createShipReqSpecialSrvsShow", true);
                eshipjetModel.setProperty("/createShipReqBusinessSelect", false);
                eshipjetModel.setProperty("/createShipReqPersonalSelect", false);
            }else if(ShipReqOrderType !== "freight_quote" && shipmentTypeSelectedKey === "business"){
                eshipjetModel.setProperty("/createShipReqSpecialSrvsShow", false);
                eshipjetModel.setProperty("/createShipReqBusinessSelect", true);
                eshipjetModel.setProperty("/createShipReqPersonalSelect", false);
            }else if(ShipReqOrderType !== "freight_quote" && shipmentTypeSelectedKey === "personal"){
                eshipjetModel.setProperty("/createShipReqSpecialSrvsShow", false);
                eshipjetModel.setProperty("/createShipReqBusinessSelect", true);
                eshipjetModel.setProperty("/createShipReqPersonalSelect", true);
            }else if(ShipReqOrderType !== "freight_quote" && shipmentTypeSelectedKey === "interbranch"){
                eshipjetModel.setProperty("/createShipReqSpecialSrvsShow", false);
                eshipjetModel.setProperty("/createShipReqBusinessSelect", false);
                eshipjetModel.setProperty("/createShipReqPersonalSelect", false);
            }
        },

        // Ship Request/Lable Code Changes ENd


        // Track Now changes start

        _handleDisplayTrackNowTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var TrackNowTableData = eshipjetModel.getData().TrackNowTableData;
            var TrackNowTableDataModel = new JSONModel(TrackNowTableData);
            this.getView().setModel(TrackNowTableDataModel, "TrackNowTableDataModel");
            const oTable = oView.byId("idTrackNowTable");
            oTable.setModel(TrackNowTableDataModel);
            var TrackNowTableDataModel = this.getView().getModel("TrackNowTableDataModel");
            var TrackNowColumns = TrackNowTableDataModel.getData().TrackNowColumns;
            var count = 0;
            for (var i = 0; i < TrackNowColumns.length; i++) {
                if (TrackNowColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/TrackNowColumns", function (sId, oContext) {
                columnName = oContext.getObject().name;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "Edit", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "CreatedDate" || columnName === "ShipDate") {
                    var DateTxt = new sap.m.Text({
                        text: {
                            path: 'TrackNowTableDataModel>ShipDate',
                            formatter: formatter.formatDate  // Attach the formatter dynamically
                        },
                        wrapping: false
                    });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/TrackNowRows");
        },

        onTrackNowStstusBtnFilterPress:function(oEvent){
            var aFilterId = oEvent.getSource().getId().split("--");
            var oText = aFilterId[aFilterId.length-1];
            var oFilterText;
            var oTable = Fragment.byId(this.getView().getId(), "idTrackNowTable");
            var oBinding = oTable.getBinding("rows");
            
            if(oText === "idTrackShipped"){
                oFilterText = "SHIP";
            }else if(oText === "idTrackCancelled"){
                oFilterText = "CANC";
            }else if(oText === "idTrackInTransit"){
                oFilterText = "In-Transit";
            }else if(oText === "idTrackDelivered"){
                oFilterText = "Delivered";
            }else if(oText === "Total"){
                return oBinding.filter([]);
            }
            
            var oFilter = new sap.ui.model.Filter("Shipprocess", sap.ui.model.FilterOperator.EQ, oFilterText);
            oBinding.filter([oFilter]);
        },

        formatPriorityAlert: function(value) {
            if (value === false) {
                return "";
            }
            return value;
        },
        
        onTrackNowExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/allOrders");
            var oDateFormat = sap.ui.core.format.DateFormat.getDateTimeInstance({
                pattern: "MM/dd/yyyy HH:mm"
            });
        
            var formattedRows = rows.map(function (row) {
                return {
                    ...row,
                    Createddate: row.Createddate ? oDateFormat.format(new Date(row.Createddate)) : "",
                    PodDate: row.PodDate ? oDateFormat.format(new Date(row.PodDate)) : ""
                };
            });
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Location Name", property: "FromCompany" },
                        { label: "Request Id", property: "Vbeln" },
                        { label: "Created Date", property: "Createddate" },
                        { label: "Ship Date", property: "PodDate" },
                        { label: "Carrier ID", property: "Carriertype" },
                        { label: "Service Name", property: "CarrierDesc" },
                        { label: "Status", property: "Shipprocess" },
                        { label: "Tracking/Pro", property: "TrackingNumber" },
                        { label: "Ship To Contact", property: "RecContact" },
                        { label: "Ship To Company", property: "RecCompany" },
                        { label: "Connected To", property: "CarrierCode" },
                        { label: "Order Type", property: "SAP Delivery Number" },
                        { label: "Ship To Address Line 1", property: "RecAddress1" },
                        { label: "Ship To City", property: "RecCity" },
                        { label: "Ship To State", property: "RecRegion" },
                        { label: "Ship To Country", property: "RecCountry" },
                        { label: "Ship To Postal Code", property: "RecPostalcode" },
                        { label: "Ship To Phone", property: "RecPhone" },
                        { label: "Ship To Email", property: "Emailaddress" },
                        { label: "Requester Name", property: "CarrierCode" },
                        { label: "Shipment Type", property: "Shipmenttype" },
                        { label: "Priority Level", property: "Priorityalert" }
                    ]
                },
                dataSource: formattedRows,
                fileName: 'Track_Now_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },
       

      

            openTrackNowColNamesPopover: function (oEvent) {
                var oButton = oEvent.getSource();
                var oView = this.getView();
                var oController = this;

                if (!this._pTrackNowPopover) {
                    this._pTrackNowPopover = Fragment.load({
                        id: oView.getId(),
                        name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.TrackNow.TrackNowTableColumns",
                        controller: this
                    }).then(function (oPopover) {
                        oView.addDependent(oPopover);
                        return oPopover;
                    });
                }

                this._pTrackNowPopover.then(function (oPopover) {
                    oController._syncTrackNowColumnSelections();
                    oPopover.openBy(oButton);
                });
            },

            _syncTrackNowColumnSelections: function () {
                var oTable = Fragment.byId(this.getView().getId(), "myTrackNowColumnSelectId");
                if (!oTable) return;

                var aItems = oTable.getItems();
                aItems.forEach(function (oItem) {
                    var oContext = oItem.getBindingContext("eshipjetModel");
                    if (oContext) {
                        var oData = oContext.getObject();
                        oItem.setSelected(oData.visible === true);
                    }
                });
            },

            onTrackNowColNameSearch: function (oEvent) {
                var sQuery = oEvent.getSource().getValue();
                var oTable = Fragment.byId(this.getView().getId(), "myTrackNowColumnSelectId");
                if (!oTable) return;

                var oBinding = oTable.getBinding("items");
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new Filter("label", FilterOperator.Contains, sQuery));
                }
                oBinding.filter(aFilters);
            },

            onTrackNowColSelectClosePress: function () {
                this._pTrackNowPopover.then(function (oPopover) {
                    oPopover.close();
                });
            },

            onoTrackNowColSelectOkPress: function () {
                var oTable = Fragment.byId(this.getView().getId(), "myTrackNowColumnSelectId");
                var oModel = this.getOwnerComponent().getModel("eshipjetModel");
                var aColumns = oModel.getProperty("/TrackNowTableData/TrackNowColumns");

                oTable.getItems().forEach(function (oItem, iIndex) {
                    var oContext = oItem.getBindingContext("eshipjetModel");
                    if (oContext) {
                        var oData = oContext.getObject();
                        oData.visible = oItem.getSelected();
                    }
                });

                oModel.refresh(true);
                this.onTrackNowColSelectClosePress();
                // Optional: Call your specific table update logic here
                // this.getOrdersHistoryShipments();
            },

        onTrackNowFilterPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            // create popover
            if (!this._trackNowPopover) {
                this._trackNowPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.TrackNow.TrackNowFilterPopover",
                    controller: this
                }).then(function (trackNowPopover) {
                    oView.addDependent(trackNowPopover);
                    // trackNowPopover.bindElement("/ProductCollection/0");
                    return trackNowPopover;
                });
            }
            this._trackNowPopover.then(function (trackNowPopover) {
                trackNowPopover.openBy(oButton);
            });
        },
        onTrackNowFilterPopoverClosePress: function () {
            this.byId("idTrackNowFilterPopover").close();
        },
        onTrackNowFilterPopoverResetPress: function () {
            this.byId("idTrackNowFilterPopover").close();
        },
        
        onTrackNowFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var oModel = oView.getModel("eshipjetModel");
        
            // Model-bound filters
            var sLocation = oModel.getProperty("/TrackLoctionName");
            var sCarrier = oModel.getProperty("/TrackCarrierFilter");
            var sStatus = oModel.getProperty("/TrackShipmentStatusFilter");
        
            // Input field filters
            var dShipFrom = oView.byId("shipFromDateId1").getDateValue();
            var dShipTo = oView.byId("shipToDateId1").getDateValue();
            var sVbeln = oView.byId("DeliveryNum").getValue();
            var sRecCountry = oView.byId("ShipToCompany").getValue();
            var sTrackingNumber = oView.byId("TrackingNumber").getValue();
        
            if (sLocation) {
                aFilters.push(new sap.ui.model.Filter("Plant", sap.ui.model.FilterOperator.EQ, sLocation));
            }
            if (sCarrier) {
                aFilters.push(new sap.ui.model.Filter("Carriertype", sap.ui.model.FilterOperator.EQ, sCarrier));
            }
            if (sStatus) {
                aFilters.push(new sap.ui.model.Filter("Shipprocess", sap.ui.model.FilterOperator.EQ, sStatus));
            }
            if (dShipFrom && dShipTo) {
                aFilters.push(new sap.ui.model.Filter({
                    path: "DateAdded",
                    operator: sap.ui.model.FilterOperator.BT,
                    value1: dShipFrom,
                    value2: dShipTo
                }));
            }
            if (sVbeln) {
                aFilters.push(new sap.ui.model.Filter("Vbeln", sap.ui.model.FilterOperator.Contains, sVbeln));
            }
            if (sRecCountry) {
                aFilters.push(new sap.ui.model.Filter("RecCountry", sap.ui.model.FilterOperator.Contains, sRecCountry));
            }
            if (sTrackingNumber) {
                aFilters.push(new sap.ui.model.Filter("TrackingNumber", sap.ui.model.FilterOperator.Contains, sTrackingNumber));
            }
        
            var oTable = oView.byId("idTrackNowTable");
            var oBinding = oTable.getBinding("rows");
            oBinding.filter(aFilters);
        
            this.byId("idTrackNowFilterPopover").close();
        },
        onTrackNowFilterPopoverResetPress: function () {
            var oView = this.getView();
        
            // Reset UI fields
            oView.byId("locationComboId1").setSelectedKey("");
            oView.byId("shipFromDateId1").setDateValue(null);
            oView.byId("shipToDateId1").setDateValue(null);
            oView.byId("carrierComboId1").setSelectedKey("");
            oView.byId("statusComboId1").setSelectedKey("");
            oView.byId("DeliveryNum").setValue("");
            oView.byId("ShipToCompany").setValue("");
            oView.byId("TrackingNumber").setValue("");
        
            // Reset model values
            var oModel = oView.getModel("eshipjetModel");
            oModel.setProperty("/TrackLoctionName", "");
            oModel.setProperty("/TrackCarrierFilter", "");
            oModel.setProperty("/TrackShipmentStatusFilter", "");
        
            // Remove all filters from table
            var oTable = oView.byId("idTrackNowTable");
            oTable.getBinding("rows").filter([]);
        },
        
        
        onTrackNowDateFilterChange: function (oEvent) {
            var selectedKey = oEvent.getSource().getSelectedKey();
            var today = new Date();
            var aFilter = [];

            if (selectedKey === "today") {
                var start = new Date();
                start.setHours(0, 0, 0, 0);
                var end = new Date();
                end.setHours(23, 59, 59, 999);

                var dateFilter = new Filter({
                    path: "DateAdded",
                    operator: FilterOperator.BT,
                    value1: start,
                    value2: end
                });
                aFilter.push(dateFilter);
            }

            else if (selectedKey === "yesterday") {
                var start = new Date();
                start.setDate(start.getDate() - 1);
                start.setHours(0, 0, 0, 0);
                var end = new Date(start);
                end.setHours(23, 59, 59, 999);

                var dateFilter = new Filter({
                    path: "DateAdded",
                    operator: FilterOperator.BT,
                    value1: start,
                    value2: end
                });
                aFilter.push(dateFilter);
            }

            else if (selectedKey === "thisWeek") {
                var start = new Date();
                start.setDate(today.getDate() - today.getDay() + 1); // Monday
                start.setHours(0, 0, 0, 0);
                var end = new Date(start);
                end.setDate(start.getDate() + 6); // Sunday
                end.setHours(23, 59, 59, 999);

                aFilter.push(new Filter({
                    path: "DateAdded",
                    operator: FilterOperator.BT,
                    value1: start,
                    value2: end
                }));
            }

            else if (selectedKey === "lastWeek") {
                var start = new Date();
                start.setDate(today.getDate() - today.getDay() - 6); // Previous Monday
                start.setHours(0, 0, 0, 0);
                var end = new Date(start);
                end.setDate(start.getDate() + 6); // Previous Sunday
                end.setHours(23, 59, 59, 999);

                aFilter.push(new Filter({
                    path: "DateAdded",
                    operator: FilterOperator.BT,
                    value1: start,
                    value2: end
                }));
            }

            else if (selectedKey === "thisMonth") {
                var start = new Date(today.getFullYear(), today.getMonth(), 1);
                start.setHours(0, 0, 0, 0);
                var end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                end.setHours(23, 59, 59, 999);

                aFilter.push(new Filter({
                    path: "DateAdded",
                    operator: FilterOperator.BT,
                    value1: start,
                    value2: end
                }));
            }

            var orderTable = this.byId("idTrackNowTable");
            var oBindings = orderTable.getBinding("rows");
            oBindings.filter(aFilter);
            eshipjetModel.setProperty("/trackNowSelectedFilter", selectedKey);
        },
        
        
        
        
        // Track Now changes End


        // Manifest Changes Starts here

        _handleDisplayManifestTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var ManifestTableData = eshipjetModel.getData().ManifestTableData;
            var ManifestTableDataModel = new JSONModel(ManifestTableData);
            this.getView().setModel(ManifestTableDataModel, "ManifestTableDataModel");
            const oTable = oView.byId("idManifestTable");
            oTable.setModel(ManifestTableDataModel);
            var ManifestTableDataModel = this.getView().getModel("ManifestTableDataModel");
            var ManifestColumns = ManifestTableDataModel.getData().ManifestColumns;
            var count = 0;
            for (var i = 0; i < ManifestColumns.length; i++) {
                if (ManifestColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/ManifestColumns", function (sId, oContext) {
                columnName = oContext.getObject().name;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "CreatedDate" || columnName === "ShipDate") {
                    var DateTxt = new sap.m.Text({
                        text: {
                            path: 'ManifestTableDataModel>ShipDate',
                            formatter: formatter.formatDate  // Attach the formatter dynamically
                        },
                        wrapping: false
                    });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/ManifestRows");
        },

        openManifestColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pManifestPopover) {
                this._pManifestPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.Manifest.ManifestTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pManifestPopover.then(function (oPopover) {
                oController.ManifestColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        ManifestColumnsVisiblity: function () {
            var oView = oController.getView();
            var oManifestTableModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = oManifestTableModel.getProperty("/ManifestTableData/ManifestColumns");
            var oManifestTable = oView.byId("myManifestColumnSelectId");
            var aTableItems = oManifestTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.name === oItem.getBindingContext("ManifestTableDataModel").getObject().name && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onManifestColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myManifestColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onManifestColSelectOkPress: function () {
            var oView = this.getView()
            var oManifestTable = oView.byId("myManifestColumnSelectId");
            var ManifestTableDataModel = oView.getModel("ManifestTableDataModel");
            var oManifestTblItems = oManifestTable.getItems();
            var aColumnsData = ManifestTableDataModel.getProperty("/ManifestColumns");
            oManifestTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("ManifestTableDataModel").getObject().name === oColObj.name) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            ManifestTableDataModel.updateBindings(true);
            this._handleDisplayManifestTable();
            this._pManifestPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onManifestColSelectClosePress: function () {
            this._pManifestPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        onManifestPrintPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pManifestPrintPopover) {
                this._pManifestPrintPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.Manifest.ManifestPrintDialog",
                    controller: this
                }).then(function (oManifestPrintPopover) {
                    oView.addDependent(oManifestPrintPopover);
                    // oManifestPrintPopover.bindElement("/ProductCollection/0");
                    return oManifestPrintPopover;
                });
            }
            this._pManifestPrintPopover.then(function (oManifestPrintPopover) {
                oManifestPrintPopover.openBy(oButton);
            })
        },

        onManifestPrintClosePress: function () {
            this.byId("idManifestPrintPopover").close();
        },


        OnManifestExportToExcel: function () {
            
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/ManifestTableData/ManifestRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Request ID / Label ID", property: "requestIdLabelId" },
                        { label: "Created Date", property: "CreatedDate" },
                        { label: "Ship Date", property: "ShipDate" },
                        { label: "Shipment Type", property: "ShipmentType" },
                        { label: "Ship Method", property: "shipMethod" },
                        { label: "Service Name", property: "ServiceName" },
                        { label: "Tracking Number", property: "TrackingNumber" },
                        { label: "Status", property: "status" },
                        { label: "Ship To Contact", property: "ShipToContact" },
                        { label: "Ship To Company", property: "ShipToCompany" },
                        { label: "Ship To AddressLine1", property: "ShipToAddressLine1" },
                        { label: "Ship To City", property: "shipToCity" },
                        { label: "Ship To State", property: "shipToState" },
                        { label: "Ship To Country", property: "shipToCountry" },
                        { label: "Ship To Zipcode", property: "shipToZipcode" },
                        { label: "Ship To Phone", property: "shipToPhone" },
                        { label: "Ship To Email", property: "shipToEmail" },
                        { label: "Requestor Name", property: "requesterName" },
                        
                        { label: "Connected To", property: "connectedTo" },
                        { label: "Order Type", property: "orderType" },
                        { label: "Priority Level", property: "priorityLevel" },
                        { label: "Actions", property: "actions" },
                    ]
                },
                dataSource: rows,
                fileName: 'Manifast_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },
        // Manifest Changes End here

        // FeightAuditAnalysis start here's

        _handleDisplayFeightAuditAnalysisTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            // var FeightAuditAnalysisTableData = eshipjetModel.getData().FeightAuditAnalysisTableData;
            // var FeightAuditAnalysisTableDataModel = new JSONModel(FeightAuditAnalysisTableData);
            // this.getView().setModel(FeightAuditAnalysisTableDataModel, "FeightAuditAnalysisTableDataModel");
            const oTable = oView.byId("idFeightAuditAnalysisTable");
            oTable.setModel(eshipjetModel);
            var eshipjetModel = this.getView().getModel("eshipjetModel");
            var FeightAuditAnalysisColumns = eshipjetModel.getData().FeightAuditAnalysisColumns;
            var count = 0;
            for (var i = 0; i < FeightAuditAnalysisColumns.length; i++) {
                if (FeightAuditAnalysisColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/FeightAuditAnalysisColumns", function (sId, oContext) {
                columnName = oContext.getObject().name;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "Edit", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "CreatedDate" || columnName === "ShipDate") {
                    var DateTxt = new sap.m.Text({
                        text: {
                            path: 'eshipjetModel>ShipDate',
                            formatter: formatter.formatDate  // Attach the formatter dynamically
                        },
                        wrapping: false
                    });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/FeightAuditAnalysisRows");
        },
        openFeightAuditAnalysisColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pFeightAuditAnalysisPopover) {
                this._pFeightAuditAnalysisPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.FeightAuditAnalysis.FeightAuditAnalysisTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pFeightAuditAnalysisPopover.then(function (oPopover) {
                oController.FeightAuditAnalysisColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        FeightAuditAnalysisColumnsVisiblity: function () {
            var oView = oController.getView();
            var oFeightAuditAnalysisTableModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = oFeightAuditAnalysisTableModel.getProperty("/FeightAuditAnalysisColumns");
            var oFeightAuditAnalysisTable = oView.byId("myFeightAuditAnalysisColumnSelectId");
            var aTableItems = oFeightAuditAnalysisTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.name === oItem.getBindingContext("eshipjetModel").getObject().name && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onFeightAuditAnalysisColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myFeightAuditAnalysisColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onoFeightAuditAnalysisColSelectOkPress: function () {
            var oView = this.getView()
            var oFeightAuditAnalysisTable = oView.byId("myFeightAuditAnalysisColumnSelectId");
            var eshipjetModel = oView.getModel("eshipjetModel");
            var oFeightAuditAnalysisTblItems = oFeightAuditAnalysisTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/FeightAuditAnalysisColumns");
            var FeightAuditAnalysisColSelectedCount = 0;

            oFeightAuditAnalysisTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                            FeightAuditAnalysisColSelectedCount +=1;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            
            eshipjetModel.setProperty("/FeightAuditAnalysisColSelectedCount", FeightAuditAnalysisColSelectedCount);
            eshipjetModel.updateBindings(true);

            this._handleDisplayFeightAuditAnalysisTable();
            // this.getOrdersHistoryShipments();
            this._pFeightAuditAnalysisPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onFeightAuditAnalysisColSelectClosePress: function () {
            this._pFeightAuditAnalysisPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        onFeightAuditAnalysisFilterPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            // create popover
            if (!this._FeightAuditAnalysisPopover) {
                this._FeightAuditAnalysisPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.FeightAuditAnalysis.FeightAuditAnalysisFilterPopover",
                    controller: this
                }).then(function (FeightAuditAnalysisPopover) {
                    oView.addDependent(FeightAuditAnalysisPopover);
                    // FeightAuditAnalysisPopover.bindElement("/ProductCollection/0");
                    return FeightAuditAnalysisPopover;
                });
            }
            this._FeightAuditAnalysisPopover.then(function (FeightAuditAnalysisPopover) {
                FeightAuditAnalysisPopover.openBy(oButton);
            });
        },
        onFeightAuditAnalysisFilterPopoverClosePress: function () {
            this.byId("idFeightAuditAnalysisFilterPopover").close();
        },
        onFeightAuditAnalysisFilterPopoverResetPress: function () {
            this.byId("idFeightAuditAnalysisFilterPopover").close();
        },
        onFeightAuditAnalysisFilterPopoverApplyPress: function () {
            this.byId("idFeightAuditAnalysisFilterPopover").close();
        },


        // FeightAuditAnalysis ends here
        _handleDisplayBatchShipTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var BatchShipTableData = eshipjetModel.getData().BatchShipTableData;
            var BatchShipTableDataModel = new JSONModel(BatchShipTableData);
            this.getView().setModel(BatchShipTableDataModel, "BatchShipTableDataModel");
            const oTable = oView.byId("idBatchShipTable");
            oTable.setModel(BatchShipTableDataModel);
            var BatchShipTableDataModel = this.getView().getModel("BatchShipTableDataModel");
            var BatchShipColumns = BatchShipTableDataModel.getData().BatchShipColumns;
            var count = 0;
            for (var i = 0; i < BatchShipColumns.length; i++) {
                if (BatchShipColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/BatchShipColumns", function (sId, oContext) {
                columnName = oContext.getObject().name;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "CreatedDate" || columnName === "ShipDate") {
                    var DateTxt = new sap.m.Text({
                        text: {
                            path: 'BatchShipTableDataModel>ShipDate',
                            formatter: formatter.formatDate  // Attach the formatter dynamically
                        },
                        wrapping: false
                    });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/BatchShipRows");
        },

        openBatchShipColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pBatchShipPopover) {
                this._pBatchShipPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.BatchShip.BatchShipTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pBatchShipPopover.then(function (oPopover) {
                oController.BatchShipColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        BatchShipColumnsVisiblity: function () {
            var oView = oController.getView();
            var oBatchShipTableModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = oBatchShipTableModel.getProperty("/BatchShipTableData/BatchShipColumns");
            var oBatchShipTable = oView.byId("myBatchShipColumnSelectId");
            var aTableItems = oBatchShipTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.name === oItem.getBindingContext("BatchShipTableDataModel").getObject().name && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onBatchShipColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myBatchShipColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onBatchShipColSelectOkPress: function () {
            var oView = this.getView()
            var oBatchShipTable = oView.byId("myBatchShipColumnSelectId");
            var BatchShipTableDataModel = oView.getModel("BatchShipTableDataModel");
            var oBatchShipTblItems = oBatchShipTable.getItems();
            var aColumnsData = BatchShipTableDataModel.getProperty("/BatchShipColumns");
            oBatchShipTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("BatchShipTableDataModel").getObject().name === oColObj.name) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            BatchShipTableDataModel.updateBindings(true);
            this._handleDisplayBatchShipTable();
            this._pBatchShipPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onBatchShipColSelectClosePress: function () {
            this._pBatchShipPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        onBatchShipFilterPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._batchShipPopover) {
                this._batchShipPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.BatchShip.BatchShipFilterPopover",
                    controller: this
                }).then(function (batchShipPopover) {
                    oView.addDependent(batchShipPopover);
                    // batchShipPopover.bindElement("/ProductCollection/0");
                    return batchShipPopover;
                });
            }
            this._batchShipPopover.then(function (batchShipPopover) {
                batchShipPopover.openBy(oButton);
            });
        },
        onBatchShipFilterPopoverClosePress: function () {
            this.byId("idBatchShipFilterPopover").close();
        },
        onBatchShipFilterPopoverResetPress: function () {
            this.byId("idBatchShipFilterPopover").close();
        },
        onBatchShipFilterPopoverApplyPress: function () {
            this.byId("idBatchShipFilterPopover").close();
        },

        onBatchShipFilterPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._batchShipPopover) {
                this._batchShipPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.BatchShip.BatchShipFilterPopover",
                    controller: this
                }).then(function (batchShipPopover) {
                    oView.addDependent(batchShipPopover);
                    // batchShipPopover.bindElement("/ProductCollection/0");
                    return batchShipPopover;
                });
            }
            this._batchShipPopover.then(function (batchShipPopover) {
                batchShipPopover.openBy(oButton);
            });
        },
        onBatchShipFilterPopoverClosePress: function () {
            this.byId("idBatchShipFilterPopover").close();
        },
        onBatchShipFilterPopoverResetPress: function () {
            this.byId("idBatchShipFilterPopover").close();
        },
        onBatchShipFilterPopoverApplyPress: function () {
            this.byId("idBatchShipFilterPopover").close();
        },

       

        onBatchShipTotalFilterPress: function(){
            var oTable = this.getView().byId("idBatchShipTable"); // Ensure this is the actual table ID
            var oBinding = oTable.getBinding("rows");
            var oFilter = new sap.ui.model.Filter("status", sap.ui.model.FilterOperator.Contains, "Total");
            oBinding.filter([oFilter]);
        },
        
        onBatchShipopenFilterPress: function(){
            var oTable = this.getView().byId("idBatchShipTable"); // Ensure this is the actual table ID
            var oBinding = oTable.getBinding("rows");
            var oFilter = new sap.ui.model.Filter("status", sap.ui.model.FilterOperator.Contains, "open");
            oBinding.filter([oFilter]);
        },
        
        onBatchShipShippedFilterPress: function(){
            var oTable = this.getView().byId("idBatchShipTable"); // Ensure this is the actual table ID
            var oBinding = oTable.getBinding("rows");
            var oFilter = new sap.ui.model.Filter("status", sap.ui.model.FilterOperator.Contains, "Shipped");
            oBinding.filter([oFilter]);
        },
        
        onBatchShipCancelledFilterPress: function(){
            var oTable = this.getView().byId("idBatchShipTable"); // Ensure this is the actual table ID
            var oBinding = oTable.getBinding("rows");
            var oFilter = new sap.ui.model.Filter("status", sap.ui.model.FilterOperator.Contains, "Cancelled");
            oBinding.filter([oFilter]);
        },
        onBatchShipExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/BatchShipTableData/BatchShipRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Batch ID", property: "batchId", visible: true },
                        { label: "Batch Description", property: "batchDescription", visible: true },
                        { label: "Batch-Request ID", property: "BatchRequestId", visible: true },
                        { label: "Created Date", property: "CreatedDate", visible: true },
                        { label: "Ship Date", property: "ShipDate", visible: true },
                        { label: "Shipment Type", property: "ShipmentType", visible: true },
                        { label: "Ship Method", property: "shipMethod", visible: true },
                        { label: "Service Name", property: "ServiceName", visible: true },
                        { label: "Tracking Number", property: "TrackingNumber", visible: true },
                        { label: "Status", property: "status", visible: true },
                        { label: "Ship To Contact", property: "ShipToContact", visible: false },
                        { label: "Ship To Company", property: "ShipToCompany", visible: false },
                        { label: "Ship To AddressLine1", property: "ShipToAddressLine1", visible: false },
                        { label: "Ship To City", property: "shipToCity", visible: false },
                        { label: "Ship To State", property: "shipToState", visible: false },
                        { label: "Ship To Country", property: "shipToCountry", visible: false },
                        { label: "Ship To Zipcode", property: "shipToZipcode", visible: false },
                        { label: "Ship To Phone", property: "shipToPhone", visible: false },
                        { label: "Ship To Email", property: "shipToEmail", visible: false },
                        { label: "Requestor Name", property: "requesterName", visible: false },
                        { label: "Connected To", property: "connectedTo", visible: false },
                        { label: "Order Type", property: "orderType", visible: false },
                        { label: "Priority Level", property: "priorityLevel", visible: true },
                        { label: "RFID", property: "RFID", visible: true },
                        { label: "Updated", property: "Updated", visible: true },
                        { label: "Notes", property: "Notes", visible: true },
                        { label: "Actions", property: "actions", visible: true }
                    ]
                },
                
                dataSource: rows,
                fileName: 'BatchShip_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },


        
    

        onOpenRecentShipmentPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
            oView = this.getView();            
            var sPath = oEvent.getSource().getId().split("--");
            var btnId = sPath[sPath.length - 1];
            eshipjetModel.setProperty("/RecentShipmentTab", btnId);
            let myPromise =  new Promise((resolve, reject) => {
                oController.getHistoryShipments(resolve);
            });
            myPromise.then(
                function(response) {
                    // create popover
                    if (!oController._recentShipPopover) {
                        oController._recentShipPopover = Fragment.load({
                            id: oView.getId(),
                            name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.RecentShipment",
                            controller: oController
                        }).then(function (oPopover) {
                            oView.addDependent(oPopover);
                            return oPopover;
                        });
                    }
                    oController._recentShipPopover.then(function (oPopover) {
                        oPopover.openBy(oButton);
                    });
                },
                function(error) {
                   
                }
            );     

        },
        onRecentShipmentClosePress: function () {
            this._recentShipPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        parseDate: function(dateStr) {
            return new Date(dateStr.replace(" {}", "")); // Removing "{}" before parsing
        },

        getHistoryShipments:function(resolve){
            oController.onOpenBusyDialog();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var ManifestModel = oController.getOwnerComponent().getModel("ManifestModel");
            ManifestModel.read("/Manifest_detSet",{
                // urlParameters: {
                //     "$expand": "to_DeliveryDocumentItem,to_DeliveryDocumentPartner"
                // },
                success:function(response){
                  if (response?.results?.length) {

                // âœ… compress duplicates â†’ keep only first occurrence
                const unique = [];
                const seen = new Set();

                response.results.forEach(item => {
                    if (!seen.has(item.Vbeln)) {          // <-- change key if needed
                        seen.add(item.Vbeln);
                        unique.push(item);
                    }
                });

                // sort + latest 20
                const lastTwenty = unique
                    .sort((a, b) => new Date(a.DateAdded) - new Date(b.DateAdded))
                    .slice(-20)
                    .reverse();

                eshipjetModel.setProperty("/RecentShipmentSet", lastTwenty);
            }

            resolve();
            oController.onCloseBusyDialog();
                },
                error: function(error){
                    resolve();
                    MessageBox.warning(error.responseText);
                    oController.onCloseBusyDialog();
                }
            });

            // var obj = {
            //     "user_id":"info@eshipjet.ai",
            //     "filters":{
            //         "status":"Shipped",
            //         "locationid":"1001"
            //     }
            // };
            // var sPath = "https://dev-api-v1.eshipjet.site/shipments/gethistoryshipments";
            // $.ajax({
            //     url: sPath,
            //     method: "POST",
            //     contentType: "application/json",
            //     data: JSON.stringify(obj),
            //     success: function (response) {
            //         if(response && response.length > 0){
            //             eshipjetModel.setProperty("/RecentShipmentSet",response);
            //         }
            //         resolve();                      
            //         oController.oBusyDialog.close();
            //     },
            //     error: function (error) {
            //         console.log("Error:", error);
            //         resolve();
            //         MessageBox.warning(error.responseText);
            //         oController.oBusyDialog.close();
            //     }
            // });
        },

        // getOrdersHistoryShipments:function(){
        //     oController.onOpenBusyDialog();
        //     var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
        //     var ManifestSrvModel = oController.getOwnerComponent().getModel("ManifestSrvModel");
        //     var RecentShipmentTab = eshipjetModel.getProperty("/RecentShipmentTab");
          

        //     ManifestSrvModel.read("/EshipjetManfestSet",{
        //         // urlParameters: {
        //         //     "$expand": "to_DeliveryDocumentItem,to_DeliveryDocumentPartner"
        //         // },
        //         success:function(response){
        //             if (response && response.results.length > 0) {
        //                 // Get today's date info
        //                 const today = new Date();
        //                 const currentMonth = today.getMonth(); // 0-based index
        //                 const currentYear = today.getFullYear();
                
        //                 // Filter to only include current month entries
        //                 const filteredResults = response.results.filter(item => {
        //                     const itemDate = new Date(item.DateAdded);
        //                     return itemDate.getMonth() === currentMonth && itemDate.getFullYear() === currentYear;
        //                 });
                
        //                 // Sort filtered results by date and time
        //                 filteredResults.sort((a, b) => {
        //                     let dateA = new Date(a.DateAdded).getTime();
        //                     let dateB = new Date(b.DateAdded).getTime();
                
        //                     if (dateA !== dateB) {
        //                         return dateB - dateA; // Descending by date
        //                     }
                
        //                     return b.TimeAdded.ms - a.TimeAdded.ms; // Descending by time
        //                 });
                
        //                 // Normalize ShipmentType
        //                 var shippedCount = 0;
        //                 var cancelledCount = 0;
        //                 var openCount = 0;
        //                 var InTransistCount = 0;
        //                 var receivedCount = 0;
        //                 filteredResults.forEach(item => {
        //                     let shipmentValue = item.Type || item.Shipmenttype || item.ShipmentType;
        //                     if (shipmentValue && typeof shipmentValue === "string") {
        //                         shipmentValue = shipmentValue.trim().toUpperCase();
        //                         item.ShipmentType = shipmentValue === 'O' ? "Parcel" : "LTL";
        //                     } else {
        //                         item.ShipmentType = "LTL";
        //                     }
        //                     if(item.Shipprocess === "SHIP"){
        //                         shippedCount += 1;
        //                     }else if(item.Shipprocess === "CANC"){
        //                         cancelledCount += 1;
        //                     }else if(item.Shipprocess === "OPEN"){
        //                         openCount += 1;
        //                     }else if(item.Shipprocess === "InTransist"){
        //                         InTransistCount += 1;
        //                     }else if(item.Shipprocess === "RECEIVED"){
        //                         receivedCount += 1;
        //                     }
        //                 });
                
        //                 // Set the filtered, sorted data to the model
        //                 eshipjetModel.setProperty("/allOrders", filteredResults);
        //                 eshipjetModel.setProperty("/allOrdersLength", filteredResults.length);
        //                 eshipjetModel.setProperty("/shippedCount", shippedCount);
        //                 eshipjetModel.setProperty("/cancelledCount", cancelledCount);
        //                 eshipjetModel.setProperty("/openCount", openCount);
        //                 eshipjetModel.setProperty("/InTransistCount", InTransistCount);
        //                 eshipjetModel.setProperty("/receivedCount", receivedCount);
        //                 oController.setupPagination();
        //                 oController.setupTrackPagination();
        //                 var oTable = oController.getView().byId("idOrdersTable");
        //                 var oBinding = oTable.getBinding("rows");
        //                 oBinding.filter([]);

        //                 var oTable = oController.getView().byId("idTrackNowTable");
        //                 var oBinding = oTable.getBinding("rows");
        //                 oBinding.filter([]);

        //                 const allOrders = oController.getView().getModel("eshipjetModel").getProperty("/allOrders") || [];
        //                 const lastThree = allOrders.slice(-3); // Get last 3 entries
        //                 oController.getView().getModel("eshipjetModel").setProperty("/lastThreeNotes", lastThree);
        //             }
        //             oController.onCloseBusyDialog();
        //         },
        //         error: function(error){
        //             MessageBox.warning(error.responseText);
        //             oController.onCloseBusyDialog();
        //         }
        //     });
        // },

getOrdersHistoryShipments: function () {
    const oController = this;
    oController.onOpenBusyDialog();

    const eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
    const ManifestModel = oController.getOwnerComponent().getModel("ManifestModel");

    ManifestModel.read("/Manifest_detSet", {
        success: function (response) {

            if (!response || !response.results || !response.results.length) {
                oController.onCloseBusyDialog();
                return;
            }

            /* =====================================================
             * STEP 1: Normalize SAP Response
             * ===================================================== */
            const normalized = response.results.map(item => {

                let createdDate = null;
                if (item.CreatedOn) {
                    // SAP /Date(1763424000000)/
                    const ts = Number(item.CreatedOn.replace(/\D/g, ""));
                    createdDate = isNaN(ts) ? null : new Date(ts);
                }

                return {
                    Vbeln: item.Vbeln,
                    Plant: item.Plant,
                    CarrierDesc: item.CarrierDesc,
                    Carriertype: item.Carriertype,
                    CarrierCode: item.ServiceName || "",
                    Shipmentid: item.ServiceName || "",
                    ShipmentType: item.ShipMethod || "LTL",
                    Shipprocess: (item.ShipStatus || "").toUpperCase(),
                    TrackingNumber: item.TrackingNumber,
                    DateAdded: createdDate,

                    RecContact: item.ShipToContact || "",
                    RecCompany: item.ShipToCompany || "",
                    RecCity: item.ShipToCity || "",
                    RecRegion: item.ShipToState || "",
                    RecPostalcode: item.ShipToPostalcode || "",
                    RecPhone: item.ShipToPhoneNumber || "",
                    Emailaddress: item.ShipToEmail || "",
                    Totalpkg: parseInt(item.Totalpkg || "0", 10)
                };
            });

            /* =====================================================
             * STEP 2: Deduplicate by VBELN
             * ===================================================== */
            const uniqueMap = new Map();
            normalized.forEach(item => {
                if (!uniqueMap.has(item.Vbeln)) {
                    uniqueMap.set(item.Vbeln, item);
                }
            });

            const unique = Array.from(uniqueMap.values());

            /* =====================================================
             * STEP 3: Date Filter (Last 60 Days + Future Safe)
             * ===================================================== */
            const today = new Date();
            const pastDate = new Date();
            pastDate.setDate(today.getDate() - 60);

            const filtered = unique.filter(item =>
                item.DateAdded &&
                item.DateAdded >= pastDate &&
                item.DateAdded <= new Date(today.getTime() + 1000 * 60 * 60 * 24 * 365)
            );

            /* =====================================================
             * STEP 4: Sort (Newest First)
             * ===================================================== */
            filtered.sort((a, b) => (b.DateAdded || 0) - (a.DateAdded || 0));

            /* =====================================================
             * STEP 5: Status Counters
             * ===================================================== */
            let counters = {
                shipped: 0,
                cancelled: 0,
                open: 0,
                inTransit: 0,
                received: 0,
                billed: 0,
                pickedUp: 0,
                delayed: 0,
                delivered: 0
            };

            filtered.forEach(item => {
                switch (item.Shipprocess) {
                    case "SHIPPED":
                        counters.shipped++;
                        break;
                    case "CANCELLED":
                        counters.cancelled++;
                        break;
                    case "OPEN":
                        counters.open++;
                        break;
                    case "INTRANSIT":
                        counters.inTransit++;
                        break;
                    case "RECEIVED":
                        counters.received++;
                        break;
                    case "BILLED":
                        counters.billed++;
                        break;
                    case "PICKED":
                        counters.pickedUp++;
                        break;
                    case "DELAYED":
                        counters.delayed++;
                        break;
                    case "DELIVERED":
                        counters.delivered++;
                        break;
                }
            });

            /* =====================================================
             * STEP 6: Set Model Data
             * ===================================================== */
            eshipjetModel.setProperty("/allOrders", filtered);
            eshipjetModel.setProperty("/allOrdersLength", filtered.length);

            eshipjetModel.setProperty("/shippedCount", counters.shipped);
            eshipjetModel.setProperty("/cancelledCount", counters.cancelled);
            eshipjetModel.setProperty("/openCount", counters.open);
            eshipjetModel.setProperty("/InTransistCount", counters.inTransit);
            eshipjetModel.setProperty("/receivedCount", counters.received);
            eshipjetModel.setProperty("/billedCount", counters.billed);
            eshipjetModel.setProperty("/pickUpCount", counters.pickedUp);
            eshipjetModel.setProperty("/delayedCount", counters.delayed);
            eshipjetModel.setProperty("/deliveredCount", counters.delivered);

            eshipjetModel.setProperty("/lastThreeNotes", filtered.slice(0, 3));

            /* =====================================================
             * STEP 7: Refresh UI
             * ===================================================== */
            oController.setupPagination();
            oController.setupTrackPagination();

            const oTable = oController.byId("idOrdersTable");
            if (oTable && oTable.getBinding("rows")) {
                oTable.getBinding("rows").filter([]);
            }

            const oTrackTable = oController.byId("idTrackNowTable");
            if (oTrackTable && oTrackTable.getBinding("rows")) {
                oTrackTable.getBinding("rows").filter([]);
            }

            oController.onCloseBusyDialog();
        },

        error: function (err) {
            sap.m.MessageBox.error(err.responseText || "Failed to load orders");
            oController.onCloseBusyDialog();
        }
    });
},



         // Setup fq Pagination

         setupFreightQuotePagination: function () {
            const oModel = this.getOwnerComponent().getModel("eshipjetModel");
            this._freightPageSize = 50;
        
            this._freightAllData = oModel.getProperty("/FreightQuoteOrdersData") || [];
            this._freightTotalItems = this._freightAllData.length;
            this._freightTotalPages = Math.ceil(this._freightTotalItems / this._freightPageSize);
            this._freightCurrentPage = 1;
        
            this._updateFreightPagedData();
        },
        
        _updateFreightPagedData: function () {
            const startIndex = (this._freightCurrentPage - 1) * this._freightPageSize;
            const endIndex = Math.min(startIndex + this._freightPageSize, this._freightTotalItems);
            const pagedData = this._freightAllData.slice(startIndex, endIndex);
        
            const oModel = this.getOwnerComponent().getModel("eshipjetModel");
            oModel.setProperty("/FreightQuoteOrdersPaged", pagedData);
        
            // Update pagination text
            this.byId("FreightQuoteOrdersPaginationText").setText(`${startIndex + 1}-${endIndex} of ${this._freightTotalItems}`);
        
            // Update visibility statuses
            oModel.setProperty("/FreightFirstVisible", this._freightCurrentPage > 1);
            oModel.setProperty("/FreightPrevVisible", this._freightCurrentPage > 1);
            oModel.setProperty("/FreightNextVisible", this._freightCurrentPage < this._freightTotalPages);
            oModel.setProperty("/FreightLastVisible", this._freightCurrentPage < this._freightTotalPages);
        },
        
        onFreightFirstPage: function () {
            this._freightCurrentPage = 1;
            this._updateFreightPagedData();
        },
        
        onFreightPreviousPage: function () {
            if (this._freightCurrentPage > 1) {
                this._freightCurrentPage--;
                this._updateFreightPagedData();
            }
        },
        
        onFreightNextPage: function () {
            if (this._freightCurrentPage < this._freightTotalPages) {
                this._freightCurrentPage++;
                this._updateFreightPagedData();
            }
        },
        
        onFreightLastPage: function () {
            this._freightCurrentPage = this._freightTotalPages;
            this._updateFreightPagedData();
        },
        

                    // Setup ShipReq Pagination
                    setupShipReqPagination: function () {
                        const oModel = this.getView().getModel("eshipjetModel");
                        const allShipReqs = oModel.getProperty("/RecentShipmentSetShipReqLabel") || [];
                    
                        this._pageSize = 50;
                        this._shipReqCurrentPage = 1;
                        this._shipReqTotalItems = allShipReqs.length;
                        this._shipReqTotalPages = Math.ceil(this._shipReqTotalItems / this._pageSize);
                    
                        this._updateShipReqPagedData();
                    },
                    

                    _updateShipReqPagedData: function () {
                        const oModel = this.getView().getModel("eshipjetModel");
                        const allShipReqs = oModel.getProperty("/RecentShipmentSetShipReqLabel") || [];
                    
                        const startIndex = (this._shipReqCurrentPage - 1) * this._pageSize;
                        const endIndex = Math.min(startIndex + this._pageSize, allShipReqs.length);
                        const pagedData = allShipReqs.slice(startIndex, endIndex);
                    
                        oModel.setProperty("/ShipReqPagedData", pagedData);
                        oModel.setProperty("/ShipReqPaginationText", `${startIndex + 1}-${endIndex} of ${allShipReqs.length}`);
                    
                        const isFirstPage = this._shipReqCurrentPage === 1;
                        const isLastPage = this._shipReqCurrentPage === this._shipReqTotalPages;
                    
                        oModel.setProperty("/ShipReqFirstVisible", !isFirstPage);
                        oModel.setProperty("/ShipReqPrevVisible", !isFirstPage);
                        oModel.setProperty("/ShipReqNextVisible", !isLastPage);
                        oModel.setProperty("/ShipReqLastVisible", !isLastPage);
                    },
                    


                onShipReqFirstPage: function () {
                    this._shipReqCurrentPage = 1;
                    this._updateShipReqPagedData();
                },

                onShipReqPreviousPage: function () {
                    if (this._shipReqCurrentPage > 1) {
                        this._shipReqCurrentPage--;
                        this._updateShipReqPagedData();
                    }
                },

                onShipReqNextPage: function () {
                    if (this._shipReqCurrentPage < this._shipReqTotalPages) {
                        this._shipReqCurrentPage++;
                        this._updateShipReqPagedData();
                    }
                },

                onShipReqLastPage: function () {
                    this._shipReqCurrentPage = this._shipReqTotalPages;
                    this._updateShipReqPagedData();
                },

        // Setup Orders Pagination
        setupPagination: function () {
            const oModel = this.getView().getModel("eshipjetModel");
            this._totalItems = oModel.getProperty("/allOrders")?.length || 0;
            this._totalPages = Math.ceil(this._totalItems / this._pageSize);
            this._currentPage = 1;
            this._updatePagedOrders();
        },
        
       _updatePagedOrders: function () {
            const allOrders = eshipjetModel.getProperty("/allOrders") || [];

            const startIndex = (this._currentPage - 1) * this._pageSize;
            const endIndex = Math.min(startIndex + this._pageSize, allOrders.length);
            const pagedData = allOrders.slice(startIndex, endIndex);

            eshipjetModel.setProperty("/pagedOrders", pagedData);

            // Update pagination text
            this.byId("paginationText").setText(`${startIndex + 1}-${endIndex} of ${this._totalItems}`);

            // Update visibility statuses in the model
            eshipjetModel.setProperty("/FirstBtnVisableStatus", this._currentPage > 1);
            eshipjetModel.setProperty("/PreviousBtnVisableStatus", this._currentPage > 1);
            eshipjetModel.setProperty("/NextBtnVisableStatus", this._currentPage < this._totalPages);
            eshipjetModel.setProperty("/LastBtnVisableStatus", this._currentPage < this._totalPages);
        },

        
        onFirstPage: function () {
            this._currentPage = 1;
            this._updatePagedOrders();
        },
        
        onPreviousPage: function () {
            if (this._currentPage > 1) {
                this._currentPage--;
                this._updatePagedOrders();
            }
        },
        
        onNextPage: function () {
            if (this._currentPage < this._totalPages) {
                this._currentPage++;
                this._updatePagedOrders();
            }
        },
        
        onLastPage: function () {
            this._currentPage = this._totalPages;
            this._updatePagedOrders();
        },



        setupTrackPagination: function () {
            const oModel = this.getView().getModel("eshipjetModel");
            this._trackTotalItems = oModel.getProperty("/allOrders")?.length || 0;
            this._trackTotalPages = Math.ceil(this._trackTotalItems / this._pageSize);
            this._trackCurrentPage = 1;
            this._updatePagedTrackOrders();
        },
        _updatePagedTrackOrders: function () {
            const allOrders = this.getView().getModel("eshipjetModel").getProperty("/allOrders") || [];
        
            const startIndex = (this._trackCurrentPage - 1) * this._pageSize;
            const endIndex = Math.min(startIndex + this._pageSize, allOrders.length);
            const pagedData = allOrders.slice(startIndex, endIndex);
        
            this.getView().getModel("eshipjetModel").setProperty("/pagedTrackOrders", pagedData);
        
            // Update pagination text if needed
            this.byId("paginationTextTrack").setText(`${startIndex + 1}-${endIndex} of ${this._trackTotalItems}`);
        
            // Update visibility status
            const oModel = this.getView().getModel("eshipjetModel");
            oModel.setProperty("/TrackFirstVisible", this._trackCurrentPage > 1);
            oModel.setProperty("/TrackPrevVisible", this._trackCurrentPage > 1);
            oModel.setProperty("/TrackNextVisible", this._trackCurrentPage < this._trackTotalPages);
            oModel.setProperty("/TrackLastVisible", this._trackCurrentPage < this._trackTotalPages);
        },
        onTrackFirstPage: function () {
            this._trackCurrentPage = 1;
            this._updatePagedTrackOrders();
        },
        
        onTrackPreviousPage: function () {
            if (this._trackCurrentPage > 1) {
                this._trackCurrentPage--;
                this._updatePagedTrackOrders();
            }
        },
        
        onTrackNextPage: function () {
            if (this._trackCurrentPage < this._trackTotalPages) {
                this._trackCurrentPage++;
                this._updatePagedTrackOrders();
            }
        },
        
        onTrackLastPage: function () {
            this._trackCurrentPage = this._trackTotalPages;
            this._updatePagedTrackOrders();
        },
        
        
        
        

        onOrdersDateFilterChange: function (oEvent) {
            var selectedKey = oEvent.getSource().getSelectedKey();
            var today = new Date();
            var aFilter = [];

            if (selectedKey === "today") {
                var start = new Date();
                start.setHours(0, 0, 0, 0);
                var end = new Date();
                end.setHours(23, 59, 59, 999);

                var dateFilter = new Filter({
                    path: "DateAdded",
                    operator: FilterOperator.BT,
                    value1: start,
                    value2: end
                });
                aFilter.push(dateFilter);
            }

            else if (selectedKey === "yesterday") {
                var start = new Date();
                start.setDate(start.getDate() - 1);
                start.setHours(0, 0, 0, 0);
                var end = new Date(start);
                end.setHours(23, 59, 59, 999);

                var dateFilter = new Filter({
                    path: "DateAdded",
                    operator: FilterOperator.BT,
                    value1: start,
                    value2: end
                });
                aFilter.push(dateFilter);
            }

            else if (selectedKey === "thisWeek") {
                var start = new Date();
                start.setDate(today.getDate() - today.getDay() + 1); // Monday
                start.setHours(0, 0, 0, 0);
                var end = new Date(start);
                end.setDate(start.getDate() + 6); // Sunday
                end.setHours(23, 59, 59, 999);

                aFilter.push(new Filter({
                    path: "DateAdded",
                    operator: FilterOperator.BT,
                    value1: start,
                    value2: end
                }));
            }

            else if (selectedKey === "lastWeek") {
                var start = new Date();
                start.setDate(today.getDate() - today.getDay() - 6); // Previous Monday
                start.setHours(0, 0, 0, 0);
                var end = new Date(start);
                end.setDate(start.getDate() + 6); // Previous Sunday
                end.setHours(23, 59, 59, 999);

                aFilter.push(new Filter({
                    path: "DateAdded",
                    operator: FilterOperator.BT,
                    value1: start,
                    value2: end
                }));
            }

            else if (selectedKey === "thisMonth") {
                var start = new Date(today.getFullYear(), today.getMonth(), 1);
                start.setHours(0, 0, 0, 0);
                var end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                end.setHours(23, 59, 59, 999);

                aFilter.push(new Filter({
                    path: "DateAdded",
                    operator: FilterOperator.BT,
                    value1: start,
                    value2: end
                }));
            }

            var orderTable = this.byId("idOrdersTable");
            var oBindings = orderTable.getBinding("rows");
            oBindings.filter(aFilter);
            eshipjetModel.setProperty("/ordersSelectedFilter", selectedKey);
        },

        getShipReqLabelHistoryShipments:function(){
            oController.onOpenBusyDialog();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var ManifestSrvModel = oController.getOwnerComponent().getModel("ManifestSrvModel");
            ManifestSrvModel.read("/EshipjetManfestSet",{
                // urlParameters: {
                //     "$expand": "to_DeliveryDocumentItem,to_DeliveryDocumentPartner"
                // },
                success:function(response){
                    var last50Records = response.results.slice(-50);

                    var shipReqShippedCount = 0;
                    var shipReqCancelledCount = 0;
                    var shipReqOpenCount = 0;
                    last50Records.forEach(item => {
                        let shipmentValue = item.Type || item.Shipmenttype || item.ShipmentType;
                        if (shipmentValue && typeof shipmentValue === "string") {
                            shipmentValue = shipmentValue.trim().toUpperCase();
                            item.Shipmenttype = shipmentValue === 'O' ? "Parcel" : "LTL";
                        } else {
                            item.Shipmenttype = "LTL";
                        }
                        if(item.Shipprocess === "SHIP"){
                            shipReqShippedCount += 1;
                        }else if(item.Shipprocess === "CANC"){
                            shipReqCancelledCount += 1;
                        }else if(item.Shipprocess === "OPEN"){
                            shipReqOpenCount += 1;
                        }
                    });
            
                    // Set the filtered, sorted data to the model
                    eshipjetModel.setProperty("/RecentShipmentSetShipReqLabel", last50Records);
                    // eshipjetModel.setProperty("/RecentShipmentSetShipReqLabel", aData);
                    oController.setupShipReqPagination();

                    eshipjetModel.setProperty("/allshipReqLength", last50Records.length);
                    eshipjetModel.setProperty("/shipReqShippedCount", shipReqShippedCount);
                    eshipjetModel.setProperty("/shipReqCancelledCount", shipReqCancelledCount);
                    eshipjetModel.setProperty("/shipReqOpenCount", shipReqOpenCount);
                    
                    var oTable = Fragment.byId(oController.getView().getId(), "idShipReqsTable");
                    var oBinding = oTable.getBinding("rows");
                    oBinding.filter([]);

                    oController.onCloseBusyDialog();
                },
                error: function(error){
                    MessageBox.warning(error.responseText);
                    oController.onCloseBusyDialog();
                }
            });
        },

        handleshipReqFilterPress:function(oEvent){
            var aFilterId = oEvent.getSource().getId().split("--");
            var oText = aFilterId[aFilterId.length-1];
            var oFilterText;
            var oTable = Fragment.byId(this.getView().getId(), "idShipReqsTable");
            var oBinding = oTable.getBinding("rows");
            
            if(oText === "idShipReqShippedBtn"){
                oFilterText = "SHIP";
            }else if(oText === "idShipRequCancelledBtn"){
                oFilterText = "CANC";
            }else if(oText === "idShipReqOpenBtn"){
                oFilterText = "Open";
            }else if(oText === "idShipReqTotalBtn"){
                return oBinding.filter([]);
            }
            
            var oFilter = new sap.ui.model.Filter("Shipprocess", sap.ui.model.FilterOperator.EQ, oFilterText);
            oBinding.filter([oFilter]);
        },

        onColumnSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myScanColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },
        onPressSettingsButton: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            // create popover
            if (!this._dashBoardAddPopover) {
                this._dashBoardAddPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.DashboardAddIconPopover",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._dashBoardAddPopover.then(function (oPopover) {
                oPopover.openBy(oButton);
            });

        },

        handlePopoverListItemPress: function (oEvent) {
            var oHeader = $(".sapTntToolHeader.sapMTBStandard");
            oHeader.removeClass("customHeaderStyle");
            oHeader.addClass("alHeaderStyle"); // Add new style
            
            var oSrc = oEvent.getSource();
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/commonValues/allViewsFooter", true);
            eshipjetModel.setProperty("/commonValues/shipNowViewFooter", false);
            eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
            eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);

            eshipjetModel.setProperty("/showDarkThemeSwitch", false);
            var oCurrObj = oSrc.getBindingContext().getObject();
            var oToolPage = this.byId("toolPage");
            var oPageContainer = this.byId("pageContainer");
            oToolPage.setSideExpanded(false);
            this._dashBoardAddPopover.then(function (oPopover) {
                oPopover.close();
            });
            if (oCurrObj && oCurrObj.name === "Locations *") {

                oController._displayTables("_IDLocationTable", "LocationTableColumns", "LocationTableRows", "Locations");
                oPageContainer.to(oView.createId("_ID_Location_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "Address Book *") {

                oController._displayTables("_IDAddressBookTable", "AddressBookTableColumns", "AddressBookTableRows", "Address Book");
                oPageContainer.to(oView.createId("_ID_AddressBook_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "Users *") {

                oController._displayTables("_IDUsersTable", "UsersTableColumns", "UsersTableRows", "Users");
                oPageContainer.to(oView.createId("_ID_Users_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "Roles *") {

                oController._displayTables("_IDRolesTable", "RolesTableColumns", "RolesTableRows", "Roles");
                oPageContainer.to(oView.createId("_ID_Roles_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "Carrier Catalog *") {
                oController.onGetCarrierCatalogData();
                // oController._displayTables("_IDCarriesCatalogTable", "CarrierCatalogTableColumns", "CarrierCatalogTableRows", "Carrier Catalog");
                oPageContainer.to(oView.createId("_ID_CarrierCatalog_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "Carrier Accounts *") {
                oController.onGetCarrierAccoData();
                // oController._displayTables("_IDCarriesAccountsTable", "CarrierAccountsTableColumns", "CarrierAccountsTableRows", "Carrier Accounts");
                oPageContainer.to(oView.createId("_ID_CarrierAccounts_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "Cost Centers") {

                oController._displayTables("_IDCostCenterTable", "CostCenterTableColumns", "CostCenterTableRows", "Cost Centers");
                oPageContainer.to(oView.createId("_ID_CostCenters_TableScrollContainer"));
            } else if (oCurrObj && oCurrObj.name === "Freight Condition") {

                oController._displayTables("_IDFreightConditionTable", "FreightConditionTableColumns", "FreightConditionTableRows", "Freight Condition");
                oPageContainer.to(oView.createId("_ID_FreightCondition_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "Module Status Codes") {

                oController._displayTables("_IDStatusesTable", "StatusesTableColumns", "StatusesTableRows", "Statuses");
                oPageContainer.to(oView.createId("_ID_Statuses_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "Products *") {

                oController._displayTables("_IDProductsTable", "ProductsTableColumns", "ProductsTableRows", "Products");
                oPageContainer.to(oView.createId("_ID_Products_TableScrollContainer"));


            } else if (oCurrObj && oCurrObj.name === "Package Types") {

                oController._displayTables("_IDPackageTypesTable", "PackageTypeTableColumns", "PackageTypeTableRows", "Package Types");
                oPageContainer.to(oView.createId("_ID_PackageTypes_TableScrollContainer"));
                
            } else if (oCurrObj && oCurrObj.name === "Document Catalog") {
                oController._handleDisplayDangerousGoodsTable();
                oController._displayTables("_IDDangerousGoodsTable", "DangerousGoodsTableColumns", "DangerousGoodsTableRows", "Document Catalog");
                oPageContainer.to(oView.createId("_ID_DangerousGoods_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "Third Party") {

                oController._displayTables("_IDThirdPartyTable", "ThirdPartiesTableColumns", "ThirdPartiesTableRows", "Third Party");
                oPageContainer.to(oView.createId("_ID_ThirdParties_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "Carrier Address *") {

                oController._displayTables("_IDLTLClassTable", "LtlClassesTableColumns", "LtlClassesTableRows", "LTL Classes");
                oPageContainer.to(oView.createId("_ID_LTLClasses_TableScrollContainer"));
            
            } else if (oCurrObj && oCurrObj.name === "Common Error Logs") {

                oController._displayTables("_IDCommonErrorLogsTable", "CommonErrorLogsTableColumns", "CommonErrorLogsTableRows", "Common Error Logs");
                oPageContainer.to(oView.createId("_ID_CommonErrorLogs_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "NMFC Class") {

                oController._displayTables("_IDNMFCTable", "NmfcTableColumns", "NmfcTableRows", "NMFC Class");
                oPageContainer.to(oView.createId("_ID_NMFC_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "MOT") {

                oController._displayTables("_IDModeOfTransportTable", "MotTableColumns", "MotTableRows", "MOT");
                oPageContainer.to(oView.createId("_ID_MOT_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "Order Types") {

                oController._displayTables("_IDOrderTypeTable", "OrderTypesTableColumns", "OrderTypesTableRows", "Order Types");
                oPageContainer.to(oView.createId("_ID_OrderTypes_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "Incoterms") {

                oController._displayTables("_ID_IncotermsTable", "IncoTermsTableColumns", "IncoTermsTableRows", "Incoterms");
                oPageContainer.to(oView.createId("_ID_Incoterms_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "Pro Number Range") {

                oController._displayTables("_ID_TrackingRangeTable", "TrackingRangeTableColumns", "TrackingRangeTableRows", "Pro Number Range");
                oPageContainer.to(oView.createId("_ID_TrackingRange_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "Dimensions") {

                oController._displayTables("_ID_DimensionTable", "DimensionsTableColumns", "DiemnsionsTableRows", "Dimensions");
                oPageContainer.to(oView.createId("_ID_Dimensions_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "Payment Types") {

                oController._displayTables("_ID_PaymentTypeTable", "PaymentTypesTableColumns", "PaymentTypesTableRows", "Payment Types");
                oPageContainer.to(oView.createId("_ID_PaymentTypes_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "SMTP Configuration") {

                oController._displayTables("_ID_SMTPConfigTable", "SMTPConfigsTableColumns", "SMTPConfigsTableRows", "SMTP Configuration");
                oPageContainer.to(oView.createId("_ID_SMTPConfig_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "ERP Configuration") {

                oController._displayTables("_ID_ERPTable", "ERPTableColumns", "ERPTableRows", "ERP Configuration");
                oPageContainer.to(oView.createId("_ID_ERP_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "Default Configuration") {

                this.OpenDefaultConfigDialog();
            } else if (oCurrObj && oCurrObj.name === "Peripheral Configuration") {

                this.OpenPeripheralConfigurationDialog();
            } else if (oCurrObj && oCurrObj.name === "Lock/Unlock User") {

                this.OpenLockUnlockUserDialog();
          
            } else if (oCurrObj && oCurrObj.name === "Company Settings") {

                this.OpenCompanySettingsDialog();
            } else if (oCurrObj && oCurrObj.name === "Reset Password") {

                this.OpenResetPasswordDialog();

            } else if (oCurrObj && oCurrObj.name === "Unlock Delivery Number") {

                this.OpenUnlockDeliveryNumberDialog();

            } else if (oCurrObj && oCurrObj.name === "User Audit Trail") {
                eshipjetModel.setProperty("/commonValues/toolPageHeader", false);
                eshipjetModel.setProperty("/commonValues/allViewsFooter", false);
                oController._displayTables("_ID_CountriesTable", "CountriesTableColumns", "CountriesTableRows", "User Audit Trail");
                oPageContainer.to(oView.createId("_ID_Countries_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "Return Address") {

                oController._displayTables("_ID_EUCountriesTable", "EUCountriesTableColumns", "EUCountriesTableRows", "Return Address");
                oPageContainer.to(oView.createId("_ID_EUCountries_TableScrollContainer"));
            } else if (oCurrObj && oCurrObj.name === "Shipment Error Logs") {

                oController._displayTables("_ID_ShipmentErrorLogsTable", "ShipmentErrorLogsTableColumns", "ShipmentErrorLogsTableRows", "Shipment Error Logs");
                oPageContainer.to(oView.createId("_ID_ShipmentErrorLogs_TableScrollContainer"));

            } else if (oCurrObj && oCurrObj.name === "Routing Guide") {

                oController._displayTables("_IDRoutingGuideTable", "RoutingGuideTableColumns", "RoutingGuideTableRows", "Routing Guide");
                oPageContainer.to(oView.createId("_ID_RoutingGuide_TableScrollContainer"));

            } eshipjetModel.setProperty("/SideNavigation", false);
        },
        _displayTables: function (oTableId, aColumns, aRows, selectedItem) {
            var oView = oController.getView(), columnName, columnLabel;
            const oTable = oView.byId(oTableId);
            var oModel = oView.getModel();
            if (oTable) {
                oTable.setModel(oModel);
                oTable.bindColumns("/" + aColumns, function (sId, oContext) {
                    columnName = oContext.getObject().key;
                    columnLabel = oContext.getObject().label;

                    if (columnName === "actions") {
                        var oHBox = new sap.m.HBox({ alignItems: "Center", justifyContent: "Start" });
                        var Link1 = new sap.m.Link({ 
                            text: "View", 
                            press: function () {
                                // handle view press if needed
                            }
                        });
                        var Link2 = new sap.m.Button({
                            icon: "sap-icon://megamenu",
                            type: "Transparent",
                            press: function (oEvent) {
                                // handle dropdown press if needed
                            }
                        });
                        oHBox.addItem(Link1);
                        oHBox.addItem(Link2);
                        return new sap.ui.table.Column({
                            label: oResourceBundle.getText(columnName),
                            template: oHBox,
                            visible: oContext.getObject().visible,
                            sortProperty: columnName
                        });

                    } else if (columnName === "status") {
                        var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                        return new sap.ui.table.Column({
                            label: oResourceBundle.getText(columnName),
                            template: oSwitch,
                            visible: oContext.getObject().visible,
                            sortProperty: columnName
                        });
                    } else {
                        return new sap.ui.table.Column({
                            label: oResourceBundle.getText(columnName),
                            template: columnName,
                            visible: oContext.getObject().visible,
                            sortProperty: columnName
                        });
                    }
                });
                oTable.bindRows("/" + aRows);
            }
        },

        onThemeChange: function (oEvent) {
            var oHeader = $(".sapTntToolHeader.sapMTBStandard");
            var bState = oEvent.getSource().getState();

            if (bState && oHeader.hasClass("customHeaderStyle")) {
                document.body.classList.remove("dark-theme");
                oHeader.removeClass("customHeaderStyle");
            } else {
                document.body.classList.add("dark-theme");
                oHeader.addClass("customHeaderStyle");
            }
        },
        OpenDefaultConfigDialog: function () {
            var oView = this.getView();
            if (!this.byId("DefaultconfopenDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.DefaultConfigDialog",
                    controller: this // Pass the controller for binding
                }).then(function (oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("DefaultconfopenDialog").open(); // Open existing dialog
            }
        },
        DefaultCancelDialog: function () {
            this.byId("DefaultconfopenDialog").close();
        },
        DefaultSaveDialog: function () {
            this.byId("DefaultconfopenDialog").close();
        },
        onDefaultConfigurationClosePress: function () {
            this.byId("DefaultconfopenDialog").close();
        },

        OpenLockUnlockUserDialog: function () {
            var oView = this.getView();
            if (!this.byId("DefaultconfopenDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.LockUnlockUserDialog",
                    controller: this // Pass the controller for binding
                }).then(function (oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("DefaultconfopenDialog").open(); // Open existing dialog
            }
        },
        DefaultCancelDialog: function () {
            this.byId("DefaultconfopenDialog").close();
        },
        DefaultSaveDialog: function () {
            this.byId("DefaultconfopenDialog").close();
        },
        onDefaultConfigurationClosePress: function () {
            this.byId("DefaultconfopenDialog").close();
        },


        // Address Book Column Names Popover code changes starts here

        openAddressBookColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pAddressBookPopover) {
                this._pAddressBookPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddressBookTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pAddressBookPopover.then(function (oPopover) {
                oController.AddressBookColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        AddressBookColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/AddressBookTableColumns");
            var oAddressBookTable = oView.byId("myAddressBookColumnSelectId");
            var aTableItems = oAddressBookTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onAddressBookColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myAddressBookColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onAddressBookColSelectOkPress: function () {
            var oView = this.getView();
            var oAddressBookTable = oView.byId("myAddressBookColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_IDAddressBookTable")
            oTable.setModel(eshipjetModel);

            var oAddressBookTblItems = oAddressBookTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/AddressBookTableColumns");
            oAddressBookTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oAddressBookTable.setModel(eshipjetModel);
            this._handleDisplayAddressBookTable();
            this._pAddressBookPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onAddressBookColSelectClosePress: function () {
            this._pAddressBookPopover.then(function (oPopover) {
                oPopover.close();
            });
        },



        _handleDisplayAddressBookTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var AddressBookTableColumns = eshipjetModel.getData().AddressBookTableColumns;
            const oTable = oView.byId("_IDAddressBookTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < AddressBookTableColumns.length; i++) {
                if (AddressBookTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/AddressBookTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status" || columnName === "rfidTag") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/AddressBookTableRows");
        },


        onSearchAddressBook: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
        
            var oTable = this.byId("_IDAddressBookTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("contactName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("companyName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("phonenum", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addressEmail", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addressLine1", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addressLine2", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addressLine3", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("stateProvience", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addressCity", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addressZip", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addressCountry", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addCategory", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addressType", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addCostCenter", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("lockerNo", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("lockerLocation", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("lockerAccCode", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("buildingNo", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("floorNo", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("mailStop", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("status", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("rfidTag", sap.ui.model.FilterOperator.Contains, sQuery)
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },

        onAddressBookFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddressBookPopover) {
                this._AddressBookPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddressBookFilterPopover",
                    controller: this
                }).then(function (AddressBookPopover) {
                    oView.addDependent(AddressBookPopover);
                    return AddressBookPopover;
                });
            }
            this._AddressBookPopover.then(function (AddressBookPopover) {
                AddressBookPopover.openBy(oButton);
            });
        },
        onAddressBookFilterPopoverClosePress: function () {
            this.byId("idAddressBookFilterPopover").close();
        },
        
        onAddressBookFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var addressBookContactName = eshipjetModel.getProperty("/addressBookContactName");
            var addressBookCompanyName = eshipjetModel.getProperty("/addressBookCompanyName");
            var addressBookAddressLine1 = eshipjetModel.getProperty("/addressBookAddressLine1");
            var addressBookCity = eshipjetModel.getProperty("/addressBookCity");
            var addressBookStateProvince = eshipjetModel.getProperty("/addressBookStateProvince");
            var addressBookPostalCode = eshipjetModel.getProperty("/addressBookPostalCode");
        
            if (addressBookContactName) {
                aFilters.push(new sap.ui.model.Filter("contactName", sap.ui.model.FilterOperator.EQ, addressBookContactName));
            }if (addressBookCompanyName) {
                aFilters.push(new sap.ui.model.Filter("companyName", sap.ui.model.FilterOperator.EQ, addressBookCompanyName));
            }if (addressBookAddressLine1) {
                aFilters.push(new sap.ui.model.Filter("addressLine1", sap.ui.model.FilterOperator.EQ, addressBookAddressLine1));
            }if (addressBookCity) {
                aFilters.push(new sap.ui.model.Filter("addressCity", sap.ui.model.FilterOperator.EQ, addressBookCity));
            }if (addressBookStateProvince) {
                aFilters.push(new sap.ui.model.Filter("stateProvience", sap.ui.model.FilterOperator.EQ, addressBookStateProvince));
            }if (addressBookPostalCode) {
                aFilters.push(new sap.ui.model.Filter("addressZip", sap.ui.model.FilterOperator.EQ, addressBookPostalCode));
            }
        
            var oTable = oView.byId("_IDAddressBookTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter(aFilters);
                }
            }
        
            this.byId("idAddressBookFilterPopover").close();
        },
        
        onAddressBookFilterPopoverResetPress: function () {
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/addressBookContactName", "");
            eshipjetModel.setProperty("/addressBookCompanyName", "");
            eshipjetModel.setProperty("/addressBookAddressLine1", "");
            eshipjetModel.setProperty("/addressBookCity", "");
            eshipjetModel.setProperty("/addressBookStateProvince", "");
            eshipjetModel.setProperty("/addressBookPostalCode", "");
            var oTable = this.byId("_IDAddressBookTable");
            var oBinding = oTable.getBinding("rows");
            oBinding.filter([]);
            this.byId("idAddressBookFilterPopover").close();
        },

        onAddressBookExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/AddressBookTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Contact Name", property: "contactName", visible: true },
                        { label: "Company Name", property: "companyName", visible: true },
                        { label: "Phone No", property: "phonenum", visible: true },
                        { label: "Address Email", property: "addressEmail", visible: true },
                        { label: "Address Line 1", property: "addressLine1", visible: false },
                        { label: "Address Line 2", property: "addressLine2", visible: false },
                        { label: "Address Line 3", property: "addressLine3", visible: false },
                        { label: "State / Provience", property: "stateProvience", visible: true },
                        { label: "City", property: "addressCity", visible: true },
                        { label: "Zip / Postal Code", property: "addressZip", visible: false },
                        { label: "Country", property: "addressCountry", visible: true },
                        { label: "Address Category", property: "addCategory", visible: false },
                        { label: "Address Type", property: "addressType", visible: false },
                        { label: "Cost Center", property: "addCostCenter", visible: false },
                        { label: "Locker No", property: "lockerNo", visible: true },
                        { label: "Locker Location", property: "lockerLocation", visible: true },
                        { label: "Locker Access Code", property: "lockerAccCode", visible: true },
                        { label: "Building No", property: "buildingNo", visible: true },
                        { label: "Floor No", property: "floorNo", visible: true },
                        { label: "Mail Stop", property: "mailStop", visible: true },
                        { label: "Status", property: "status", visible: true },
                        { label: "RFID Tag", property: "rfidTag", visible: true }
                    ]
                    
                    
                },
                dataSource: rows,
                fileName: 'AddressBook_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },


        onRolesExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/RolesTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Role ID", property: "roleId", visible: true },
                        { label: "Role Name", property: "roleName", visible: true },
                        { label: "Status", property: "status", visible: true }
                    ]                    
                                        
                },
                dataSource: rows,
                fileName: 'Roles_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },



        onCarrierCatalogExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/CarrierCatalogTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Ship Method ID", property: "shipMethodId", visible: true },
                        { label: "Ship Method", property: "shipMethodName", visible: true },
                        { label: "Ship Method Type", property: "shipMethodType", visible: true },
                        { label: "Ship Method Coverage", property: "shipMethodCoverage", visible: true },
                        { label: "Ship Method Status", property: "status", visible: true }
                    ]                     
                },
                dataSource: rows,
                fileName: 'CarrierCatalog_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },




        onCarrierAccountsExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/CarrierAccountsTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Location Name", property: "locationName", visible: true },
                        { label: "Ship Method", property: "shipMethodName", visible: true },
                        { label: "Cost Center", property: "costCenter", visible: true },
                        { label: "Ship From Country", property: "shipFromCountry", visible: true },
                        { label: "Ship To Country", property: "shipToCountry", visible: true },
                        { label: "Ship Url", property: "shipUrl", visible: true },
                        { label: "Void Url", property: "voidUrl", visible: true },
                        { label: "Rate Url", property: "rateUrl", visible: true },
                        { label: "Track Url", property: "trackUrl", visible: true },
                        { label: "Environment", property: "environment", visible: true },
                        { label: "Carrier Type", property: "carrierType", visible: true },
                        { label: "Status", property: "status", visible: true },
                        { label: "ERP Carrier ID", property: "erpCarrierID", visible: true },
                        { label: "Rate Shop", property: "rateShop", visible: true },
                        { label: "EDOC", property: "edoc", visible: true },
                        { label: "Manual Rates", property: "manualRates", visible: true },
                        { label: "Actions", property: "actions", visible: true }
                    ]
                                      
                },
                dataSource: rows,
                fileName: 'CarrierAccounts_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },

        onStatusesRefreshPress: function () {
            location.reload();
        },
        

        onStatusesExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/StatusesTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Ship Method ID", property: "shipMethodId", visible: true },
                        { label: "Ship Method", property: "shipMethodName", visible: true },
                        { label: "Ship Method Type", property: "shipMethodType", visible: true },
                        { label: "Ship Method Coverage", property: "shipMethodCoverage", visible: true },
                        { label: "Ship Method Status", property: "status", visible: true }
                    ]                     
                },
                dataSource: rows,
                fileName: 'Statuses_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },


        onLTLClassesExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/LtlClassesTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Location Name", property: "locationName", visible: true },
                        { label: "Package Code", property: "packageCode", visible: true },
                        { label: "Package Type", property: "packageType", visible: true },
                        { label: "Ship Method", property: "shipMethod", visible: true },
                        { label: "Dimension Units", property: "dimensionUnits", visible: true },
                        { label: "Status", property: "status", visible: true },
                        { label: "Ship Method ID", property: "shipMethodId", visible: true },
                        { label: "Ship Method", property: "shipMethodName", visible: true },
                        { label: "Ship Method Type", property: "shipMethodType", visible: true },
                        { label: "Ship Method Coverage", property: "shipMethodCoverage", visible: true },
                        { label: "Ship Method Status", property: "status", visible: true }
                    ]                                  
                },
                dataSource: rows,
                fileName: 'LTLClasses_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },

        onLTLClassesExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/LtlClassesTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Location Name", property: "locationName", visible: true },
                        { label: "Package Code", property: "packageCode", visible: true },
                        { label: "Package Type", property: "packageType", visible: true },
                        { label: "Ship Method", property: "shipMethod", visible: true },
                        { label: "Dimension Units", property: "dimensionUnits", visible: true },
                        { label: "Status", property: "status", visible: true },
                        { label: "Ship Method ID", property: "shipMethodId", visible: true },
                        { label: "Ship Method", property: "shipMethodName", visible: true },
                        { label: "Ship Method Type", property: "shipMethodType", visible: true },
                        { label: "Ship Method Coverage", property: "shipMethodCoverage", visible: true },
                        { label: "Ship Method Status", property: "status", visible: true }
                    ]                                  
                },
                dataSource: rows,
                fileName: 'LTLClasses_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },

        onNMFCExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/NmfcTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Location Name", property: "locationName", visible: true },
                        { label: "NMFC Code", property: "nmfcCode", visible: true },
                        { label: "NMFC Description", property: "nmfcDesc", visible: true },
                        { label: "Ship Method", property: "shipMethod", visible: true },
                        { label: "Status", property: "status", visible: true }
                    ]                                    
                },
                dataSource: rows,
                fileName: 'NMFC_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },



        onModeOfTransportsExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/MotTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Location Name", property: "locationName", visible: true },
                        { label: "Mode", property: "mode", visible: true },
                        { label: "Status", property: "status", visible: true }
                    ]                                                 
                },
                dataSource: rows,
                fileName: 'ModeOfTransports_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },

        onOrdersTypeExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/OrderTypesTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Location Name", property: "locationName", visible: true },
                        { label: "Mode", property: "mode", visible: true },
                        { label: "Status", property: "status", visible: true }
                    ]                                                 
                },
                dataSource: rows,
                fileName: 'OrdersType_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },

        onIncotermsExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/IncotermsTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Incoterm", property: "incoterm", visible: true },
                        { label: "Description", property: "desc", visible: true },
                        { label: "Status", property: "status", visible: true }
                    ]                                                                 
                },
                dataSource: rows,
                fileName: 'Incoterms_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },


        onTrackingRangeExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/TrackingRangeTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Location Name", property: "LocationName", visible: true },
                        { label: "Carrier", property: "Carrier", visible: true },
                        { label: "Range From", property: "RangeFrom", visible: true },
                        { label: "Range To", property: "RangeTo", visible: true },
                        { label: "Status", property: "status", visible: true }
                    ]
                                                                                 
                },
                dataSource: rows,
                fileName: 'TrackingRange_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },


        onDimensionsExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/DiemnsionsTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Location Name", property: "locationName", visible: true },
                        { label: "Dimension Code", property: "dimensionCode", visible: true },
                        { label: "Dimension Value", property: "dimensionValue", visible: true },
                        { label: "Length", property: "length", visible: true },
                        { label: "Width", property: "width", visible: true },
                        { label: "Height", property: "height", visible: true },
                        { label: "Maximum Weight", property: "maxWeight", visible: true },
                        { label: "Material Weight", property: "materialWeight", visible: true },
                        { label: "Status", property: "status", visible: true }
                    ]                                                              
                },
                dataSource: rows,
                fileName: 'Dimensions_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },

        onPaymentTypesExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/PaymentTypesTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Payment Type", property: "paymentType", visible: true },
                        { label: "Payment Code", property: "paymentCode", visible: true },
                        { label: "Description", property: "desc", visible: true },
                        { label: "Status", property: "status", visible: true }
                    ]
                                                                            
                },
                dataSource: rows,
                fileName: 'PaymentTypes_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },


        onERPExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/ERPTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Location Name", property: "locationName", visible: true },
                        { label: "ERP Name", property: "erpName", visible: true },
                        { label: "ERP Code", property: "ERPCode", visible: true },
                        { label: "Status", property: "status", visible: true }
                    ]                    
                                                                            
                },
                dataSource: rows,
                fileName: 'ERP_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },


        onCountriesExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/CountriesTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Country Code", property: "countryCode", visible: true },
                        { label: "Country Description", property: "countryDesc", visible: true },
                        { label: "Region", property: "region", visible: true },
                        { label: "Currency", property: "currency", visible: true },
                        { label: "Status", property: "status", visible: true }
                    ]                                                                                        
                },
                dataSource: rows,
                fileName: 'Countries_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },

        onEUCountriesExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/EUCountriesTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Country Code", property: "countryCode", visible: true },
                        { label: "Country Description", property: "countryDesc", visible: true },
                        { label: "Status", property: "status", visible: true }
                    ]                                                                                                         
                },
                dataSource: rows,
                fileName: 'EUCountries_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },


        onProductsExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/ProductsTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                            { "label": "Location Name", "property": "locationName", "visible": true },
                            { "label": "Item No", "property": "itemNo", "visible": true },
                            { "label": "Product No", "property": "productNo", "visible": true },
                            { "label": "Description", "property": "desc", "visible": true },
                            { "label": "Quantity", "property": "quantity", "visible": true },
                            { "label": "Unit Cost", "property": "unitCost", "visible": true },
                            { "label": "Unit Weight", "property": "unitWeight", "visible": true },
                            { "label": "Dimensions", "property": "dimensions", "visible": true },
                            { "label": "Harmonized Code", "property": "harmonizedcode", "visible": true },
                            { "label": "ECCN", "property": "eccn", "visible": true },
                            { "label": "Un No", "property": "unNo", "visible": true },
                            { "label": "Class", "property": "class", "visible": true },
                            { "label": "NMFC", "property": "nmfc", "visible": true },
                            { "label": "UOM", "property": "uom", "visible": true },
                            { "label": "EPC-RFID", "property": "epcRfidNo", "visible": true },
                            { "label": "Country Of MFR", "property": "countryOfMFR", "visible": true },
                            { "label": "Status", "property": "status", "visible": true }
                    ]                     
                },
                dataSource: rows,
                fileName: 'Products_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },

        onSearchProducts: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
            var oTable = this.byId("_IDProductsTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("itemNo", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("productNo", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("desc", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("quantity", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("unitCost", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("unitWeight", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("dimensions", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("harmonizedcode", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("eccn", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("unNo", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("class", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("nmfc", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("uom", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("epcRfidNo", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("countryOfMFR", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("status", sap.ui.model.FilterOperator.Contains, sQuery)
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },

        onProductsFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._ProductsPopover) {
                this._ProductsPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ProductsFilterPopover",
                    controller: this
                }).then(function (ProductsPopover) {
                    oView.addDependent(ProductsPopover);
                    return ProductsPopover;
                });
            }
            this._ProductsPopover.then(function (ProductsPopover) {
                ProductsPopover.openBy(oButton);
            });
        },

        onProductsFilterPopoverClosePress: function () {
            this.byId("idProductsFilterPopover").close();
        },
        
        onProductsFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var sLocation = eshipjetModel.getProperty("/orderLocationFilter");
        
            if (sLocation) {
                aFilters.push(new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.EQ, sLocation));
            }
            var oTable = oView.byId("_IDProductsTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter(aFilters);
                }
            }
            this.byId("idProductsFilterPopover").close();
        },
        
        onProductsFilterPopoverResetPress: function () {
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/orderLocationFilter", "");
            var oTable = this.byId("_IDProductsTable");
            var oBinding = oTable.getBinding("rows");
            oBinding.filter([]);
            this.byId("idProductsFilterPopover").close();
        },

        // Address Book Column Names Popover code changes End here


        // Users Column Names Popover code changes starts here

        openUsersColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pUsersPopover) {
                this._pUsersPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.UsersTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pUsersPopover.then(function (oPopover) {
                oController.UsersColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        UsersColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/UsersTableColumns");
            var oUsersTable = oView.byId("myUsersColumnSelectId");
            var aTableItems = oUsersTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onUsersColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myUsersColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onUsersColSelectOkPress: function () {
            var oView = this.getView();
            var oUsersTable = oView.byId("myUsersColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_IDUsersTable")
            oTable.setModel(eshipjetModel);

            var oUsersTblItems = oUsersTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/UsersTableColumns");
            oUsersTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oUsersTable.setModel(eshipjetModel);
            this._handleDisplayUsersTable();
            this._pUsersPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onUsersColSelectClosePress: function () {
            this._pUsersPopover.then(function (oPopover) {
                oPopover.close();
            });
        },


        _handleDisplayUsersTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var UsersTableColumns = eshipjetModel.getData().UsersTableColumns;
            const oTable = oView.byId("_IDUsersTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < UsersTableColumns.length; i++) {
                if (UsersTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/UsersTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/UsersTableRows");
        },

        onSearchUsers: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
        
            var oTable = this.byId("_IDUsersTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("userId", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("firstName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("lastName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("phonenum", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("userEmail", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addressLine1", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addressLine2", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addressLine3", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addressCity", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addressZip", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addressCountry", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("userRole", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("status", sap.ui.model.FilterOperator.Contains, sQuery)
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },

        onUsersFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._UsersPopover) {
                this._UsersPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.UsersFilterPopover",
                    controller: this
                }).then(function (UsersPopover) {
                    oView.addDependent(UsersPopover);
                    return UsersPopover;
                });
            }
            this._UsersPopover.then(function (UsersPopover) {
                UsersPopover.openBy(oButton);
            });
        },

        onUsersFilterPopoverClosePress: function () {
            this.byId("idUsersFilterPopover").close();
        },
        
        onUsersFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var sLocation = eshipjetModel.getProperty("/orderLocationFilter");
            var UsersUserNameFilter = eshipjetModel.getProperty("/orderLocationFilter");
        
            if (sLocation) {
                aFilters.push(new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.EQ, sLocation));
            }if (UsersUserNameFilter) {
                aFilters.push(new sap.ui.model.Filter("userRole", sap.ui.model.FilterOperator.EQ, UsersUserNameFilter));
            }
            var oTable = oView.byId("_IDUsersTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter(aFilters);
                }
            }
            this.byId("idUsersFilterPopover").close();
        },
        
        onUsersFilterPopoverResetPress: function () {
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/orderLocationFilter", "");
            eshipjetModel.setProperty("/orderLocationFilter", "");
            var oTable = this.byId("_IDUsersTable");
            var oBinding = oTable.getBinding("rows");
            oBinding.filter([]);
            this.byId("idUsersFilterPopover").close();
        },

        onUsersExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/UsersTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Location Name", property: "locationName"},
                        { label: "User ID", property: "userId"},
                        { label: "First Name", property: "firstName"},
                        { label: "Last Name", property: "lastName"},
                        { label: "Phone No", property: "phonenum"},
                        { label: "Email", property: "userEmail"},
                        { label: "Address Line 1", property: "addressLine1"},
                        { label: "Address Line 2", property: "addressLine2"},
                        { label: "Address Line 3", property: "addressLine3" },
                        { label: "City", property: "addressCity" },
                        { label: "Zip / Postal Code", property: "addressZip" },
                        { label: "Country", property: "addressCountry" },
                        { label: "Role", property: "userRole" },
                        { label: "Status", property: "status" }
                    ]
                },
                dataSource: rows,
                fileName: 'Usres_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },

        //Users Column Names Popover code changes End here
            // Peripheral Configuration Column Names Popover code changes starts here
 OpenPeripheralConfigurationDialog: function () {
            var oView = this.getView();
            if (!this.byId("_IDGenAlcoholEditDialogPeripheralConfiguration")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.PeripheralConfiguration",
                    controller: this // Pass the controller for binding
                }).then(function (oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenAlcoholEditDialogPeripheralConfiguration").open(); // Open existing dialog
            }
        },
        onPeripheralConfigurationCancelPress: function () {
            this.byId("_IDGenAlcoholEditDialogPeripheralConfiguration").close();
        },
        onPeripheralConfigCancelPress: function () {
            this.byId("_IDGenAlcoholEditDialogPeripheralConfiguration").close();
        },
        onPeripheralConfigSelectPress: function () {
            this.byId("_IDGenAlcoholEditDialogPeripheralConfiguration").close();
        },
            // PeripheralConfiguration Column Names Popover code changes End here


        // Roles Column Names Popover code changes starts here

        openRolesColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pRolesPopover) {
                this._pRolesPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.RolesTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pRolesPopover.then(function (oPopover) {
                oController.RolesColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        RolesColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/RolesTableColumns");
            var oRolesTable = oView.byId("myRolesColumnSelectId");
            var aTableItems = oRolesTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onRolesColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myRolesColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onRolesColSelectOkPress: function () {
            var oView = this.getView();
            var oRolesTable = oView.byId("myRolesColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_IDRolesTable")
            oTable.setModel(eshipjetModel);

            var oRolesTblItems = oRolesTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/RolesTableColumns");
            oRolesTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oRolesTable.setModel(eshipjetModel);
            this._handleDisplayRolesTable();
            this._pRolesPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onRolesColSelectClosePress: function () {
            this._pRolesPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayRolesTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var RolesTableColumns = eshipjetModel.getData().RolesTableColumns;
            const oTable = oView.byId("_IDLocationTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < RolesTableColumns.length; i++) {
                if (RolesTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/RolesTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/RolesTableRows");
        },

        onSearchRoles: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
        
            var oTable = this.byId("_IDRolesTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("roleId", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("roleName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("status", sap.ui.model.FilterOperator.Contains, sQuery)
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },

        // Roles Column Names Popover code changes End here


        // CarrierCatalog Column Names Popover code changes starts here

        openCarrierCatalogColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pCarrierCatalogPopover) {
                this._pCarrierCatalogPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.CarrierCatalogTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pCarrierCatalogPopover.then(function (oPopover) {
                oController.CarrierCatalogColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        CarrierCatalogColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/CarrierCatalogTableColumns");
            var oCarrierCatalogTable = oView.byId("myCarrierCatalogColumnSelectId");
            var aTableItems = oCarrierCatalogTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onCarrierCatalogColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myCarrierCatalogColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

      onCarrierCatalogColSelectOkPress: function () {
    var oView = this.getView();
    var oCarrierCatalogTable = oView.byId("myCarrierCatalogColumnSelectId");
    var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
    var oTable = oView.byId("_IDCarriesCatalogTable");

    // Update visibility in the model based on popover selection
    var oCarrierCatalogTblItems = oCarrierCatalogTable.getItems();
    var aColumnsData = eshipjetModel.getProperty("/CarrierCatalogTableColumns");

    oCarrierCatalogTblItems.forEach(function (oItem) {
        var oContext = oItem.getBindingContext("eshipjetModel").getObject();
        aColumnsData.forEach(function (oColObj) {
            if (oContext.key === oColObj.key) {
                oColObj.visible = oItem.getSelected();
            }
        });
    });

    // Refresh model bindings
    eshipjetModel.updateBindings(true);

    // Update table column visibility dynamically
    oTable.getColumns().forEach(function (oColumn, i) {
        var bVisible = aColumnsData[i] ? aColumnsData[i].visible : true;
        oColumn.setVisible(bVisible);
    });

    // Close the popover
    this._pCarrierCatalogPopover.then(function (oPopover) {
        oPopover.close();
    });
},


        _handleDisplayCarrierCatalogTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var CarrierCatalogTableColumns = eshipjetModel.getData().CarrierCatalogTableColumns;
            var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
            eshipjetModel.updateBindings(true);
            const oTable = oView.byId("_IDCarriesCatalogTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < CarrierCatalogTableColumns.length; i++) {
                if (CarrierCatalogTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/CarrierCatalogTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actionsforCarrierCatalog") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                // } else if (columnName === "status") {
                //     var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                //     oSwitch.addStyleClass("mySwitch");
                //     return new sap.ui.table.Column({
                //         label: oResourceBundle.getText(columnName),
                //         template: oSwitch,
                //         visible: oContext.getObject().visible,
                //         width: minWidth,
                //         sortProperty: columnName
                //     });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/CarrierCatalogTableRows");
        },


        onSearchCarrierCatalog: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
        
            var oTable = this.byId("_IDCarriesCatalogTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("shipMethodId", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("shipMethodName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("shipMethodType", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("shipMethodCoverage", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("shipMethodStatus", sap.ui.model.FilterOperator.Contains, sQuery)
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },

        onCarrierCatalogFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._CarrierCatalogPopover) {
                this._CarrierCatalogPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.CarrierCatalogFilterPopover",
                    controller: this
                }).then(function (CarrierCatalogPopover) {
                    oView.addDependent(CarrierCatalogPopover);
                    return CarrierCatalogPopover;
                });
            }
            this._CarrierCatalogPopover.then(function (CarrierCatalogPopover) {
                CarrierCatalogPopover.openBy(oButton);
            });
        },

        onCarrierCatalogFilterPopoverClosePress: function () {
            this.byId("idCarrierCatalogFilterPopover").close();
        },
        
        onCarrierCatalogFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var sLocation = eshipjetModel.getProperty("/orderLocationFilter");
            var carrierCatelogCarrierName = eshipjetModel.getProperty("/carrierCatelogCarrierName");
            if (sLocation) {
                aFilters.push(new sap.ui.model.Filter("Plant", sap.ui.model.FilterOperator.EQ, sLocation));
            }
            if (carrierCatelogCarrierName) {
                aFilters.push(new sap.ui.model.Filter("Plant", sap.ui.model.FilterOperator.EQ, carrierCatelogCarrierName));
            }
            var oTable = oView.byId("_IDCarriesCatalogTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter(aFilters);
                }
            }
            this.byId("idCarrierCatalogFilterPopover").close();
        },
        
        onCarrierCatalogFilterPopoverResetPress: function () {
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/orderLocationFilter", "");
            eshipjetModel.setProperty("/carrierCatelogCarrierName", "");
            var oTable = this.byId("_IDCarriesCatalogTable");
            var oBinding = oTable.getBinding("rows");
            oBinding.filter([]);
            this.byId("idCarrierCatalogFilterPopover").close();
        },

        // CarrierCatalog Column Names Popover code changes End here


        // CarrierAccount Column Names Popover code changes starts here

        openCarrierAccountColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pCarrierAccountPopover) {
                this._pCarrierAccountPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.CarrierAccountTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pCarrierAccountPopover.then(function (oPopover) {
                oController.CarrierAccountColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        CarrierAccountColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/CarrierAccountsTableColumns");
            var oCarrierAccountTable = oView.byId("myCarrierAccountColumnSelectId");
            var aTableItems = oCarrierAccountTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onCarrierAccountColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myCarrierAccountColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

      onCarrierAccountColSelectOkPress: function () {
    var oView = this.getView();
    var oCarrierAccountTable = oView.byId("myCarrierAccountColumnSelectId");
    var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
    var oTable = oView.byId("_IDCarriesAccountsTable"); // âœ… Correct table ID

    var oCarrierAccountTblItems = oCarrierAccountTable.getItems();
    var aColumnsData = eshipjetModel.getProperty("/CarrierAccountsTableColumns");

    // âœ… Update model based on user selections
    oCarrierAccountTblItems.forEach(function (oItem) {
        var oContext = oItem.getBindingContext("eshipjetModel").getObject();
        var sKey = oContext.key;
        var bSelected = oItem.getSelected();

        var oMatch = aColumnsData.find(function (col) { return col.key === sKey; });
        if (oMatch) {
            oMatch.visible = bSelected;
        }
    });

    // âœ… Update table column visibility dynamically by matching key
    oTable.getColumns().forEach(function (oColumn) {
        var oLabel = oColumn.getLabel();
        if (oLabel && oLabel.getText) {
            var sLabelText = oLabel.getText();
            var oMatch = aColumnsData.find(function (col) { return col.label === sLabelText; });
            if (oMatch) {
                oColumn.setVisible(oMatch.visible);
            }
        }
    });

    // âœ… Update model bindings
    eshipjetModel.setProperty("/CarrierAccountsTableColumns", aColumnsData);
    eshipjetModel.updateBindings(true);

    // âœ… Close popover
    this._pCarrierAccountPopover.then(function (oPopover) {
        oPopover.close();
    });
},



        // _handleDisplayCarrierAccountTable: function () {
        //     var that = this;
        //     const oView = oController.getView();
        //     var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
        //     var CarrierAccountsTableColumns = eshipjetModel.getData().CarrierAccountsTableColumns;
        //     const oTable = oView.byId("_IDCarriesAccountsTable");
        //     oTable.setModel(eshipjetModel);
        //     var count = 0;
        //     for (var i = 0; i < CarrierAccountsTableColumns.length; i++) {
        //         if (CarrierAccountsTableColumns[i].visible === true) {
        //             count += 1
        //         }
        //     }
        //     oTable.bindColumns("/CarrierAccountsTableColumns", function (sId, oContext) {
        //         columnName = oContext.getObject().key;
        //         label = oContext.getObject().label;
        //         var minWidth = "100%";
        //         if (count >= 14) {
        //             var minWidth = "130px";
        //         }
        //         if (columnName === "actions") {
        //             var oHBox = new sap.m.HBox({}); // Create Text instance 
        //             var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
        //             var Btn2 = new sap.m.Button({
        //                 icon: "sap-icon://megamenu", type: "Transparent",
        //                 press: function (oEvent) {
        //                     that.handleDownArrowPress(oEvent);
        //                 }
        //             });
        //             oHBox.addItem(Btn1);
        //             oHBox.addItem(Btn2);
        //             return new sap.ui.table.Column({
        //                 label: oResourceBundle.getText(columnName),
        //                 template: oHBox,
        //                 visible: oContext.getObject().visible,
        //                 width: minWidth,
        //                 sortProperty: columnName
        //             });
        //         } else if (columnName === "status" || columnName === "rateShop" || columnName === "edoc" || columnName === "manualRates") {
        //             var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
        //             return new sap.ui.table.Column({
        //                 label: oResourceBundle.getText(columnName),
        //                 template: oSwitch,
        //                 visible: oContext.getObject().visible,
        //                 width: minWidth,
        //                 sortProperty: columnName
        //             });
        //         } else {
        //             return new sap.ui.table.Column({
        //                 label: oResourceBundle.getText(columnName),
        //                 template: columnName,
        //                 visible: oContext.getObject().visible,
        //                 width: minWidth,
        //                 sortProperty: columnName
        //             });
        //         }
        //     });
        //     oTable.bindRows("/CarrierAccountsTableRows");
        // },

        onSearchCarrierAccounts: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
            var oTable = this.byId("_IDCarriesAccountsTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("shipMethodName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("costCenter", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("shipFromCountry", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("shipToCountry", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("shipUrl", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("voidUrl", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("rateUrl", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("trackUrl", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("environment", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("carrierType", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("status", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("erpCarrierID", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("rateShop", sap.ui.model.FilterOperator.Contains, sQuery)
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },


        onCarriesAccountsFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._CarriesAccountsPopover) {
                this._CarriesAccountsPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.CarriesAccountsFilterPopover",
                    controller: this
                }).then(function (CarriesAccountsPopover) {
                    oView.addDependent(CarriesAccountsPopover);
                    return CarriesAccountsPopover;
                });
            }
            this._CarriesAccountsPopover.then(function (CarriesAccountsPopover) {
                CarriesAccountsPopover.openBy(oButton);
            });
        },
        onCarrierAccountsFilterPopoverClosePress: function () {
            this.byId("idCarrierAccountsFilterPopover").close();
        },
        
        onCarrierAccountsFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var sLocation = eshipjetModel.getProperty("/orderLocationFilter");
            var CarrierAccountsCarrierName = eshipjetModel.getProperty("/CarrierAccountsCarrierName");
        
            if (sLocation) {
                aFilters.push(new sap.ui.model.Filter("Plant", sap.ui.model.FilterOperator.EQ, sLocation));
            }
            if (CarrierAccountsCarrierName) {
                aFilters.push(new sap.ui.model.Filter("CarrierAccountsCarrierName", sap.ui.model.FilterOperator.EQ, CarrierAccountsCarrierName));
            }
        
            var oTable = oView.byId("_IDCarriesAccountsTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter(aFilters);
                }
            }
        
            this.byId("idCarrierAccountsFilterPopover").close();
        },
        
        onCarrierAccountsFilterPopoverResetPress: function () {
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/orderLocationFilter", "");
            eshipjetModel.setProperty("/CarrierAccountsCarrierName", "");
            var oTable = this.byId("_IDCarriesAccountsTable");
            var oBinding = oTable.getBinding("rows");
            oBinding.filter([]);
            this.byId("idCarrierAccountsFilterPopover").close();
        },

        // CarrierAccount Column Names Popover code changes End here


        // CostCenter Column Names Popover code changes starts here

        openCostCenterColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pCostCenterPopover) {
                this._pCostCenterPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.CostCenterTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pCostCenterPopover.then(function (oPopover) {
                oController.CostCenterColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        CostCenterColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/CostCenterTableColumns");
            var oCostCenterTable = oView.byId("myCostCenterColumnSelectId");
            var aTableItems = oCostCenterTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onCostCenterColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myCostCenterColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onCostCenterColSelectOkPress: function () {
            var oView = this.getView();
            var oCostCenterTable = oView.byId("myCostCenterColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_IDCostCenterTable")
            oTable.setModel(eshipjetModel);

            var oCostCenterTblItems = oCostCenterTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/CostCenterTableColumns");
            oCostCenterTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oCostCenterTable.setModel(eshipjetModel);
            this._handleDisplayCostCenterTable();
            this._pCostCenterPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onCostCenterColSelectClosePress: function () {
            this._pCostCenterPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayCostCenterTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var CostCenterTableColumns = eshipjetModel.getData().CostCenterTableColumns;
            const oTable = oView.byId("_IDCostCenterTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < CostCenterTableColumns.length; i++) {
                if (CostCenterTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/CostCenterTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/CostCenterTableRows");
        },

        onSearchCostCenter: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
        
            var oTable = this.byId("_IDCostCenterTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("costCenter", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("desc", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("status", sap.ui.model.FilterOperator.Contains, sQuery)
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },

        onCostCenterFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._UsersPopover) {
                this._UsersPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.CostCenterFilterPopover",
                    controller: this
                }).then(function (UsersPopover) {
                    oView.addDependent(UsersPopover);
                    return UsersPopover;
                });
            }
            this._UsersPopover.then(function (UsersPopover) {
                UsersPopover.openBy(oButton);
            });
        },

        onCostCenterFilterPopoverClosePress: function () {
            this.byId("idCostCenterFilterPopover").close();
        },
        
        onCostCenterFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var sLocation = eshipjetModel.getProperty("/orderLocationFilter");
        
            if (sLocation) {
                aFilters.push(new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.EQ, sLocation));
            }
            var oTable = oView.byId("_IDCostCenterTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter(aFilters);
                }
            }
            this.byId("idCostCenterFilterPopover").close();
        },
        
        onCostCenterFilterPopoverResetPress: function () {
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/orderLocationFilter", "");
            var oTable = this.byId("_IDCostCenterTable");
            var oBinding = oTable.getBinding("rows");
            oBinding.filter([]);
            this.byId("idCostCenterFilterPopover").close();
        },

        onCostCenterExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/CostCenterTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Location Name", property: "locationName"},
                        { label: "User ID", property: "userId"},
                        { label: "First Name", property: "firstName"},
                        { label: "Last Name", property: "lastName"},
                        { label: "Phone No", property: "phonenum"},
                        { label: "Email", property: "userEmail"},
                        { label: "Address Line 1", property: "addressLine1"},
                        { label: "Address Line 2", property: "addressLine2"},
                        { label: "Address Line 3", property: "addressLine3" },
                        { label: "City", property: "addressCity" },
                        { label: "Zip / Postal Code", property: "addressZip" },
                        { label: "Country", property: "addressCountry" },
                        { label: "Role", property: "userRole" },
                        { label: "Status", property: "status" }
                    ]
                },
                dataSource: rows,
                fileName: 'Cost_Center_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },

        // CostCenter Column Names Popover code changes End here


         // FreightCondition Column Names Popover code changes starts here

         openFreightConditionColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pFreightConditionPopover) {
                this._pFreightConditionPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.FreightConditionTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pFreightConditionPopover.then(function (oPopover) {
                oController.FreightConditionColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        FreightConditionColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/FreightConditionTableColumns");
            var oFreightConditionTable = oView.byId("myFreightConditionColumnSelectId");
            var aTableItems = oFreightConditionTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onFreightConditionColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myFreightConditionColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onFreightConditionColSelectOkPress: function () {
            var oView = this.getView();
            var oFreightConditionTable = oView.byId("myFreightConditionColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_IDFreightConditionTable")
            oTable.setModel(eshipjetModel);

            var oFreightConditionTblItems = oFreightConditionTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/FreightConditionTableColumns");
            oFreightConditionTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oFreightConditionTable.setModel(eshipjetModel);
            this._handleDisplayFreightConditionTable();
            this._pFreightConditionPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onFreightConditionColSelectClosePress: function () {
            this._pFreightConditionPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayFreightConditionTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var FreightConditionTableColumns = eshipjetModel.getData().FreightConditionTableColumns;
            const oTable = oView.byId("_IDFreightConditionTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < FreightConditionTableColumns.length; i++) {
                if (FreightConditionTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/FreightConditionTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/FreightConditionTableRows");
        },

        // onSearchCostCenter: function (oEvent) {
        //     var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
        
        //     var oTable = this.byId("_IDCostCenterTable");
        //     var oBinding = oTable.getBinding("rows");
        
        //     if (oBinding) {
        //         var aFilters = [];
        //         if (sQuery) {
        //             aFilters.push(new sap.ui.model.Filter({
        //                 filters: [
        //                     new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.Contains, sQuery),
        //                     new sap.ui.model.Filter("costCenter", sap.ui.model.FilterOperator.Contains, sQuery),
        //                     new sap.ui.model.Filter("desc", sap.ui.model.FilterOperator.Contains, sQuery),
        //                     new sap.ui.model.Filter("status", sap.ui.model.FilterOperator.Contains, sQuery)
        //                 ],
        //                 and: false
        //             }));
        //         }
        //         oBinding.filter(aFilters);
        //     }
        // },

        // onCostCenterFilterPopoverPress: function (oEvent) {
        //     var oButton = oEvent.getSource(),
        //         oView = this.getView();
        //     if (!this._UsersPopover) {
        //         this._UsersPopover = Fragment.load({
        //             id: oView.getId(),
        //             name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.CostCenterFilterPopover",
        //             controller: this
        //         }).then(function (UsersPopover) {
        //             oView.addDependent(UsersPopover);
        //             return UsersPopover;
        //         });
        //     }
        //     this._UsersPopover.then(function (UsersPopover) {
        //         UsersPopover.openBy(oButton);
        //     });
        // },

        // onCostCenterFilterPopoverClosePress: function () {
        //     this.byId("idCostCenterFilterPopover").close();
        // },
        
        // onCostCenterFilterPopoverApplyPress: function () {
        //     var aFilters = [];
        //     var oView = this.getView();
        //     var sLocation = eshipjetModel.getProperty("/orderLocationFilter");
        
        //     if (sLocation) {
        //         aFilters.push(new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.EQ, sLocation));
        //     }
        //     var oTable = oView.byId("_IDCostCenterTable");
        //     if (oTable) {
        //         var oBinding = oTable.getBinding("rows");
        //         if (oBinding) {
        //             oBinding.filter(aFilters);
        //         }
        //     }
        //     this.byId("idCostCenterFilterPopover").close();
        // },
        
        // onCostCenterFilterPopoverResetPress: function () {
        //     var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
        //     eshipjetModel.setProperty("/orderLocationFilter", "");
        //     var oTable = this.byId("_IDCostCenterTable");
        //     var oBinding = oTable.getBinding("rows");
        //     oBinding.filter([]);
        //     this.byId("idCostCenterFilterPopover").close();
        // },

        // onCostCenterExportToExcel: function () {
        //     var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
        //     var rows = eshipjetModel.getProperty("/CostCenterTableRows");
        //     var oSettings = {
        //         workbook: {
        //             columns: [
        //                 { label: "Location Name", property: "locationName"},
        //                 { label: "User ID", property: "userId"},
        //                 { label: "First Name", property: "firstName"},
        //                 { label: "Last Name", property: "lastName"},
        //                 { label: "Phone No", property: "phonenum"},
        //                 { label: "Email", property: "userEmail"},
        //                 { label: "Address Line 1", property: "addressLine1"},
        //                 { label: "Address Line 2", property: "addressLine2"},
        //                 { label: "Address Line 3", property: "addressLine3" },
        //                 { label: "City", property: "addressCity" },
        //                 { label: "Zip / Postal Code", property: "addressZip" },
        //                 { label: "Country", property: "addressCountry" },
        //                 { label: "Role", property: "userRole" },
        //                 { label: "Status", property: "status" }
        //             ]
        //         },
        //         dataSource: rows,
        //         fileName: 'Cost_Center_Data',
        //         Worker: true
        //     };
        //     var oSpreadsheet = new Spreadsheet(oSettings);
        //     oSpreadsheet.build().finally(function () {
        //         oSpreadsheet.destroy();
        //     });
        // },

        // CostCenter Column Names Popover code changes End here

        // Statuses Column Names Popover code changes starts here

        openStatusesColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pStatusesPopover) {
                this._pStatusesPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.StatusesTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pStatusesPopover.then(function (oPopover) {
                oController.StatusesColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        StatusesColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/StatusesTableColumns");
            var oStatusesTable = oView.byId("myStatusesColumnSelectId");
            var aTableItems = oStatusesTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onStatusesColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myStatusesColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onStatusesColSelectOkPress: function () {
            var oView = this.getView();
            var oStatusesTable = oView.byId("myStatusesColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_IDStatusesTable")
            oTable.setModel(eshipjetModel);

            var oStatusesTblItems = oStatusesTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/StatusesTableColumns");
            oStatusesTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oStatusesTable.setModel(eshipjetModel);
            this._handleDisplayStatusesTable();
            this._pStatusesPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onStatusesColSelectClosePress: function () {
            this._pStatusesPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayStatusesTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var StatusesTableColumns = eshipjetModel.getData().StatusesTableColumns;
            const oTable = oView.byId("_IDStatusesTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < StatusesTableColumns.length; i++) {
                if (StatusesTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/StatusesTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/StatusesTableRows");
        },

        onSearchStatuses: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
        
            var oTable = this.byId("_IDStatusesTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("code", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("colorPicker", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("desc", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("status", sap.ui.model.FilterOperator.Contains, sQuery)
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },

        onStatusesFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._StatusesPopover) {
                this._StatusesPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.StatusesFilterPopover",
                    controller: this
                }).then(function (StatusesPopover) {
                    oView.addDependent(StatusesPopover);
                    return StatusesPopover;
                });
            }
            this._StatusesPopover.then(function (StatusesPopover) {
                StatusesPopover.openBy(oButton);
            });
        },

        onStatusesFilterPopoverClosePress: function () {
            this.byId("idStatusesFilterPopover").close();
        },
        
        onStatusesFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var sLocation = eshipjetModel.getProperty("/orderLocationFilter");
        
            if (sLocation) {
                aFilters.push(new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.EQ, sLocation));
            }
            var oTable = oView.byId("_IDStatusesTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter(aFilters);
                }
            }
            this.byId("idStatusesFilterPopover").close();
        },
        
        onStatusesFilterPopoverResetPress: function () {
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/orderLocationFilter", "");
            var oTable = this.byId("_IDStatusesTable");
            var oBinding = oTable.getBinding("rows");
            oBinding.filter([]);
            this.byId("idStatusesFilterPopover").close();
        },

        onStatusesExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/StatusesTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Location Name", property: "locationName"},
                        { label: "Code", property: "code"},
                        { label: "Color Picker", property: "colorPicker"},
                        { label: "Description", property: "desc"},
                        { label: "Status", property: "status"}
                    ]
                },
                dataSource: rows,
                fileName: 'Statuses_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },

        // Statuses Column Names Popover code changes End here


        // Products Column Names Popover code changes starts here

        openProductsColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pProductsPopover) {
                this._pProductsPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ProductsTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pProductsPopover.then(function (oPopover) {
                oController.ProductsColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        ProductsColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/ProductsTableColumns");
            var oProductsTable = oView.byId("myProductsColumnSelectId");
            var aTableItems = oProductsTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onProductsColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myProductsColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onProductsColSelectOkPress: function () {
            var oView = this.getView();
            var oProductsTable = oView.byId("myProductsColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_IDProductsTable")
            oTable.setModel(eshipjetModel);

            var oProductsTblItems = oProductsTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/ProductsTableColumns");
            oProductsTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oProductsTable.setModel(eshipjetModel);
            this._handleDisplayProductsTable();
            this._pProductsPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onProductsColSelectClosePress: function () {
            this._pProductsPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayProductsTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var ProductsTableColumns = eshipjetModel.getData().ProductsTableColumns;
            const oTable = oView.byId("_IDProductsTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < ProductsTableColumns.length; i++) {
                if (ProductsTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/ProductsTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/ProductsTableRows");
        },

        // Products Column Names Popover code changes End here


        // PackageTypes Column Names Popover code changes starts here

        openPackageTypesColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pPackageTypesPopover) {
                this._pPackageTypesPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.PackageTypesTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pPackageTypesPopover.then(function (oPopover) {
                oController.PackageTypesColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        PackageTypesColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/PackageTypeTableColumns");
            var oPackageTypesTable = oView.byId("myPackageTypesColumnSelectId");
            var aTableItems = oPackageTypesTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onPackageTypesColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myPackageTypesColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onPackageTypesColSelectOkPress: function () {
            var oView = this.getView();
            var oPackageTypesTable = oView.byId("myPackageTypesColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_IDPackageTypesTable")
            oTable.setModel(eshipjetModel);

            var oPackageTypesTblItems = oPackageTypesTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/PackageTypeTableColumns");
            oPackageTypesTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oPackageTypesTable.setModel(eshipjetModel);
            this._handleDisplayPackageTypesTable();
            this._pPackageTypesPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onPackageTypesColSelectClosePress: function () {
            this._pPackageTypesPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayPackageTypesTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var PackageTypeTableColumns = eshipjetModel.getData().PackageTypeTableColumns;
            const oTable = oView.byId("_IDPackageTypesTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < PackageTypeTableColumns.length; i++) {
                if (PackageTypeTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/PackageTypeTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/PackageTypeTableRows");
        },

        onSearchPackageTypes: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
        
            var oTable = this.byId("_IDPackageTypesTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("packageCode", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("shipMethod", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("dimensionUnits", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("status", sap.ui.model.FilterOperator.Contains, sQuery)
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },

        onPackageTypesFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._PackageTypesPopover) {
                this._PackageTypesPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.PackageTypesFilterPopover",
                    controller: this
                }).then(function (PackageTypesPopover) {
                    oView.addDependent(PackageTypesPopover);
                    return PackageTypesPopover;
                });
            }
            this._PackageTypesPopover.then(function (PackageTypesPopover) {
                PackageTypesPopover.openBy(oButton);
            });
        },

        onPackageTypesFilterPopoverClosePress: function () {
            this.byId("idPackageTypesFilterPopover").close();
        },
        
        onPackageTypesFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var sLocation = eshipjetModel.getProperty("/orderLocationFilter");
        
            if (sLocation) {
                aFilters.push(new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.EQ, sLocation));
            }
            var oTable = oView.byId("_IDPackageTypesTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter(aFilters);
                }
            }
            this.byId("idPackageTypesFilterPopover").close();
        },
        
        onPackageTypesFilterPopoverResetPress: function () {
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/orderLocationFilter", "");
            var oTable = this.byId("_IDPackageTypesTable");
            var oBinding = oTable.getBinding("rows");
            oBinding.filter([]);
            this.byId("idPackageTypesFilterPopover").close();
        },

        onPackageTypesExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/PackageTypeTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Location Name", property: "locationName"},
                        { label: "Package Code", property: "packageCode"},
                        { label: "Ship Method", property: "shipMethod"},
                        { label: "Dimension Units", property: "dimensionUnits"},
                        { label: "Status", property: "status"}
                    ]
                },
                dataSource: rows,
                fileName: 'Package_Types_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },

        // PackageTypes Column Names Popover code changes End here



          // DangerousGoods Column Names Popover code changes starts here

          openDangerousGoodsColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pDangerousGoodsPopover) {
                this._pDangerousGoodsPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.DangerousGoodsTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pDangerousGoodsPopover.then(function (oPopover) {
                oController.DangerousGoodsColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        DangerousGoodsColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/DangerousGoodsTableColumns");
            var oDangerousGoodsTable = oView.byId("myDangerousGoodsColumnSelectId");
            var aTableItems = oDangerousGoodsTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onDangerousGoodsColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myDangerousGoodsColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onDangerousGoodsColSelectOkPress: function () {
            var oView = this.getView();
            var oDangerousGoodsTable = oView.byId("myDangerousGoodsColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_IDDangerousGoodsTable")
            oTable.setModel(eshipjetModel);

            var oDangerousGoodsTblItems = oDangerousGoodsTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/DangerousGoodsTableColumns");
            oDangerousGoodsTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oDangerousGoodsTable.setModel(eshipjetModel);
            this._handleDisplayDangerousGoodsTable();
            this._pDangerousGoodsPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onDangerousGoodsColSelectClosePress: function () {
            this._pDangerousGoodsPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayDangerousGoodsTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var DangerousGoodsTableColumns = eshipjetModel.getData().DangerousGoodsTableColumns;
            const oTable = oView.byId("_IDDangerousGoodsTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < DangerousGoodsTableColumns.length; i++) {
                if (DangerousGoodsTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/DangerousGoodsTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "Actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "Edit", type: "Transparent", press:"onDangerousGoodsEditPress" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.onDangerousGoodsDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }  else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/DangerousGoodsTableRows");
        },


        onDangerousGoodsExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/DangerousGoodsTableRows");
            var oSettings = {
                Workbook: {
                    columns: [
                        { label: "UN No", property: "unNo", visible: true },
                        { label: "Carrier", property: "carrier", visible: true },
                        { label: "Transport Mode", property: "transportMode", visible: true },
                        { label: "Destination", property: "destination", visible: true },
                        { label: "Hazard ID", property: "hazardId", visible: true },
                        { label: "ERG Guide Number", property: "ergGuideNumber", visible: true },
                        { label: "Hazard Class", property: "hazardClass", visible: true },
                        { label: "Labels Required", property: "labelsRequired", visible: true },
                        { label: "Limited Quantity Max Net Qty Per Package", property: "limitedQuantityMaxNetQty", visible: true },
                        { label: "Limited Quantity Packing Instructions", property: "limitedQuantityPackingInstructions", visible: true },
                        { label: "Limited Quantity", property: "limitedQuantity", visible: true },
                        { label: "Limited Quantity Unit of Measure", property: "limitedQuantityUnit", visible: true },
                        { label: "Packaging Exceptions", property: "packagingExceptions", visible: true },
                        { label: "Packaging Non-Bulk", property: "packagingNonBulk", visible: true },
                        { label: "Passenger & Cargo Aircraft Packing Instructions", property: "passengerCargoAircraftPackingInstructions", visible: true },
                        { label: "Passenger & Cargo Aircraft Quantity", property: "passengerCargoAircraftQuantity", visible: true },
                        { label: "Passenger & Cargo Aircraft Unit of Measure", property: "passengerCargoAircraftUnit", visible: true },
                        { label: "Technical Info Flag", property: "technicalInfoFlag", visible: true },
                        { label: "Actions", property: "actions", visible: true },
                        
                        // Fields with `visible: false`
                        { label: "Additional Info", property: "additionalInfo", visible: false },
                        { label: "Packing Group", property: "packingGroup", visible: false },
                        { label: "Passenger & Cargo Max Net Qty", property: "passengerCargoMaxNetQty", visible: false },
                        { label: "Proper Shipping Name", property: "properShippingName", visible: false },
                        { label: "Canada Permitted", property: "canadaPermitted", visible: false },
                        { label: "Cargo Aircraft Only Quantity", property: "cargoAircraftOnlyQuantity", visible: false },
                        { label: "Cargo Aircraft Only Unit of Measure", property: "cargoAircraftOnlyUnit", visible: false },
                        { label: "Do Not Print PSN Reference Only", property: "doNotPrintPSN", visible: false },
                        { label: "Excepted Quantity Code", property: "exceptedQuantityCode", visible: false },
                        { label: "Exemption Required", property: "exemptionRequired", visible: false },
                        { label: "Forbidden", property: "forbidden", visible: false }
                    ]
                },
                
                dataSource: rows,
                fileName: 'DangerousGoods_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },

        // DangerousGoods Column Names Popover code changes End here


        // ThirdParties Column Names Popover code changes starts here

        openThirdPartiesColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pThirdPartiesPopover) {
                this._pThirdPartiesPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ThirdPartiesTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pThirdPartiesPopover.then(function (oPopover) {
                oController.ThirdPartiesColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        ThirdPartiesColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/ThirdPartiesTableColumns");
            var oThirdPartiesTable = oView.byId("myThirdPartiesColumnSelectId");
            var aTableItems = oThirdPartiesTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onThirdPartiesColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myThirdPartiesColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onThirdPartiesColSelectOkPress: function () {
            var oView = this.getView();
            var oThirdPartiesTable = oView.byId("myThirdPartiesColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_IDThirdPartyTable")
            oTable.setModel(eshipjetModel);

            var oThirdPartiesTblItems = oThirdPartiesTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/ThirdPartiesTableColumns");
            oThirdPartiesTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oThirdPartiesTable.setModel(eshipjetModel);
            this._handleDisplayThirdPartiesTable();
            this._pThirdPartiesPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onThirdPartiesColSelectClosePress: function () {
            this._pThirdPartiesPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayThirdPartiesTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var ThirdPartiesTableColumns = eshipjetModel.getData().ThirdPartiesTableColumns;
            const oTable = oView.byId("_IDThirdPartyTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < ThirdPartiesTableColumns.length; i++) {
                if (ThirdPartiesTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/ThirdPartiesTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/ThirdPartiesTableRows");
        },

        onThirdPartyExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/ThirdPartiesTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Location Name", property: "locationName", visible: true },
                        { label: "Account", property: "account", visible: true },
                        { label: "Contact Name", property: "contactName", visible: true },
                        { label: "Company Name", property: "companyName", visible: true },
                        { label: "Address Line 1", property: "addressLine1", visible: false },
                        { label: "Address Line 2", property: "addressLine2", visible: false },
                        { label: "City", property: "addressCity", visible: true },
                        { label: "State / Provience", property: "stateProvience", visible: true },
                        { label: "Zip / Postal Code", property: "addressZip", visible: true },
                        { label: "Country", property: "addressCountry", visible: true },
                        { label: "Status", property: "status", visible: true }
                    ]   
                },
                dataSource: rows,
                fileName: 'ThirdParty',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },

        // ThirdParties Column Names Popover code changes End here


        // LTLClasses Column Names Popover code changes starts here

        openLTLClassesColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pLTLClassesPopover) {
                this._pLTLClassesPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.LTLClassesTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pLTLClassesPopover.then(function (oPopover) {
                oController.LTLClassesColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        LTLClassesColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/LtlClassesTableColumns");
            var oLTLClassesTable = oView.byId("myLTLClassesColumnSelectId");
            var aTableItems = oLTLClassesTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onLTLClassesColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myLTLClassesColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onLTLClassesColSelectOkPress: function () {
            var oView = this.getView();
            var oLTLClassesTable = oView.byId("myLTLClassesColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_IDLTLClassTable")
            oTable.setModel(eshipjetModel);

            var oLTLClassesTblItems = oLTLClassesTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/LtlClassesTableColumns");
            oLTLClassesTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oLTLClassesTable.setModel(eshipjetModel);
            this._handleDisplayLTLClassesTable();
            this._pLTLClassesPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onLTLClassesColSelectClosePress: function () {
            this._pLTLClassesPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayLTLClassesTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var LtlClassesTableColumns = eshipjetModel.getData().LtlClassesTableColumns;
            const oTable = oView.byId("_IDLTLClassTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < LtlClassesTableColumns.length; i++) {
                if (LtlClassesTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/LtlClassesTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/LtlClassesTableRows");
        },

        // LTLClasses Column Names Popover code changes End here

        // CommonErrorLogs Column Names Popover code changes starts here

        openCommonErrorLogsColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pCommonErrorLogsPopover) {
                this._pCommonErrorLogsPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.CommonErrorLogsTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pCommonErrorLogsPopover.then(function (oPopover) {
                oController.CommonErrorLogsColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        CommonErrorLogsColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/CommonErrorLogsTableColumns");
            var oCommonErrorLogsTable = oView.byId("myCommonErrorLogsColumnSelectId");
            var aTableItems = oCommonErrorLogsTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onCommonErrorLogsColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myCommonErrorLogsColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onCommonErrorLogsColSelectOkPress: function () {
            var oView = this.getView();
            var oCommonErrorLogsTable = oView.byId("myCommonErrorLogsColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_IDCommonErrorLogsTable")
            oTable.setModel(eshipjetModel);

            var oCommonErrorLogsTblItems = oCommonErrorLogsTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/CommonErrorLogsTableColumns");
            oCommonErrorLogsTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oCommonErrorLogsTable.setModel(eshipjetModel);
            this._handleDisplayCommonErrorLogsTable();
            this._pCommonErrorLogsPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onCommonErrorLogsColSelectClosePress: function () {
            this._pCommonErrorLogsPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayCommonErrorLogsTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var CommonErrorLogsTableColumns = eshipjetModel.getData().CommonErrorLogsTableColumns;
            const oTable = oView.byId("_IDCommonErrorLogsTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < CommonErrorLogsTableColumns.length; i++) {
                if (CommonErrorLogsTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/CommonErrorLogsTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/CommonErrorLogsTableRows");
        },

        // CommonErrorLogs Column Names Popover code changes End here

        // NMFC Column Names Popover code changes starts here

        openNMFCColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pNMFCPopover) {
                this._pNMFCPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.NMFCTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pNMFCPopover.then(function (oPopover) {
                oController.NMFCColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        NMFCColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/NmfcTableColumns");
            var oNMFCTable = oView.byId("myNMFCColumnSelectId");
            var aTableItems = oNMFCTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onNMFCColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myNMFCColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onNMFCColSelectOkPress: function () {
            var oView = this.getView();
            var oNMFCTable = oView.byId("myNMFCColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_IDNMFCTable")
            oTable.setModel(eshipjetModel);

            var oNMFCTblItems = oNMFCTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/NmfcTableColumns");
            oNMFCTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oNMFCTable.setModel(eshipjetModel);
            this._handleDisplayNMFCTable();
            this._pNMFCPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onNMFCColSelectClosePress: function () {
            this._pNMFCPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayNMFCTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var NmfcTableColumns = eshipjetModel.getData().NmfcTableColumns;
            const oTable = oView.byId("_IDNMFCTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < NmfcTableColumns.length; i++) {
                if (NmfcTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/NmfcTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/NmfcTableRows");
        },

        // NMFC Column Names Popover code changes End here


        // MOT Column Names Popover code changes starts here

        openMOTColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pMOTPopover) {
                this._pMOTPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.MOTTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pMOTPopover.then(function (oPopover) {
                oController.MOTColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        MOTColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/MotTableColumns");
            var oMOTTable = oView.byId("myMOTColumnSelectId");
            var aTableItems = oMOTTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onMOTColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myMOTColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onMOTColSelectOkPress: function () {
            var oView = this.getView();
            var oMOTTable = oView.byId("myMOTColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_IDModeOfTransportTable")
            oTable.setModel(eshipjetModel);

            var oMOTTblItems = oMOTTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/MotTableColumns");
            oMOTTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oMOTTable.setModel(eshipjetModel);
            this._handleDisplayMOTTable();
            this._pMOTPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onMOTColSelectClosePress: function () {
            this._pMOTPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayMOTTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var MotTableColumns = eshipjetModel.getData().MotTableColumns;
            const oTable = oView.byId("_IDModeOfTransportTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < MotTableColumns.length; i++) {
                if (MotTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/MotTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/MotTableRows");
        },

        // MOT Column Names Popover code changes End here

        // Locations Column Names Popover code changes starts here

        openLocationsColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pLocationsPopover) {
                this._pLocationsPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.LocationsTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pLocationsPopover.then(function (oPopover) {
                oController.LocationsColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        LocationsColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/LocationTableColumns");
            var oLocationsTable = oView.byId("myLocationsColumnSelectId");
            var aTableItems = oLocationsTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onLocationsColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myLocationsColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onLocationsColSelectOkPress: function () {
            var oView = this.getView();
            var oLocationsTable = oView.byId("myLocationsColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_IDLocationTable")
            oTable.setModel(eshipjetModel);

            var oLocationsTblItems = oLocationsTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/LocationTableColumns");
            oLocationsTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oLocationsTable.setModel(eshipjetModel);
            this._handleDisplayLocationTable();
            this._pLocationsPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onLocationsColSelectClosePress: function () {
            this._pLocationsPopover.then(function (oPopover) {
                oPopover.close();
            });
        },


        _handleDisplayLocationTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var LocationTableColumns = eshipjetModel.getData().LocationTableColumns;
            const oTable = oView.byId("_IDLocationTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < LocationTableColumns.length; i++) {
                if (LocationTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/LocationTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/LocationTableRows");
        },

        onSearchLocations: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
        
            var oTable = this.byId("_IDLocationTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("contactName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("phonenum", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("Email", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addressLine1", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addressLine2", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("stateProvience", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locaCity", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locZip", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locCountry", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locWeightUnit", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locCurr", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locDimensionUnit", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locStatus", sap.ui.model.FilterOperator.Contains, sQuery)
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },


        onLocationsFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._LocationsPopover) {
                this._LocationsPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.LocationsFilterPopover",
                    controller: this
                }).then(function (LocationsPopover) {
                    oView.addDependent(LocationsPopover);
                    return LocationsPopover;
                });
            }
            this._LocationsPopover.then(function (LocationsPopover) {
                LocationsPopover.openBy(oButton);
            });
        },
        onLocationsFilterPopoverClosePress: function () {
            this.byId("idLocationsFilterPopover").close();
        },
        
        onLocationsFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var sLocation = eshipjetModel.getProperty("/orderLocationFilter");
        
            if (sLocation) {
                aFilters.push(new sap.ui.model.Filter("Plant", sap.ui.model.FilterOperator.EQ, sLocation));
            }
        
            var oTable = oView.byId("_IDLocationTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter(aFilters);
                }
            }
        
            this.byId("idLocationsFilterPopover").close();
        },
        
        onLocationsFilterPopoverResetPress: function () {
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/orderLocationFilter", "");
            var oTable = this.byId("_IDLocationTable");
            var oBinding = oTable.getBinding("rows");
            oBinding.filter([]);
            this.byId("idLocationsFilterPopover").close();
        },
// ThirdParty
        onSearchThirdParty: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
        
            var oTable = this.byId("_IDThirdPartyTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("contactName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("phonenum", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("Email", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addressLine1", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("addressLine2", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("stateProvience", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locaCity", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locZip", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locCountry", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locWeightUnit", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locCurr", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locDimensionUnit", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locStatus", sap.ui.model.FilterOperator.Contains, sQuery)
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },


        onThirdPartyFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._ThirdPartyPopover) {
                this._ThirdPartyPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ThirdPartyFilterPopover",
                    controller: this
                }).then(function (ThirdPartyPopover) {
                    oView.addDependent(ThirdPartyPopover);
                    return ThirdPartyPopover;
                });
            }
            this._ThirdPartyPopover.then(function (ThirdPartyPopover) {
                ThirdPartyPopover.openBy(oButton);
            });
        },
        onThirdPartyFilterPopoverClosePress: function () {
            this.byId("idThirdPartyFilterPopover").close();
        },
        
        onThirdPartyFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var sThirdParty = eshipjetModel.getProperty("/ThirdPartyFilter");
        
            if (sThirdParty) {
                aFilters.push(new sap.ui.model.Filter("Plant", sap.ui.model.FilterOperator.EQ, sThirdParty));
            }
        
            var oTable = oView.byId("_IDThirdPartyTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter(aFilters);
                }
            }
        
            this.byId("idThirdPartyFilterPopover").close();
        },
        
        onThirdPartyFilterPopoverResetPress: function () {
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/ThirdPartyFilter", "");
            var oTable = this.byId("_IDThirdPartyTable");
            var oBinding = oTable.getBinding("rows");
            oBinding.filter([]);
            this.byId("idThirdPartyFilterPopover").close();
        },
// LTL CLASSES
        onSearchLTLClasses: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
        
            var oTable = this.byId("_IDLTLClassTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("ltlClass", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("shipMethod", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("Email", sap.ui.model.FilterOperator.Contains, sQuery)
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },


        onLTLClassesFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._LTLClassesPopover) {
                this._LTLClassesPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.LTLClassesFilterPopover",
                    controller: this
                }).then(function (LTLClassesPopover) {
                    oView.addDependent(LTLClassesPopover);
                    return LTLClassesPopover;
                });
            }
            this._LTLClassesPopover.then(function (LTLClassesPopover) {
                LTLClassesPopover.openBy(oButton);
            });
        },
        onLTLClassesFilterPopoverClosePress: function () {
            this.byId("idLTLClassesFilterPopover").close();
        },
        
        onLTLClassesFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var sLTLClasses = eshipjetModel.getProperty("/LTLClassesFilter");
        
            if (sLTLClasses) {
                aFilters.push(new sap.ui.model.Filter("Plant", sap.ui.model.FilterOperator.EQ, sLTLClasses));
            }
        
            var oTable = oView.byId("_IDLTLClassTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter(aFilters);
                }
            }
        
            this.byId("idLTLClassesFilterPopover").close();
        },
        
        onLTLClassesFilterPopoverResetPress: function () {
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/LTLClassesFilter", "");
            var oTable = this.byId("_IDLTLClassTable");
            var oBinding = oTable.getBinding("rows");
            oBinding.filter([]);
            this.byId("idLTLClassesFilterPopover").close();
        },



        // Dangerous Goods
        onSearchDangerousGoods: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
        
            var oTable = this.byId("_IDDangerousGoodsTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("destination", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("transportMode", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("hazardClass", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("labelsRequired", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("additionalInfo", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("packingGroup", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("forbidden", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("properShippingName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locZip", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locCountry", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locWeightUnit", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locCurr", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locDimensionUnit", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locStatus", sap.ui.model.FilterOperator.Contains, sQuery)
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },


        onDangerousGoodsFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._DangerousGoodsPopover) {
                this._DangerousGoodsPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.DangerousGoodsFilterPopover",
                    controller: this
                }).then(function (DangerousGoodsPopover) {
                    oView.addDependent(DangerousGoodsPopover);
                    return DangerousGoodsPopover;
                });
            }
            this._DangerousGoodsPopover.then(function (DangerousGoodsPopover) {
                DangerousGoodsPopover.openBy(oButton);
            });
        },
        onDangerousGoodsFilterPopoverClosePress: function () {
            this.byId("idDangerousGoodsFilterPopover").close();
        },
        
        onDangerousGoodsFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var sDangerousGoods = eshipjetModel.getProperty("/DangerousGoodsFilter");
        
            if (sDangerousGoods) {
                aFilters.push(new sap.ui.model.Filter("Plant", sap.ui.model.FilterOperator.EQ, sDangerousGoods));
            }
        
            var oTable = oView.byId("_IDDangerousGoodsTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter(aFilters);
                }
            }
        
            this.byId("idDangerousGoodsFilterPopover").close();
        },
        
        onDangerousGoodsFilterPopoverResetPress: function () {
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/DangerousGoodsFilter", "");
            var oTable = this.byId("_IDDangerousGoodsTable");
            var oBinding = oTable.getBinding("rows");
            oBinding.filter([]);
            this.byId("idDangerousGoodsFilterPopover").close();
        },


        // NMFC Table-------------------------------------
        onSearchNMFCTable: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
        
            var oTable = this.byId("_IDNMFCTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("nmfcCode", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("nmfcDesc", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("shipMethod", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("status", sap.ui.model.FilterOperator.Contains, sQuery)
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },


        onNMFCTableFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._NMFCTablePopover) {
                this._NMFCTablePopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.NMFCTableFilterPopover",
                    controller: this
                }).then(function (NMFCTablePopover) {
                    oView.addDependent(NMFCTablePopover);
                    return NMFCTablePopover;
                });
            }
            this._NMFCTablePopover.then(function (NMFCTablePopover) {
                NMFCTablePopover.openBy(oButton);
            });
        },
        onNMFCTableFilterPopoverClosePress: function () {
            this.byId("idNMFCTableFilterPopover").close();
        },
        
        onNMFCTableFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var sNMFCTable = eshipjetModel.getProperty("/NMFCTableFilter");
        
            if (sNMFCTable) {
                aFilters.push(new sap.ui.model.Filter("Plant", sap.ui.model.FilterOperator.EQ, sNMFCTable));
            }
        
            var oTable = oView.byId("_IDNMFCTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter(aFilters);
                }
            }
        
            this.byId("idNMFCTableFilterPopover").close();
        },
        
        onNMFCTableFilterPopoverResetPress: function () {
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/NMFCTableFilter", "");
            var oTable = this.byId("_IDNMFCTable");
            var oBinding = oTable.getBinding("rows");
            oBinding.filter([]);
            this.byId("idNMFCTableFilterPopover").close();
        },


         // OrderTypes
         onSearchOrderTypes: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
        
            var oTable = this.byId("_IDOrderTypeTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("locationid", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("erplocationid", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("erpName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("orderTypeCode", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("orderTypeDesc", sap.ui.model.FilterOperator.Contains, sQuery)

                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },


        onOrderTypesFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._OrderTypesPopover) {
                this._OrderTypesPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.OrderTypesFilterPopover",
                    controller: this
                }).then(function (OrderTypesPopover) {
                    oView.addDependent(OrderTypesPopover);
                    return OrderTypesPopover;
                });
            }
            this._OrderTypesPopover.then(function (OrderTypesPopover) {
                OrderTypesPopover.openBy(oButton);
            });
        },
        onOrderTypesFilterPopoverClosePress: function () {
            this.byId("idOrderTypesFilterPopover").close();
        },
        
        onOrderTypesFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var sOrderTypes = eshipjetModel.getProperty("/OrderTypesFilter");
        
            if (sOrderTypes) {
                aFilters.push(new sap.ui.model.Filter("locationid", sap.ui.model.FilterOperator.EQ, sOrderTypes));
            }
        
            var oTable = oView.byId("_IDOrderTypeTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter(aFilters);
                }
            }
        
            this.byId("idOrderTypesFilterPopover").close();
        },
        
        onOrderTypesFilterPopoverResetPress: function () {
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/OrderTypesFilter", "");
            var oTable = this.byId("_IDOrderTypeTable");
            var oBinding = oTable.getBinding("rows");
            oBinding.filter([]);
            this.byId("idOrderTypesFilterPopover").close();
        },


         // Incoterms
         onSearchIncoterms: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
        
            var oTable = this.byId("_ID_IncotermsTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("locationid", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("erplocationid", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("erpName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("orderTypeCode", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("orderTypeDesc", sap.ui.model.FilterOperator.Contains, sQuery)
                            
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },


        onIncotermsFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._IncotermsPopover) {
                this._IncotermsPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.IncotermsFilterPopover",
                    controller: this
                }).then(function (IncotermsPopover) {
                    oView.addDependent(IncotermsPopover);
                    return IncotermsPopover;
                });
            }
            this._IncotermsPopover.then(function (IncotermsPopover) {
                IncotermsPopover.openBy(oButton);
            });
        },
        onIncotermsFilterPopoverClosePress: function () {
            this.byId("idIncotermsFilterPopover").close();
        },
        
        onIncotermsFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var sIncoterms = eshipjetModel.getProperty("/IncotermsFilter");
        
            if (sIncoterms) {
                aFilters.push(new sap.ui.model.Filter("locationid", sap.ui.model.FilterOperator.EQ, sIncoterms));
            }
        
            var oTable = oView.byId("_ID_IncotermsTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter(aFilters);
                }
            }
        
            this.byId("idIncotermsFilterPopover").close();
        },
        
        onIncotermsFilterPopoverResetPress: function () {
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/IncotermsFilter", "");
            var oTable = this.byId("_ID_IncotermsTable");
            var oBinding = oTable.getBinding("rows");
            oBinding.filter([]);
            this.byId("idIncotermsFilterPopover").close();
        },

         // PaymentTypes
         onSearchPaymentTypes: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
        
            var oTable = this.byId("_ID_PaymentTypesTable");
            var oBinding = oTable.getBinding("rows");
        
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("locationid", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("locationName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("erplocationid", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("erpName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("orderTypeCode", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("orderTypeDesc", sap.ui.model.FilterOperator.Contains, sQuery)
                            
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },


        onPaymentTypesFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._PaymentTypesPopover) {
                this._PaymentTypesPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.PaymentTypesFilterPopover",
                    controller: this
                }).then(function (PaymentTypesPopover) {
                    oView.addDependent(PaymentTypesPopover);
                    return PaymentTypesPopover;
                });
            }
            this._PaymentTypesPopover.then(function (PaymentTypesPopover) {
                PaymentTypesPopover.openBy(oButton);
            });
        },
        onPaymentTypesFilterPopoverClosePress: function () {
            this.byId("idPaymentTypesFilterPopover").close();
        },
        
        onPaymentTypesFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var sPaymentTypes = eshipjetModel.getProperty("/PaymentTypesFilter");
        
            if (sPaymentTypes) {
                aFilters.push(new sap.ui.model.Filter("locationid", sap.ui.model.FilterOperator.EQ, sPaymentTypes));
            }
        
            var oTable = oView.byId("_ID_PaymentTypesTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter(aFilters);
                }
            }
        
            this.byId("idPaymentTypesFilterPopover").close();
        },
        
        onPaymentTypesFilterPopoverResetPress: function () {
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/PaymentTypesFilter", "");
            var oTable = this.byId("_ID_PaymentTypesTable");
            var oBinding = oTable.getBinding("rows");
            oBinding.filter([]);
            this.byId("idPaymentTypesFilterPopover").close();
        },



        onLocationsExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/LocationTableRows");
            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Location Name", property: "locationName", visible: false },
                        { label: "Contact Name", property: "contactName", visible: true },
                        { label: "Phone No", property: "phonenum", visible: true },
                        { label: "Email", property: "Email", visible: true },
                        { label: "Address Line 1", property: "addressLine1", visible: false },
                        { label: "Address Line 2", property: "addressLine2", visible: false },
                        { label: "State Provience", property: "stateProvience", visible: true },
                        { label: "Location City", property: "locaCity", visible: true },
                        { label: "ZipCode", property: "locZip", visible: false },
                        { label: "Country", property: "locCountry", visible: true },
                        { label: "Weight Unit", property: "locWeightUnit", visible: false },
                        { label: "Currency", property: "locCurr", visible: false },
                        { label: "Dimension Unit", property: "locDimensionUnit", visible: false },
                        { label: "Status", property: "status", visible: true }
                    ]
                },
                dataSource: rows,
                fileName: 'Location_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },

        // Locations Column Names Popover code changes End here

        // OrderTypes Column Names Popover code changes starts here

        openOrderTypesColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pOrderTypesPopover) {
                this._pOrderTypesPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.OrderTypesTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pOrderTypesPopover.then(function (oPopover) {
                oController.OrderTypesColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        OrderTypesColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/OrderTypesTableColumns");
            var oOrderTypesTable = oView.byId("myOrderTypesColumnSelectId");
            var aTableItems = oOrderTypesTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onOrderTypesColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myOrderTypesColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onOrderTypesColSelectOkPress: function () {
            var oView = this.getView();
            var oOrderTypesTable = oView.byId("myOrderTypesColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_IDOrderTypeTable")
            oTable.setModel(eshipjetModel);

            var oOrderTypesTblItems = oOrderTypesTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/OrderTypesTableColumns");
            oOrderTypesTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oOrderTypesTable.setModel(eshipjetModel);
            this._handleDisplayOrderTypesTable();
            this._pOrderTypesPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onOrderTypesColSelectClosePress: function () {
            this._pOrderTypesPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayOrderTypesTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var OrderTypesTableColumns = eshipjetModel.getData().OrderTypesTableColumns;
            const oTable = oView.byId("_IDOrderTypeTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < OrderTypesTableColumns.length; i++) {
                if (OrderTypesTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/OrderTypesTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/OrderTypesTableRows");
        },

        // OrderTypes Column Names Popover code changes End here


        // Incoterms Column Names Popover code changes starts here

        openIncotermsColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pIncotermsPopover) {
                this._pIncotermsPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.IncotermsTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pIncotermsPopover.then(function (oPopover) {
                oController.IncotermsColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        IncotermsColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/IncoTermsTableColumns");
            var oIncotermsTable = oView.byId("myIncotermsColumnSelectId");
            var aTableItems = oIncotermsTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onIncotermsColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myIncotermsColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onIncotermsColSelectOkPress: function () {
            var oView = this.getView();
            var oIncotermsTable = oView.byId("myIncotermsColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_ID_IncotermsTable")
            oTable.setModel(eshipjetModel);

            var oIncotermsTblItems = oIncotermsTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/IncoTermsTableColumns");
            oIncotermsTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oIncotermsTable.setModel(eshipjetModel);
            this._handleDisplayIncotermsTable();
            this._pIncotermsPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onIncotermsColSelectClosePress: function () {
            this._pIncotermsPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayIncotermsTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var IncoTermsTableColumns = eshipjetModel.getData().IncoTermsTableColumns;
            const oTable = oView.byId("_ID_IncotermsTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < IncoTermsTableColumns.length; i++) {
                if (IncoTermsTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/IncoTermsTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/IncoTermsTableRows");
        },

        // Incoterms Column Names Popover code changes End here

        // Tracking Range Column Names Popover code changes starts here

        openTrackingRangeColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pTrackingRangePopover) {
                this._pTrackingRangePopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.TrackingRangeTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pTrackingRangePopover.then(function (oPopover) {
                oController.TrackingRangeColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        TrackingRangeColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/TrackingRangeTableColumns");
            var oTrackingRangeTable = oView.byId("myTrackingRangeColumnSelectId");
            var aTableItems = oTrackingRangeTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onTrackingRangeColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myTrackingRangeColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onTrackingRangeColSelectOkPress: function () {
            var oView = this.getView();
            var oTrackingRangeTable = oView.byId("myTrackingRangeColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_ID_TrackingRangeTable")
            oTable.setModel(eshipjetModel);

            var oTrackingRangeTblItems = oTrackingRangeTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/TrackingRangeTableColumns");
            oTrackingRangeTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oTrackingRangeTable.setModel(eshipjetModel);
            this._handleDisplayTrackingRangeTable();
            this._pTrackingRangePopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onTrackingRangeColSelectClosePress: function () {
            this._pTrackingRangePopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayTrackingRangeTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var TrackingRangeTableColumns = eshipjetModel.getData().TrackingRangeTableColumns;
            const oTable = oView.byId("_ID_TrackingRangeTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < TrackingRangeTableColumns.length; i++) {
                if (TrackingRangeTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/TrackingRangeTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/TrackingRangeTableRows");
        },

        // Dimensions Column Names Popover code changes starts here

        openDimensionsColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pDimensionsPopover) {
                this._pDimensionsPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.DimensionsTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pDimensionsPopover.then(function (oPopover) {
                oController.DimensionsColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        DimensionsColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/DimensionsTableColumns");
            var oDimensionsTable = oView.byId("myDimensionsColumnSelectId");
            var aTableItems = oDimensionsTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onDimensionsColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myDimensionsColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onDimensionsColSelectOkPress: function () {
            var oView = this.getView();
            var oDimensionsTable = oView.byId("myDimensionsColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_ID_DimensionTable")
            oTable.setModel(eshipjetModel);

            var oDimensionsTblItems = oDimensionsTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/DimensionsTableColumns");
            oDimensionsTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oDimensionsTable.setModel(eshipjetModel);
            this._handleDisplayDimensionsTable();
            this._pDimensionsPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onDimensionsColSelectClosePress: function () {
            this._pDimensionsPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayDimensionsTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var DimensionsTableColumns = eshipjetModel.getData().DimensionsTableColumns;
            const oTable = oView.byId("_ID_DimensionTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < DimensionsTableColumns.length; i++) {
                if (DimensionsTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/DimensionsTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/DiemnsionsTableRows");
        },

        // Dimensions Column Names Popover code changes End here


        // PaymentTypes Column Names Popover code changes starts here

        openPaymentTypesColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pPaymentTypesPopover) {
                this._pPaymentTypesPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.PaymentTypesTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pPaymentTypesPopover.then(function (oPopover) {
                oController.PaymentTypesColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        PaymentTypesColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/PaymentTypesTableColumns");
            var oPaymentTypesTable = oView.byId("myPaymentTypesColumnSelectId");
            var aTableItems = oPaymentTypesTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onPaymentTypesColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myPaymentTypesColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onPaymentTypesColSelectOkPress: function () {
            var oView = this.getView();
            var oPaymentTypesTable = oView.byId("myPaymentTypesColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_ID_PaymentTypeTable")
            oTable.setModel(eshipjetModel);

            var oPaymentTypesTblItems = oPaymentTypesTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/PaymentTypesTableColumns");
            oPaymentTypesTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oPaymentTypesTable.setModel(eshipjetModel);
            this._pPaymentTypesPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onPaymentTypesColSelectClosePress: function () {
            this._pPaymentTypesPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayPaymentTypesTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var PaymentTypesTableColumns = eshipjetModel.getData().PaymentTypesTableColumns;
            const oTable = oView.byId("_ID_PaymentTypeTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < PaymentTypesTableColumns.length; i++) {
                if (PaymentTypesTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/PaymentTypesTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/PaymentTypesTableRows");
        },

        // PaymentTypes Column Names Popover code changes End here

        // SMTP Column Names Popover code changes starts here

        openSMTPColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pSMTPPopover) {
                this._pSMTPPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.SMTPTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pSMTPPopover.then(function (oPopover) {
                oController.SMTPColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        SMTPColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/SMTPConfigsTableColumns");
            var oSMTPTable = oView.byId("mySMTPColumnSelectId");
            var aTableItems = oSMTPTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onSMTPColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("mySMTPColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onSMTPColSelectOkPress: function () {
            var oView = this.getView();
            var oSMTPTable = oView.byId("mySMTPColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_ID_SMTPConfigTable")
            oTable.setModel(eshipjetModel);

            var oSMTPTblItems = oSMTPTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/SMTPConfigsTableColumns");
            oSMTPTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oSMTPTable.setModel(eshipjetModel);
            this._handleDisplaySMTPTable();
            this._pSMTPPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onSMTPColSelectClosePress: function () {
            this._pSMTPPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplaySMTPTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var SMTPConfigsTableColumns = eshipjetModel.getData().SMTPConfigsTableColumns;
            const oTable = oView.byId("_ID_SMTPConfigTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < SMTPConfigsTableColumns.length; i++) {
                if (SMTPConfigsTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/SMTPConfigsTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status" || columnName === "ssl") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/SMTPConfigsTableRows");
        },

        // SMTP Column Names Popover code changes End here


        // ERP Column Names Popover code changes starts here

        openERPColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pERPPopover) {
                this._pERPPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ERPTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pERPPopover.then(function (oPopover) {
                oController.ERPColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        ERPColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/ERPTableColumns");
            var oERPTable = oView.byId("myERPColumnSelectId");
            var aTableItems = oERPTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onERPColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myERPColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onERPColSelectOkPress: function () {
            var oView = this.getView();
            var oERPTable = oView.byId("myERPColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_ID_ERPTable")
            oTable.setModel(eshipjetModel);

            var oERPTblItems = oERPTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/ERPTableColumns");
            oERPTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oERPTable.setModel(eshipjetModel);
            this._handleDisplayERPTable();
            this._pERPPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onERPColSelectClosePress: function () {
            this._pERPPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayERPTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var ERPTableColumns = eshipjetModel.getData().ERPTableColumns;
            const oTable = oView.byId("_ID_ERPTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < ERPTableColumns.length; i++) {
                if (ERPTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/ERPTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/ERPTableRows");
        },

        // ERP Column Names Popover code changes End here


        // Countries Column Names Popover code changes starts here

        openCountriesColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pCountriesPopover) {
                this._pCountriesPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.CountriesTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pCountriesPopover.then(function (oPopover) {
                oController.CountriesColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        CountriesColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/CountriesTableColumns");
            var oCountriesTable = oView.byId("myCountriesColumnSelectId");
            var aTableItems = oCountriesTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onCountriesColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myCountriesColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onCountriesColSelectOkPress: function () {
            var oView = this.getView();
            var oCountriesTable = oView.byId("myCountriesColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_ID_CountriesTable")
            oTable.setModel(eshipjetModel);

            var oCountriesTblItems = oCountriesTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/CountriesTableColumns");
            oCountriesTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oCountriesTable.setModel(eshipjetModel);
            this._handleDisplayCountriesTable();
            this._pCountriesPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onCountriesColSelectClosePress: function () {
            this._pCountriesPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayCountriesTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var CountriesTableColumns = eshipjetModel.getData().CountriesTableColumns;
            const oTable = oView.byId("_ID_CountriesTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < CountriesTableColumns.length; i++) {
                if (CountriesTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/CountriesTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/CountriesTableRows");
        },

        // Countries Column Names Popover code changes End here


        // EUCountries Column Names Popover code changes starts here

        openEUCountriesColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pEUCountriesPopover) {
                this._pEUCountriesPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.EUCountriesTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pEUCountriesPopover.then(function (oPopover) {
                oController.EUCountriesColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        EUCountriesColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/EUCountriesTableColumns");
            var oEUCountriesTable = oView.byId("myEUCountriesColumnSelectId");
            var aTableItems = oEUCountriesTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onEUCountriesColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myEUCountriesColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onEUCountriesColSelectOkPress: function () {
            var oView = this.getView();
            var oEUCountriesTable = oView.byId("myEUCountriesColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_ID_EUCountriesTable")
            oTable.setModel(eshipjetModel);

            var oEUCountriesTblItems = oEUCountriesTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/EUCountriesTableColumns");
            oEUCountriesTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oEUCountriesTable.setModel(eshipjetModel);
            this._handleDisplayEUCountriesTable();
            this._pEUCountriesPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onEUCountriesColSelectClosePress: function () {
            this._pEUCountriesPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayEUCountriesTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var EUCountriesTableColumns = eshipjetModel.getData().EUCountriesTableColumns;
            const oTable = oView.byId("_ID_EUCountriesTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < EUCountriesTableColumns.length; i++) {
                if (EUCountriesTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/EUCountriesTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/EUCountriesTableRows");
        },

        // EUCountries Column Names Popover code changes End here

        // ShipmentErrorLogs Column Names Popover code changes starts here

        openShipmentErrorLogsColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pShipmentErrorLogsPopover) {
                this._pShipmentErrorLogsPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipmentErrorLogsTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pShipmentErrorLogsPopover.then(function (oPopover) {
                oController.ShipmentErrorLogsColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        ShipmentErrorLogsColumnsVisiblity: function () {
            var oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = eshipjetModel.getProperty("/ShipmentErrorLogsTableColumns");
            var oShipmentErrorLogsTable = oView.byId("myShipmentErrorLogsColumnSelectId");
            var aTableItems = oShipmentErrorLogsTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("eshipjetModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },

        onShipmentErrorLogsColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myShipmentErrorLogsColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onShipmentErrorLogsColSelectOkPress: function () {
            var oView = this.getView();
            var oShipmentErrorLogsTable = oView.byId("myShipmentErrorLogsColumnSelectId");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oTable = oView.byId("_ID_ShipmentErrorLogsTable")
            oTable.setModel(eshipjetModel);

            var oShipmentErrorLogsTblItems = oShipmentErrorLogsTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/ShipmentErrorLogsTableColumns");
            oShipmentErrorLogsTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            eshipjetModel.updateBindings(true);
            oShipmentErrorLogsTable.setModel(eshipjetModel);
            this._handleDisplayShipmentErrorLogsTable();
            this._pShipmentErrorLogsPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onShipmentErrorLogsColSelectClosePress: function () {
            this._pShipmentErrorLogsPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        _handleDisplayShipmentErrorLogsTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var ShipmentErrorLogsTableColumns = eshipjetModel.getData().ShipmentErrorLogsTableColumns;
            const oTable = oView.byId("_ID_ShipmentErrorLogsTable");
            oTable.setModel(eshipjetModel);
            var count = 0;
            for (var i = 0; i < ShipmentErrorLogsTableColumns.length; i++) {
                if (ShipmentErrorLogsTableColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/ShipmentErrorLogsTableColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count >= 14) {
                    var minWidth = "130px";
                }
                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "View Now", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "status") {
                    var oSwitch = new sap.m.Switch({ type: "AcceptReject" });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oSwitch,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/ShipmentErrorLogsTableRows");
        },

        // ShipmentErrorLogs Column Names Popover code changes End here

        // add location popover changes start
        onAddLocationPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            // create popover
            if (!this._AddLocPopover) {
                this._AddLocPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddLocationPopover",
                    controller: this
                }).then(function (oAddLocPopover) {
                    oView.addDependent(oAddLocPopover);
                    return oAddLocPopover;
                });
            }
            this._AddLocPopover.then(function (oAddLocPopover) {
                oAddLocPopover.openBy(oButton);
            });
        },

        onAddLocationClosePress: function (oEvent) {
            this.byId("addLocationPopover").close();
        },
        AddLocPopoverClose: function () {
            var oPopover = this.byId("addLocationPopover");
            if (oPopover) {
                oPopover.close(); // Close the popover
            }
        },
        AddLocCancelPopover: function () {
            var oPopover = this.byId("addLocationPopover");
            if (oPopover) {
                oPopover.close(); // Close the popover
            }
        },

        AddLocSelectPopover: function () {
            var oPopover = this.byId("addLocationPopover");
            if (oPopover) {
                oPopover.close(); // Close the popover
            }
        },
        // add location popover changes end

        // add ShipNowPickAnAddressPopover changes start
        ShipNowPickAnAddressPopoverPress: function() {
            var oView = this.getView();

            if (!this.byId("_IDGenAlcoholEditDialogshipnow")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.ShipNowPickAnAddressPopover",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenAlcoholEditDialogshipnow").open();
            }
        },

        onShipNowPickAnAddressCancelPress1: function() {
            this.byId("_IDGenAlcoholEditDialogshipnow").close();
        },

        


        onShipNowPickAnAddressSelectPress: function () {
            var ShipNowDataModel = this.getView().getModel("ShipNowDataModel");
            var shipNowBtnId = ShipNowDataModel.getProperty("/shipNowBtnId");
            var oTable = this.getView().byId("idShipNowPickAnAddressTable");
            

            var oSelectedItem = oTable.getSelectedItem();

            var oContext = oSelectedItem.getBindingContext();
            var oSelectedData = oContext.getObject();
            var ShipNowDataModel = oController.getView().getModel("ShipNowDataModel");
            ShipNowDataModel.setProperty("/ShipFromAddress", oSelectedData);
            // var oAddressModel = new JSONModel(oSelectedData);
            // this.getView().setModel(oAddressModel, "oAddressModel");

           
            oTable.removeSelections(true);
            this.byId("_IDGenAlcoholEditDialogshipnow").close();
        },

            ShipToPickAnAddressPopoverPress: function() {
                var oView = this.getView();
    
                if (!this.byId("_IDGenAlcoholEditDialogshipnowTo")) {
                    Fragment.load({
                        id: oView.getId(),
                        name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.ShipToPickAnAddressPopover",
                        controller: this
                    }).then(function(oDialog) {
                        oView.addDependent(oDialog);
                        oDialog.open();
                    });
                } else {
                    this.byId("_IDGenAlcoholEditDialogshipnowTo").open();
                }
            },
    
            onShipNowPickAnAddressCancelPress123: function() {
                this.byId("_IDGenAlcoholEditDialogshipnowTo").close();
            },
    

        onShipToPickAnAddressSelectPress: function () {
            var ShipNowDataModel = this.getView().getModel("ShipNowDataModel");
            var shipNowBtnId = ShipNowDataModel.getProperty("/shipNowBtnId");
            var oShipToTable = this.getView().byId("idShipTOPickAnAddressTable");
            

            var oSelectedItem = oShipToTable.getSelectedItem();

            var oContext = oSelectedItem.getBindingContext();
            var oSelectedData = oContext.getObject();
            var ShipNowDataModel = oController.getView().getModel("ShipNowDataModel");
            ShipNowDataModel.setProperty("/ShipToAddress", oSelectedData);
            // var oAddressModel = new JSONModel(oSelectedData);
            // this.getView().setModel(oAddressModel, "oAddressModel");

           
            oShipToTable.removeSelections(true);
            this.byId("_IDGenAlcoholEditDialogshipnowTo").close();
        },

        // add ShipNowPlusIcon popover changes start
        onShipNowAddIconPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            // create popover
            if (!this._AddShioReqLabelAddIconPopover) {
                this._AddShioReqLabelAddIconPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.ShipNowAddIconPopover",
                    controller: this
                }).then(function (oAddShioReqLabelAddIconPopover) {
                    oView.addDependent(oAddShioReqLabelAddIconPopover);
                    return oAddShioReqLabelAddIconPopover;
                });
            }
            this._AddShioReqLabelAddIconPopover.then(function (oAddShioReqLabelAddIconPopover) {
                oAddShioReqLabelAddIconPopover.openBy(oButton);
            });
        },

        onShipNowAddClosePress: function (oEvent) {
            this.byId("idShipNowAddIconPopover").close();
        },
        ShipNowAddIconClosePress: function () {
            var oPopover = this.byId("idShipNowAddIconPopover");
            if (oPopover) {
                oPopover.close(); // Close the popover
            }
        },
        ShipNowAddIconCancelPopover: function () {
            var oPopover = this.byId("idShipNowAddIconPopover");
            if (oPopover) {
                oPopover.close(); // Close the popover
            }
        },

        ShipNowAddIconSelectPopover: function () {
            var oPopover = this.byId("idShipNowAddIconPopover");
            if (oPopover) {
                oPopover.close(); // Close the popover
            }
        },

      
      
        // add ShipNowPlusIcon popover changes start
      onPressShipReqLabelEditicon: function (oEvent) {
        var oButton = oEvent.getSource(),
            oView = this.getView();
        // create popover
        if (!this._AddShioReqLabelEditIconPopover) {
            this._AddShioReqLabelEditIconPopover = Fragment.load({
                id: oView.getId(),
                name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipReqLabel.ShipReqLabelEditIconPopover",
                controller: this
            }).then(function (oAddShioReqLabelEditIconPopover) {
                oView.addDependent(oAddShioReqLabelEditIconPopover);
                return oAddShioReqLabelEditIconPopover;
            });
        }
        this._AddShioReqLabelEditIconPopover.then(function (oAddShioReqLabelEditIconPopover) {
            oAddShioReqLabelEditIconPopover.openBy(oButton);
        });
    },

    onShioReqLabelEditIconClosePress: function (oEvent) {
        this.byId("idShipReqLabelEditIconAddIconPopover").close();
    },
    ShioReqLabelEditIconSubmitPress: function () {
        this.byId("idShipReqLabelEditIconAddIconPopover").close();
    },
    ShioReqLabelEditIconIconCancelPopover: function () {
        this.byId("idShipReqLabelEditIconAddIconPopover").close();
    },

    onCheckBoxSelect: function (oEvent) {
        // Get the state of the checkbox (selected or not)
        var bSelected = oEvent.getParameter("selected");
    
        // Get the button control by its ID
        var oButton = this.byId("btnEditIcon");
    
        // Enable or disable the button based on the checkbox state
        oButton.setEnabled(bSelected);
    },
    

    
        // add onAddAdressBookIconPress popover changes start
        onAddAdressBookIconPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            // create popover
            if (!this._AddAdressBookPopover) {
                this._AddAdressBookPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddAddressBookPopover",
                    controller: this
                }).then(function (oAddAdressBookPopover) {
                    oView.addDependent(oAddAdressBookPopover);
                    return oAddAdressBookPopover;
                });
            }
            this._AddAdressBookPopover.then(function (oAddAdressBookPopover) {
                oAddAdressBookPopover.openBy(oButton);
            });
        },
        AddAddressBookClosePress: function () {
            var oPopover = this.byId("idAddAddressBookPopover");
            if (oPopover) {
                oPopover.close(); // Close the popover
            }
        },
        AddAddressBookCancelPopover: function () {
            var oPopover = this.byId("idAddAddressBookPopover");
            if (oPopover) {
                oPopover.close(); // Close the popover
            }
        },

        AddAddressBookSelectPopover: function () {
            var oPopover = this.byId("idAddAddressBookPopover");
            if (oPopover) {
                oPopover.close(); // Close the popover
            }
        },


        // add onAddUserIconPress popover changes start
        onAddUserIconPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddUserPopover) {
                this._AddUserPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddUserPopOver",
                    controller: this
                }).then(function (oAddUserPopover) {
                    oView.addDependent(oAddUserPopover);
                    return oAddUserPopover;
                });
            }
            this._AddUserPopover.then(function (oAddUserPopover) {
                oAddUserPopover.openBy(oButton);
            });
        },
        AddUserClosePress: function () {
            var oPopover = this.byId("idAddUserPopover");
            if (oPopover) {
                oPopover.close();
            }
        },
        AddUserCancelPopover: function () {
            var oPopover = this.byId("idAddUserPopover");
            if (oPopover) {
                oPopover.close();
            }
        },

        AddUserSelectPopover: function () {
            var oPopover = this.byId("idAddUserPopover");
            if (oPopover) {
                oPopover.close();
            }
        },

        onShipNowSearchDialog: function () {
            var oView = this.getView();
            oController.ShipNowSearchDlg = oController.byId("idShipNowSearchDialog");
            if (!oController.ShipNowSearchDlg) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.shipNowSearchIcon",
                    controller: this
                }).then(function (oShipNowSearchDialog) {
                    oView.addDependent(oShipNowSearchDialog);
                    oShipNowSearchDialog.open();
                });
            } else {
                oController.ShipNowSearchDlg.open();
            }
        },

        onShipNowSearchDialogClosePress: function () {
            Fragment.byId(this.getView().getId(), "idShipNowSearchDialog").close();
        },

        handleConsolidationPress: function () {
            var that = this;
            var oView = this.getView();
            if (!this.byId("idShipNowConsolidationDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.shipNowConsolidationDialog",
                    controller: this
                }).then(function (oShipNowConsolidationDialog) {
                    oView.addDependent(oShipNowConsolidationDialog);
                    oShipNowConsolidationDialog.open();
                    that._handleDisplayShipNowConsolidationTable();
                });
            } else {
                this.byId("idShipNowConsolidationDialog").open();
                this._handleDisplayShipNowConsolidationTable();
            }
        },

        onConsolidationClosePress: function () {
            Fragment.byId(oView.getId(), "idShipNowConsolidationDialog").close();
        },
        
// handleHULinkPress: function (oEvent) {
//     var oController = this;
//     var oView = this.getView();
//     var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");

//     // -------------------------------------------------
//     // 1ï¸âƒ£ Get clicked HU header object
//     // -------------------------------------------------
//     var oHU = oEvent.getSource()
//         .getBindingContext("eshipjetModel")
//         .getObject();

//     var sHUId = oHU.HandlingUnitExternalId;

//     if (!sHUId) {
//         sap.m.MessageToast.show("Handling Unit not found");
//         return;
//     }

//     // -------------------------------------------------
//     // 2ï¸âƒ£ Read HU ITEM data directly from GET response
//     // -------------------------------------------------
//     var aHUItemsRaw =
//         oHU.to_HandlingUnitItemDelivery &&
//         oHU.to_HandlingUnitItemDelivery.results
//             ? oHU.to_HandlingUnitItemDelivery.results
//             : [];

//     if (!aHUItemsRaw.length) {
//         sap.m.MessageToast.show("No products found for this Handling Unit");
//         return;
//     }

//     // -------------------------------------------------
//     // 3ï¸âƒ£ Map to dialog table structure
//     // -------------------------------------------------
//     var aHandlingUnitItems = aHUItemsRaw.map(function (item, index) {
//         return {
//             ItemNo: (index + 1) * 10,
//             Material: item.ProductCode || item.Material || "",
//             MaterialName: item.MaterialName || "",
//             HandlingUnitQuantity: item.HandlingUnitQuantity || "",
//             HandlingUnitQuantityUnit: item.HandlingUnitQuantityUnit || ""
//         };
//     });

//     // -------------------------------------------------
//     // 4ï¸âƒ£ Set model data
//     // -------------------------------------------------
//     eshipjetModel.setProperty("/handlingUnitItems", aHandlingUnitItems);
//     eshipjetModel.updateBindings(true);

//     // -------------------------------------------------
//     // 5ï¸âƒ£ Open dialog (load once, reuse)
//     // -------------------------------------------------
//     if (!oController.HandlingUnitDlg) {
//         Fragment.load({
//             id: oView.getId(),
//             name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.HandlingUnitDialog",
//             controller: oController
//         }).then(function (oDialog) {
//             oController.HandlingUnitDlg = oDialog;
//             oView.addDependent(oDialog);
//             oDialog.open();
//         });
//     } else {
//         oController.HandlingUnitDlg.open();
//     }
// },
handleHULinkPress: function (oEvent) {

    var oController = this;
    var oView = this.getView();
    var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");

    // -------------------------------------------------
    // 1ï¸âƒ£ Get clicked HU row
    // -------------------------------------------------
    var oHU = oEvent.getSource()
        .getBindingContext("eshipjetModel")
        .getObject();

    // -------------------------------------------------
    // 2ï¸âƒ£ SAME LOGIC AS FIRST APPLICATION
    // -------------------------------------------------
    if (!oHU.to_HandlingUnitItemDelivery || 
        !oHU.to_HandlingUnitItemDelivery.results || 
        !oHU.to_HandlingUnitItemDelivery.results.length) {

        // No items â†’ pass HU itself
        eshipjetModel.setProperty("/handlingUnitItems", [oHU]);

    } else {

        // Has items â†’ pass item list
        eshipjetModel.setProperty(
            "/handlingUnitItems",
            oHU.to_HandlingUnitItemDelivery.results
        );
    }

    eshipjetModel.updateBindings(true);

    // -------------------------------------------------
    // 3ï¸âƒ£ Open dialog (same reuse logic)
    // -------------------------------------------------
    if (!oController.HandlingUnitDlg) {
        Fragment.load({
            id: oView.getId(),
            name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.HandlingUnitDialog",
            controller: oController
        }).then(function (oDialog) {
            oController.HandlingUnitDlg = oDialog;
            oView.addDependent(oDialog);
            oDialog.open();
        });
    } else {
        oController.HandlingUnitDlg.open();
    }
},



onHandlingUnitDialogClosePress: function () {
    if (this.HandlingUnitDlg) {
        this.HandlingUnitDlg.close();
    }
},




        _handleDisplayShipNowConsolidationTable: function () {
            var that = this;
            const oView = oController.getView();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel"), columnName, label, oTemplate, oHboxControl;
            var ShipNowConsolidationTableData = eshipjetModel.getData().ShipNowConsolidationTableData;
            var ShipNowConsolidationTableDataModel = new JSONModel(ShipNowConsolidationTableData);
            this.getView().setModel(ShipNowConsolidationTableDataModel, "ShipNowConsolidationTableDataModel");
            const oTable = oView.byId("idShipNowConsolidationTable");
            oTable.setModel(ShipNowConsolidationTableDataModel);
            var ShipNowConsolidationTableDataModel = this.getView().getModel("ShipNowConsolidationTableDataModel");
            var ShipNowConsolidationColumns = ShipNowConsolidationTableDataModel.getData().ShipNowConsolidationColumns;
            var count = 0;
            for (var i = 0; i < ShipNowConsolidationColumns.length; i++) {
                if (ShipNowConsolidationColumns[i].visible === true) {
                    count += 1
                }
            }
            oTable.bindColumns("/ShipNowConsolidationColumns", function (sId, oContext) {
                columnName = oContext.getObject().key;
                label = oContext.getObject().label;
                var minWidth = "100%";
                if (count > 10) {
                    var minWidth = "120px";
                }


                if (columnName === "actions") {
                    var oHBox = new sap.m.HBox({}); // Create Text instance 
                    var Btn1 = new sap.m.Button({ text: "Edit", type: "Transparent" });
                    var Btn2 = new sap.m.Button({
                        icon: "sap-icon://megamenu", type: "Transparent",
                        press: function (oEvent) {
                            that.handleDownArrowPress(oEvent);
                        }
                    });
                    oHBox.addItem(Btn1);
                    oHBox.addItem(Btn2);
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: oHBox,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else if (columnName === "CreatedDate" || columnName === "ShipDate") {
                    var DateTxt = new sap.m.Text({
                        text: {
                            path: 'ShipNowConsolidationTableDataModel>ShipDate',
                            formatter: formatter.formatDate
                        },
                        wrapping: false
                    });
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                } else {
                    return new sap.ui.table.Column({
                        label: oResourceBundle.getText(columnName),
                        template: columnName,
                        visible: oContext.getObject().visible,
                        width: minWidth,
                        sortProperty: columnName
                    });
                }
            });
            oTable.bindRows("/ShipNowConsolidationRows");
        },

        openShipNowConsolidationColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pShipNowConsolidationPopover) {
                this._pShipNowConsolidationPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.ShipNowConsolidationTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
            this._pShipNowConsolidationPopover.then(function (oPopover) {
                oController.ShipNowConsolidationColumnsVisiblity();
                oPopover.openBy(oButton);
            });
        },

        ShipNowConsolidationColumnsVisiblity: function () {
            var oView = oController.getView();
            var oShipNowConsolidationTableModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = oShipNowConsolidationTableModel.getProperty("/ShipNowConsolidationTableData/ShipNowConsolidationColumns");
            var oShipNowConsolidationTable = oView.byId("myShipNowConsolidationColumnSelectId");
            var aTableItems = oShipNowConsolidationTable.getItems();

            aColumns.map(function (oColObj) {
                aTableItems.map(function (oItem) {
                    if (oColObj.key === oItem.getBindingContext("ShipNowConsolidationTableDataModel").getObject().key && oColObj.visible) {
                        oItem.setSelected(true);
                    }
                });
            });
        },
        onShipNowConsolidationColNameSearch: function (oEvent) {
            var aFilters = [];
            var sQuery = oEvent.getSource().getValue();
            if (sQuery && sQuery.length > 0) {
                var filter = new Filter("label", FilterOperator.Contains, sQuery);
                aFilters.push(filter);
            }
            // update list binding
            var oList = oController.getView().byId("myShipNowConsolidationColumnSelectId");
            var oBinding = oList.getBinding("items");
            oBinding.filter(aFilters, "Application");

        },

        onoShipNowConsolidationColSelectOkPress: function () {
            var oView = this.getView()
            var oShipNowConsolidationTable = oView.byId("myShipNowConsolidationColumnSelectId");
            var ShipNowConsolidationTableDataModel = oView.getModel("ShipNowConsolidationTableDataModel");
            var oShipNowConsolidationTblItems = oShipNowConsolidationTable.getItems();
            var aColumnsData = ShipNowConsolidationTableDataModel.getProperty("/ShipNowConsolidationColumns");
            oShipNowConsolidationTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("ShipNowConsolidationTableDataModel").getObject().key === oColObj.key) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            ShipNowConsolidationTableDataModel.updateBindings(true);
            this._handleDisplayShipNowConsolidationTable();
            this._pShipNowConsolidationPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onShipNowConsolidationColSelectClosePress: function () {
            this._pShipNowConsolidationPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        onConsolidationFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._ShipNowConsolidationPopover) {
                this._ShipNowConsolidationPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.ShipNowConsolidationFilterPopover",
                    controller: this
                }).then(function (ShipNowConsolidationPopover) {
                    oView.addDependent(ShipNowConsolidationPopover);
                    // ShipNowConsolidationPopover.bindElement("/ProductCollection/0");
                    return ShipNowConsolidationPopover;
                });
            }
            this._ShipNowConsolidationPopover.then(function (ShipNowConsolidationPopover) {
                ShipNowConsolidationPopover.openBy(oButton);
            });
        },
        onConsolidationFilterPopoverClosePress: function () {
            this.byId("idShipNowConsolidationFilterPopover").close();
        },
        onConsolidationFilterPopoverResetPress: function () {
            this.byId("idShipNowConsolidationFilterPopover").close();
        },
        onConsolidationFilterPopoverApplyPress: function () {
            this.byId("idShipNowConsolidationFilterPopover").close();
        },
        // add AddEUCountriesPopover popover changes start
        onAddEUCountriesPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddEUPopover) {
                this._AddEUPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddEUCountriesPopover",
                    controller: this
                }).then(function (oAddEUPopover) {
                    oView.addDependent(oAddEUPopover);
                    return oAddEUPopover;
                });
            }
            this._AddEUPopover.then(function (oAddEUPopover) {
                oAddEUPopover.openBy(oButton);
            });
        },
        AddEUCountriesClosePress: function () {
            this.byId("idAddEUCountriesPopover").close();
        },
        AddEUCountriesCancelPopover: function () {
            this.byId("idAddEUCountriesPopover").close();
        },
        AddEUCountriesSelectPopover: function () {
            this.byId("idAddEUCountriesPopover").close();
        },

        // add AddEUCountriesPopover popover changes start
        onAddCountriesPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddCountriesPopover) {
                this._AddCountriesPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddCountriesPopover",
                    controller: this
                }).then(function (oAddCountriesPopover) {
                    oView.addDependent(oAddCountriesPopover);
                    return oAddCountriesPopover;
                });
            }
            this._AddCountriesPopover.then(function (oAddCountriesPopover) {
                oAddCountriesPopover.openBy(oButton);
            });
        },
        AddCountriesClosePress: function () {
            this.byId("idAddCountriesPopover").close();
        },
        AddCountriesCancelPopover: function () {
            this.byId("idAddCountriesPopover").close();
        },

        AddCountriesSelectPopover: function () {
            this.byId("idAddCountriesPopover").close();
        },


        // add onAddERP popover changes start
        onAddERPPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddERPPopover) {
                this._AddERPPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddERPPopover",
                    controller: this
                }).then(function (oAddERPPopover) {
                    oView.addDependent(oAddERPPopover);
                    return oAddERPPopover;
                });
            }
            this._AddERPPopover.then(function (oAddERPPopover) {
                oAddERPPopover.openBy(oButton);
            });
        },
        AddERPClosePress: function () {
            this.byId("idAddERPPopover").close();
        },
        AddERPCancelPopover: function () {
            this.byId("idAddERPPopover").close();
        },

        AddERPSelectPopover: function () {
            this.byId("idAddERPPopover").close();
        },


        // add onAddAddPaymentTypes popover changes start
        onAddAddPaymentTypesPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddPayPopover) {
                this._AddPayPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddPaymentTypesPopover",
                    controller: this
                }).then(function (oAddPayPopover) {
                    oView.addDependent(oAddPayPopover);
                    return oAddPayPopover;
                });
            }
            this._AddPayPopover.then(function (oAddPayPopover) {
                oAddPayPopover.openBy(oButton);
            });
        },
        AddPaymentTypesClosePress: function () {
            this.byId("idAddPaymentTypesPopover").close();
        },
        AddPaymentTypesCancelPopover: function () {
            this.byId("idAddPaymentTypesPopover").close();
        },

        AddPaymentTypesSelectPopover: function () {
            this.byId("idAddPaymentTypesPopover").close();
        },


        // add onAddRolePress popover changes start
        onAddRolePress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddRolePopover) {
                this._AddRolePopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddRolePopover",
                    controller: this
                }).then(function (oAddRolePopover) {
                    oView.addDependent(oAddRolePopover);
                    return oAddRolePopover;
                });
            }
            this._AddRolePopover.then(function (oAddRolePopover) {
                oAddRolePopover.openBy(oButton);
            });
        },
        AddRoleClosePress: function () {
            this.byId("idAddRolePopover").close();
        },
        AddRoleCancelPopover: function () {
            this.byId("idAddRolePopover").close();
        },
        AddRoleSelectPopover: function () {
            this.byId("idAddRolePopover").close();
        },
        onCreateBatchShipPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._oCreateBatchShipPopover) {
                this._oCreateBatchShipPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.BatchShip.CreateBatch",
                    controller: this
                }).then(function (CreateBatchShipPopover) {
                    oView.addDependent(CreateBatchShipPopover);
                    // CreateBatchShipPopover.bindElement("/ProductCollection/0");
                    return CreateBatchShipPopover;
                });
            }
            this._oCreateBatchShipPopover.then(function (CreateBatchShipPopover) {
                CreateBatchShipPopover.openBy(oButton);
            });
        },
        onCreateBatchShipClosePress: function () {
            this.byId("idCreateBatchShipPopover").close();
        },
        onExcelUploadChange: function (oEvent) {
            var that = this;
            var oFileUploader = oEvent.getSource();
            var oFile = oEvent.getParameter("files")[0];
        
            if (oFile && window.FileReader) {
                var reader = new FileReader();
        
                reader.onload = function (e) {
                    var data = e.target.result;
                    var workbook = XLSX.read(data, {
                        type: 'binary'
                    });
        
                    // Assuming the first sheet
                    var sheetName = workbook.SheetNames[0];
                    var sheet = workbook.Sheets[sheetName];
        
                    // Convert to JSON
                    var jsonData = XLSX.utils.sheet_to_json(sheet, { defval: "" });
        
                    // Optional: log the parsed Excel data
                    console.log("Excel Data", jsonData);
        
                    // Set to eshipjetModel
                    var oModel = that.getView().getModel("eshipjetModel");
                    oModel.setProperty("/BatchShipItems", jsonData);
                };
        
                reader.readAsBinaryString(oFile);
            } else {
                sap.m.MessageToast.show("This browser does not support FileReader.");
            }
        },
        


        // add onAddProductPress popover changes start
        onAddProductPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddPrdPopover) {
                this._AddPrdPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddProductPopover",
                    controller: this
                }).then(function (oAddPrdPopover) {
                    oView.addDependent(oAddPrdPopover);
                    return oAddPrdPopover;
                });
            }
            this._AddPrdPopover.then(function (oAddPrdPopover) {
                oAddPrdPopover.openBy(oButton);
            });
        },
        AddProductClosePress: function () {
            this.byId("idAddProductPopover").close();
        },
        AddProductCancelPopover: function () {
            this.byId("idAddProductPopover").close();
        },
        AddProductSelectPopover: function () {
            this.byId("idAddProductPopover").close();
        },

        // add onAddAddPackageType popover changes start
        onAddAddPackageTypePress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddPackPopover) {
                this._AddPackPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddPackageTypePopover",
                    controller: this
                }).then(function (oAddPackPopover) {
                    oView.addDependent(oAddPackPopover);
                    return oAddPackPopover;
                });
            }
            this._AddPackPopover.then(function (oAddPackPopover) {
                oAddPackPopover.openBy(oButton);
            });
        },
        AddPackageTypeClosePress: function () {
            this.byId("idAddPackageTypePopover").close();
        },
        AddPackageTypeCancelPopover: function () {
            this.byId("idAddPackageTypePopover").close();
        },
        AddPackageTypeSelectPopover: function () {
            this.byId("idAddPackageTypePopover").close();
        },

        // add onAddAddPackageType popover changes start
        OnAddCostCenterPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddCostPopover) {
                this._AddCostPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddCostCenterPopover",
                    controller: this
                }).then(function (oAddCostPopover) {
                    oView.addDependent(oAddCostPopover);
                    return oAddCostPopover;
                });
            }
            this._AddCostPopover.then(function (oAddCostPopover) {
                oAddCostPopover.openBy(oButton);
            });
        },
        AddCostCenterClosePress: function () {
            this.byId("idAddCostCenterPopover").close();
        },
        AddCostCenterCancelPopover: function () {
            this.byId("idAddCostCenterPopover").close();
        },
        AddCostCenterSelectPopover: function () {
            this.byId("idAddCostCenterPopover").close();
        },


        // add onAddAddPackageType popover changes start
        OnAddCostCenterPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddCostPopover) {
                this._AddCostPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddCostCenterPopover",
                    controller: this
                }).then(function (oAddCostPopover) {
                    oView.addDependent(oAddCostPopover);
                    return oAddCostPopover;
                });
            }
            this._AddCostPopover.then(function (oAddCostPopover) {
                oAddCostPopover.openBy(oButton);
            });
        },
        AddCostCenterClosePress: function () {
            this.byId("idAddCostCenterPopover").close();
        },
        AddCostCenterCancelPopover: function () {
            this.byId("idAddCostCenterPopover").close();
        },
        AddCostCenterSelectPopover: function () {
            this.byId("idAddCostCenterPopover").close();
        },

        // add onAddAddPackageType popover changes start
        onAddStatusPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddStatusPopover) {
                this._AddStatusPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddStatusPopover",
                    controller: this
                }).then(function (oAddStatusPopover) {
                    oView.addDependent(oAddStatusPopover);
                    return oAddStatusPopover;
                });
            }
            this._AddStatusPopover.then(function (oAddStatusPopover) {
                oAddStatusPopover.openBy(oButton);
            });
        },
        AddStatusClosePress: function () {
            this.byId("idAddStatusPopover").close();
        },
        AddStatusCancelpress: function () {
            this.byId("idAddStatusPopover").close();
        },
        AddStatusSelectpress: function () {
            this.byId("idAddStatusPopover").close();
        },

        // add onAdd Third Party popover changes start
        onAddThirdPartyPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddThirdPopover) {
                this._AddThirdPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddThirdPartyPopover",
                    controller: this
                }).then(function (oAddThirdPopover) {
                    oView.addDependent(oAddThirdPopover);
                    return oAddThirdPopover;
                });
            }
            this._AddThirdPopover.then(function (oAddThirdPopover) {
                oAddThirdPopover.openBy(oButton);
            });
        },
        AddThirdPartyClosePress1: function () {
            this.byId("idAddThirdPartyPopover1").close();
        },
        AddThirdPartyCancelPress: function () {
            this.byId("idAddThirdPartyPopover1").close();
        },
        AddThirdPartySelectpress: function () {
            this.byId("idAddThirdPartyPopover1").close();
        },
        // add onAdd Third Party popover changes start
        onAddCarrierAddressPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddLTLPopover) {
                this._AddLTLPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddLTLClassPopover",
                    controller: this
                }).then(function (oAddLTLPopover) {
                    oView.addDependent(oAddLTLPopover);
                    return oAddLTLPopover;
                });
            }
            this._AddLTLPopover.then(function (oAddLTLPopover) {
                oAddLTLPopover.openBy(oButton);
            });
        },
        AddLTLClassClosePress: function () {
            this.byId("idAddLTLClassPopover1").close();
        },
        AddLTLClassCancelPress: function () {
            this.byId("idAddLTLClassPopover1").close();
        },
        AddLTLClassSelectpress: function () {
            this.byId("idAddLTLClassPopover1").close();
        },

        // add onAdd Third Party popover changes start
        onAddNMFCClassPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddNMFCPopover) {
                this._AddNMFCPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddNMFCClassPopover",
                    controller: this
                }).then(function (oAddNMFCPopover) {
                    oView.addDependent(oAddNMFCPopover);
                    return oAddNMFCPopover;
                });
            }
            this._AddNMFCPopover.then(function (oAddNMFCPopover) {
                oAddNMFCPopover.openBy(oButton);
            });
        },
        AddNMFCClassClosePress: function () {
            this.byId("idAddNMFCClassPopover").close();
        },
        AddNMFCClassCancelPress: function () {
            this.byId("idAddNMFCClassPopover").close();
        },
        AddNMFCClassSelectpress: function () {
            this.byId("idAddNMFCClassPopover").close();
        },

        // add onAdd Third Party popover changes start
        AddModeOfTransportPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddModeOfTransPopover) {
                this._AddModeOfTransPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddModeOfTransportPopover",
                    controller: this
                }).then(function (oAddModeOfTransPopover) {
                    oView.addDependent(oAddModeOfTransPopover);
                    return oAddModeOfTransPopover;
                });
            }
            this._AddModeOfTransPopover.then(function (oAddModeOfTransPopover) {
                oAddModeOfTransPopover.openBy(oButton);
            });
        },
        AddModeOfTransportClosePress: function () {
            this.byId("idAddModeOfTransportPopover").close();
        },
        AddModeOfTransportCancelPopover: function () {
            this.byId("idAddModeOfTransportPopover").close();
        },
        AddModeOfTransportSelectPopover: function () {
            this.byId("idAddModeOfTransportPopover").close();
        },


        // add on Add Order Type  popover changes start
        AddOrderTypePress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddModeOfTransPopover) {
                this._AddModeOfTransPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddOrderTypePopover",
                    controller: this
                }).then(function (oAddModeOfTransPopover) {
                    oView.addDependent(oAddModeOfTransPopover);
                    return oAddModeOfTransPopover;
                });
            }
            this._AddModeOfTransPopover.then(function (oAddModeOfTransPopover) {
                oAddModeOfTransPopover.openBy(oButton);
            });
        },
        AddOrderTypeClosePress: function () {
            this.byId("idAddOrderTypePopover").close();
        },
        AddOrderTypeCancelPopover: function () {
            this.byId("idAddOrderTypePopover").close();
        },
        AddOrderTypeSelectPopover: function () {
            this.byId("idAddOrderTypePopover").close();
        },

        // add on Add Order Type  popover changes start
        AddIncotermPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddAddIncotermPopover) {
                this._AddAddIncotermPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddIncotermPopover",
                    controller: this
                }).then(function (oAddAddIncotermPopover) {
                    oView.addDependent(oAddAddIncotermPopover);
                    return oAddAddIncotermPopover;
                });
            }
            this._AddAddIncotermPopover.then(function (oAddAddIncotermPopover) {
                oAddAddIncotermPopover.openBy(oButton);
            });
        },
        AddIncotermClosePress: function () {
            this.byId("idAddIncotermPopover").close();
        },
        AddIncotermCancelPopover: function () {
            this.byId("idAddIncotermPopover").close();
        },
        AddIncotermSelectPopover: function () {
            this.byId("idAddIncotermPopover").close();
        },

        // add on Add Dimensions popover changes start
        AddDimensionsPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddAddDimensionsPopover) {
                this._AddAddDimensionsPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddDimensionsPopover",
                    controller: this
                }).then(function (oAddAddDimensionsPopover) {
                    oView.addDependent(oAddAddDimensionsPopover);
                    return oAddAddDimensionsPopover;
                });
            }
            this._AddAddDimensionsPopover.then(function (oAddAddDimensionsPopover) {
                oAddAddDimensionsPopover.openBy(oButton);
            });
        },
        AddDimensionsClosePress: function () {
            this.byId("idAddDimensionsPopover").close();
        },
        AddDimensionsCancelPopover: function () {
            this.byId("idAddDimensionsPopover").close();
        },
        AddDimensionsSelectPopover: function () {
            this.byId("idAddDimensionsPopover").close();
        },

        // add on Add Dimensions popover changes start
        AddSMTPConfigPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddAddSMTPConfigPopover) {
                this._AddAddSMTPConfigPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddSMTPConfigPopover",
                    controller: this
                }).then(function (oAddAddSMTPConfigPopover) {
                    oView.addDependent(oAddAddSMTPConfigPopover);
                    return oAddAddSMTPConfigPopover;
                });
            }
            this._AddAddSMTPConfigPopover.then(function (oAddAddSMTPConfigPopover) {
                oAddAddSMTPConfigPopover.openBy(oButton);
            });
        },
        AddSMTPConfigClosePress: function () {
            this.byId("idAddSMTPConfigPopover").close();
        },
        AddSMTPConfigCancelPopover: function () {
            this.byId("idAddSMTPConfigPopover").close();
        },
        AddSMTPConfigSelectPopover: function () {
            this.byId("idAddSMTPConfigPopover").close();
        },

        AddCarrierDialog: function (oEvent) {
            var oView = this.getView();
            var oModel = this.getOwnerComponent().getModel("eshipjetModel");
            var sText = oEvent.getSource().mProperties.text;
            if(sText === "Add Carrier"){
                oModel.setProperty("/CarrierCatalogLocations", "");
                oModel.setProperty("/CarrierName", "");
                oModel.setProperty("/carrierId", "");
                oModel.setProperty("/erpCarrierId", "");
                oModel.setProperty("/CarrierType", "");
                oModel.setProperty("/CarrierCoverage", "");
                oModel.setProperty("/connectionType1", "");
                oModel.setProperty("/carrierAcntsLabelType", "");
                eshipjetModel.setProperty("/showCarrierCatalogSaveBtn", true);
                eshipjetModel.setProperty("/showCarrierCatalogUpdateBtn", false);
            }
            
            
            if (!this.byId("idAddCarrierDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddCarrierDialog",
                    controller: this // Pass the controller for binding
                }).then(function (oAddCarrierDialog) {
                    oView.addDependent(oAddCarrierDialog);
                    oAddCarrierDialog.open();
                });
            } else {
                this.byId("idAddCarrierDialog").open(); // Open existing dialog
            }
        },

        AddCarrierCancelDialog: function () {
            this.byId("idAddCarrierDialog").close();
        },

        AddCarrierUpdateDialog: function () {
            this.byId("idAddCarrierDialog").close();
        },

        onOpenColorPicker: function(oEvent) {
            var oButton = oEvent.getSource();
            if (!this.oColorPalettePopover) {
                this.oColorPalettePopover = new sap.m.ColorPalettePopover({
                    colors: [
                        "#FF0000", "#00FF00", "#0000FF", "#FFFF00", "#FF00FF", "#00FFFF"
                    ],
                    colorSelect: function(oEvent) {
                        var sColor = oEvent.getParameter("value");
                        this.byId("myVBox").getDomRef().style.backgroundColor = sColor;
                    }.bind(this)
                });
            }
            this.oColorPalettePopover.openBy(oButton);
        },        

        onAddCarrierDialogPlusPress: function () {
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            var addCrrierDialogItems = eshipjetModel.getData().addCrrierDialogItems;
            addCrrierDialogItems.push(
                {
                    "ServDesc": "",
                    "ErpServId": "",
                    "ServCode": "",
                    "ServiceCoverage": "",
                    "IsActive": false
                });
            eshipjetModel.updateBindings(true);
        },

        onAddCrrierDialogDeleteIconPress: function (oEvent) {
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            var addCrrierDialogItems = eshipjetModel.getData().addCrrierDialogItems;
            var aSplitPath = oEvent.getSource().getBindingContext("eshipjetModel").sPath.split("/");
            var sPath = aSplitPath[aSplitPath.length - 1];

            sap.m.MessageBox.warning("Are you sure you want to delete this record?", {
                actions: [sap.m.MessageBox.Action.OK, sap.m.MessageBox.Action.CANCEL],
                emphasizedAction: sap.m.MessageBox.Action.OK,
                onClose: function (sAction) {
                    if (sAction === "OK") {
                        addCrrierDialogItems.splice(parseInt(sPath), 1);
                        eshipjetModel.updateBindings(true);
                    }
                },
                dependentOn: this.getView()
            });
        },


        AddCarrierConfigurationDialogPress: function (oEvent) {
            var oView = this.getView();
            var sText = oEvent.getSource().mProperties.text;
            if(sText === "Add Carrier Account"){
                eshipjetModel.setProperty("/carrierAccountsLocationId", "");
                eshipjetModel.setProperty("/carrierAccountsCarrierName", "");
                eshipjetModel.setProperty("/carrierAccountsCarrierType", "");
                eshipjetModel.setProperty("/carrierAccountsShipFromCountryName", "");
                eshipjetModel.setProperty("/carrierAccountsShipToCountryName", "");
                eshipjetModel.setProperty("/carrierAccountsCostCentre", "");
                eshipjetModel.setProperty("/carrierAccountsEnvironment", "");
                eshipjetModel.setProperty("/carrierAccountsAccountNumber", "");
                eshipjetModel.setProperty("/carrierAccountsUserId", "");
                eshipjetModel.setProperty("/carrierAccountsPassword", "");
                eshipjetModel.setProperty("/carrierAccountsAccessKey", "");
                eshipjetModel.setProperty("/carrierAccountsMeterId", "");
                eshipjetModel.setProperty("/carrierAccountsHubId", "");
                eshipjetModel.setProperty("/carrierAccountsConnectionType", "");
                eshipjetModel.setProperty("/carrierAccountsTableItems", []);
                 eshipjetModel.setProperty("/showCarrierAccountSaveBtn", true);
                eshipjetModel.setProperty("/showCarrierAccountUpdateBtn", false);
            }

            if (!this.byId("idAddCarrierConfigurationDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddCarrierConfigurationDialog",
                    controller: this // Pass the controller for binding
                }).then(function (oAddCarrierConfigurationDialog) {
                    oView.addDependent(oAddCarrierConfigurationDialog);
                    oAddCarrierConfigurationDialog.open();
                });
            } else {
                this.byId("idAddCarrierConfigurationDialog").open(); // Open existing dialog
            }
        },
        AddCarrierConfigurationCancelDialog: function () {
            this.byId("idAddCarrierConfigurationDialog").close();
               this._clearCarrierConfigurationFields();
        },
        AddCarrierConfigurationCloseDialog: function () {
            this.byId("idAddCarrierConfigurationDialog").close();
        },

        OpenCompanySettingsDialog: function () {
            var oView = this.getView();
            if (!this.byId("_IDGenAlcoholEditDialogUpdateCompanySettings")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.UpdateCompanySettingsPopover",
                    controller: this // Pass the controller for binding
                }).then(function (oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("_IDGenAlcoholEditDialogUpdateCompanySettings").open(); // Open existing dialog
            }
        },
        onUpdateCompanySettingsCancelPress: function () {
            this.byId("_IDGenAlcoholEditDialogUpdateCompanySettings").close();
        },
        CompanySettingsSaveDialog: function () {
            this.byId("_IDGenAlcoholEditDialogUpdateCompanySettings").close();
        },
        CompanySettingsClosePress: function () {
            this.byId("_IDGenAlcoholEditDialogUpdateCompanySettings").close();
        },

        OpenResetPasswordDialog: function () {
            var oView = this.getView();
            if (!this.byId("ResetPasswordopenDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ResetPassword",
                    controller: this // Pass the controller for binding
                }).then(function (oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("ResetPasswordopenDialog").open(); // Open existing dialog
            }
        },
        ResetPasswordCancelDialog: function () {
            this.byId("ResetPasswordopenDialog").close();
        },
        ResetPasswordSaveDialog: function () {
            this.byId("ResetPasswordopenDialog").close();
        },
        ResetPasswordClosePress: function () {
            this.byId("ResetPasswordopenDialog").close();
        },

        OpenUnlockDeliveryNumberDialog: function () {
            var oView = this.getView();
            if (!this.byId("UnlockDeliveryNumberopenDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.UnlockDeliveryNumber",
                    controller: this // Pass the controller for binding
                }).then(function (oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                });
            } else {
                this.byId("UnlockDeliveryNumberopenDialog").open(); // Open existing dialog
            }
        },
        UnlockDeliveryNumberCancelDialog: function () {
            this.byId("UnlockDeliveryNumberopenDialog").close();
        },
        UnlockDeliveryNumberSaveDialog: function () {
            this.byId("UnlockDeliveryNumberopenDialog").close();
        },
        UnlockDeliveryNumberClosePress: function () {
            this.byId("UnlockDeliveryNumberopenDialog").close();
        },


        // Freight Quote Changes Starts Here

        onGetFreightQuotesPress: function () {
            var ShipNowDataModel = oController.getView().getModel("ShipNowDataModel");
            var ShipFromAddress = ShipNowDataModel.getProperty("/ShipFromAddress");
            var ShipToAddress = ShipNowDataModel.getProperty("/ShipToAddress");
            var oTableLength = oController.byId("idCreateShipReqTable").getBinding("rows").getLength();
        
            if (ShipToAddress.FullName === "" || ShipToAddress.FullName === undefined) {
                MessageBox.warning("Contact Name is required.");
            } else if (ShipToAddress.FullName !== "" && oTableLength === 0) {
                MessageBox.warning("At least one row must have all required fields (Product Code, Product Description, Quantity, Unit Weight)." );
            } else {
                var oView = oController.getView();
                if (!oController.byId("idFreightQuotesDialog")) {
                    Fragment.load({
                        id: oView.getId(),
                        name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipReqLabel.GetFreightQuotesDialog",
                        controller: oController // Pass the controller for binding
                    }).then(function (oDialog) {
                        oView.addDependent(oDialog);
                        oDialog.open();
                    });
                } else {
                    oController.byId("idFreightQuotesDialog").open(); // Open existing dialog
                }
        
                // API Call to Fetch Data
                var sPath = "https://dev-api-v1.eshipjet.site/LocationMaster/defaultdata ";
                oController.onOpenBusyDialog();
                
                $.ajax({
                    url: sPath,
                    method: "GET",
                    dataType: "json",
                    success: function (oData) {
                        oController.oBusyDialog.close();
                        console.log("API Response:", oData);
                        
                        // Set the API response to the model
                        var oModel = oController.getView().getModel("eshipjetModel");
                        oModel.setProperty("/freightQuoteSubmition", oData);
                    },
                    error: function (error) {
                        console.log("Error:", error);
                        oController.oBusyDialog.close();
                    }
                });
            }
        },

        FreightQuoteUpdatedSrvData:function(){
            var ShipperDataUpdateSrvModel = oController.getOwnerComponent().getModel("ShipperDataUpdateSrvModel");
            var oEshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aPackages = oEshipjetModel.getProperty("/ShipNowPostResponse/Packages");
            var oPayload = {
                "Delivery": oEshipjetModel.getProperty("/commonValues/sapDeliveryNumber") ? oEshipjetModel.getProperty("/commonValues/sapDeliveryNumber") : "",
                "Carrier": oEshipjetModel.getProperty("/shipRateSelectItem/Carrier") ?  oEshipjetModel.getProperty("/shipRateSelectItem/Carrier") : "",
                "SerName": oEshipjetModel.getProperty("/shipRateSelectItem/serviceName") ? oEshipjetModel.getProperty("/shipRateSelectItem/serviceName") : "",
                "TotPack": oEshipjetModel.getProperty("/ShipNowPostResponse/Packages") ? oEshipjetModel.getProperty("/ShipNowPostResponse/Packages").length.toString() : "",
                "Currency": oEshipjetModel.getProperty("/shipRateSelectItem/currency") ? oEshipjetModel.getProperty("/shipRateSelectItem/currency") : "",
                "PubFrt": oEshipjetModel.getProperty("/shipRateSelectItem/publishedFreight") ? oEshipjetModel.getProperty("/shipRateSelectItem/publishedFreight").toString() : "",
                "DiscFrt": oEshipjetModel.getProperty("/shipRateSelectItem/discountFreight_Cal") ? oEshipjetModel.getProperty("/shipRateSelectItem/discountFreight_Cal").toString() : "",
                "ItemSet": []               
              };
             
              var aItemInfo  = oEshipjetModel.getProperty("/ShipNowPostResponse/Packages/ItemsInfo");
              var aPayloadPackages = [], packObj = {}, sIdx = 0;
              if(aPackages && aPackages.length > 0){
                aPackages.forEach(function(currObj){
                    sIdx =   sIdx + 10;
                    packObj ={
                        "Delivery": oEshipjetModel.getProperty("/commonValues/sapDeliveryNumber"),
                        "DelItem": sIdx.toString(),
                        "HandUnit": currObj.HU.toString(),
                        "Weight": currObj.Weight,
                        "WeightUnit": currObj.Weightunits,
                        "Dimension": currObj.Dimension,
                        "Tracking": currObj.TrackingNumber
                    };
                    aPayloadPackages.push(packObj);    
                    packObj = {};                                          
                });
                oPayload.ItemSet = aPayloadPackages;
              }
              
              ShipperDataUpdateSrvModel.create("/HeaderSet", oPayload, {
                success: function(oResponse) {
                    var aShippingCharges = [
                        { "description": "Freight Amount", "amount": parseInt(oResponse.PubFrt).toFixed(2), "currency": "USD" },
                        { "description": "Discount Amount", "amount": parseInt(oResponse.DiscFrt).toFixed(2), "currency": "USD" },
                        { "description": "Fuel", "amount": "", "currency": "USD" }
                    ];
                    eshipjetModel.setProperty("/shippingCharges", aShippingCharges);
                    sap.m.MessageToast.show("FreightQuote Updated successful!");
                    oController.updateManifestHeaderSet();
                },
                error: function(oError) {
                    // var errMsg = JSON.parse(oError.responseText).error.message.value
                    // sap.m.MessageBox.error(errMsg);
                }
            });
        },
        onFreightQuoteClosePress:function() {
            oController.byId("idFreightQuotesDialog").close();
        },
        // Freight Quote Changes End Here

        // add on Add Order Type  popover changes start
        AddTrackingRangePress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._AddAddTrackingRangeopover) {
                this._AddAddTrackingRangePopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddTrackingRangePopover",
                    controller: this
                }).then(function (oAddAddTrackingRangePopover) {
                    oView.addDependent(oAddAddTrackingRangePopover);
                    return oAddAddTrackingRangePopover;
                });
            }
            this._AddAddTrackingRangePopover.then(function (oAddAddTrackingRangePopover) {
                oAddAddTrackingRangePopover.openBy(oButton);
            });
        },
        AddTrackingRangeClosePress: function () {
            this.byId("idAddTrackingRangePopover").close();
        },
        AddTrackingRangeCancelPopover: function () {
            this.byId("idAddTrackingRangePopover").close();
        },
        AddTrackingRangeSelectPopover: function () {
            this.byId("idAddTrackingRangePopover").close();
        },

        onPressAddProduct: function (oEvent) {
            oController.onOpenBusyDialog();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var sPath = oEvent.getSource().sId.split("--");
            var addPrctBtnId = sPath[sPath.length-1];
            eshipjetModel.setProperty("/addPrctBtnId", addPrctBtnId);
            var oDeliveryModel = oController.getView().getModel("OutBoundDeliveryModel");
            var promise = new Promise(function (resolved, rejected) {
                oDeliveryModel.read("/A_OutbDeliveryItem",{
                    success:function(oData){
                        if(oData && oData.results && oData.results.length > 0){
                            var aProductTable = [];
                            for(var i = 0; i < oData.results.length; i++){
                                oData.results[i]["SerialNumber"] = i+1;
                                aProductTable.push(oData.results[i]);
                            };
                            eshipjetModel.setProperty("/pickAddProductTable",aProductTable);
                        }
                        resolved(oData);
                    },
                    error:function(error){
                        rejected(error);
                    }
                })
            });

            promise.then(function (data) {
                oController.onOpenProductsDialog();
                oController.onCloseBusyDialog();
            }).catch(function(oError){
                oController.onCloseBusyDialog();
            });
        },

        onOpenProductsDialog:function(){
            var oView = this.getView();
            if (!this.byId("idAddProductDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipReqLabel.AddProductsDialog",
                    controller: this // Pass the controller for binding
                }).then(function (oAddProductDialog) {
                    oView.addDependent(oAddProductDialog);
                    oAddProductDialog.open();
                });
            } else {
                this.byId("idAddProductDialog").open(); // Open existing dialog
            }
        },

        AddProductCancelDialog: function () {
            this.byId("idAddProductDialog").close();
        },

        onTrackingNumberPress: function (oEvent) {
            var oView = this.getView();
            var oCurrentObject = oEvent.getSource().getBindingContext("eshipjetModel").getObject();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            oCurrentObject["StandardTransit"]= "01/31/25 before 2:39 PM";
            oCurrentObject["Delivered"] = "01/31/25 at 2:39 PM";
            oCurrentObject["SignedBy"] = "Stephen";
            oCurrentObject["ServiceName"] =  eshipjetModel.getProperty("/carrierServiceName_dis");
            eshipjetModel.setProperty("/TrackingNumberTableRows",oCurrentObject);
            var sUrl;
            //Hardcoding values
            var aTravelHistoryData = eshipjetModel.getProperty("/ShipmentTravelHistoryRows");
            if(oCurrentObject.CarrierCode.toUpperCase() === "FEDEX"){
                sUrl = "https://drivemedical.eshipjet.site/next-gen-tracking?Carrier=Fedex&TrackingNumber="+oCurrentObject.TrackingNumber;
                aTravelHistoryData.forEach(function(item, idx){
                    item.Status = item.Status.replace("UPS", oCurrentObject.CarrierCode);
                });   
                // oController.TrackDialogWithUrl();
                oController.TrackDialogWithOutUrl();          
            }else if(oCurrentObject.CarrierCode.toUpperCase() === "UPS"){
                sUrl = "https://drivemedical.eshipjet.site/next-gen-tracking?Carrier=UPS&TrackingNumber="+oCurrentObject.TrackingNumber;
                aTravelHistoryData.forEach(function(item, idx){
                    item.Status = item.Status.replace("FedEx", oCurrentObject.CarrierCode);
                });
                // oController.TrackDialogWithUrl();
                oController.TrackDialogWithOutUrl();
            }else{
                oController.TrackDialogWithOutUrl();
            };
            eshipjetModel.setProperty("/ShipmentTravelHistoryRows", aTravelHistoryData);
            eshipjetModel.setProperty("TrackingdisplayUrl", sUrl);
        },

        TrackDialogWithUrl:function(){
            var oView = this.getView();
            if (!this.byId("idTrackingNumberDialog1")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipReqLabel.TrackingNumberDialog1",
                    controller: this // Pass the controller for binding
                }).then(function (oTrackingNumberDialog) {
                    oView.addDependent(oTrackingNumberDialog);
                    oTrackingNumberDialog.open();
                });
            } else {
                this.byId("idTrackingNumberDialog1").open(); // Open existing dialog
            }
        },

        TrackingNumberCancelDialog: function () {
            this.byId("idTrackingNumberDialog1").close();
        },

        TrackDialogWithOutUrl:function(){
            var oView = this.getView();
            if (!this.byId("idTrackingNumberDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipReqLabel.TrackingNumberDialog",
                    controller: this // Pass the controller for binding
                }).then(function (oTrackingNumberDialog) {
                    oView.addDependent(oTrackingNumberDialog);
                    oTrackingNumberDialog.open();
                });
            } else {
                this.byId("idTrackingNumberDialog").open(); // Open existing dialog
            }
        },

        TrackingNumberWithOutUrlCancelDialog: function () {
            this.byId("idTrackingNumberDialog").close();
        },

        onShipMethodUpdate: function () {
            var oView = this.getView();
            if (!this.byId("idShipMethodDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.FreightQuoteOrders.ShipMethodPlusDialog",
                    controller: this // Pass the controller for binding
                }).then(function (oShipMethodDialog) {
                    oView.addDependent(oShipMethodDialog);
                    oShipMethodDialog.open();
                });
            } else {
                this.byId("idShipMethodDialog").open(); // Open existing dialog
            }
        },
        ShipMethodCancelDialog: function () {
            this.byId("idShipMethodDialog").close();
        },
        onCloseDialog: function () {
            this.byId("idShipMethodDialog").close();
        },

        onShipmentWorkflowPress: function () {
            var oView = this.getView();
            if (!this.byId("idShipmentWorkflowDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipReqLabel.ShipmentWorkflowPlusDialog",
                    controller: this // Pass the controller for binding
                }).then(function (oShipmentWorkflowDialog) {
                    oView.addDependent(oShipmentWorkflowDialog);
                    oShipmentWorkflowDialog.open();
                });
            } else {
                this.byId("idShipmentWorkflowDialog").open(); // Open existing dialog
            }
        },
        ShipmentWorkflowCancelDialog: function () {
            this.byId("idShipmentWorkflowDialog").close();
        },
        onCloseDialog: function () {
            this.byId("idShipmentWorkflowDialog").close();
        },
        saveSelectPopover: function () {
            this.byId("idShipmentWorkflowDialog").close();
        },


        handleAddProductRowPress:function(oEvent){
            var oSelectedObj = oEvent.getSource().getBindingContext("eshipjetModel").getObject();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var addPrctBtnId = eshipjetModel.getProperty("/addPrctBtnId");
            if(addPrctBtnId === "idShipNowAddProduct"){
                var packAddProductTable = eshipjetModel.getProperty("/commonValues/packAddProductTable");
                oSelectedObj["SerialNo"] = packAddProductTable.length+1;
                packAddProductTable.push(oSelectedObj);
                eshipjetModel.updateBindings(true);
                // for(var i=0; i<packAddProductTable.length; i++){
                //     packAddProductTable[i]["SerialNo"] = i+1;
                // };
            }else if(addPrctBtnId === "idShipReqAddProduct"){
                var ShipReqTableDataModel = this.getView().getModel("ShipReqTableDataModel");
                var CreateShipReqRowsData = ShipReqTableDataModel.getData().CreateShipReqRows;
                CreateShipReqRowsData.push(oSelectedObj);
                ShipReqTableDataModel.updateBindings(true);
                for(var i=0; i<CreateShipReqRowsData.length; i++){
                    CreateShipReqRowsData[i]["#"] = i+1;
                    ShipReqTableDataModel.updateBindings(true);
                }
                oController._handleDisplayCreateShipReqTable();
            }
            var oTable = oController.getView().byId("idAddProductsDialog");
            oTable.removeSelections();
            this.byId("idAddProductDialog").close();
        },

        
         // add Ship Req onSearchPickAnAddressPopover changes start
         onSearch: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            var ShipNowDataModel = this.getView().getModel("ShipNowDataModel");
            var sPath = oEvent.getSource().getId().split("--");
            var btnId = sPath[sPath.length - 1];
            ShipNowDataModel.setProperty("/shipNowBtnId", btnId);
            if (!this._onSearchPopover) {
                this._onSearchPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.ShipNowPickAnAddressPopover",
                    controller: this
                }).then(function (oonSearchPopover) {
                    oView.addDependent(oonSearchPopover);
                    return oonSearchPopover;
                });
            }
            this._onSearchPopover.then(function (oonSearchPopover) {
                oonSearchPopover.openBy(oButton);
            });
        },
        onShipNowPickAnAddressCancelPress: function () {
            this.byId("idShipNowPickAnAddressPopover").close();
        },

        onMoreActionsPress:function(oEvent){
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._moreActionsPopover) {
                this._moreActionsPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.MoreActions",
                    controller: this
                }).then(function (oMoreActionsPopover) {
                    oView.addDependent(oMoreActionsPopover);
                    return oMoreActionsPopover;
                });
            }
            this._moreActionsPopover.then(function (oMoreActionsPopover) {
                oMoreActionsPopover.openBy(oButton);
            });
        },

        onMoreActionItemPress:function(oEvent){
            var oSelectedPGI = oEvent.getParameter("listItem").getBindingContext().getProperty("moreActionItem");
            var sapDeliveryNumber = eshipjetModel.getProperty("/commonValues/sapDeliveryNumber");
            if(sapDeliveryNumber === "" || sapDeliveryNumber === undefined){
                MessageBox.warning("Please enter valid document number.");
            }else if(oSelectedPGI === "Post Goods Issue"){
                oController.onOpenBusyDialog();
                oController.createPostGoodsIssue(sapDeliveryNumber);
            }else if(oSelectedPGI === "Reverse PGI"){
                oController.onOpenBusyDialog();
                oController.createReversePostGoodsIssue(sapDeliveryNumber);
            }
            var oMoreActionsPopover = this.byId("idMoreActionsPopover");
            if (oMoreActionsPopover) {
                oMoreActionsPopover.close();
            }
        },

            // ===============================================
            //  MAIN FUNCTION TO TRIGGER PGI
            // ===============================================
        //     onPostGoodsIssue: function (sDeliveryNo) {
        //         var oController = this;
        //         if (!sDeliveryNo || sDeliveryNo.length < 7) {
        //             sap.m.MessageBox.error("Invalid Delivery Number");
        //             return;
        //         }
        //         oController.onOpenBusyDialog();

        //         // STEP 1 : GET CSRF + ETAG
        //         oController._fetchCSRFandETAG(sDeliveryNo)
        //             .then(function (security) {

        //                 // STEP 2 : CALL PGI API
        //                 return oController._callPGIAPI(sDeliveryNo, security.token, security.etag);

        //             })
        //             .then(function () {

        //                 // STEP 3 : REFRESH DELIVERY STATUS AFTER PGI
        //                 return oController.getShippingDataAfterPGI(sDeliveryNo);

        //             })
        //             .then(function () {

        //                 oController.onCloseBusyDialog();
        //                 sap.m.MessageToast.show("PGI Successful");

        //             })
        //             .catch(function (err) {

        //                 oController.onCloseBusyDialog();
        //                 sap.m.MessageBox.error("PGI Failed: " + JSON.stringify(err));
        //             });
        //     },



        //     // ===============================================================
        //     //  STEP 1 â€” Fetch X-CSRF Token + ETag from /A_OutbDeliveryHeader()
        //     // ===============================================================
        //     _fetchCSRFandETAG: function (sDeliveryNo) {
        //         return new Promise(function (resolve, reject) {

        //             $.ajax({
        //                 url: "/sap/opu/odata/sap/API_OUTBOUND_DELIVERY_SRV;v=0002/A_OutbDeliveryHeader('" +
        //                     sDeliveryNo + "')",
        //                 method: "GET",
        //                 headers: {
        //                     "X-CSRF-Token": "Fetch",
        //                     "Accept": "application/json"
        //                 },
        //                 success: function (data, textStatus, jqXHR) {

        //                     var token = jqXHR.getResponseHeader("X-CSRF-Token");
        //                     var etag = jqXHR.getResponseHeader("ETag");

        //                     if (!token || !etag) {
        //                         reject("Failed to fetch CSRF Token or ETag");
        //                         return;
        //                     }

        //                     resolve({
        //                         token: token,
        //                         etag: etag
        //                     });
        //                 },
        //                 error: function (err) {
        //                     reject(err);
        //                 }
        //             });

        //         });
        //     },



        // // ===============================================================
        // //  STEP 2 â€” POST PGI Function Import
        // // ===============================================================
        // _callPGIAPI: function (sDeliveryNo, token, etag) {

        //     return new Promise(function (resolve, reject) {

        //         $.ajax({
        //             url: "/sap/opu/odata/sap/API_OUTBOUND_DELIVERY_SRV;v=0002/PostGoodsIssue?DeliveryDocument='" +
        //                 sDeliveryNo + "'",
        //             method: "POST",
        //             headers: {
        //                 "X-CSRF-Token": token,
        //                 "If-Match": etag,
        //                 "Accept": "application/json"
        //             },
        //             success: function (response) {
        //                 resolve(response);
        //             },
        //             error: function (err) {
        //                 reject(err);
        //             }
        //         });

        //     });
        // },



        // // ===============================================================
        // //  STEP 3 â€” READ DELIVERY AFTER PGI AND UPDATE UI STATUS
        // // ===============================================================
        // getShippingDataAfterPGI: function (sDeliveryNo) {
        //     var oController = this;
        //     var oDeliveryModel = oController.getView().getModel("OutBoundDeliveryModel");
        //     var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");

        //     return new Promise(function (resolve, reject) {

        //         var path = "/A_OutbDeliveryHeader('" + sDeliveryNo + "')";

        //         oDeliveryModel.read(path, {
        //             urlParameters: {
        //                 "$expand": "to_DeliveryDocumentItem,to_DeliveryDocumentPartner"
        //             },

        //             success: function (oData) {

        //                 // Save ETag for next PGI/Update
        //                 oController.etag = oData.__metadata.etag;

        //                 // Save Shipping Type
        //                 oController.ShippingType = oData.ShippingType;

        //                 // â­ UPDATE PGI STATUS IN MODEL
        //                 eshipjetModel.setProperty(
        //                     "/commonValues/OverallGoodsMovementStatus",
        //                     oData.OverallGoodsMovementStatus
        //                 );

        //                 resolve();
        //             },

        //             error: function (oErr) {
        //                 reject(oErr);
        //             }
        //         });
        //     });
        // },


        onPostGoodsIssuePress: function (sDeliveryNo) {
    var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
    var GetDeliveryData = eshipjetModel.getProperty("/GetDeliveryData");

    if (GetDeliveryData && GetDeliveryData.Warehouse) {
        // WITH EWM
        this.onPostGoodsIssueWithEWM(sDeliveryNo);
    } else {
        // WITHOUT EWM
        this.onPostGoodsIssueWithoutEWM(sDeliveryNo);
    }
},

        onPostGoodsIssueWithEWM: function (sDeliveryNo) {
            var oController = this;

            if (!sDeliveryNo) {
                sap.m.MessageBox.error("Invalid Delivery Number");
                return;
            }

            oController.onOpenBusyDialog();

            var CreateHUSrvModel = oController.getOwnerComponent().getModel("CreateHUSrvModel");

            var oPayload = {
                Delivery: sDeliveryNo
            };

            CreateHUSrvModel.create("/PGICREATESet", oPayload, {
                success: function (oData) {
                    var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");

                    eshipjetModel.setProperty("/PGIStatus", oData.Msgtyp);
                    eshipjetModel.setProperty("/PGIMessage", oData.Message1);
                    oController._logPGIResult( oData.Msgtyp,  oData.Message1);

                    oController.onManifestCreatePress();   // PGI Success â†’ Update Manifest

                    oController.onCloseBusyDialog();
                    sap.m.MessageToast.show("PGI Successful (EWM)");
                },
                error: function (oError) {
                    oController.onCloseBusyDialog();

                    var errMsg = jQuery.parseXML(oError.responseText).getElementsByTagName("message")[0].textContent;

                    oController._logPGIResult("F", errMsg);
                    oController.onManifestCreatePress();   // PGI Success â†’ Update Manifest
                    sap.m.MessageBox.error(errMsg);
                }
            });
        },


        checkPostGoodsIssueStatus:function(sDeliveryNo){
            var CreateHUSrvModel = oController.getOwnerComponent().getModel("CreateHUSrvModel");
            var aFilters = [];
            aFilters.push(new Filter("Delivery", "EQ", sDeliveryNo));
            CreateHUSrvModel.read("/PGICREATESet", {
                filters: aFilters,
                success: function (oData) {
                    // oController.getShippingDataAfterPGI(sapDeliveryNumber);
                    eshipjetModel.setProperty("/commonValues/OverallGoodsMovementStatus", oData.results[0].Msgtyp);
                    oController.onCloseBusyDialog();
                },
                error: function (oError) {
                    oController.onCloseBusyDialog();
                    var errMsg = JSON.parse(oError.responseText).error.message.value;
                    sap.m.MessageBox.error(errMsg);
                }
            });
        },


         getShippingDataAfterPGI:function(sDeliveryNo){
            var oDeliveryModel = oController.getView().getModel("OutBoundDeliveryModel");                    
            var oHandlingUnitModel = oController.getView().getModel("HandlingUnitModel");           
            var sPath = "/A_OutbDeliveryHeader('"+ sDeliveryNo +"')/to_DeliveryDocumentPartner";
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            if(sDeliveryNo && sDeliveryNo.length >= 7){
                oController.onOpenBusyDialog();
                
                var path = "/A_OutbDeliveryHeader('"+ sDeliveryNo +"')"
                oDeliveryModel.read(path,{
                    urlParameters: {
                        "$expand": "to_DeliveryDocumentItem,to_DeliveryDocumentPartner"
                    },
                    success:function(oData){                        
                        oController.etag = oData.__metadata.etag;
                        oController.ShippingType = oData.ShippingType;
                        eshipjetModel.setProperty("/commonValues/OverallGoodsMovementStatus", oData.OverallGoodsMovementStatus);
                        oController.onCloseBusyDialog();
                    },
                    error: function(oErr){
                        oController.onCloseBusyDialog();
                    }
                });
            }
        },


    onPostGoodsIssueWithoutEWM: function (sDeliveryNo) {
        var oController = this;
        var oModel = oController.getView().getModel("OutBoundDeliveryModel");

        if (!sDeliveryNo || sDeliveryNo.length < 7) {
            sap.m.MessageBox.error("Invalid Delivery Number");
            return;
        }
        oController.onOpenBusyDialog();

        // STEP 1: Read ETag from Delivery Header
        var sPath = "/A_OutbDeliveryHeader('" + sDeliveryNo + "')";

        oModel.refreshSecurityToken();

        oModel.read(sPath, {
            headers: {
                "X-Csrf-Token": "Fetch"
            },
            success: function (oData, response) {
                var token = response.headers["X-Csrf-Token"];
                var etag = oData.__metadata.etag;

                // STEP 2: Trigger PGI
                oController._triggerPGIWithOData(sDeliveryNo, token, etag)

                    .then(function () {

                        // LOG SUCCESS
                        return oController._logPGIResult("S", "PGI Successful for Delivery " + sDeliveryNo);
                        
                    }).then(function () {

                        // REFRESH DELIVERY STATUS
                        return oController.getShippingDataAfterPGI(sDeliveryNo);

                    }).then(function () {
                    // ADD THIS
                     eshipjetModel.setProperty("/PGIStatus", "S");  // <-- NEW
                        oController.onManifestCreatePress();   // PGI Success â†’ Update Manifest
                        oController.onCloseBusyDialog();
                        sap.m.MessageToast.show("PGI Successful");

                    }).catch(function (oError) {

                        oController.onCloseBusyDialog();

                        var sMessage = "Something went wrong";

                        if (oError && oError.responseText) {
                            try {
                                var oResponse = JSON.parse(oError.responseText);
                                sMessage = oResponse?.error?.message?.value || sMessage;
                            } catch (e) {}
                        }

                        // STORE ERROR MESSAGE
                        var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
                        eshipjetModel.setProperty("/commonValues/PGIErrorMessage", sMessage);

                        // LOG FAILURE
                        oController._logPGIResult("F", sMessage);
                        eshipjetModel.setProperty("/PGIStatus", "F");  // <-- NEW

                        // ADD THIS
                        oController.onManifestCreatePress();   // PGI Failed â†’ Update Manifest

                        // OPEN ERROR DIALOG
                        // oController.OpenErrorLogDialog();
                    });
            },
            error: function () {
                oController.onCloseBusyDialog();
                sap.m.MessageBox.error("Failed to read delivery header");
            }
        });
    },



/* ============================================================
   TRIGGER PGI FUNCTION IMPORT
   ============================================================ */
_triggerPGIWithOData: function (sDeliveryNo, token, etag) {
    var oModel = this.getView().getModel("OutBoundDeliveryModel");

    return new Promise(function (resolve, reject) {

        oModel.callFunction("/PostGoodsIssue", {
            method: "POST",
            urlParameters: {
                "DeliveryDocument": sDeliveryNo
            },
            headers: {
                "If-Match": etag,
                "X-Csrf-Token": token
            },
            success: resolve,
            error: reject
        });
    });
},


/* ============================================================
   REFRESH DELIVERY STATUS
   ============================================================ */
getShippingDataAfterPGI: function (sDeliveryNo) {
    var oController = this;
    var oModel = this.getView().getModel("OutBoundDeliveryModel");
    var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");

    return new Promise(function (resolve, reject) {

        var path = "/A_OutbDeliveryHeader('" + sDeliveryNo + "')";

        oModel.read(path, {
            urlParameters: {
                "$expand": "to_DeliveryDocumentItem,to_DeliveryDocumentPartner"
            },
            success: function (oData) {
                eshipjetModel.setProperty(
                    "/commonValues/OverallGoodsMovementStatus",
                    oData.OverallGoodsMovementStatus
                );
                resolve();
            },
            error: reject
        });
    });
},


/* ============================================================
   PGI ERROR POPUP
   ============================================================ */
OpenErrorLogDialog: function () {
    var oView = this.getView();
    var oController = this;

    if (!this._pPGIErrorDialog) {
        this._pPGIErrorDialog = Fragment.load({
            id: oView.getId(),
            name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.PGIErrorLogDialog",
            controller: oController
        }).then(function (oDialog) {
            oView.addDependent(oDialog);

            // Bind dialog to eshipjetModel
            oDialog.setModel(oController.getOwnerComponent().getModel("eshipjetModel"));

            return oDialog;
        });
    }

    this._pPGIErrorDialog.then(function (oDialog) {
        oDialog.open();
    });

    
},
onClosePGIErrorDialog: function () {
    var that = this;

    if (this._pPGIErrorDialog) {
        this._pPGIErrorDialog.then(function (oDialog) {
            oDialog.close();
        });
    }
},



// onPrintPGIError: function () {
//     var text = this.byId("pgiErrorText").getText();
//     var win = window.open('', '', 'height=600,width=800');
//     win.document.write('<html><head><title>PGI Error Details</title></head><body>');
//     win.document.write('<pre>' + text + '</pre>');
//     win.document.write('</body></html>');
//     win.print();
//     win.close();
// },


/* ============================================================
   MF_LOGS_SRV â†’ LOG PGI SUCCESS / FAILURE
   ============================================================ */
_logPGIResult: function (type, message) {
    var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
    var oManifestModel = oController.getOwnerComponent().getModel("ManifestModel");
    var oModel = this.getOwnerComponent().getModel("MF_LOGS_SRV");

    var GU_ID = crypto.randomUUID();
    eshipjetModel.setProperty("/GU_ID", GU_ID);

     // Save type S/F into model if needed elsewhere
    eshipjetModel.setProperty("/pgisetFS", type);

    var payload = {
        GuId: GU_ID,
        MessageType: type,        // 'S' or 'F'
        MessageText: message,
        CreatedOn: new Date().toISOString()
    };

    return new Promise(function (resolve, reject) {
        oModel.create("/MFLogsSet", payload, {
            success: function (data) {
                console.log("PGI Log Saved:", data);
                resolve(data);
            },
            error: function (err) {
                console.error("PGI Log Failed:", err);
                reject(err);
            }
        });
    });
},


// /* ============================================================
//    GUID GENERATOR
//    ============================================================ */
// _generateGuid: function () {
//     return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
//         var r = Math.random() * 16 | 0;
//         var v = c === 'x' ? r : (r & 0x3 | 0x8);
//         return v.toString(16);
//     });
// },

// readPGIErrorLog: function () {
//     var oController = this;
//     var oModel = this.getOwnerComponent().getModel("MF_LOGS_SRV");
//     var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");

//     var guid = eshipjetModel.getProperty("/manifestGUID");

//     if (!guid) {
//         sap.m.MessageBox.error("No PGI error log GUID found.");
//         return;
//     }

//     return new Promise(function (resolve, reject) {

//         // Filter: Only logs for this deliveryâ€™s GUID and only FAILED (F)
//         var aFilters = [
//             new sap.ui.model.Filter("GuId", sap.ui.model.FilterOperator.EQ, guid),
//             new sap.ui.model.Filter("MessageType", sap.ui.model.FilterOperator.EQ, "F")
//         ];

//         oModel.read("/MFLogsSet", {
//             filters: aFilters,
//             success: function (oData) {

//                 let msg = "No PGI error message found for this shipment.";

//                 if (oData.results && oData.results.length > 0) {
//                     msg = oData.results[oData.results.length - 1].MessageText || msg;
//                 }

//                 // open dialog and show message
//                 eshipjetModel.setProperty("/pgiErrorMessage", msg);
//                 oController.OpenErrorLogDialog();

//                 resolve(msg);
//             },
//             error: function (err) {
//                 console.error("âŒ PGI Log Read Failed:", err);
//                 sap.m.MessageBox.error("Failed to fetch PGI logs. Try again.");
//                 reject(err);
//             }
//         });
//     });
// },


readPGIErrorLog: function () {
    const oController = this;
    var oModel = this.getOwnerComponent().getModel("MF_LOGS_SRV");
    var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");

    var guid = eshipjetModel.getProperty("/manifestGUID"); // the GUID stored during PGI update

    return new Promise(function (resolve, reject) {

        var aFilters = [
            new sap.ui.model.Filter("GuId", sap.ui.model.FilterOperator.EQ, guid),
            new sap.ui.model.Filter("MessageType", sap.ui.model.FilterOperator.EQ, "F")
        ];

        oModel.read("/MFLogsSet", {
            filters: aFilters,
            success: function (oData) {
                eshipjetModel.setProperty("/MESSAGE_TEXT", oData.results[0].MessageText);
                let msg = "No PGI error message found.";

                if (oData.results?.length > 0) {
                    msg = oData.results[oData.results.length - 1].MessageText;
                }

                oController.OpenErrorLogDialog(msg);
                resolve(msg);
            },
            error: function (err) {
                reject("Error fetching PGI logs: " + err.message);
            }
        });
    });
},










       

        createReversePostGoodsIssue:function(sapDeliveryNumber){
            var ShipReadDataSrvModel = oController.getOwnerComponent().getModel("ShipReadDataSrvModel");
            var oPayload = {
                "Document": sapDeliveryNumber,
                "ResponseDataSet" : []
            };
            ShipReadDataSrvModel.create("/ReversePGISet", oPayload, {
                success: function (oData) {
                    // MessageBox.error(oData.ResponseDataSet.results[0].Message);
                    console.log("Success:", oData);
                    oController.onCloseBusyDialog();
                },
                error: function (oError) {
                    oController.onCloseBusyDialog();
                    var errMsg = JSON.parse(oError.responseText).error.message.value;
                    sap.m.MessageBox.error(errMsg);
                }
            });
        },

        onAfterRendering: function() {
            var oInput = this.getView().byId("idSapDeliveryNumber");
            if (oInput) {
                setTimeout(function () {
                    var oVHIcon = oInput.$().find(".sapMInputValHelp .sapUiIcon");
                    if (oVHIcon.length) {
                        oVHIcon.removeClass("sapUiIcon-valueHelp").addClass("sapUiIcon");
                        oVHIcon.attr("data-sap-ui-icon-content", "\ue0a8"); // Unicode for search icon
                        oVHIcon.css("font-family", "SAP-icons"); // Ensure correct font
                    }
                }, 100); // Small delay to ensure UI is fully rendered
            }
        },
        onServiceNowDropdownChange:function(oEvent){
            var selectedKey = oEvent.getSource().getSelectedKey();
            var eshipjetModel =  this.getOwnerComponent().getModel("eshipjetModel");
            var ShipMethodKey =  eshipjetModel.getProperty("/commonValues/ShipNowShipsrvNameSelectedKey");
            var ServiceDropdown = eshipjetModel.getProperty("/carrierServicesList");
            var serviceObj = {};
            ServiceDropdown.forEach(function(item, Idx){
                if(item.ShippingType === selectedKey){
                    // serviceObj = item;
                    eshipjetModel.setProperty("/carrierServiceName_dis", item.ServDesc);
                    eshipjetModel.setProperty("/carrierServiceCode_display", item.ServiceCode);
                }
            });
            var ShipNowShipMethodSelectedKey = eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey");
            var carrierName = ShipNowShipMethodSelectedKey.toUpperCase();
            if(carrierName === "UPS" || carrierName === "FEDEX" || carrierName === "USPS"){
                eshipjetModel.setProperty("/hideTrackPackDetails", false);
            }else{
                eshipjetModel.setProperty("/hideTrackPackDetails", true);
                eshipjetModel.setProperty("/commonValues/lengthOfDimensions", "40");
                eshipjetModel.setProperty("/commonValues/widthOfDimensions", "48");
                eshipjetModel.setProperty("/commonValues/heightOfDimensions", "");
            }
        },

        onShopNowShipMethodTypeChange : function(oEvent){
            var selectedKey = oEvent.getSource().getSelectedKey();
            oController.onShopNowShipMethodAfterChange(selectedKey, "");
        },

        onShopNowShipMethodAfterChange:function(selectedKey, ErpServId){
            var oController = this;
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var carrierNamesDropDownData = eshipjetModel.getProperty("/carrierNamesDropDownData");
            for(var i=0; i<carrierNamesDropDownData.length; i++){
                if(carrierNamesDropDownData[i].CarrierCode === selectedKey){
                    eshipjetModel.setProperty("/selectedCarrierAccountsData", carrierNamesDropDownData[i]);
                    eshipjetModel.setProperty("/accountNumber", carrierNamesDropDownData[i].AcntNmbr);
                }
            };
            
            var oMainModel = oController.getOwnerComponent().getModel("CARRIERS_SRV");
            var ShippingPoint = eshipjetModel.getProperty("/commonValues/plant");
            oMainModel.read("/carrier_srvSet", {
                success: function (oData, response) {
                    const aFiltered = (oData.results || []).filter(item =>
                        item.ServLoc === ShippingPoint &&
                        item.CarrierCode === selectedKey &&
                        item.IsActive === true
                    );
                    eshipjetModel.setProperty("/carrierServicesDropDownData", aFiltered);
                    eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey", ErpServId);
                },
                error: function (oError) {
                    console.error("âŒ Error loading carrier catalog:", oError);

                    var sErrorMsg = "Failed to load carrier catalog";
                    if (oError.responseText) {
                        try {
                            var oErrorResponse = JSON.parse(oError.responseText);
                            sErrorMsg = oErrorResponse.error.message.value || sErrorMsg;
                        } catch (e) {
                            console.error("Could not parse error response");
                        }
                    }
                    sap.m.MessageToast.show(sErrorMsg);
                }
            });
            var ShipNowShipMethodSelectedKey =  eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey");


            // var eshipjetModel =  this.getOwnerComponent().getModel("eshipjetModel");
            // var carriersCatalogData = eshipjetModel.getProperty("/carriersCatalogData");
            // var carriersList = eshipjetModel.getProperty("/carrierNamesDropDownData");
            // var tempCarrierServicesList = [];
            // // for (var i = 0; i < carriersCatalogData.length; i++) {
            // //     if (carriersCatalogData[i].CarrierCode.toUpperCase() === selectedKey.toUpperCase()) {
            // //         eshipjetModel.setProperty("/selectedCarrier", carriersCatalogData[i]);
            // //         tempCarrierServicesList.push(carriersCatalogData[i]);
            // //     }
            // // };
            // for (var i = 0; i < carriersList.length; i++) {
            //     if (carriersList[i].CarrierCode.toUpperCase() === selectedKey.toUpperCase()) {
            //         eshipjetModel.setProperty("/selectedCarrierServices", carriersList[i]);
            //         eshipjetModel.setProperty("/accountNumber", carriersList[i].AcntNmbr);
            //         // tempCarrierServicesList.push(carriersCatalogData[i]);
            //     }
            // };
            // eshipjetModel.setProperty("/carrierServicesList", tempCarrierServicesList);
            // eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey", "");



            // for(var i=0; i<carrierconfiguration.length; i++){
            //     if(carrierconfiguration[i].CarrierName === selectedKey){
            //         var serviceNamesList = new JSONModel(carrierconfiguration[i]);
            //         this.getView().setModel(serviceNamesList, "serviceNamesList");
            //     }
            // };
            // eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey", oController.ShippingType);
            // for(var i=0; i<serviceNamesList.getProperty("/carrierServices").length; i++){
            //     if(serviceNamesList.getProperty("/carrierServices")[i].ShippingType === oController.ShippingType){
            //         eshipjetModel.setProperty("/carrierServiceName_dis", serviceNamesList.getProperty("/carrierServices")[i].ServiceName);
            //         eshipjetModel.setProperty("/carrierServiceCode_display", serviceNamesList.getProperty("/carrierServices")[i].ServiceCode);
            //     }
            // }
            // if(selectedKey === "UPS"){                
            //     eshipjetModel.setProperty("/accountNumber", "B24W72");                            
            // }else{
            //     eshipjetModel.setProperty("/accountNumber", "740561073");                
            // }              
            
            if (ShipNowShipMethodSelectedKey === "FEDEX"){
                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", true );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );

            }else if(ShipNowShipMethodSelectedKey === "DHL"){
                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", true );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
                
            }else if(ShipNowShipMethodSelectedKey === "FastFarwarder"){
                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", true );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );

             }else if(ShipNowShipMethodSelectedKey === "Other"){

                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", true );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
             }else if(ShipNowShipMethodSelectedKey === "UPS"){

                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", true );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
             }else if(ShipNowShipMethodSelectedKey === "USPS"){
                
                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", true );
             }else if(ShipNowShipMethodSelectedKey === "Gander & White"){
                
                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
             }else if(ShipNowShipMethodSelectedKey === "ABF"){
                
                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false  );
             }else if(ShipNowShipMethodSelectedKey === "ARTEX Fine Art Services"){
                
                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
             }else if(ShipNowShipMethodSelectedKey === "ATLAS Fine Art"){
                
                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
             }else if(ShipNowShipMethodSelectedKey === "Brinks Fine Art"){
                
                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
             }else if(ShipNowShipMethodSelectedKey === "Crown Fine Art"){
                
                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
             }else if(ShipNowShipMethodSelectedKey === "DTDC"){
                
                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
             }else if(ShipNowShipMethodSelectedKey === "FedEx Freight"){
                
                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
             }else if(ShipNowShipMethodSelectedKey === "Fine Art Shippers"){
                
                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
             }else if(ShipNowShipMethodSelectedKey === "JPMorgan Chase Internal"){
                
                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
             }else if(ShipNowShipMethodSelectedKey === "Malca-Amit"){
                
                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
             }else if(ShipNowShipMethodSelectedKey === "Movi Group"){
                
                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
             }else if(ShipNowShipMethodSelectedKey === "RL"){
                
                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
             }else if(ShipNowShipMethodSelectedKey === "The Armory"){
                
                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
             }
             else if(ShipNowShipMethodSelectedKey === "ABFS"){
                
                eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
                eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
                eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
             }

            var carrierName = ShipNowShipMethodSelectedKey.toUpperCase();
            if(carrierName === "UPS" || carrierName === "FEDEX" || carrierName === "USPS"){
                eshipjetModel.setProperty("/hideTrackPackDetails", false);
            }else{
                eshipjetModel.setProperty("/hideTrackPackDetails", true);
                eshipjetModel.setProperty("/commonValues/lengthOfDimensions", "40");
                eshipjetModel.setProperty("/commonValues/widthOfDimensions", "48");
                eshipjetModel.setProperty("/commonValues/heightOfDimensions", "");
            }
        },

        // add location popover down arrow 
        onADDLocImpPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._oADDLocImpPopover) {
                this._oADDLocImpPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddLocImportPopover",
                    controller: this
                }).then(function (ADDLocImpPopover) {
                    oView.addDependent(ADDLocImpPopover);
                    // ADDLocImpPopover.bindElement("/ProductCollection/0");
                    return ADDLocImpPopover;
                });
            }
            this._oADDLocImpPopover.then(function (ADDLocImpPopover) {
                ADDLocImpPopover.openBy(oButton);
            });
        },
        
          // add location popover down arrow 
          onImagePress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._oADDLocImpPopover) {
                this._oADDLocImpPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.CubeDimPackPopover",
                    controller: this
                }).then(function (ADDLocImpPopover) {
                    oView.addDependent(ADDLocImpPopover);
                    // ADDLocImpPopover.bindElement("/ProductCollection/0");
                    return ADDLocImpPopover;
                });
            }
            this._oADDLocImpPopover.then(function (ADDLocImpPopover) {
                ADDLocImpPopover.openBy(oButton);
            });
        },



         // add location popover down arrow 
         AddIMportLocPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._oAddIMportRolesPopover) {
                this._oAddIMportRolesPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ImportRolesLocPopover",
                    controller: this
                }).then(function (AddIMportRolesPopover) {
                    oView.addDependent(AddIMportRolesPopover);
                    // AddIMportRolesPopover.bindElement("/ProductCollection/0");
                    return AddIMportRolesPopover;
                });
            }
            this._oAddIMportRolesPopover.then(function (AddIMportRolesPopover) {
                AddIMportRolesPopover.openBy(oButton);
            });
        },
        onAddIMportRolesClosePress: function () {
            this.byId("idAddIMportRolesPopover").close();
        },

       // add location popover down arrow 
       onAddAdressBookArrowPress: function (oEvent) {
        var oButton = oEvent.getSource(),
            oView = this.getView();
        if (!this._oAddAdressBookArrowPopover) {
            this._oAddAdressBookArrowPopover = Fragment.load({
                id: oView.getId(),
                name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddAddressImportArrowPopover",
                controller: this
            }).then(function (AddAdressBookArrowPopover) {
                oView.addDependent(AddAdressBookArrowPopover);
                // AddAdressBookArrowPopover.bindElement("/ProductCollection/0");
                return AddAdressBookArrowPopover;
            });
        }
        this._oAddAdressBookArrowPopover.then(function (AddAdressBookArrowPopover) {
            AddAdressBookArrowPopover.openBy(oButton);
        });
    },  


      // add AddImportAddressBookPress popover down arrow 
      AddImportAddressBookPress: function (oEvent) {
        var oButton = oEvent.getSource(),
            oView = this.getView();
        if (!this._oAddImportAddressBookPopover) {
            this._oAddImportAddressBookPopover = Fragment.load({
                id: oView.getId(),
                name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddAddressImportPopover1",
                controller: this
            }).then(function (AddImportAddressBookPopover) {
                oView.addDependent(AddImportAddressBookPopover);
                // AddImportAddressBookPopover.bindElement("/ProductCollection/0");
                return AddImportAddressBookPopover;
            });
        }
        this._oAddImportAddressBookPopover.then(function (AddImportAddressBookPopover) {
            AddImportAddressBookPopover.openBy(oButton);
        });
    },
    onAddImportAddressBookClosePress: function () {
        this.byId("idAddAddressBookImportPopover").close();
    },

         // add User Arrow click popover down arrow 
       onUserArrowPress: function (oEvent) {
        var oButton = oEvent.getSource(),
            oView = this.getView();
        if (!this._oAddUserArrowPopover) {
            this._oAddUserArrowPopover = Fragment.load({
                id: oView.getId(),
                name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.UserArrowPressPopover",
                controller: this
            }).then(function (AddUserArrowPopover) {
                oView.addDependent(AddUserArrowPopover);
                // AddUserArrowPopover.bindElement("/ProductCollection/0");
                return AddUserArrowPopover;
            });
        }
        this._oAddUserArrowPopover.then(function (AddUserArrowPopover) {
            AddUserArrowPopover.openBy(oButton);
        });
    },  
       

         // add AddUserPress popover down arrow 
         AddImportUserPress: function (oEvent) {
        var oButton = oEvent.getSource(),
            oView = this.getView();
        if (!this._oAddUserImportPopover) {
            this._oAddUserImportPopover = Fragment.load({
                id: oView.getId(),
                name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.UserImportPopover",
                controller: this
            }).then(function (AddUserImportPopover) {
                oView.addDependent(AddUserImportPopover);
                // AddUserImportPopover.bindElement("/ProductCollection/0");
                return AddUserImportPopover;
            });
        }
        this._oAddUserImportPopover.then(function (AddUserImportPopover) {
            AddUserImportPopover.openBy(oButton);
        });
    },
    onAddUserImportClosePress: function () {
        this.byId("idUserImportPopover").close();
    },
    onUserCloseFinishImportingPress: function () {
        this.byId("idUserImportPopover").close();
    },

        // add Third Party Arrow click popover down arrow 
    onThirdPartyArrowPress: function (oEvent) {
        var oButton = oEvent.getSource(),
            oView = this.getView();
        if (!this._oAddThirdPartyArrowPopover) {
            this._oAddThirdPartyArrowPopover = Fragment.load({
                id: oView.getId(),
                name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ThirdPartyArrowPopover",
                controller: this
            }).then(function (AddThirdPartyArrowPopover) {
                oView.addDependent(AddThirdPartyArrowPopover);
                // AddThirdPartyArrowPopover.bindElement("/ProductCollection/0");
                return AddThirdPartyArrowPopover;
            });
        }
        this._oAddThirdPartyArrowPopover.then(function (AddThirdPartyArrowPopover) {
            AddThirdPartyArrowPopover.openBy(oButton);
        });
    },  

         // add AddThirdPartyPress popover down arrow 
         AddImportThirdPartyPress: function (oEvent) {
        var oButton = oEvent.getSource(),
            oView = this.getView();
        if (!this._oAddThirdPartyImportPopover) {
            this._oAddThirdPartyImportPopover = Fragment.load({
                id: oView.getId(),
                name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ThirdPartyImportPopover",
                controller: this
            }).then(function (AddThirdPartyImportPopover) {
                oView.addDependent(AddThirdPartyImportPopover);
                // AddThirdPartyImportPopover.bindElement("/ProductCollection/0");
                return AddThirdPartyImportPopover;
            });
        }
        this._oAddThirdPartyImportPopover.then(function (AddThirdPartyImportPopover) {
            AddThirdPartyImportPopover.openBy(oButton);
        });
    },
    onThirdPartyImportClosePress: function () {
        this.byId("idThirdPartyImportPopover").close();
    },
    onThirdPartyCloseFinishImportingPress: function () {
        this.byId("idThirdPartyImportPopover").close();
    },



     // add Third Party Arrow click popover down arrow 
     onRolesArrowPress: function (oEvent) {
        var oButton = oEvent.getSource(),
            oView = this.getView();
        if (!this._oAddRolesArrowPopover) {
            this._oAddRolesArrowPopover = Fragment.load({
                id: oView.getId(),
                name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.RolesArrowPopover",
                controller: this
            }).then(function (AddRolesArrowPopover) {
                oView.addDependent(AddRolesArrowPopover);
                // AddRolesArrowPopover.bindElement("/ProductCollection/0");
                return AddRolesArrowPopover;
            });
        }
        this._oAddRolesArrowPopover.then(function (AddRolesArrowPopover) {
            AddRolesArrowPopover.openBy(oButton);
        });
    },  

         // add AddRolesPress popover down arrow 
         AddImportRolesPress: function (oEvent) {
        var oButton = oEvent.getSource(),
            oView = this.getView();
        if (!this._oAddRolesImportPopover) {
            this._oAddRolesImportPopover = Fragment.load({
                id: oView.getId(),
                name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.RolesImportPopover",
                controller: this
            }).then(function (AddRolesImportPopover) {
                oView.addDependent(AddRolesImportPopover);
                // AddRolesImportPopover.bindElement("/ProductCollection/0");
                return AddRolesImportPopover;
            });
        }
        this._oAddRolesImportPopover.then(function (AddRolesImportPopover) {
            AddRolesImportPopover.openBy(oButton);
        });
    },


    
     // add Third Party Arrow click popover down arrow 
     onCostCenterArrowPress: function (oEvent) {
        var oButton = oEvent.getSource(),
            oView = this.getView();
        if (!this._oAddCostCenterArrowPopover) {
            this._oAddCostCenterArrowPopover = Fragment.load({
                id: oView.getId(),
                name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.CostCenterArrowPopover",
                controller: this
            }).then(function (AddCostCenterArrowPopover) {
                oView.addDependent(AddCostCenterArrowPopover);
                // AddCostCenterArrowPopover.bindElement("/ProductCollection/0");
                return AddCostCenterArrowPopover;
            });
        }
        this._oAddCostCenterArrowPopover.then(function (AddCostCenterArrowPopover) {
            AddCostCenterArrowPopover.openBy(oButton);
        });
        
    },  
    onAddImportCostCenterClosePress: function () {
        this.byId("idCostCenterImportPopover").close();
    },
    onCreateCostcenterFinishImportingPress: function () {
        this.byId("idCostCenterImportPopover").close();
    },

         // add AddCostCenterPress popover down arrow 
         AddImportCostCenterPress: function (oEvent) {
        var oButton = oEvent.getSource(),
            oView = this.getView();
        if (!this._oAddCostCenterImportPopover) {
            this._oAddCostCenterImportPopover = Fragment.load({
                id: oView.getId(),
                name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.CostCenterImportPopover",
                controller: this
            }).then(function (AddCostCenterImportPopover) {
                oView.addDependent(AddCostCenterImportPopover);
                // AddCostCenterImportPopover.bindElement("/ProductCollection/0");
                return AddCostCenterImportPopover;
            });
        }
        this._oAddCostCenterImportPopover.then(function (AddCostCenterImportPopover) {
            AddCostCenterImportPopover.openBy(oButton);
        });
    },


     // add LTLClasses  Arrow click popover down arrow 
     onLTLClassesArrowPress: function (oEvent) {
        var oButton = oEvent.getSource(),
            oView = this.getView();
        if (!this._oAddLTLClassesArrowPopover) {
            this._oAddLTLClassesArrowPopover = Fragment.load({
                id: oView.getId(),
                name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.LTLClassesArrowPopover",
                controller: this
            }).then(function (AddLTLClassesArrowPopover) {
                oView.addDependent(AddLTLClassesArrowPopover);
                // AddLTLClassesArrowPopover.bindElement("/ProductCollection/0");
                return AddLTLClassesArrowPopover;
            });
        }
        this._oAddLTLClassesArrowPopover.then(function (AddLTLClassesArrowPopover) {
            AddLTLClassesArrowPopover.openBy(oButton);
        });
    },  

         // add onLTLClassesArrowPress popover down arrow 
         onLTLClassesImportPress: function (oEvent) {
        var oButton = oEvent.getSource(),
            oView = this.getView();
        if (!this._oAddLTLClassesImportPopover) {
            this._oAddLTLClassesImportPopover = Fragment.load({
                id: oView.getId(),
                name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.LTLClassesImportPopover",
                controller: this
            }).then(function (AddLTLClassesImportPopover) {
                oView.addDependent(AddLTLClassesImportPopover);
                // AddLTLClassesImportPopover.bindElement("/ProductCollection/0");
                return AddLTLClassesImportPopover;
            });
        }
        this._oAddLTLClassesImportPopover.then(function (AddLTLClassesImportPopover) {
            AddLTLClassesImportPopover.openBy(oButton);
        });
    },
    onAddImportLTLCLassesClosePress: function () {
        this.byId("idLTLClassesImportPopover").close();
    },
    onCreateLTLClassesFinishImportingPress: function () {
        this.byId("idLTLClassesImportPopover").close();
    },


     // add carriercatalog  Arrow click popover down arrow 
     onCarrierCatalogArrowPress: function (oEvent) {
        var oButton = oEvent.getSource(),
            oView = this.getView();
        if (!this._oAddCarrierCatalogArrowPopover) {
            this._oAddCarrierCatalogArrowPopover = Fragment.load({
                id: oView.getId(),
                name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.CarrierCatalogArrowPopover",
                controller: this
            }).then(function (AddCarrierCatalogArrowPopover) {
                oView.addDependent(AddCarrierCatalogArrowPopover);
                // AddCarrierCatalogArrowPopover.bindElement("/ProductCollection/0");
                return AddCarrierCatalogArrowPopover;
            });
        }
        this._oAddCarrierCatalogArrowPopover.then(function (AddCarrierCatalogArrowPopover) {
            AddCarrierCatalogArrowPopover.openBy(oButton);
        });
    },  

         // add onCarrierCatalogArrowPress popover down arrow 
         onCarrierCatalogImportPress: function (oEvent) {
        var oButton = oEvent.getSource(),
            oView = this.getView();
        if (!this._oAddCarrierCatalogImportPopover) {
            this._oAddCarrierCatalogImportPopover = Fragment.load({
                id: oView.getId(),
                name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.CarrierCatalogImportPopover",
                controller: this
            }).then(function (AddCarrierCatalogImportPopover) {
                oView.addDependent(AddCarrierCatalogImportPopover);
                // AddCarrierCatalogImportPopover.bindElement("/ProductCollection/0");
                return AddCarrierCatalogImportPopover;
            });
        }
        this._oAddCarrierCatalogImportPopover.then(function (AddCarrierCatalogImportPopover) {
            AddCarrierCatalogImportPopover.openBy(oButton);
        });
    },
    onAddImportCarrierCatalogClosePress: function () {
        this.byId("idCarrierCatalogImportPopover").close();
    },
    onCarrierCatalogcenterFinishImportingPress: function () {
        this.byId("idCarrierCatalogImportPopover").close();
    },

         // add carriercatalog  Arrow click popover down arrow 
     onCarrierAccountsArrowPress: function (oEvent) {
        var oButton = oEvent.getSource(),
            oView = this.getView();
        if (!this._oAddCarrierAccountsArrowPopover) {
            this._oAddCarrierAccountsArrowPopover = Fragment.load({
                id: oView.getId(),
                name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.CarrierAccountsArrowPopover",
                controller: this
            }).then(function (AddCarrierAccountsArrowPopover) {
                oView.addDependent(AddCarrierAccountsArrowPopover);
                // AddCarrierAccountsArrowPopover.bindElement("/ProductCollection/0");
                return AddCarrierAccountsArrowPopover;
            });
        }
        this._oAddCarrierAccountsArrowPopover.then(function (AddCarrierAccountsArrowPopover) {
            AddCarrierAccountsArrowPopover.openBy(oButton);
        });
    },  

         // add onCarrierAccountsArrowPress popover down arrow 
         onCarrierAccountsImportPress: function (oEvent) {
        var oButton = oEvent.getSource(),
            oView = this.getView();
        if (!this._oAddCarrierAccountsImportPopover) {
            this._oAddCarrierAccountsImportPopover = Fragment.load({
                id: oView.getId(),
                name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.CarrierAccountsImportPopover",
                controller: this
            }).then(function (AddCarrierAccountsImportPopover) {
                oView.addDependent(AddCarrierAccountsImportPopover);
                // AddCarrierAccountsImportPopover.bindElement("/ProductCollection/0");
                return AddCarrierAccountsImportPopover;
            });
        }
        this._oAddCarrierAccountsImportPopover.then(function (AddCarrierAccountsImportPopover) {
            AddCarrierAccountsImportPopover.openBy(oButton);
        });
    },
    onAddImportCarrierAccountsClosePress: function () {
        this.byId("idCarrierAccountsImportPopover").close();
    },
    onCarrierAccountscenterFinishImportingPress: function () {
        this.byId("idCarrierAccountsImportPopover").close();
    },




          // add Status  Arrow click popover down arrow 
          onStatusArrowPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._oAddStatusArrowPopover) {
                this._oAddStatusArrowPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.StatusArrowPopover",
                    controller: this
                }).then(function (AddStatusArrowPopover) {
                    oView.addDependent(AddStatusArrowPopover);
                    // AddStatusArrowPopover.bindElement("/ProductCollection/0");
                    return AddStatusArrowPopover;
                });
            }
            this._oAddStatusArrowPopover.then(function (AddStatusArrowPopover) {
                AddStatusArrowPopover.openBy(oButton);
            });
        },  
    
             // add onStatusArrowPress popover down arrow 
             onStatusImportPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._oAddStatusImportPopover) {
                this._oAddStatusImportPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.StatusImportPopover",
                    controller: this
                }).then(function (AddStatusImportPopover) {
                    oView.addDependent(AddStatusImportPopover);
                    // AddStatusImportPopover.bindElement("/ProductCollection/0");
                    return AddStatusImportPopover;
                });
            }
            this._oAddStatusImportPopover.then(function (AddStatusImportPopover) {
                AddStatusImportPopover.openBy(oButton);
            });
        },
        onAddImportStatusClosePress: function () {
            this.byId("idStatusImportPopover").close();
        },
        onStatuscenterFinishImportingPress: function () {
            this.byId("idStatusImportPopover").close();
        },



         // add Product  Arrow click popover down arrow 
         onProductArrowPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._oAddProductArrowPopover) {
                this._oAddProductArrowPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ProductArrowPopover",
                    controller: this
                }).then(function (AddProductArrowPopover) {
                    oView.addDependent(AddProductArrowPopover);
                    // AddProductArrowPopover.bindElement("/ProductCollection/0");
                    return AddProductArrowPopover;
                });
            }
            this._oAddProductArrowPopover.then(function (AddProductArrowPopover) {
                AddProductArrowPopover.openBy(oButton);
            });
        },  
    
             // add onProductArrowPress popover down arrow 
             onProductImportPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._oAddProductImportPopover) {
                this._oAddProductImportPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ProductImportPopover",
                    controller: this
                }).then(function (AddProductImportPopover) {
                    oView.addDependent(AddProductImportPopover);
                    // AddProductImportPopover.bindElement("/ProductCollection/0");
                    return AddProductImportPopover;
                });
            }
            this._oAddProductImportPopover.then(function (AddProductImportPopover) {
                AddProductImportPopover.openBy(oButton);
            });
        },
        onAddImportProductClosePress: function () {
            this.byId("idProductImportPopover").close();
        },
        onProductcenterFinishImportingPress: function () {
            this.byId("idProductImportPopover").close();
        },

         // add PackagesTypes  Arrow click popover down arrow 
         onDangerousGoodsArrowPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._oAddDangerousGoodsArrowPopover) {
                this._oAddDangerousGoodsArrowPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.DangerousGoodsImportArrowPopover",
                    controller: this
                }).then(function (AddDangerousGoodsArrowPopover) {
                    oView.addDependent(AddDangerousGoodsArrowPopover);
                    // AddDangerousGoodsArrowPopover.bindElement("/DangerousGoodsCollection/0");
                    return AddDangerousGoodsArrowPopover;
                });
            }
            this._oAddDangerousGoodsArrowPopover.then(function (AddDangerousGoodsArrowPopover) {
                AddDangerousGoodsArrowPopover.openBy(oButton);
            });
        },  

        AddImportDangerousGoodsPress: function (oEvent) {
            var oView = this.getView();
        
            if (!this._oAddDangerousGoodsImportDialog) {
                this._oAddDangerousGoodsImportDialog = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.DangerousGoodsImportDialog",
                    controller: this
                }).then(function (oDialog) {
                    oView.addDependent(oDialog);
                    return oDialog;
                });
            }
        
            this._oAddDangerousGoodsImportDialog.then(function (oDialog) {
                oDialog.open();
            });
        },
        
        onAddImportDangerousGoodsClosePress: function () {
            this.byId("idDangerousGoodsImportDialog").close();
        },
        
        onDangerousGoodscenterFinishImportingPress: function () {
            this.byId("idDangerousGoodsImportDialog").close();
        },
        

         // add PackagesTypes  Arrow click popover down arrow 
         onPackagesTypesArrowPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._oAddPackagesTypesArrowPopover) {
                this._oAddPackagesTypesArrowPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.PackageTypesArrowPopover",
                    controller: this
                }).then(function (AddPackagesTypesArrowPopover) {
                    oView.addDependent(AddPackagesTypesArrowPopover);
                    // AddPackagesTypesArrowPopover.bindElement("/PackagesTypesCollection/0");
                    return AddPackagesTypesArrowPopover;
                });
            }
            this._oAddPackagesTypesArrowPopover.then(function (AddPackagesTypesArrowPopover) {
                AddPackagesTypesArrowPopover.openBy(oButton);
            });
        },  
    
             // add onPackagesTypesArrowPress popover down arrow 
             onPackagesTypesImportPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._oAddPackagesTypesImportPopover) {
                this._oAddPackagesTypesImportPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.PackageTypesImportPopover",
                    controller: this
                }).then(function (AddPackagesTypesImportPopover) {
                    oView.addDependent(AddPackagesTypesImportPopover);
                    // AddPackagesTypesImportPopover.bindElement("/PackagesTypesCollection/0");
                    return AddPackagesTypesImportPopover;
                });
            }
            this._oAddPackagesTypesImportPopover.then(function (AddPackagesTypesImportPopover) {
                AddPackagesTypesImportPopover.openBy(oButton);
            });
        },
        onAddImportPackagesTypesClosePress: function () {
            this.byId("idPackagesTypesImportPopover").close();
        },
        onPackagesTypescenterFinishImportingPress: function () {
            this.byId("idPackagesTypesImportPopover").close();
        },
    

        

    // onShipRatePress:function(){
    //     var ShipNowDataModel = oController.getView().getModel("ShipNowDataModel");
    //     var shipToCountry = ShipNowDataModel.getProperty("/ShipToAddress/Country");
    //     var shipToAddressLine1 = ShipNowDataModel.getProperty("/ShipToAddress/StreetName");
    //     var shipToCity = ShipNowDataModel.getProperty("/ShipToAddress/CityName");
    //     var shipToZipCode = ShipNowDataModel.getProperty("/ShipToAddress/PostalCode");
    //     var shipToState = ShipNowDataModel.getProperty("/ShipToAddress/CityName");
    //     var shipToCompanyName = ShipNowDataModel.getProperty("/ShipToAddress/BusinessPartnerName1");
    //     var shipToContactName = ShipNowDataModel.getProperty("/ShipToAddress/FullName");
    //     var shipToAddressLine2 = ShipNowDataModel.getProperty("/ShipToAddress/HouseNumber");
    //     var shipToEmail = ShipNowDataModel.getProperty("/ShipToAddress/EMAIL");
    //     var shipToPhone = ShipNowDataModel.getProperty("/ShipToAddress/PhoneNumber");
    //     var ShipNowPackTable = oController.getView().byId("idShipNowPackTable");
    //     var oTableItemsLength = ShipNowPackTable.getBinding("rows").iLength;

    //     if(shipToCountry === "" || shipToCountry === undefined){
    //         MessageBox.warning("Please Enter Ship To Country");
    //     }else if(shipToCountry !== "" && shipToAddressLine1 === ""){
    //         MessageBox.warning("Please Enter Address Line 1");
    //     }else if(shipToCountry !== "" && shipToAddressLine1 !== "" && shipToCity === ""){
    //         MessageBox.warning("Please Enter Ship To City");
    //     }else if(shipToCountry !== "" && shipToAddressLine1 !== "" && shipToCity !== "" && shipToZipCode === ""){
    //         MessageBox.warning("Please Enter Ship To ZipCode");
    //     }else if(shipToCountry !== "" && shipToAddressLine1 !== "" && shipToCity !== "" && shipToZipCode !== "" && shipToState === ""){
    //         MessageBox.warning("Please Enter Ship To State");
    //     }else if(shipToCountry !== "" && shipToAddressLine1 !== "" && shipToCity !== "" && shipToZipCode !== "" && shipToState !== "" && shipToCompanyName === ""){
    //         MessageBox.warning("Please Enter Ship To Company Name");
    //     }else if(shipToCountry !== "" && shipToAddressLine1 !== "" && shipToCity !== "" && shipToZipCode !== "" && shipToState !== "" && shipToCompanyName !== "" && shipToContactName === ""){
    //         MessageBox.warning("Please Enter Ship To Contact Name");
    //     }else if(shipToCountry !== "" && shipToAddressLine1 !== "" && shipToCity !== "" && shipToZipCode !== "" && shipToState !== "" && shipToCompanyName !== "" && shipToContactName !== "" && shipToEmail === ""){
    //         MessageBox.warning("Please Enter Ship To Email");
    //     }else if(shipToCountry !== "" && shipToAddressLine1 !== "" && shipToCity !== "" && shipToZipCode !== "" && shipToState !== "" && shipToCompanyName !== "" && shipToContactName !== "" && shipToEmail !== "" && shipToPhone === ""){
    //         MessageBox.warning("Please Enter Ship To Phone No");
    //     }else if(shipToCountry !== "" && shipToAddressLine1 !== "" && shipToCity !== "" && shipToZipCode !== "" && shipToState !== "" && shipToCompanyName !== "" && shipToContactName !== "" && shipToEmail !== "" && shipToPhone !== "" && oTableItemsLength <= 0){
    //         MessageBox.warning("Please create package");
    //     }else{
           
    //         let getShipRatePromise = new Promise((resolve, reject) => {
    //             oController.onShipRateRequest(resolve, reject, "ShipRates");
    //         });
    //     }        
    // },

    onShipRatePress: function () {

    var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
    var ShipTo = eshipjetModel.getProperty("/ShipToAddress");

    // ---------------------------------------------------
    // VALIDATION
    // ---------------------------------------------------
    if (!ShipTo.Country) return MessageBox.warning("Please Enter Ship To Country");
    // if (!ShipTo.StreetName) return MessageBox.warning("Please Enter Address Line 1");
    if (!ShipTo.CityName) return MessageBox.warning("Please Enter Ship To City");
    if (!ShipTo.PostalCode) return MessageBox.warning("Please Enter Ship To ZipCode");
    if (!ShipTo.Region) return MessageBox.warning("Please Enter Ship To State");
    if (!ShipTo.BusinessPartnerName1) return MessageBox.warning("Please Enter Ship To Company Name");
    if (!ShipTo.FullName) return MessageBox.warning("Please Enter Ship To Contact Name");
    // if (!ShipTo.EMAIL) return MessageBox.warning("Please Enter Ship To Email");
    // if (!ShipTo.PhoneNumber) return MessageBox.warning("Please Enter Ship To Phone No");

    // ---------------------------------------------------
    // ðŸ”¥ CREATE PROMISE FOR API CALL
    // ---------------------------------------------------
    new Promise((resolve, reject) => {
        oController.onShipRateRequest(resolve, reject, "ShipRates");
    })
    .then(function (response) {
        resolve(response); 

        console.log("ðŸšš Rate API Response:", response);

        // Set rate list
        if (response.RateServices) {
            response.RateServices.forEach(function (rate) {
                rate.discountFreight_Cal =
                    rate.publishedFreight - ((rate.publishedFreight * 20) / 100);
            });
        }

        eshipjetModel.setProperty("/shipNowShippingRates", response.RateServices || []);

        // Open the popup
        oController.onOpenShipNowShippinRateDialog();
    })
    .catch(function () {
        // MessageBox.error("Unable to fetch shipping rates.");
    });
},

    onShipRateRequest:function(resolve, reject, sRequestFrom){       
        var eshipjetModel  = oController.getView().getModel("ShipNowDataModel");  
        var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
        var ShipToAddress = eshipjetModel.getProperty("/ShipToAddress");
        var ShipFromAddress = eshipjetModel.getProperty("/ShipFromAddress");
        //oController.onOpenBusyDialog();
       var oPayload = {
                "HeaderInfo": {
                    "FeederSystem": "Manual",
                    "DocumentNumber": eshipjetModel.getProperty("/commonValues/sapDeliveryNumber"),
                    "DocumentType": "Delivery Order",
                    "ShipDate": "2024-10-29T09:08:36.962Z",
                    "CreatedDate": "2024-10-29T09:08:36.962Z",
                    "ShipmentType": "Manual",
                    "Location": "1001",
                    "ERP": "Manual",
                    "TotalWeight": "020"
                },
                "Shipper": {
                    "COMPANY": "Eshipjet Software Inc.",
                    "CONTACT": "Steve Marsh",
                    "ADDRESS_LINE1": "5717 Legacy",
                    "ADDRESS_LINE2": "Suite 250",
                    "ADDRESS_LINE3": "",
                    "CITY": "Plano",
                    "STATE": "TX",
                    "ZIPCODE": "75024",
                    "COUNTRY": "US",
                    "PHONE": "(888) 464 2360",
                    "EMAIL": "info@eshipjet.ai"
                },
                 "ShipTo" : {
                        "COMPANY": ShipToAddress.FullName || ShipToAddress.BusinessPartnerName1 || "",
                        "CONTACT": ShipToAddress.FullName || "",
                        "ADDRESS_LINE1": ShipToAddress.HouseNumber || "",
                        "ADDRESS_LINE2": ShipToAddress.StreetName || "",
                        "ADDRESS_LINE3": null,
                        "CITY": ShipToAddress.CityName || "",
                        "STATE": ShipToAddress.Region || "",
                        "ZIPCODE": ShipToAddress.PostalCode || "",
                        "COUNTRY": ShipToAddress.Country || "",
                        "PHONE": ShipToAddress.PhoneNumber || "",
                        "EMAIL": ShipToAddress.EMAIL || "",
                        "TAXID": null
                    },
                "SoldTo": {
                    "COMPANY": eshipjetModel.getProperty("/ShipTo/FullName") 
                        || eshipjetModel.getProperty("/ShipTo/BusinessPartnerName1"),
                    "CONTACT": eshipjetModel.getProperty("/ShipTo/FullName") 
                        || eshipjetModel.getProperty("/ShipTo/BusinessPartnerName1"),
                    // StreetName is empty â†’ so use HouseNumber (actual address)
                    "ADDRESS_LINE1": eshipjetModel.getProperty("/ShipTo/HouseNumber"),
                    "ADDRESS_LINE2": eshipjetModel.getProperty("/ShipTo/StreetName") || "",
                    "ADDRESS_LINE3": null,
                    "CITY": eshipjetModel.getProperty("/ShipTo/CityName"),
                    "STATE": eshipjetModel.getProperty("/ShipTo/Region"),
                    "ZIPCODE": eshipjetModel.getProperty("/ShipTo/PostalCode"),
                    "COUNTRY": eshipjetModel.getProperty("/ShipTo/Country"),
                    "PHONE": eshipjetModel.getProperty("/ShipTo/PhoneNumber"),
                    // EMAIL from backend â†’ if undefined use empty string
                    "EMAIL": eshipjetModel.getProperty("/ShipTo/EMAIL") || ""
                },
                "Packages": [
                    {
                        "ItemsInfo": [
                            {
                                "ItemNo": "OPF12346",
                                "ProductNo": "OPF12346",
                                "Description": "Oakley Square plastic",
                                "IsDG": false,
                                "UnitCost": "131",
                                "UnitWeight": "1",
                                "Dimension": "",
                                "HTSCode": "900410",
                                "ECCN": "",
                                "UN": "",
                                "Class": 50,
                                "NMFC": "",
                                "Category": "",
                                "IsSerial": null,
                                "IsBatch": null,
                                "IsStackable": null,
                                "IsActive": true,
                                "LocationId": "",
                                "id": 1,
                                "Sno": 1,
                                "Quantity": 15,
                                "Partial": 15,
                                "Balance": 15
                            }
                        ],
                        "SpecialServices": {},
                        "Weightunits": "LBS",
                        "DimensionUnits": "IN",
                        "Sno": 1,
                        "HU": 1371,
                        "Weight": "11",
                        "Dimension": "5x5x5",
                        "PackageSpecialServiceTyeps": []
                    }
                ],
                "ShipmentLevelServices": {},
                "ShipmentLevelSpecialServices": {},
                "id": 86,
                "items": [],
                "ShipmentSpecialServiceTypes": [],
                "InternationalDetails": {
                    "ItemInfo": [
                        {
                            "ItemNo": "",
                            "ProductNo": "",
                            "Description": "",
                            "IsDG": null,
                            "UnitCost": "",
                            "UnitWeight": "",
                            "Dimension": "",
                            "HTSCode": "",
                            "ECCN": "",
                            "UN": "",
                            "Class": "",
                            "NMFC": "",
                            "Category": "",
                            "IsSerial": null,
                            "IsBatch": null,
                            "IsStackable": null,
                            "IsActive": true,
                            "LocationId": "1001",
                            "id": 1,
                            "Sno": 1,
                            "Quantity": null,
                            "Partial": 1,
                            "Balance": null,
                            "UOM": null
                        }
                    ],
                    "termsofShipment": "",
                    "reasonforExport": "",
                    "customDecVal": "",
                    "documentsContentType": "",
                    "iNTDutiesTaxes": "",
                    "dutiesAccountnumber": "",
                    "bookingConfirmnumber": "",
                    "B13AFilingOption": "",
                    "Permitnumber": "",
                    "ITN": "",
                    "compliStatement": "",
                    "payorCountryCode": ""
                },
                "CarrierDetails": [
                    // {
                    //     "Carrier": "FedEx",
                    //     "ServiceName": "",
                    //     "PaymentType": "Sender",
                    //     "ShippingAccount": "740561073",
                    //     "BillingAccount": "",
                    //     "BillingZipCode": "",
                    //     "Reference1": "",
                    //     "Reference2": "",
                    //     "Reference3": "",
                    //     "Reference4": "",
                    //     "Note": "",
                    //     "UserId": "l70c717f3eaf284dc9af42169e93874b6e",
                    //     "Password": "7f271bf486084e8f8073945bb7e6a020",
                    //     "LocationId": "1001",
                    //     "Account": "740561073"
                    // },
                    {
                        "Carrier": "RL",
                        "ServiceName": "",
                        "PaymentType": "Sender",
                        "ShippingAccount": "",
                        "BillingAccount": "",
                        "BillingCountry": "",
                        "BillingZipCode": "",
                        "Reference1": "",
                        "Reference2": "",
                        "Reference3": "",
                        "Reference4": "",
                        "Note": "",
                        "UserId": "test",
                        "Password": "test",
                        "AccessKey": "ItO0YzFzIxZ1Q0MWQtZWNlZi00MDVkLTgxYzNGNiQlMzMTkTC"
                    },
                    // {
                    //     "Carrier": "ABFS",
                    //     "ServiceName": "",
                    //     "PaymentType": "Sender",
                    //     "ShippingAccount": "B24W72",
                    //     "BillingAccount": "",
                    //     "BillingCountry": "",
                    //     "BillingZipCode": "",
                    //     "Reference1": "",
                    //     "Reference2": "",
                    //     "Reference3": "",
                    //     "Reference4": "",
                    //     "Note": "",
                    //     "UserId": "ABFESHIPJET",
                    //     "Password": "Legacy!@3",
                    //     "AccessKey": "JVG9SX85"
                    // },
                    {
                        "Carrier": "UPS",
                        "ServiceName": "",
                        "PaymentType": "Sender",
                        "ShippingAccount": "B24W72",
                        "BillingAccount": "89W74E",
                        "BillingCountry": "",
                        "BillingZipCode": "",
                        "Reference1": "EWM17-CU02",
                        "Reference2": "",
                        "Reference3": "",
                        "Reference4": "",
                        "Note": "",
                        "UserId": "6ljUpEbuu1OlOk7ow932lsxXHISUET0WKjTn59GzQ5MRdEbA",
                        "Password": "ioZmsfcbrzlWfGh7wGMhqHL6sY4EAaKzZObullipni0cEGJGChjFmGpkcdCWQynK",
                        "AccessKey": null
                    },
                    // {
                    //     "Carrier": "DHL",
                    //     "ServiceName": "P",
                    //     "PaymentType": "Sender",
                    //     "ShippingAccount": "965278629",
                    //     "BillingAccount": "",
                    //     "BillingCountry": "",
                    //     "BillingZipCode": "",
                    //     "Reference1": "EWM17-CU02",
                    //     "Reference2": "test",
                    //     "Reference3": "",
                    //     "Reference4": "",
                    //     "Note": "",
                    //     "UserId": "apT2vB7mV1qR1b",
                    //     "Password": "U#3mO^1vY!5mT@0j",
                    //     "AccessKey": null,
                    //     "RefreshKey": null
                    // }
                ],
                "ShipFrom": {
                   "COMPANY": ShipFromAddress.ShipFromCOMPANY || "",
                    "CONTACT": ShipFromAddress.ShipFromCONTACT || "",
                    "ADDRESS_LINE1": ShipFromAddress.ShipFromADDRESS_LINE1 || "",
                    "ADDRESS_LINE2": ShipFromAddress.ShipFromADDRESS_LINE2 || "",
                    "ADDRESS_LINE3": null,
                    "CITY": ShipFromAddress.ShipFromCITY || "",
                    "STATE": ShipFromAddress.ShipFromSTATE || "",
                    "ZIPCODE": ShipFromAddress.ShipFromZIPCODE || "",
                    "COUNTRY": ShipFromAddress.ShipFromCOUNTRY || "",
                    "PHONE": ShipFromAddress.ShipFromPHONE || "",
                    "EMAIL": ShipFromAddress.ShipFromEMAIL || ""
                }
            };    
        oController.onOpenBusyDialog();
        // var sPath = "https://eshipjet-stg-scpn-byargfehdgdtf8f3.francecentral-01.azurewebsites.net/Rateall "; 
        var sPath = "https://carrier-api-v1.eshipjet.site/rateall"
        $.ajax({
            url: sPath, // Replace with your API endpoint
            method: "POST",
            contentType: "application/json", // Set content type to JSON if sending JSON data
            data: JSON.stringify(oPayload),
            success: function (response) {                 
                resolve();          
                if(response && response.RateServices && response.RateServices.length > 0){
                    response.RateServices.map(function(Obj, idx){
                        Obj["discountFreight_Cal"] = (Obj.publishedFreight) - ((Obj.publishedFreight * 20 ) / 100) ;  
                    });
                    eshipjetModel.setProperty("/shipNowShippingRates", response.RateServices);
                    let sFromViewName = eshipjetModel.getProperty("/sFromViewName");
                    if(sRequestFrom === "ShipRates"|| sFromViewName === "QUOTE_NOW"){                        
                        oController.onOpenShipNowShippinRateDialog();
                        oController.onCloseBusyDialog();
                    }else{
                        var sKey = eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey"), oCarrier = {};
                        if(sKey !== "ABFS"){
                            
                            var sServiceKeyName = eshipjetModel.getProperty("/carrierServiceName_dis");
                            if(response && response.RateServices &&  response.RateServices.length > 0){
                                response.RateServices.forEach(function(item, idx){
                                    if(sServiceKeyName === item.serviceName){
                                        oCarrier = item;
                                    }
                                })
                            }
                            eshipjetModel.setProperty("/shipRateSelectItem", oCarrier);
                            let fuelAmount = (oCarrier && oCarrier.surCharges && oCarrier.surCharges.length > 0 ) ? oCarrier.surCharges[0].amount : "";
                            var aShippingCharges = [
                                { "description": "Freight Amount", "amount": parseInt(oCarrier.publishedFreight).toFixed(2), "currency": "USD" },
                                { "description": "Discount Amount", "amount": parseInt(oCarrier.discountFreight_Cal).toFixed(2), "currency": "USD" },
                                { "description": "Fuel", "amount": fuelAmount, "currency": "USD" }
                            ];
                            eshipjetModel.setProperty("/shippingCharges", aShippingCharges);
                            eshipjetModel.setProperty("/commonValues/ShipNowShipMethodSelectedKey", oCarrier.Carrier);
                            eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey", oCarrier.serviceCode);
                            eshipjetModel.setProperty("/commonValues/ShipNowSelectedServiceName", oCarrier.serviceName);
                            eshipjetModel.setProperty("/accountNumber", oCarrier.AccountNumber); 
                            eshipjetModel.setProperty("/carrierServiceName_dis",oCarrier.serviceName);
                        }else{
                            var aShippingCharges = [
                                { "description": "Freight Amount", "amount": "100.00", "currency": "USD" },
                                { "description": "Discount Amount", "amount": "80.00", "currency": "USD" },
                                { "description": "Fuel", "amount": "10.00", "currency": "USD" }
                            ];
                            eshipjetModel.setProperty("/shippingCharges", aShippingCharges);
                        }
                        

                    }
                }
                // oController.onCloseBusyDialog();
            },
            error: function (oError) {
                 reject();

    let errMsg = "Rate API Error";

    try {
        let parsed = JSON.parse(oError.responseText);
        errMsg = parsed.error?.message?.value || errMsg;
    } catch (e) {
        errMsg = "Rate API is temporarily unavailable (502 Bad Gateway)";
    }

    sap.m.MessageBox.error(errMsg);
    oController.onCloseBusyDialog();
            }
        });
    },


    onRecentShipmentsItemPress:function(oEvent){
        oController.onOpenBusyDialog();
        var oCurrentObj = oEvent.getSource().getBindingContext("eshipjetModel").getObject();
        var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");

        // var aShippingCharges = [
        //     { "description": "Freight Amount", "amount": oCurrentObj.Freightamt, "currency": oCurrentObj.Waerk },
        //     { "description": "Discount Amount", "amount": oCurrentObj.Discountamt, "currency": oCurrentObj.Waerk },
        //     { "description": "Fuel", "amount": oCurrentObj.Fuel, "currency": oCurrentObj.Waerk }
        // ];
        // eshipjetModel.setProperty("/shippingCharges", aShippingCharges);
        // eshipjetModel.updateBindings(true);

        var sDocumentNumber = oCurrentObj.Vbeln;
        
        oController.getOwnerComponent().getModel("eshipjetModel").setProperty("/commonValues/sapDeliveryNumber",sDocumentNumber);
        eshipjetModel.setProperty("/commonValues/shipNowGetBtn", true);
        
        eshipjetModel.setProperty("/commonValues/shipNowBtnStatus", false);
        eshipjetModel.setProperty("/commonValues/shipNowVoidSelectShipNow", false);
        eshipjetModel.setProperty("/commonValues/shipNowVoidSelect", true);

        oController.onShipNowGetPress();
        oController.onRecentShipmentClosePress();
        oController.getManifestHeaderForCharges()
    },


    onOpenShipNowShippinRateDialog:function(){    
        var oView = oController.getView();
        if (!oController.byId("_IDGenShipNowShppindRateDialog")) {
            Fragment.load({
                id: oView.getId(),
                name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.ShippingRates",
                controller: this // Pass the controller for binding
            }).then(function (oShippingDialog) {
                oView.addDependent(oShippingDialog);
                oShippingDialog.open();                
            });
        } else {
            this.byId("_IDGenShipNowShppindRateDialog").open(); 
        }
    },
    onCloseShipNowShippinRateDialog:function(){
        oController.byId("_ShippingRateTableId").removeSelections();
        this.byId("_IDGenShipNowShppindRateDialog").close();        
    },

    onPickCarrierSubmit:function(oEvent){
        var oTable  = oController.byId("_ShippingRateTableId"),        
        aSelectedItems = oTable.getSelectedItems(), oCarrier,
        sFromViewName = eshipjetModel.getProperty("/sFromViewName");
        // var RecentShipmentSet = oEshipjetModel.getData().RecentShipmentSet;
        // RecentShipmentSet[RecentShipmentSet.length-1]["Carrier"] = oCarrier.Carrier;
        // RecentShipmentSet["Carrier"] = oCarrier;

        if(aSelectedItems && aSelectedItems.length > 0){
            oCarrier = oTable.getSelectedItem().getBindingContext("eshipjetModel").getObject();
            oCarrier.discountFreight = oCarrier.discountFreight.toString();
            oCarrier.publishedFreight = oCarrier.publishedFreight.toString();
            // oCarrier.discountFreight_Cal = oCarrier.discountFreight_Cal.toString();

            eshipjetModel.setProperty("/shipRateSelectItem", oCarrier);  
            oController.oSelectObj = aSelectedItems[0].getBindingContext("eshipjetModel").getObject(); 
            eshipjetModel.setProperty("/commonValues/ShipNowShipMethodSelectedKey", oController.oSelectObj.Carrier.toUpperCase());
            eshipjetModel.setProperty("/commonValues/ShipNowSelectedServiceName", oController.oSelectObj.serviceName);

            oController.onShopNowShipMethodChangeFromQuoteNow(eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey"), oController.oSelectObj.serviceName);
            // eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey", oController._getShippingType(oController.oSelectObj.serviceCode));
            
            
            // eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey", oController.oSelectObj.serviceName);
            // eshipjetModel.setProperty("/accountNumber", oController.oSelectObj.AccountNumber); 
            // eshipjetModel.setProperty("/carrierServiceCode_display", oController.oSelectObj.serviceCode);
            // eshipjetModel.setProperty("/carrierServiceName_dis",oController.oSelectObj.serviceName);  
            
        if(sFromViewName === "QUOTE_NOW"){
            var sKey = "ShipNow";
                eshipjetModel.setProperty("/commonValues/toolPageHeader", false);
                eshipjetModel.setProperty("/commonValues/allViewsFooter", false);
                eshipjetModel.setProperty("/commonValues/shipNowViewFooter", true);
                eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
                eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
                eshipjetModel.setProperty("/showDarkThemeSwitch", false);
                eshipjetModel.setProperty("/commonValues/darkTheme", false);
                document.body.classList.remove("dark-theme");
                eshipjetModel.setProperty("/commonValues/shipNowGetBtn", true);
                eshipjetModel.setProperty("/sFromViewName", "SHIP_NOW");
                oController.onPackSectionEmptyRows();
            eshipjetModel.setProperty("/SideNavigation", false);
            this.byId("pageContainer").to(this.getView().createId(sKey));
            
            oController.onShipNowNavigateInitialProcess();
        }              
        }else{
            MessageToast.show("Please select the item from list");
        }   
        eshipjetModel.updateBindings(true);
        oController.onCloseShipNowShippinRateDialog();
    },

    onShopNowShipMethodChangeFromQuoteNow:function(selectedKey, serviceName){
        var eshipjetModel =  this.getOwnerComponent().getModel("eshipjetModel");
        var carrierconfiguration = eshipjetModel.getProperty("/carrierconfiguration1");
        var ShipNowShipMethodSelectedKey =  eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey");
        for(var i=0; i<carrierconfiguration.length; i++){
            if(carrierconfiguration[i].CarrierName === selectedKey){
                var serviceNamesList = new JSONModel(carrierconfiguration[i]);
                this.getView().setModel(serviceNamesList, "serviceNamesList");
            }
        };
        // eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey", oController.ShippingType);
        for(var i=0; i<serviceNamesList.getProperty("/carrierServices").length; i++){
            if(serviceNamesList.getProperty("/carrierServices")[i].ServiceName === serviceName){
                eshipjetModel.setProperty("/carrierServiceName_dis", serviceNamesList.getProperty("/carrierServices")[i].ServiceName);
                eshipjetModel.setProperty("/carrierServiceCode_display", serviceNamesList.getProperty("/carrierServices")[i].ServiceCode);
                eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey", serviceNamesList.getProperty("/carrierServices")[i].ShippingType);
            }
        };
        if(selectedKey === "UPS"){                
            eshipjetModel.setProperty("/accountNumber", "B24W72");                            
        }else{
            eshipjetModel.setProperty("/accountNumber", "740561073");                
        }              
        
        if (ShipNowShipMethodSelectedKey === "FEDEX"){
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", true );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );

        }else if(ShipNowShipMethodSelectedKey === "DHL"){
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", true );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
            
        }else if(ShipNowShipMethodSelectedKey === "FastFarwarder"){
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", true );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );

         }else if(ShipNowShipMethodSelectedKey === "Other"){

            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", true );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
         }else if(ShipNowShipMethodSelectedKey === "UPS"){

            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", true );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
         }else if(ShipNowShipMethodSelectedKey === "USPS"){
            
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", true );
         }else if(ShipNowShipMethodSelectedKey === "Gander & White"){
            
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
         }else if(ShipNowShipMethodSelectedKey === "ABF"){
            
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false  );
         }else if(ShipNowShipMethodSelectedKey === "ARTEX Fine Art Services"){
            
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
         }else if(ShipNowShipMethodSelectedKey === "ATLAS Fine Art"){
            
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
         }else if(ShipNowShipMethodSelectedKey === "Brinks Fine Art"){
            
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
         }else if(ShipNowShipMethodSelectedKey === "Crown Fine Art"){
            
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
         }else if(ShipNowShipMethodSelectedKey === "DTDC"){
            
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
         }else if(ShipNowShipMethodSelectedKey === "FedEx Freight"){
            
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
         }else if(ShipNowShipMethodSelectedKey === "Fine Art Shippers"){
            
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
         }else if(ShipNowShipMethodSelectedKey === "JPMorgan Chase Internal"){
            
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
         }else if(ShipNowShipMethodSelectedKey === "Malca-Amit"){
            
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
         }else if(ShipNowShipMethodSelectedKey === "Movi Group"){
            
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
         }else if(ShipNowShipMethodSelectedKey === "RL"){
            
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
         }else if(ShipNowShipMethodSelectedKey === "The Armory"){
            
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
         }
         else if(ShipNowShipMethodSelectedKey === "ABFS"){
            
            eshipjetModel.setProperty("/commonValues/shipNowGanderWhiteSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowABFSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowARTEXFineArtSrvSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowATLASFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowBrinksFineArtSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowCrownFineArtSelect", false ); 
            eshipjetModel.setProperty("/commonValues/shipNowDHLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowDTDCSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFastFarwarderSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowFedExFreightSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowJPMorganChaseInternalSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMalca_AmitSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowMoviGroupSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowOtherSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowRLSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowTheArmorySelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUPSSelect", false );
            eshipjetModel.setProperty("/commonValues/shipNowUSPSSelect", false );
         }
    },

    onPressCloseShipNow: function() {
        var oRouter = sap.ui.core.UIComponent.getRouterFor(this);
        oRouter.navTo("ShipRequestLabel"); // Replace with your actual route name
    },
    onViewNowPressBackToShipNow: function(oEvent){
        var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel") 
        var oCurrentObj = oEvent.getSource().getBindingContext("eshipjetModel").getObject();
        var sKey = "ShipNow";      
        // eshipjetModel.setProperty("/commonValues/sapDeliveryNumber",""); //80000001
        var oToolPage = this.byId("toolPage");
        oToolPage.setSideExpanded(false);
        eshipjetModel.setProperty("/shippingCharges",[]);
        eshipjetModel.setProperty("/shippingDocuments",[]);
        eshipjetModel.setProperty("/HandlingUnitItems",[]);
        eshipjetModel.setProperty("/HandlingUnits",[]);
        eshipjetModel.setProperty("/shippingDocuments",[]);
        // oController._handleDisplayShipNowPackTable();
        if (sKey === "ShipNow") {
            eshipjetModel.setProperty("/commonValues/toolPageHeader", false);
            eshipjetModel.setProperty("/commonValues/allViewsFooter", false);
            eshipjetModel.setProperty("/commonValues/shipNowViewFooter", true);
            eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
            eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
            eshipjetModel.setProperty("/showDarkThemeSwitch", false);
            eshipjetModel.setProperty("/commonValues/darkTheme", false);
            document.body.classList.remove("dark-theme");
            eshipjetModel.setProperty("/commonValues/shipNowGetBtn", true);
            eshipjetModel.setProperty("/sFromViewName", "SHIP_NOW");
            oController.onPackSectionEmptyRows();
        };
        eshipjetModel.setProperty("/SideNavigation", false);
        this.byId("pageContainer").to(this.getView().createId(sKey));
        // var trackingArray = eshipjetModel.getProperty("/trackingArray") || [];
        // var ShipNowDataModel = oController.getView().getModel("ShipNowDataModel");
        //     var shipFromObj = {
        //         "ShipFromCONTACT": oCurrentObj.FromContact,
        //         "ShipFromCOMPANY": oCurrentObj.FromCompany,
        //         "ShipFromPHONE": oCurrentObj.FromPhone,
        //         "ShipFromEMAIL": oCurrentObj.Emailaddress,
        //         "ShipFromCITY": oCurrentObj.Fromcity,
        //         "ShipFromSTATE": oCurrentObj.FromRegion,
        //         "ShipFromCOUNTRY": oCurrentObj.FromCountry,
        //         "ShipFromZIPCODE": oCurrentObj.FromPostalcode,
        //         "ShipFromADDRESS_LINE1": oCurrentObj.FromStreet,
        //         "ShipFromADDRESS_LINE2": oCurrentObj.FromStreet2,
        //         "ShipFromADDRESS_LINE3": ""
        //     };
        //     var shipToObj = {
        //         "FullName": oCurrentObj.RecContact,
        //         "BusinessPartnerName1": oCurrentObj.RecCompany,
        //         "PhoneNumber": oCurrentObj.RecPhone,
        //         "EMAIL": oCurrentObj.Emailaddress,
        //         "CityName": oCurrentObj.RecCity,
        //         "Region": oCurrentObj.RecRegion,
        //         "Country": oCurrentObj.RecCountry,
        //         "PostalCode": oCurrentObj.RecPostalcode,
        //         "StreetName": oCurrentObj.RecAddress1,
        //         "HouseNumber": oCurrentObj.RecAddress2,
        //         "ShipFromADDRESS_LINE3": ""
        //     };
        //     var handlingUnitObj = {
        //         "HandlingUnitExternalID": oCurrentObj.HandlingUnit,
        //         "SerialNumber": oCurrentObj.SerialNumber || "", 
        //         "PackagingMaterial": oCurrentObj.PackagingMaterial || "" 
        //     };
        //     eshipjetModel.setProperty("/HandlingUnits", [handlingUnitObj]);
            

        //     var trackingObj = {
        //         "COMPANY": oCurrentObj.Company,
        //         "CreatedDate" : oCurrentObj.Createddate,
        //         "ShipDate": oCurrentObj.DateAdded,
        //         "CarrierCode": oCurrentObj.CarrierCode,
        //         "ServiceName": oCurrentObj.CarrierDesc,
        //         "TrackingNumber": oCurrentObj.TrackingNumber,
        //         "TrackingStatus":  oCurrentObj.Shipprocess,
        //         "SHIP_TO_CONTACT": oCurrentObj.Company,
        //         "SHIP_TO_COMPANY": oCurrentObj.Contact,
        //     };
        //     trackingArray.push(trackingObj);
        //     eshipjetModel.setProperty("/trackingArray", trackingArray);
        //     ShipNowDataModel.setProperty("/ShipFromAddress", shipFromObj);
        //     ShipNowDataModel.setProperty("/ShipToAddress", shipToObj);

        //     var shippingChargesArray = eshipjetModel.getProperty("/shippingCharges") || [];
        //     var shippingChargesObj1 = {
        //         description: "Freight Amount",
        //         amount: oCurrentObj.Freightamt || "0.00",
        //         currency: oCurrentObj.Waerk
        //     };
        //     var shippingChargesObj2 = {
        //         description: "Discount Amount",
        //         amount: oCurrentObj.Discountamt || "0.00",
        //         currency: oCurrentObj.Waerk
        //     };
        //     var shippingChargesObj3 = {
        //         description: "Fuel",
        //         amount: oCurrentObj.Fuel || "0.00",
        //         currency:oCurrentObj.Waerk
        //     };

        //     shippingChargesArray.push(shippingChargesObj1, shippingChargesObj2, shippingChargesObj3);
        //     eshipjetModel.setProperty("/shippingCharges", shippingChargesArray);

        //     var packUrl = oCurrentObj.PackURL || "";
        //     var packDocType = packUrl.split('.').pop().toUpperCase();

        //     var labelUrl = oCurrentObj.Labelurl || "";
        //     var labelDocType = labelUrl.split('.').pop().toUpperCase();

        //     var shippingDocuments = [
        //         {
        //             srNo: 1,
        //             docProvider: oCurrentObj.CarrierCode,
        //             docType: labelDocType,  
        //             contentType: "Label",
        //             docURL: labelUrl
        //         },
        //         {
        //             srNo: 2,
        //             docProvider: "Eshipjet",
        //             docType: packDocType, 
        //             contentType: "Packing Slip",
        //             docURL: packUrl
        //         }
        //     ];

        //     eshipjetModel.setProperty("/shippingDocuments", shippingDocuments);
        var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
        var sDocumentNumber = oCurrentObj.Vbeln;
        oController.getOwnerComponent().getModel("eshipjetModel").setProperty("/commonValues/sapDeliveryNumber",sDocumentNumber);
        eshipjetModel.setProperty("/commonValues/shipNowGetBtn", true);
        oController.onShipNowGetPress();
    },

    
    // add onAddAddPaymentTypes popover changes start
    onAddAddDangerousGoodsPress: function (oEvent) {
        var oButton = oEvent.getSource(),
            oView = this.getView();
        if (!this._AddDangerousGoodsPopover) {
            this._AddDangerousGoodsPopover = Fragment.load({
                id: oView.getId(),
                name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.AddDangerousGoodsPopover",
                controller: this
            }).then(function (oAddDangerousGoodsPopover) {
                oView.addDependent(oAddDangerousGoodsPopover);
                return oAddDangerousGoodsPopover;
            });
        }
        this._AddDangerousGoodsPopover.then(function (oAddDangerousGoodsPopover) {
            oAddDangerousGoodsPopover.openBy(oButton);
        });
    },
    AddDangerousGoodsClosePress: function () {
        this.byId("idAddDangerousGoodsPopover").close();
    },
    AddDangerousGoodsCancelPopover: function () {
        this.byId("idAddDangerousGoodsPopover").close();
    },

    AddDangerousGoodsSelectPopover: function () {
        this.byId("idAddDangerousGoodsPopover").close();
    },

    onOpenSAPDeliveryList:function(oEvent){
        var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._pShipNowSAPDeliveryPopover) {
                this._pShipNowSAPDeliveryPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SAPDeliveryList",
                    controller: this
                }).then(function (oShipNowSAPDeliveryPopover) {
                    oView.addDependent(oShipNowSAPDeliveryPopover);
                    return oShipNowSAPDeliveryPopover;
                });
            }
            this._pShipNowSAPDeliveryPopover.then(function (oShipNowSAPDeliveryPopover) {
                oShipNowSAPDeliveryPopover.openBy(oButton);
            });
        },

        onSAPDeliveryNoSelect:function(oEvent){
            var oSelectedItem = oEvent.getParameter("listItem").getTitle();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/SAPDeliveryNo", oSelectedItem);
            var oShipNowSAPDeliveryPopover = this.byId("idSAPDeliveryPopover"); // For fragments use `this.byId`
            if (oShipNowSAPDeliveryPopover) {
                oShipNowSAPDeliveryPopover.close();
            }
        },

        onObtainProofOfDeliveryPress:function(oEvent){
            var TrackingNumberTableRows = eshipjetModel.getProperty("/TrackingNumberTableRows");
            var sFilePath, oLink, sDownloadFileName; 
            if(TrackingNumberTableRows.CarrierCode.toUpperCase() === "UPS"){    
                sFilePath = "https://eshipjet-products-dev.s3.us-east-1.amazonaws.com/Tracking+_+UPS+-+India.pdf";			
                sDownloadFileName = "UPS_Tracking.pdf";             
            }else if(TrackingNumberTableRows.CarrierCode.toUpperCase() === "FEDEX"){
                sFilePath = "https://eshipjet-products-dev.s3.us-east-1.amazonaws.com/Fedex+POD.pdf";
                sDownloadFileName = "FedEx_Tracking.pdf";
            }   
            oLink = document.createElement("a");
            oLink.href = sFilePath;
            oLink.target = "_blank";
            oLink.download = sDownloadFileName; // Set the downloaded filename
            document.body.appendChild(oLink);
            oLink.click();
            document.body.removeChild(oLink);             
        },
        onOpenValidateAddressDialog: function() {
            var oView = this.getView();
            var ShipNowDataModel =  oController.getView().getModel("ShipNowDataModel");
            var eshipjetModel =  oController.getView().getModel("eshipjetModel");

            var that = this;
            var idServiceName = oController.getView().byId("idServiceName");
            var carrier = eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey");
            var id,password,accountNumber;
            if(carrier && carrier.toUpperCase() === "UPS"){
                id = "6ljUpEbuu1OlOk7ow932lsxXHISUET0WKjTn59GzQ5MRdEbA";
                password = "ioZmsfcbrzlWfGh7wGMhqHL6sY4EAaKzZObullipni0cEGJGChjFmGpkcdCWQynK";
                accountNumber = "B24W72";
            }else if(carrier && carrier.toUpperCase() === "FEDEX"){
                 id = "l70c717f3eaf284dc9af42169e93874b6e";
                 password = "7f271bf486084e8f8073945bb7e6a020";
                 accountNumber = "740561073";
            }else if(carrier && carrier.toUpperCase() === "DHL"){
                 id = "apT2vB7mV1qR1b";
                 password = "U#3mO^1vY!5mT@0j";
            }else if(carrier && carrier.toUpperCase() === "USPS"){
                id = "3087617";
                password = "October2024!";
            }else if(carrier && carrier.toUpperCase() === "ABFS"){
                id = "ABFESHIPJET";
                password = "Legacy!@3";
            }

        
            var fnCallAddressValidationAPI = function() {
                var oPayload = {
                    "ShipTo": {
                        "COMPANY": ShipNowDataModel.getProperty("/ShipToAddress/BusinessPartnerName1"),
                        "CONTACT": ShipNowDataModel.getProperty("/ShipToAddress/FullName"),
                        "ADDRESS_LINE1": ShipNowDataModel.getProperty("/ShipToAddress/StreetName"),
                        "ADDRESS_LINE2": ShipNowDataModel.getProperty("/ShipToAddress/HouseNumber"),
                        "ADDRESS_LINE3": "",
                        "AddressType": ShipNowDataModel.getProperty("/ShipToAddress/LocationType"),
                        "CITY": ShipNowDataModel.getProperty("/ShipToAddress/CityName"),
                        "STATE": ShipNowDataModel.getProperty("/ShipToAddress/Region"),
                        "ZIPCODE":ShipNowDataModel.getProperty("/ShipToAddress/PostalCode"),
                        "COUNTRY": ShipNowDataModel.getProperty("/ShipToAddress/Country"),
                        "PHONE": ShipNowDataModel.getProperty("/ShipToAddress/PhoneNumber"),
                        "EMAIL": ShipNowDataModel.getProperty("/ShipToAddress/EMAIL"),
                    },
                    "CarrierDetails": {
                        // "Carrier": carrier,
                        // "ServiceName": idServiceName.getSelectedItem().getText(),
                        // "PaymentType": eshipjetModel.getProperty("/CarrierDetails/PaymentType"),
                        // "ShippingAccount":accountNumber,
                        // "UserId": id,
                        // "Password": password,
                        "Carrier": "FedEx",
                        "ServiceName": "FEDEX_GROUND",
                        "PaymentType": "Sender",
                        "ShippingAccount": "740561073",
                        "UserId": "l70c717f3eaf284dc9af42169e93874b6e",
                        "Password": "7f271bf486084e8f8073945bb7e6a020"
                    }
                };
        
                $.ajax({
                    url: "https://drivemedical-carrier-api-v1.eshipjet.site/AddressValidation",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(oPayload),
                    success: function(oResponse) {
                        console.log("API Success:", oResponse);
                         // Get the existing model or create one
                            var oModel = that.getView().getModel("ShipNowDataModel");
                            if (!oModel) {
                                oModel = new sap.ui.model.json.JSONModel();
                                that.getView().setModel(oModel, "ShipNowDataModel");
                            }
                            // Set the VerifiedAddress part of the model
                            oModel.setProperty("/VerifiedAddress", oResponse.VerifiedAddress);
                           // COMPANY
                            var oEnterCompany = oController.byId("idEnteredCOMPANY");
                            var EnterCompany = oEnterCompany.getText();

                            var oVerifiedCompany = oController.byId("idVerifiedCOMPANY");
                            var VerifiedCompany = oVerifiedCompany.getText();

                            oEnterCompany.removeStyleClass("mismatch");
                            oVerifiedCompany.removeStyleClass("mismatch");
                            oEnterCompany.removeStyleClass("normal");
                            oVerifiedCompany.removeStyleClass("normal");

                            if (EnterCompany === VerifiedCompany) {
                                oEnterCompany.addStyleClass("normal");
                                oVerifiedCompany.addStyleClass("normal");
                            } else {
                                oEnterCompany.addStyleClass("mismatch");
                                oVerifiedCompany.addStyleClass("mismatch");
                            }

                            // STREET
                            var oEnterStreet = oController.byId("idEnteredStreet");
                            var EnterStreet = oEnterStreet.getText();

                            var oVerifiedStreet = oController.byId("idVerifiedStreet");
                            var VerifiedStreet = oVerifiedStreet.getText();

                            oEnterStreet.removeStyleClass("mismatch");
                            oVerifiedStreet.removeStyleClass("mismatch");
                            oEnterStreet.removeStyleClass("normal");
                            oVerifiedStreet.removeStyleClass("normal");

                            if (EnterStreet === VerifiedStreet) {
                                oEnterStreet.addStyleClass("normal");
                                oVerifiedStreet.addStyleClass("normal");
                            } else {
                                oEnterStreet.addStyleClass("mismatch");
                                oVerifiedStreet.addStyleClass("mismatch");
                            }

                            // CITY
                            var oEnterCity = oController.byId("idEnteredCity");
                            var EnterCity = oEnterCity.getText();

                            var oVerifiedCity = oController.byId("idVerifiedCity");
                            var VerifiedCity = oVerifiedCity.getText();

                            oEnterCity.removeStyleClass("mismatch");
                            oVerifiedCity.removeStyleClass("mismatch");
                            oEnterCity.removeStyleClass("normal");
                            oVerifiedCity.removeStyleClass("normal");

                            if (EnterCity === VerifiedCity) {
                                oEnterCity.addStyleClass("normal");
                                oVerifiedCity.addStyleClass("normal");
                            } else {
                                oEnterCity.addStyleClass("mismatch");
                                oVerifiedCity.addStyleClass("mismatch");
                            }

                            
                    },
                    error: function(err) {
                        sap.m.MessageToast.show("Address validation failed.");
                    }
                });
            };
            // var oModel = this.getView().getModel("ShipNowDataModel");

            // var oEntered = oModel.getProperty("/ShipToAddress");
            // var oVerified = oModel.getProperty("/VerifiedAddress");
            
            // oModel.setProperty("/UI/IsDifferentCompany", oEntered?.BusinessPartnerName1 !== oVerified?.COMPANY);
            // oModel.setProperty("/UI/IsDifferentStreet", oEntered?.StreetName !== oVerified?.ADDRESS_LINE1);
            // oModel.setProperty("/UI/IsDifferentCity", oEntered?.CityName !== oVerified?.CITY);
            

        
            if (!this.byId("addressVerificationDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.SpecialOptions.ValidateAddressDialog",
                    controller: this
                }).then(function(oDialog) {
                    oView.addDependent(oDialog);
                    oDialog.open();
                    fnCallAddressValidationAPI(); // Call API after dialog opens
                });
            } else {
                this.byId("addressVerificationDialog").open();
                fnCallAddressValidationAPI(); // Call API immediately
            }
        },
        onCloseValidateAddressDialog: function() {
            this.byId("addressVerificationDialog").close();
        },

        onUpdateValidateAddressDialog: function () {
            var oModel = this.getView().getModel("ShipNowDataModel");
            var oVerified = oModel.getProperty("/VerifiedAddress");
        
            if (oVerified) {
                oModel.setProperty("/ShipToAddress/BusinessPartnerName1", oVerified.COMPANY || "");
                oModel.setProperty("/ShipToAddress/StreetName", oVerified.ADDRESS_LINE1 || "");
                oModel.setProperty("/ShipToAddress/CityName", oVerified.CITY || "");
        
                sap.m.MessageToast.show("Ship To Address updated from verified address.");
                this.onCloseValidateAddressDialog();
            } else {
                sap.m.MessageToast.show("Verified address not found.");
            }
        },
        getManifestHeaderForScanShip:function(sUserMessage){
            oController.onOpenBusyDialog();
            return new Promise(function (resolve, reject) {
                var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
                var sDeveliveryNumber = eshipjetModel.getProperty("/sShipAndScan");
                var ManifestSrvModel = oController.getOwnerComponent().getModel("ManifestSrvModel");
                var aFilters = [
                    new sap.ui.model.Filter("Vbeln", sap.ui.model.FilterOperator.EQ, sDeveliveryNumber)
                ];

                ManifestSrvModel.read("/EshipjetManfestSet",{
                    filters: aFilters,
                    success:function(response){
                        if(response && response.results.length > 0){                           
                                sUserMessage = sUserMessage.trim().toLowerCase();
                                var text = response.results[0].Labelurl;
                                const aMessages = oShipperCopilotModel.getProperty("/messages");
                                if (sUserMessage.indexOf("ship") !== -1) { 
                                    aMessages.push({ sender: "Bot", imageSrc: text, hasTableData:false, hasCountryTableData:false, hasTrackTableData:false, isBotImage:true});
                                    oShipperCopilotModel.setProperty("/messages", aMessages);
                                }

                                if (sUserMessage.indexOf("track") !== -1) { 
                                    aMessages.push({ sender: "Bot", imageSrc: "", TrackTableData:response.results, hasTableData:false, hasCountryTableData:false, hasTrackTableData:true, isBotImage:false});
                                    oShipperCopilotModel.setProperty("/messages", aMessages);
                                }
                                eshipjetModel.setProperty("/scanShipTableData2", response.results);
                                eshipjetModel.setProperty("/sShipAndScan", "");
                        }else{
                            oController.createShipmentFromScanShip();
                        }
                        resolve();
                        oController.onCloseBusyDialog();
                    },
                    error: function(error){
                        MessageBox.warning(error.responseText);
                        reject();
                        oController.onCloseBusyDialog();
                    }
                });
            });
        },

        onShipperCopilotTrackPress: function (oEvent) {
            var oView = this.getView();
            var oCurrentObject = oEvent.getSource().getBindingContext("ShipperCopilotModel").getObject();
			var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
			oCurrentObject["StandardTransit"]= "01/31/25 before 2:39 PM";
            oCurrentObject["Delivered"] = "01/31/25 at 2:39 PM";
            oCurrentObject["SignedBy"] = "Stephen";
            oCurrentObject["ServiceName"] =  eshipjetModel.getProperty("/carrierServiceName_dis");
			eshipjetModel.setProperty("/TrackingNumberTableRows",oCurrentObject);
            var sUrl;
            //Hardcoding values
            var aTravelHistoryData = eshipjetModel.getProperty("/ShipmentTravelHistoryRows");
            if(oCurrentObject.CarrierCode.toUpperCase() === "FEDEX"){
                sUrl = "https://drivemedical.eshipjet.site/next-gen-tracking?Carrier=Fedex&TrackingNumber="+oCurrentObject.TrackingNumber;
                aTravelHistoryData.forEach(function(item, idx){
                    item.Status = item.Status.replace("UPS", oCurrentObject.CarrierCode);
                });   
                oController.TrackDialogWithUrl();             
            }else if(oCurrentObject.CarrierCode.toUpperCase() === "UPS"){
                sUrl = "https://drivemedical.eshipjet.site/next-gen-tracking?Carrier=UPS&TrackingNumber="+oCurrentObject.TrackingNumber;
                aTravelHistoryData.forEach(function(item, idx){
                    item.Status = item.Status.replace("FedEx", oCurrentObject.CarrierCode);
                });
                oController.TrackDialogWithUrl();
            }else{
                oController.TrackDialogWithOutUrl();
            };
            eshipjetModel.setProperty("/ShipmentTravelHistoryRows", aTravelHistoryData);
            eshipjetModel.setProperty("TrackingdisplayUrl", sUrl);
		},
        
        createShipmentFromScanShip: async function () {
            oController.onOpenBusyDialog();
            var sShipAndScanDeliveryNum = eshipjetModel.getProperty("/sShipAndScan");
            eshipjetModel.setProperty("/sFromViewName", "SCAN_SHIP");
            if (sShipAndScanDeliveryNum && sShipAndScanDeliveryNum.length > 0) {
                eshipjetModel.setProperty("/commonValues/sapDeliveryNumber", sShipAndScanDeliveryNum);
                try {
                    await oController.onShipNowGetPress();
                    // oController.onShipNowPress();
                } catch (error) {
                    console.error("Error occurred:", error);
                }
            }
        },


        onScanShipViewPressBackToShipNow:function(oEvent){
            var oCurrentObj = oEvent.getSource().getBindingContext("eshipjetModel").getObject();
            var sKey = "ShipNow";      
            eshipjetModel.setProperty("/commonValues/sapDeliveryNumber",""); //80000001
            var oToolPage = this.byId("toolPage");
            
            oToolPage.setSideExpanded(false);
            eshipjetModel.setProperty("/shippingCharges",[]);
            eshipjetModel.setProperty("/shippingDocuments",[]);
            eshipjetModel.setProperty("/HandlingUnitItems",[]);
            eshipjetModel.setProperty("/HandlingUnits",[]);
            eshipjetModel.setProperty("/shippingDocuments",[]);
            eshipjetModel.setProperty("/commonValues/toolPageHeader", false);
            eshipjetModel.setProperty("/commonValues/allViewsFooter", false);
            eshipjetModel.setProperty("/commonValues/shipNowViewFooter", true);
            eshipjetModel.setProperty("/commonValues/createShipReqViewFooter", false);
            eshipjetModel.setProperty("/commonValues/routingGuidFooter", false);
            eshipjetModel.setProperty("/showDarkThemeSwitch", false);
            eshipjetModel.setProperty("/commonValues/darkTheme", false);
            document.body.classList.remove("dark-theme");
            eshipjetModel.setProperty("/commonValues/shipNowGetBtn", true);
            oController.onPackSectionEmptyRows();

            eshipjetModel.setProperty("/SideNavigation", false);
            this.byId("pageContainer").to(this.getView().createId(sKey));


            var ShipNowDataModel = oController.getView().getModel("ShipNowDataModel");
            var shipFromObj = {
                "ShipFromCONTACT": oCurrentObj.FromContact,
                "ShipFromCOMPANY": oCurrentObj.FromCompany,
                "ShipFromPHONE": oCurrentObj.FromPhone,
                "ShipFromEMAIL": oCurrentObj.Emailaddress,
                "ShipFromCITY": oCurrentObj.Fromcity,
                "ShipFromSTATE": oCurrentObj.FromRegion,
                "ShipFromCOUNTRY": oCurrentObj.FromCountry,
                "ShipFromZIPCODE": oCurrentObj.FromPostalcode,
                "ShipFromADDRESS_LINE1": oCurrentObj.FromStreet,
                "ShipFromADDRESS_LINE2": oCurrentObj.FromStreet2,
                "ShipFromADDRESS_LINE3": ""
            };
            var shipToObj = {
                "FullName": oCurrentObj.RecContact,
                "BusinessPartnerName1": oCurrentObj.RecCompany,
                "PhoneNumber": oCurrentObj.RecPhone,
                "EMAIL": oCurrentObj.Emailaddress,
                "CityName": oCurrentObj.RecCity,
                "Region": oCurrentObj.RecRegion,
                "Country": oCurrentObj.RecCountry,
                "PostalCode": oCurrentObj.RecPostalcode,
                "StreetName": oCurrentObj.RecAddress1,
                "HouseNumber": oCurrentObj.RecAddress2,
                "ShipFromADDRESS_LINE3": ""
            };
            ShipNowDataModel.setProperty("/ShipFromAddress", shipFromObj);
            ShipNowDataModel.setProperty("/ShipToAddress", shipToObj);

            eshipjetModel.setProperty("/commonValues/ShipNowShipMethodSelectedKey", oCurrentObj.Carriertype);
            eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey", oCurrentObj.CarrierDesc);
            eshipjetModel.setProperty("/accountNumber", oCurrentObj.Accountnumber);
        },


        // getTodayShipments: function () {
        //     oController.onOpenBusyDialog();
        //     var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
        //     var ManifestModel = oController.getOwnerComponent().getModel("ManifestModel");
        
        //     ManifestModel.read("/Manifest_detSet", {
        //         success: function (response) {
        //             if (response && response.results.length > 0) {
        //                 const today = new Date();
        //                 today.setHours(0, 0, 0, 0);

        //                 const filteredResults = response.results.filter(item => {
        //                     const timestamp = parseInt(item.CreatedOn.replace(/\/Date\((\d+)\)\//, '$1'));
        //                     const itemDate = new Date(timestamp);
        //                     itemDate.setHours(0, 0, 0, 0);

        //                     return itemDate.getTime() === today.getTime();
        //                 });

        //                 filteredResults.sort((a, b) => {
        //                     const dateA = parseInt(a.CreatedOn.replace(/\/Date\((\d+)\)\//, '$1'));
        //                     const dateB = parseInt(b.CreatedOn.replace(/\/Date\((\d+)\)\//, '$1'));
        //                     return dateB - dateA;
        //                 });

        //                 // Normalize ShipmentType
        //                 filteredResults.forEach(item => {
        //                     let shipmentValue = item.Type || item.Shipmenttype || item.ShipmentType;
        //                     if (shipmentValue && typeof shipmentValue === "string") {
        //                         shipmentValue = shipmentValue.trim().toUpperCase();
        //                         item.Shipmenttype = shipmentValue === 'O' ? "Parcel" : "LTL";
        //                     } else {
        //                         item.Shipmenttype = "LTL";
        //                     }
        //                 });

        //                 eshipjetModel.setProperty("/TodayShipmentsLength", filteredResults.length);
        //             }
        //             oController.onCloseBusyDialog();
        //         },
        //         error: function (error) {
        //             MessageBox.warning(error.message);
        //             oController.onCloseBusyDialog();
        //         }
        //     });
        // },


        _waitForCarrierIdentity: function () {
            const m = this.getOwnerComponent().getModel("eshipjetModel");

            return new Promise(resolve => {
                const spin = () => {
                    const ctx = m.getProperty("/selectedCarrierAccountsData");
                    if (ctx && ctx.CarrierCode) {
                        resolve(ctx);
                    } else {
                        setTimeout(spin, 60);
                    }
                };
                spin();
            });
        },


        onShipNowVoidPress: async function () {
            const m = this.getOwnerComponent().getModel("eshipjetModel");
            this.onOpenBusyDialog();

            const carrier = m.getProperty("/commonValues/ShipNowShipMethodSelectedKey");

            this.onGetCarrierNamesDataForDropDown(carrier);   // fire identity fetch

            const carrierCtx = await this._waitForCarrierIdentity();   // block until ready

            const tracking = m.getProperty("/trackingArray")[0].TrackingNumber;

            const payload = {
                CarrierDetails: {
                    Carrier: carrierCtx.CarrierCode,
                    UserId: carrierCtx.UserId,
                    Password: carrierCtx.Password,
                    Reference1: eshipjetModel.getProperty("/commonValues/sapDeliveryNumber"),
                    ShippingAccount: carrierCtx.AcntNmbr,
                    TokenURL: carrierCtx.TokenUrl,
                    VoidURL: carrierCtx.VoidUrl
                },
                Packages: [{ TrackingNumber: tracking }]
            };

            const url = carrier === "ABFS"
                ? "https://carrier-api-v1.eshipjet.site/ABFvoid"
                : `https://carrier-api-v1.eshipjet.site/${carrier}void`;

            $.ajax({
                url,
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(payload),
                success: (oData) => {
                    oController.onCancelUpdateToManifestHeaderSet("CANC");
                    oController.onCloseBusyDialog();
                    // if(oData.status === "Success"){
                    //     oController.shipStstusUpdateToManifestHeaderSet("CANC");
                    //     oController.onCloseBusyDialog();
                    // }else if(oData.status === "Error"){
                    //     sap.m.MessageBox.error(
                    //         oData.Errors[0],
                    //         { title: "Void Rejected." });
                    //     oController.onCloseBusyDialog();
                    // }
                },
                error: (oError) => this.onCloseBusyDialog()
            });
        },

        onCancelUpdateToManifestHeaderSet:function(){
            var sapDeliveryNumber = eshipjetModel.getProperty("/commonValues/sapDeliveryNumber");
            var ManifestModel = oController.getOwnerComponent().getModel("ManifestModel");
            var oPayload = {
                "Vbeln": sapDeliveryNumber,
                "CancTstamp": {
                    ms : (
                    (new Date().getHours() * 3600000) +
                    (new Date().getMinutes() * 60000) +
                    (new Date().getSeconds() * 1000) +
                    new Date().getMilliseconds()
                    ),
                    __edmType : "Edm.Time"
                }
            }

            ManifestModel.update(
                "/ManifestHeaderSet('" + sapDeliveryNumber + "')",   // entity key
                oPayload,
                {
                    merge: false,      // force full state rewrite = true Void
                    success: function () {
                        sap.m.MessageToast.show("Shipment successfully VOIDED");
                    },
                    error: function (oError) {
                        sap.m.MessageBox.error(
                            JSON.parse(oError.responseText).error.message.value
                        );
                    }
                }
            );
        },


        shipStstusUpdateToManifestHeaderSet: function (shipStatus) {
            var amount, Discountamt, Fuel;
            var sapDeliveryNumber = eshipjetModel.getProperty("/commonValues/sapDeliveryNumber");
            var SalesOrder = eshipjetModel.getProperty("commonValues/SalesOrder");
            var PurchaseOrder = eshipjetModel.getProperty("commonValues/PurchaseOrder");
            var ShipReadDataSrvModel = oController.getOwnerComponent().getModel("ShipReadDataSrvModel");
            var shippingCharges = eshipjetModel.getProperty("/shippingCharges");
            shippingCharges.forEach(function(item, idx){
                if(item.description === "Published Freight"){
                    amount = item.amount;
                }else if(item.description === "Discount Freight"){
                    Discountamt = item.amount;
                }else {
                    Fuel = item.amount;
                }
            })
            // var amount = eshipjetModel.getProperty("/shippingCharges/0/amount") ? eshipjetModel.getProperty("/shippingCharges/0/amount") : "0" ;
            // let percentage = (20 / 100) * amount;
            // var Discountamt = eshipjetModel.getProperty("/shippingCharges/1/amount");
            let time = new Date();
            time.setMinutes(time.getMinutes() + 10);
            let SAPDate = "/Date(" + time.getTime() + ")/";
            var date = new Date();
            let hours = String(date.getHours()).padStart(2, '0');
            let minutes = String(date.getMinutes()).padStart(2, '0');
            let seconds = String(date.getSeconds()).padStart(2, '0');
            var timeAdded = `PT${hours}H${minutes}M${seconds}S`;
            var packAddProductTable = eshipjetModel.getProperty("/commonValues/packAddProductTable");
            var HandlingUnitsLength = eshipjetModel.getProperty("/HandlingUnitsLength");
            if (HandlingUnitsLength === "0" || HandlingUnitsLength === 0) {
                HandlingUnitsLength = 1
            };
            var grossWeight, shippingDocName, packingSlip, billOfLading;
            var ShipNowDataModel = oController.getView().getModel("ShipNowDataModel");
            var shippingDocuments = eshipjetModel.getProperty("/shippingDocuments");
            var aHandlingUnits = eshipjetModel.getProperty("/HandlingUnits");
            var oManifestDataObj = {}, aManifestData = [];
            var aHUnitsFilterData = aHandlingUnits.filter(function (item) {
                 return item.HandlingUnitReferenceDocument === sapDeliveryNumber;
            });            
            grossWeight = eshipjetModel.getProperty("/commonValues/packAddProductTable/0/ItemGrossWeight");
            var trackingArray = eshipjetModel.getProperty("/trackingArray");
            
            oManifestDataObj =  {
                "Saturdaydel": eshipjetModel.getProperty("/SaturdayDelivery"),
                "Residentialdel": eshipjetModel.getProperty("/ResidentialDelivery"),
                "Priorityalert": eshipjetModel.getProperty("/PriorityAlert"),
                "Satpickup": eshipjetModel.getProperty("/SaturdayPickup"),
                "Insidedel": eshipjetModel.getProperty("/InsideDelivery"),
                "Insidepickup": eshipjetModel.getProperty("/InsidePickup"),
                "Liftgate": false,
                "Hold": eshipjetModel.getProperty("/HoldAtLocation"),
                "Dghazmat": false,
                "CodFlag": false,
                "Closeout": false,
                "Upsoffline": false,
                "ArrivalNotification": false,
                "Bsoflag": false,
                "Documents": false,
                "LimitedAccess": false,
                "Fedexonerate": false,
                "Crossdock": false,
                "Ddo": false,
                "Isc": false,
                "Appointment": false,
                "CrossdockRecdate": SAPDate,
                "PodDate": SAPDate,
                "DateAdded": SAPDate,
                "Createddate": SAPDate,
                // "CancDt": "/Date(1734480000000)/",
                "CancTim": {
                    ms : (
                    (new Date().getHours() * 3600000) +
                    (new Date().getMinutes() * 60000) +
                    (new Date().getSeconds() * 1000) +
                    new Date().getMilliseconds()
                    ),
                    __edmType : "Edm.Time"
                },
                "PackageWeight": grossWeight,
                "Chargweight": grossWeight,
                "Codamount": "0.00",
                "Customs": "0.00",
                "Freightamt": amount ? amount.toString() : "0.00" ,
                "Discountamt": Discountamt ?  Discountamt.toString() : "0.00",
                "Insurance": "0.00",
                "Dryweight": "0.000",
                "Mandt": "200",
                "Vbeln": sapDeliveryNumber,
                "Posnr": "",
                "Plant": eshipjetModel.getProperty("/PlantCode"),
                "Shipmenttype": "O",
                "Pkgcount": HandlingUnitsLength ? HandlingUnitsLength.toString() : "0",
                "MultiSeq": "1",
                "MultiLegno": "0",
                "Totalpkg": HandlingUnitsLength ? HandlingUnitsLength.toString() : "0",
                "HandlingUnit": "10006973",
                "SalesOrder": SalesOrder ? SalesOrder : "",
                "PurchaseOrder": PurchaseOrder ? PurchaseOrder : "",
                "TrackingNumber": eshipjetModel.getProperty("/trackingArray/0/TrackingNumber"),
                "Mastertracking": eshipjetModel.getProperty("/trackingArray/0/TrackingNumber"),
                "Uspstracking": "",
                "Iorcode": "",
                "Externaldoc": "",
                "CarrierCode": eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey"),
                "Carriertype": eshipjetModel.getProperty("/commonValues/ShipNowShipMethodSelectedKey"),
                "CarrierDesc": eshipjetModel.getProperty("/carrierServiceName_dis"),
                "Paymentcode": "Sender",
                "Shipperacct": eshipjetModel.getProperty("/accountNumber"),
                "Accountnumber": eshipjetModel.getProperty("/accountNumber"),
                "Dutytaxpaytype": "SENDER",
                "Dtaccountnumber": "",
                "Dimensions": "10X12X12",
                "Aesitn": "",
                "Vhilm": eshipjetModel.getProperty("/selectedPackageMat"),
                "Emailaddress": "",
                "Signaturetype": "",
                "RecCompany": ShipNowDataModel.getProperty("/ShipToAddress/BusinessPartnerName1"),
                "RecContact": ShipNowDataModel.getProperty("/ShipToAddress/FullName"),
                "RecAddress1": ShipNowDataModel.getProperty("/ShipToAddress/StreetName"),
                "RecAddress2": ShipNowDataModel.getProperty("/ShipToAddress/HouseNumber"),
                "RecAddress3": "null",
                "RecCity": ShipNowDataModel.getProperty("/ShipToAddress/CityName"),
                "RecRegion": ShipNowDataModel.getProperty("/ShipToAddress/Region"),
                "RecPostalcode": ShipNowDataModel.getProperty("/ShipToAddress/PostalCode"),
                "RecCountry": ShipNowDataModel.getProperty("/ShipToAddress/Country"),
                "RecPhone": ShipNowDataModel.getProperty("/ShipToAddress/PhoneNumber"),
                "Company": ShipNowDataModel.getProperty("/ShipToAddress/BusinessPartnerName1"),
                "Contact": ShipNowDataModel.getProperty("/ShipToAddress/FullName"),
                "Address1": ShipNowDataModel.getProperty("/ShipToAddress/StreetName"),
                "Address2": ShipNowDataModel.getProperty("/ShipToAddress/HouseNumber"),
                "Address3": "null",
                "City": ShipNowDataModel.getProperty("/ShipToAddress/CityName"),
                "Region": ShipNowDataModel.getProperty("/ShipToAddress/Region"),
                "Postalcode": ShipNowDataModel.getProperty("/ShipToAddress/PostalCode"),
                "Country": ShipNowDataModel.getProperty("/ShipToAddress/Country"),
                "Phone": ShipNowDataModel.getProperty("/ShipToAddress/PhoneNumber"),
                "Stceg": "",
                "PodSignature": "",
                "PodLocation": "",
                "PodActivity": "",
                "Podstatus": "",
                "Podcurrentstatus": "",
                "Podexpstatus": "",
                "ReturnTrack": "",
                "FromCompany": ShipNowDataModel.getProperty("/ShipFromAddress/ShipFromCOMPANY"),
                "FromContact": ShipNowDataModel.getProperty("/ShipFromAddress/ShipFromCONTACT"),
                "FromStreet": ShipNowDataModel.getProperty("/ShipFromAddress/ShipFromADDRESS_LINE1"),
                "Fromcity": ShipNowDataModel.getProperty("/ShipFromAddress/ShipFromCITY"),
                "FromPostalcode": ShipNowDataModel.getProperty("/ShipFromAddress/ShipFromZIPCODE"),
                "FromCountry": ShipNowDataModel.getProperty("/ShipFromAddress/ShipFromCOUNTRY"),
                "FromPhone": ShipNowDataModel.getProperty("/ShipFromAddress/ShipFromPHONE"),
                "EnteredBy": "dm_atla",
                "Sammg": "",
                "Lifnr": "",
                "Waerk": "USD",
                "Billoflading": "",
                "Ltlclass": "",
                "Ltlboxcount": "",
                "Ltlhutype": "",
                "Ltlpacktype": "",
                "Ltlnmfccode": "",
                "TpCompany": "",
                "TpContact": "",
                "TpStreet": "",
                "TpStreet2": "",
                "TpCity1": "",
                "TpRegion": "",
                "TpPostCode1": "",
                "TpCountry": "",
                "TpPhone": "",
                "EuClearance": "",
                "Reference1": sapDeliveryNumber,
                "Reference2": "",
                "Kunnr": "100188",
                "Kunag": "100188",
                "Vkorg": "BP01",
                "Werks": "BP01",
                "Auart": "OR",
                "Lfart": "LF",
                "Description": "",
                "Shipprocess": shipStatus,
                "Venum": "123",
                "Gewei": "LB",                
                "Reasonforexport": "",
                "Addcomments": "",
                "DimensionFactor": "00000",
                "TransitDays": "000",
                "Delivery": sapDeliveryNumber ? sapDeliveryNumber : "",
                "UpsEod": "",
                "Tcode": "/PWEAVER/PPS",
                "Packagetype": "",
                "Manifestid": "",
                "Scac": "",
                "Sealnumber": "",
                "Trailerno": "",
                "Door": "",
                "Tu": "",
                "Odo": "",
                "Returntype": "",
                "Volumequote": "",
                "Truckno": "",
                "Container": "",
                "Pallets": "",
                "Seal": "",
                "Crossdockloc": "",
                "Ecsid": "",
                "Saleterms": "FOB",
                "Iorpartner": "",
                "Iorcompany": "",
                "Iorcontact": "",
                "Ioraddress1": "",
                "Ioraddress2": "",
                "Iorcity": "",
                "Iorregion": "",
                "Iorpostalcode": "",
                "Iorcountry": "",
                "Iorphone": "",
                "SfOrderid": "",
                "CrossdockStatus": "",
                "CrossdockRecby": "",
                "CrossdockShipby": "",
                "EdiControlNo": "",
                "Edi997Status": "",
                "Shipmentid": eshipjetModel.getProperty("/commonValues/ShipNowShipsrvNameSelectedKey"),
                "EodTimestamp": "",
                "Labelurl": shippingDocName,
                "PackURL" : packingSlip,
                "BOLURL": billOfLading,
                "DgUrl": "",
                "Multi": "",
                "Legno": "",
                "Wemshipid": "",
                "Weshipid": "",
                "Wemanfid": "",
                "WeconsolManfid": "",
                "Weportcode": "",
                "Wecloseout": "",
                "WecloseBy": "",
                "Leg": "",
                "Knota": "",
                "Knotz": "",
                "DeliveryStatus": "",
                "Stagloc": "Z00001",
                "Licence": "",
                "Orate": "",
                "Ocarrier": "",
                "Accessorial": "",
                "Fuel": Fuel ?  Fuel.toString() : "0.00",
                "Deliverynno": sapDeliveryNumber ? sapDeliveryNumber : "",
                "TimeAdded": timeAdded ? timeAdded : ""
            };
            // var packCount = 0;
            // var Count  = 0
            // if(aHUnitsFilterData && aHUnitsFilterData.length > 0) {
            //     aHUnitsFilterData.forEach(function(item, index){
            //         Count = Count  + 1 
            //         grossWeight = item.GrossWeight;                
            //         oManifestDataObj["HandlingUnit"] = item.HandlingUnitExternalID;
            //         oManifestDataObj["PackageWeight"] = grossWeight;
            //         oManifestDataObj["Chargweight"]   = grossWeight;   
            //         // oManifestDataObj["Labelurl"] = shippingDocuments[index].docName;
            //         oManifestDataObj["Pkgcount"] = Count.toString();
            //         oManifestDataObj["TrackingNumber"] = trackingArray[index].TrackingNumber;
            //         oManifestDataObj["Labelurl"] = shippingDocuments[index].docName;
            //         for(var i=0; i<shippingDocuments.length; i++){
            //             if(shippingDocuments[i].contentType === "Packing Slip"){
            //                 oManifestDataObj["PackURL"] = shippingDocuments[i].docName;
            //             }else if(shippingDocuments[i].contentType === "Bill Of Lading"){
            //                 oManifestDataObj["BOLURL"] = shippingDocuments[i].docName;
            //             }
            //         };
            //         // if(shippingDocuments[shippingDocuments.length - 1].contentType === "Packing Slip"){
            //         //     oManifestDataObj["PackURL"] = shippingDocuments[shippingDocuments.length - 1].docName;
            //         // }
            //         aManifestData.push(jQuery.extend(true, {}, oManifestDataObj));
            //     });
            // }else{
            //     for(var i=0; i<shippingDocuments.length; i++){
            //         if(shippingDocuments[i].contentType === "Label"){
            //             oManifestDataObj["Labelurl"] = shippingDocuments[i].docName;
            //         }else if(shippingDocuments[i].contentType === "Packing Slip"){
            //             oManifestDataObj["PackURL"] = shippingDocuments[i].docName;
            //         }else if(shippingDocuments[i].contentType === "Bill Of Lading"){
            //             oManifestDataObj["BOLURL"] = shippingDocuments[i].docName;
            //         }
            //     };
            //     aManifestData.push(oManifestDataObj);
            // };
            var oPayload = {
                "Vbeln": sapDeliveryNumber,
                "ToManifestData": [oManifestDataObj]
            };
            ShipReadDataSrvModel.create("/ManifestHeaderSet", oPayload, {
                method: "PATCH",
                success: function (oData) {
                    sap.m.MessageBox.warning("Shipment Cancelled Successfully.");
                    // MessageToast.show("Shipment Cancelled successfully.");
                    oController.createReversePostGoodsIssue(oData.ToManifestData.results[0].Vbeln);
                    
                    oController.onCloseBusyDialog();
                },
                error: function (oError) {
                    var errMsg = JSON.parse(oError.responseText).error.message.value;
                    sap.m.MessageBox.error(errMsg);
                    oController.onCloseBusyDialog();
                }
            });
        },

         /**
         * Below Function invoke on "Quote Now" button press from QuoteNow screen
         * once user provice delivery number and click quote now we are calling getting shipdata for shiping rates and showing dialog
         */
         onQuoteNowPress:function(){            
            let quoteNowDeliveryNum = eshipjetModel.getProperty("/commonValues/quoteNowDeliveryNumbInput");
            if(quoteNowDeliveryNum && quoteNowDeliveryNum.length > 0){
                eshipjetModel.setProperty("/commonValues/sapDeliveryNumber", quoteNowDeliveryNum);
                eshipjetModel.setProperty("/sFromViewName", "QUOTE_NOW");
                oController.onShipNowGetPress();
            }
        },
        onQuoteNowClearPress:function(){
            eshipjetModel.setProperty("/commonValues/quoteNowDeliveryNumbInput","");
        },
        _getShippingType:function(sServiceNameCode){
            var aCarrierServiceNames = oController.getView().getModel("serviceNamesList").getProperty("/carrierServices");
            var sShippinType;
            //var sSelectedValue = aCarrierServiceNames.find(function())
            const result = aCarrierServiceNames.find(({ ServiceCode }) => ServiceCode === sServiceNameCode);
            if(result){
                sShippinType = result.ShippingType;
            }else{
                sShippinType = sServiceNameCode;
            }

            return sShippinType;
        },


        // Freight Quote Orders Changes Starts
        openFreightQuoteOrdersColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource();
            var oView = this.getView();
            var oController = this;
        
            if (!this._pOrderPopover) {
                this._pOrderPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.FreightQuoteOrders.FreightQuoteOrdersTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
        
            this._pOrderPopover.then(function (oPopover) {
                oController._syncColumnSelections();
                oPopover.openBy(oButton);
            });
        },
        
        _syncColumnSelections: function () {
            var oTable = Fragment.byId(this.getView().getId(), "myFreightQuoteOrdersColumnSelectId");
            if (!oTable) return;
        
            var aItems = oTable.getItems();
            aItems.forEach(function (oItem) {
                var oContext = oItem.getBindingContext("eshipjetModel");
                if (oContext) {
                    var oData = oContext.getObject();
                    oItem.setSelected(oData.visible === true);
                }
            });
        },
        
        onFreightQuoteOrdersColNameSearch: function (oEvent) {
            var sQuery = oEvent.getSource().getValue();
            var oTable = Fragment.byId(this.getView().getId(), "myFreightQuoteOrdersColumnSelectId");
            if (!oTable) return;
        
            var oBinding = oTable.getBinding("items");
            var aFilters = [];
            if (sQuery) {
                aFilters.push(new Filter("label", FilterOperator.Contains, sQuery));
            }
            oBinding.filter(aFilters);
        },
        
        onFreightQuoteOrdersColSelectClosePress: function () {
            var oPopover = Fragment.byId(this.getView().getId(), "FreightQuoteOrdersColumnsPopover");
            if (oPopover) {
                oPopover.close();
            }
        },
        
        onFreightQuoteOrdersColSelectOkPress: function () {
            var oTable = Fragment.byId(this.getView().getId(), "myFreightQuoteOrdersColumnSelectId");
            var oModel = this.getOwnerComponent().getModel("eshipjetModel");
            var aColumns = oModel.getProperty("/FreightQuoteOrdersColumns");
        
            oTable.getItems().forEach(function (oItem, iIndex) {
                var oContext = oItem.getBindingContext("eshipjetModel");
                if (oContext) {
                    var oData = oContext.getObject();
                    oData.visible = oItem.getSelected();
                }
            });
        
            oModel.refresh(true);
            this.onOrderColSelectClosePress();
            // You may also call table rerender or update logic here
        },

        openFreightQuoteColNamesPopover: function (oEvent) {
            var oButton = oEvent.getSource();
            var oView = this.getView();
            var oController = this;
        
            if (!this._pFreightQuotePopover) {
                this._pFreightQuotePopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.FreightQuoteOrders.FreightQuoteOrdersTableColumns",
                    controller: this
                }).then(function (oPopover) {
                    oView.addDependent(oPopover);
                    return oPopover;
                });
            }
        
            this._pFreightQuotePopover.then(function (oPopover) {
                oController._syncFreightQuoteColumnSelections();
                oPopover.openBy(oButton);
            });
        },
        
        _syncFreightQuoteColumnSelections: function () {
            var oTable = Fragment.byId(this.getView().getId(), "myFreightQuoteOrdersColumnSelectId");
            if (!oTable) return;
        
            var aItems = oTable.getItems();
            aItems.forEach(function (oItem) {
                var oContext = oItem.getBindingContext("eshipjetModel");
                if (oContext) {
                    var oData = oContext.getObject();
                    oItem.setSelected(oData.visible === true);
                }
            });
        },
        
        onFreightQuoteOrdersColNameSearch: function (oEvent) {
            var sQuery = oEvent.getSource().getValue();
            var oTable = Fragment.byId(this.getView().getId(), "myFreightQuoteOrdersColumnSelectId");
            if (!oTable) return;
        
            var oBinding = oTable.getBinding("items");
            var aFilters = [];
            if (sQuery) {
                aFilters.push(new sap.ui.model.Filter("label", sap.ui.model.FilterOperator.Contains, sQuery));
            }
            oBinding.filter(aFilters);
        },
        
        onFreightQuoteOrdersColSelectClosePress: function () {
            this._pFreightQuotePopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        
        onFreightQuoteOrdersColSelectOkPress: function () {
            var oTable = Fragment.byId(this.getView().getId(), "myFreightQuoteOrdersColumnSelectId");
            var oModel = this.getOwnerComponent().getModel("eshipjetModel");
        
            oTable.getItems().forEach(function (oItem) {
                var oContext = oItem.getBindingContext("eshipjetModel");
                if (oContext) {
                    var oData = oContext.getObject();
                    oData.visible = oItem.getSelected();
                }
            });
        
            oModel.refresh(true);
            this.onFreightQuoteOrdersColSelectClosePress();
            // Optional: Update the actual table column rendering if needed
        },
        
        
        
        


        onFreightQuoteOrdersExportToExcel: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var rows = eshipjetModel.getProperty("/FreightQuoteOrdersData");

            var oDateFormat = sap.ui.core.format.DateFormat.getDateTimeInstance({
                pattern: "MM/dd/yyyy HH:mm"
            });
        
            var formattedRows = rows.map(function (row) {
                return {
                    ...row,
                    ShipDateTime: row.ShipDateTime ? oDateFormat.format(new Date(row.ShipDateTime)) : ""
                };
            });

            var oSettings = {
                workbook: {
                    columns: [
                        { label: "Plant ID", property: "PlantID" },
                        { label: "Order ID", property: "OrderID" },
                        { label: "Order Type", property: "OrderType" },
                        { label: "Freight Quote ID", property: "FreightQuoteID" },
                        { label: "Carrier Name", property: "CarrierName" },
                        { label: "ERP Service ID", property: "ERPServiceID" },
                        { label: "Ship Type", property: "ShipType" },
                        { label: "Service Name", property: "ServiceName" },
                        { label: "Type", property: "Type" },
                        { label: "Bidded Carriers", property: "BiddedCarriers" },
                        { label: "Ship Date Time", property: "ShipDateTime" },
                        { label: "Quote Status", property: "QuoteStatus" },
                        { label: "Notes", property: "Notes" }
                    ]
                },
                dataSource: formattedRows,
                fileName: 'Freight_Quote_Orders_Data',
                Worker: true
            };
            var oSpreadsheet = new Spreadsheet(oSettings);
            oSpreadsheet.build().finally(function () {
                oSpreadsheet.destroy();
            });
        },

        onoOrderColSelectOkPress: function () {
            var oView = this.getView();
            var oOrderTable = oView.byId("myOrderColumnSelectId");
            var eshipjetModel = oView.getModel("eshipjetModel");
            var oOrderTblItems = oOrderTable.getItems();
            var aColumnsData = eshipjetModel.getProperty("/OrderTableData/OrderColumns");
            var orderColSelectedCount = 0;
            oOrderTblItems.map(function (oTableItems) {
                aColumnsData.map(function (oColObj) {
                    if (oTableItems.getBindingContext("eshipjetModel").getObject().name === oColObj.name) {
                        if (oTableItems.getSelected()) {
                            oColObj.visible = true;
                            orderColSelectedCount += 1;
                        } else {
                            oColObj.visible = false;
                        }
                    }
                })
            });
            console.log(orderColSelectedCount);
            eshipjetModel.setProperty("/orderColSelectedCount", orderColSelectedCount);
            eshipjetModel.updateBindings(true);
            // this._handleDisplayOrdersTable();
            this._pOrderPopover.then(function (oPopover) {
                oPopover.close();
            });
        },
        onOrderColSelectClosePress: function () {
            this._pOrderPopover.then(function (oPopover) {
                oPopover.close();
            });
        },

        onFreightQuoteOrdersFilterPopoverPress: function (oEvent) {
            var oButton = oEvent.getSource(),
                oView = this.getView();
            if (!this._orderPopover) {
                this._orderPopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.FreightQuoteOrders.FreightQuoteOrdersFilterPopover",
                    controller: this
                }).then(function (orderPopover) {
                    oView.addDependent(orderPopover);
                    return orderPopover;
                });
            }
            this._orderPopover.then(function (orderPopover) {
                orderPopover.openBy(oButton);
            });
        },
        onFreightQuoteOrdersFilterPopoverClosePress: function () {
            this.byId("idFreightQuoteOrdersFilterPopover").close();
        },
        
        onFreightQuoteOrdersFilterPopoverApplyPress: function () {
            var aFilters = [];
            var oView = this.getView();
            var sLocation = eshipjetModel.getProperty("/orderLocationFilter");
            var sCarrier = eshipjetModel.getProperty("/orderCarrierFilter");
            var sStatus = eshipjetModel.getProperty("/orderShipmentStatusFilter");
        
            // Accessing DatePickers from the Fragment using View ID as fragment ID
            var oShipFrom = Fragment.byId(oView.getId(), "shipFromDateId");
            var oShipTo = Fragment.byId(oView.getId(), "shipToDateId");
        
            var dShipFrom = oShipFrom ? oShipFrom.getDateValue() : null;
            var dShipTo = oShipTo ? oShipTo.getDateValue() : null;
        
            if (sLocation) {
                aFilters.push(new sap.ui.model.Filter("PlantID", sap.ui.model.FilterOperator.EQ, sLocation));
            }
            if (sCarrier) {
                aFilters.push(new sap.ui.model.Filter("Carriertype", sap.ui.model.FilterOperator.EQ, sCarrier));
            }
            if (sStatus) {
                aFilters.push(new sap.ui.model.Filter("Shipprocess", sap.ui.model.FilterOperator.EQ, sStatus));
            }
            if (dShipFrom && dShipTo) {
                aFilters.push(new sap.ui.model.Filter({
                    path: "DateAdded",
                    operator: sap.ui.model.FilterOperator.BT,
                    value1: dShipFrom,
                    value2: dShipTo
                }));
            }
        
            var oTable = oView.byId("idOrdersTable");
            if (oTable) {
                var oBinding = oTable.getBinding("rows");
                if (oBinding) {
                    oBinding.filter(aFilters);
                }
            }
        
            this.byId("idOrdersFilterPopover").close();
        },
        
        onFreightQuoteOrdersFilterPopoverResetPress: function () {
            var oView = this.getView();
            var today = new Date();
            oView.byId("locationComboId").setSelectedKey("");
            oView.byId("shipFromDateId").setDateValue(null);
            oView.byId("shipToDateId").setDateValue(null);
            oView.byId("carrierComboId").setSelectedKey("");
            oView.byId("orderTypeComboId").setSelectedKey("");
            oView.byId("statusComboId").setSelectedKey("");
        
            // Reset table to show all
            var oModel = oView.getModel("eshipjetModel");
            oModel.setProperty("/filteredOrders", oModel.getProperty("/allOrders"));
            oView.byId("idOrdersTable").bindRows("eshipjetModel>/filteredOrders");
            this.byId("idFreightQuoteOrdersFilterPopover").close();
        },

        onSearchFreightQuoteOrders: function (oEvent) {
            var sQuery = oEvent.getParameter("query") || oEvent.getSource().getValue();
            var oTable = this.byId("_IDFreightQuoteOrdersTable");
            var oBinding = oTable.getBinding("rows");
            if (oBinding) {
                var aFilters = [];
                if (sQuery) {
                    aFilters.push(new sap.ui.model.Filter({
                        filters: [
                            new sap.ui.model.Filter("PlantID", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("OrderID", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("OrderType", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("FreightQuoteID", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("CarrierName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("ERPServiceID", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("ShipType", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("ServiceName", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("Type", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("BiddedCarriers", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("ShipDateTime", sap.ui.model.FilterOperator.Contains, sQuery),
                            new sap.ui.model.Filter("QuoteStatus", sap.ui.model.FilterOperator.Contains, sQuery)
                        ],
                        and: false
                    }));
                }
                oBinding.filter(aFilters);
            }
        },

        refreshFreightQuoteOrders:function(){
            oController.onOpenBusyDialog();
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            var oTable = this.byId("_IDFreightQuoteOrdersTable");
            var oBinding = oTable.getBinding("rows");
            oBinding.filter([]);
            eshipjetModel.setProperty("/FreightQuoteOrdersSearchText", "");
            oController.onCloseBusyDialog();
        },

        // Freight Quote Orders Changes End

        onLogOutPress:function(){
            clearInterval(this.timerInterval);
            window.location.href = "/sap/public/bc/icf/logoff";
        },

        onTrackTableColumConfigPress: function (oEvent) {
            var oButton = oEvent.getSource();
            var oView = this.getView();
            var oController = this;
        
            if (!this._pTrackTracePopover) {
                this._pTrackTracePopover = Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.TrackTraceTableColumns",
                    controller: this
                }).then(function (oTrackTracePopover) {
                    oView.addDependent(oTrackTracePopover);
                    return oTrackTracePopover;
                });
            }
        
            this._pTrackTracePopover.then(function (oTrackTracePopover) {
                oController._syncTrackTraceColumnSelections();
                oTrackTracePopover.openBy(oButton);
            });
        },
        
        _syncTrackTraceColumnSelections: function () {
            var oTable = Fragment.byId(this.getView().getId(), "myTrackTraceColumnSelectId");
            if (!oTable) return;
        
            var aItems = oTable.getItems();
            aItems.forEach(function (oItem) {
                var oContext = oItem.getBindingContext("eshipjetModel");
                if (oContext) {
                    var oData = oContext.getObject();
                    oItem.setSelected(oData.visible === true);
                }
            });
        },
        
        onTrackTraceColNameSearch: function (oEvent) {
            var sQuery = oEvent.getSource().getValue();
            var oTable = Fragment.byId(this.getView().getId(), "myTrackTraceColumnSelectId");
            if (!oTable) return;
        
            var oBinding = oTable.getBinding("items");
            var aFilters = [];
            if (sQuery) {
                aFilters.push(new Filter("label", FilterOperator.Contains, sQuery));
            }
            oBinding.filter(aFilters);
        },
        
        onTrackTraceColSelectClosePress: function () {
            this._pTrackTracePopover.then(function (oTrackTracePopover) {
                oTrackTracePopover.close();
            });
        },
        
        onTrackTraceColSelectOkPress: function () {
            var oTable = Fragment.byId(this.getView().getId(), "myTrackTraceColumnSelectId");
            var oModel = this.getOwnerComponent().getModel("eshipjetModel");
        
            oTable.getItems().forEach(function (oItem) {
                var oContext = oItem.getBindingContext("eshipjetModel");
                if (oContext) {
                    var oData = oContext.getObject();
                    oData.visible = oItem.getSelected();
                }
            });
        
            oModel.refresh(true);
            this.onTrackTraceColSelectClosePress();
            // optionally call refresh on your orders table
        },



        // onShipNowGetPress:function(){
        //     oController.onOpenBusyDialog();
        //     var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
        //     var sDeveliveryNumber = eshipjetModel.getProperty("/commonValues/sapDeliveryNumber");
        //     var GetDeliveryDataModel = oController.getOwnerComponent().getModel("GetDeliveryDataModel");
        //     var aFilters = [
        //         new sap.ui.model.Filter("DeliveryDocument", sap.ui.model.FilterOperator.EQ, sDeveliveryNumber.toString())
        //     ];
        //     GetDeliveryDataModel.read("/zcds_dlvr_data", {
        //         filters: aFilters,
        //         urlParameters: {
        //             "$expand": "to_Carrier,to_Items,to_Packages,to_ShipFrom,to_ShipTo,to_ShipToParty,to_Shipper,to_SoldTo,to_SoldToParty"
        //         },
        //         success: function(oData, response) {
        //             if(oData.results.length > 0){
        //                 eshipjetModel.setProperty("/GetDeliveryData", oData.results[0]);
        //                 var GetDeliveryData = eshipjetModel.getProperty("/GetDeliveryData");
        //                 oController.ShippingType = GetDeliveryData.ShippingType;
        //                 var BusinessPartners = [
        //                     {"PartnerType": "Sold-to Party", "PartnerID":GetDeliveryData.to_SoldToParty.AddressID, "CompanyName":GetDeliveryData.to_SoldToParty.BPCustomerFullName, "ContactName":GetDeliveryData.to_SoldToParty.CustomerName, "AddressLine1":GetDeliveryData.to_SoldToParty.AddressSearchTerm1, "City":GetDeliveryData.to_SoldToParty.CityName, "State":GetDeliveryData.to_SoldToParty.Region, "PostalCode":GetDeliveryData.to_SoldToParty.PostalCode, "Country":GetDeliveryData.to_SoldToParty.Country, "PhoneNumber":GetDeliveryData.to_SoldToParty.TelephoneNumber1, "EmailAddress":""},
        //                     {"PartnerType": "Forwarding Agent", "PartnerID":GetDeliveryData.to_Carrier.AddressID, "CompanyName":GetDeliveryData.to_Carrier.BusinessPartnerFullName, "ContactName":GetDeliveryData.to_Carrier.Supplier, "AddressLine1":"", "City":GetDeliveryData.to_Carrier.CityName, "State":GetDeliveryData.to_Carrier.Region, "PostalCode":GetDeliveryData.to_Carrier.PostalCode, "Country":GetDeliveryData.to_Carrier.Country, "PhoneNumber":GetDeliveryData.to_Carrier.PhoneNumber, "EmailAddress":GetDeliveryData.to_Carrier.EmailAddress},
        //                     {"PartnerType": "Ship-to Party", "PartnerID":GetDeliveryData.to_SoldToParty.AddressID, "CompanyName":GetDeliveryData.to_SoldToParty.BPCustomerFullName, "ContactName":GetDeliveryData.to_SoldToParty.CustomerName, "AddressLine1":GetDeliveryData.to_SoldToParty.AddressSearchTerm1, "City":GetDeliveryData.to_SoldToParty.CityName, "State":GetDeliveryData.to_SoldToParty.Region, "PostalCode":GetDeliveryData.to_SoldToParty.PostalCode, "Country":GetDeliveryData.to_SoldToParty.Country, "PhoneNumber":GetDeliveryData.to_SoldToParty.TelephoneNumber1, "EmailAddress":""}
        //                 ];
        //                 eshipjetModel.setProperty("/BusinessPartners", BusinessPartners);
        //                 eshipjetModel.setProperty("/commonValues/ShipNowShipMethodSelectedKey", GetDeliveryData.to_Carrier.Supplier);
        //                 oController.onShopNowShipMethodAfterChange(GetDeliveryData.to_Carrier.Supplier);
        //                 console.log("Success", oData);
        //                 oController.readHUData();
        //                 eshipjetModel.setProperty("/selectPaymentType", "Sender");
        //                 eshipjetModel.setProperty("/ShipNowShipMethodSelectedKey", ShippingType);
        //                  // ðŸ”½ðŸ”½ðŸ”½ ADD THIS CODE HERE (right after above line) ðŸ”½ðŸ”½ðŸ”½
        //         // --- Auto-select Service based on ShippingType ---
        //         var carrierConfig = eshipjetModel.getProperty("/carrierconfiguration1");
        //         var shippingType = GetDeliveryData.ShippingType; // e.g. "UG"
        //         var shipMethod = GetDeliveryData.to_Carrier.Supplier; // e.g. "UPS"
        //         var matchedServiceName = "";

        //         // Find the right carrier
        //         var selectedCarrier = carrierConfig.find(function (carrier) {
        //             return carrier.CarrierName === shipMethod;
        //         });

        //         // Find the matching service by ShippingType
        //         if (selectedCarrier && selectedCarrier.carrierServices) {
        //             var matchedService = selectedCarrier.carrierServices.find(function (service) {
        //                 return service.ShippingType === shippingType;
        //             });

        //             if (matchedService) {
        //                 matchedServiceName = matchedService.ServiceName;
        //             }
        //         }

        //         // Update ComboBox data and select correct key
        //         if (selectedCarrier) {
        //             eshipjetModel.setProperty("/carrierServicesList", selectedCarrier.carrierServices.map(function (srv) {
        //                 return { ServDesc: srv.ServiceName, ServiceCode: srv.ServiceCode };
        //             }));

        //             eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey", matchedServiceName);
        //         }
        //         // --- End of new code ---
        //             }
        //             // oController.onCloseBusyDialog();
        //         },
        //         error: function(oError) {
        //             oController.onCloseBusyDialog();
        //             console.error("Error", oError);
        //             var oResponse = JSON.parse(oError.responseText);
        //             sMessage = oResponse.error.message.value || sMessage;
        //             MessageBox.error(sMessage);
        //         }
        //     });
        // },
        
  
    // onShipNowGetPress: async function () {
    //     oController.onOpenBusyDialog();
    //     var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
    //     var sDeveliveryNumber = eshipjetModel.getProperty("/commonValues/sapDeliveryNumber");
    //     var GetDeliveryDataModel = oController.getOwnerComponent().getModel("GetDeliveryDataModel");

    //     const cleanDelivery = String(Number(sDeveliveryNumber));

    //     if (!sDeveliveryNumber) {
    //                 MessageBox.error("Delivery number is missing.");
    //                 throw new Error("No delivery number found in model");
    //             }

    //             if (sDeveliveryNumber.length !== 8) {
    //                 MessageBox.error("Please enter a valid 8-digit Delivery number.");
    //                 throw new Error("Invalid delivery number length");
    //             }

    //             // -------------------------
    //             // NEW: Manifest availability check
    //             // -------------------------
    //             try {
    //                 oController.onOpenBusyDialog();

    //                 eshipjetModel.setProperty("/GetDeliveryData/to_Items/results",[]);
    //                 eshipjetModel.setProperty("/ShipNowHandlingUnits",[]);
    //                 var manifestExists = await oController._checkManifestAvailability(sDeveliveryNumber);

    //                 if (manifestExists) {
    //                     // Manifest exists â†’ load manifest UI & STOP further execution
    //                     await oController.getManifestHeaderForCharges(sDeveliveryNumber);

    //                     oController.onCloseBusyDialog();
    //                     return; // <<< EARLY EXIT IMPORTANT
    //                 }

    //             } catch (e) {
    //                 oController.onCloseBusyDialog();
    //                 MessageBox.error("Error checking manifest availability.");
    //                 return;
    //             }

    //     // var aFilters = [
    //     //     new sap.ui.model.Filter("DeliveryDocument", sap.ui.model.FilterOperator.EQ, sDeveliveryNumber.toString())
    //     // ];

    //     GetDeliveryDataModel.read("/zcds_dlvr_data", {
    //         // filters: aFilters,
    //         filters: [ new sap.ui.model.Filter("DeliveryDocument", "EQ", cleanDelivery) ],
    //         urlParameters: {
    //             "$expand": "to_Carrier,to_Items,to_Packages,to_ShipFrom,to_ShipTo,to_ShipToParty,to_Shipper,to_SoldTo,to_SoldToParty"
    //         },
    //         success: function (oData, response) {
    //             if (oData.results.length > 0) {
    //                 eshipjetModel.setProperty("/GetDeliveryData", oData.results[0]);
    //                 var GetDeliveryData = eshipjetModel.getProperty("/GetDeliveryData");

    //                 eshipjetModel.setProperty("/commonValues/plant", GetDeliveryData.ShippingPoint);

    //                 oController.onGetCarrierNamesDataForDropDown(GetDeliveryData.to_Carrier.Supplier);
                    
    //                 // Store shipping type (like "UG", "FA", etc.)
    //                 oController.ShippingType = GetDeliveryData.ShippingType;

    //                 // ðŸ§© Set Business Partner details
    //                 var BusinessPartners = [
    //                     {
    //                         "PartnerType": "Sold-to Party",
    //                         "PartnerID": GetDeliveryData.to_ShipFrom.AddressID,
    //                         "CompanyName": GetDeliveryData.to_ShipFrom.butxt,
    //                         "ContactName": GetDeliveryData.to_ShipFrom.name1,
    //                         "AddressLine1": GetDeliveryData.to_ShipFrom.AddressSearchTerm1,
    //                         "City": GetDeliveryData.to_ShipFrom.ort01,
    //                         "State": GetDeliveryData.to_ShipFrom.regio,
    //                         "PostalCode": GetDeliveryData.to_ShipFrom.pstlz,
    //                         "Country": GetDeliveryData.to_ShipFrom.Country,
    //                         "PhoneNumber": GetDeliveryData.to_ShipFrom.persnumber,
    //                         "EmailAddress": GetDeliveryData.to_ShipFrom.smtp_addr
    //                     },
    //                     {
    //                         "PartnerType": "Forwarding Agent",
    //                         "PartnerID": GetDeliveryData.to_Carrier.AddressID,
    //                         "CompanyName": GetDeliveryData.to_Carrier.BusinessPartnerFullName,
    //                         "ContactName": GetDeliveryData.to_Carrier.Supplier,
    //                         "AddressLine1": GetDeliveryData.to_Carrier.AddressID,
    //                         "City": GetDeliveryData.to_Carrier.CityName,
    //                         "State": GetDeliveryData.to_Carrier.Region,
    //                         "PostalCode": GetDeliveryData.to_Carrier.PostalCode,
    //                         "Country": GetDeliveryData.to_Carrier.Country,
    //                         "PhoneNumber": GetDeliveryData.to_Carrier.PhoneNumber,
    //                         "EmailAddress": GetDeliveryData.to_Carrier.EmailAddress
    //                     },
    //                     {
    //                         "PartnerType": "Ship-to Party",
    //                         "PartnerID": GetDeliveryData.to_SoldToParty.AddressID,
    //                         "CompanyName": GetDeliveryData.to_SoldToParty.BPCustomerFullName,
    //                         "ContactName": GetDeliveryData.to_SoldToParty.CustomerName,
    //                         "AddressLine1": GetDeliveryData.to_SoldToParty.AddressSearchTerm1,
    //                         "City": GetDeliveryData.to_SoldToParty.CityName,
    //                         "State": GetDeliveryData.to_SoldToParty.Region,
    //                         "PostalCode": GetDeliveryData.to_SoldToParty.PostalCode,
    //                         "Country": GetDeliveryData.to_SoldToParty.Country,
    //                         "PhoneNumber": GetDeliveryData.to_SoldToParty.TelephoneNumber1,
    //                         "EmailAddress": ""
    //                     }
    //                 ];

    //                 eshipjetModel.setProperty("/BusinessPartners", BusinessPartners);

    //                 var ShipFrom = {
    //                             ShipFromCOMPANY: GetDeliveryData.to_ShipFrom.butxt,
    //                             ShipFromCONTACT: GetDeliveryData.to_ShipFrom.name1,
    //                             ShipFromADDRESS_LINE1: GetDeliveryData.to_ShipFrom.stras,
    //                             ShipFromADDRESS_LINE2: GetDeliveryData.to_ShipFrom.name2,
    //                             ShipFromCITY: GetDeliveryData.to_ShipFrom.ort01,
    //                             ShipFromSTATE: GetDeliveryData.to_ShipFrom.regio,
    //                             ShipFromZIPCODE: GetDeliveryData.to_ShipFrom.pstlz,
    //                             ShipFromCOUNTRY: GetDeliveryData.to_ShipFrom.land1,
    //                             ShipFromPHONE: GetDeliveryData.to_ShipFrom.persnumber,
    //                             ShipFromEMAIL: GetDeliveryData.to_ShipFrom.smtp_addr
    //                         };
    //                         eshipjetModel.setProperty("/ShipFromAddress", ShipFrom);

    //                         var ShipTo = {
    //                             BusinessPartnerName1: GetDeliveryData.to_ShipToParty.CustomerFullName,
    //                             FullName: GetDeliveryData.to_ShipToParty.CustomerName,
    //                             StreetName: GetDeliveryData.to_ShipToParty.AddressSearchTerm1,
    //                             HouseNumber: GetDeliveryData.to_ShipToParty.StreetName,
    //                             CityName: GetDeliveryData.to_ShipToParty.CityName,
    //                             Region: GetDeliveryData.to_ShipToParty.Region,
    //                             PostalCode: GetDeliveryData.to_ShipToParty.PostalCode,
    //                             Country: GetDeliveryData.to_ShipToParty.Country,
    //                             PhoneNumber: GetDeliveryData.to_ShipToParty.TelephoneNumber1,
    //                             EMAIL: GetDeliveryData.to_ShipToParty.EmailAddress 
    //                                     ? GetDeliveryData.to_ShipToParty.EmailAddress 
    //                                     : "info@eshipjet.ai"
    //                         };
    //                         eshipjetModel.setProperty("/ShipToAddress", ShipTo);

    //                         var aHUs = GetDeliveryData.to_Packages.results.map(function (item, idx) {
    //                             return {
    //                                 SerialNumber: idx + 1,
    //                                 HandlingUnitExternalID: item.HandlingUnitExternalID,
    //                                 CreatedByUser: item.CreatedByUser,
    //                                 GrossWeight: item.GrossWeight,
    //                                 Dimensions: item.Dimensions,
    //                                 HandlingUnitPackingObjectType: item.HandlingUnitPackingObjectType,
    //                                 HandlingUnitInternalID: item.HandlingUnitInternalID,
    //                                 Hunumber: item.Hunumber,
    //                                 HandlingUnitIsClosed: item.HandlingUnitIsClosed,
    //                                 PackagingMaterial: item.PackagingMaterial,
    //                                 HuLabel: item.HuLabel
    //                             };
    //                         });

    //                         eshipjetModel.setProperty("/ShipNowHandlingUnits", aHUs);



    //                 var plant = oData.results[0].ShippingPoint;

    //                 if (plant) {
    //                     eshipjetModel.setProperty("/commonValues/plant", plant);
    //                     eshipjetModel.setProperty("/commonValues/showPlant", true); // ðŸ‘ˆ make visible
    //                 }

    //                 // oController.onShopNowShipMethodAfterChange(GetDeliveryData.to_Carrier.Supplier);
    //                 oController.onGetCarrierServicesDataForDropDown(GetDeliveryData.to_Carrier.Supplier, GetDeliveryData.ShippingType);

    //                 // ðŸ§¾ Load HU data
    //                 oController.readHUData();
    //                 // oController.readTodayHUData();

    //                 // ðŸ§¾ Default Payment Type
    //                 eshipjetModel.setProperty("/selectPaymentType", "Sender");

    //                 // ðŸ§© Set selected shipping type
    //                 eshipjetModel.setProperty("/ShipNowShipMethodSelectedKey", oController.ShippingType);

    //                 // ----------------------------------------------------------------
    //                 // ðŸ”½ AUTO-SELECT SERVICE BASED ON SHIPPING TYPE ðŸ”½
    //                 // ----------------------------------------------------------------
    //                 var carrierConfig = eshipjetModel.getProperty("/carrierconfiguration1") || [];
    //                 var shippingType = GetDeliveryData.ShippingType;          // e.g. "UG"
    //                 var shipMethod = GetDeliveryData.to_Carrier?.Supplier;    // e.g. "UPS"
    //                 var matchedServiceName = "";

    //                 console.log("ðŸ” Matching service for Carrier:", shipMethod, "| ShippingType:", shippingType);

    //                 // Find the correct carrier in configuration
    //                 var selectedCarrier = carrierConfig.find(function (carrier) {
    //                     return carrier.CarrierName === shipMethod;
    //                 });

    //                 if (selectedCarrier && selectedCarrier.carrierServices && selectedCarrier.carrierServices.length) {

    //                     console.log("ðŸ“¦ Services available:", selectedCarrier.carrierServices.map(function (s) {
    //                         return s.ServiceName + " (" + s.ShippingType + "/" + s.ServiceCode + ")";
    //                     }));

    //                     // Try matching by ShippingType or ServiceCode (case-insensitive)
    //                     var matchedService = selectedCarrier.carrierServices.find(function (srv) {
    //                         return (
    //                             (srv.ShippingType && srv.ShippingType.toLowerCase() === shippingType.toLowerCase()) ||
    //                             (srv.ServiceCode && srv.ServiceCode.toLowerCase() === shippingType.toLowerCase()) ||
    //                             (srv.ServiceName && srv.ServiceName.toLowerCase() === shippingType.toLowerCase())
    //                         );
    //                     });

    //                     if (matchedService) {
    //                         matchedServiceName = matchedService.ServiceName;
    //                         console.log("âœ… Matched Service Found:", matchedServiceName);
    //                     } else {
    //                         console.warn("âš ï¸ No service match found for ShippingType:", shippingType);
    //                     }

    //                     // Populate the service dropdown list
    //                     eshipjetModel.setProperty("/carrierServicesList", selectedCarrier.carrierServices.map(function (srv) {
    //                         return {
    //                             ServDesc: srv.ServiceName,
    //                             ServiceCode: srv.ServiceCode,
    //                             ShippingType: srv.ShippingType
    //                         };
    //                     }));
                    
    //                     // Auto-select the matching service
    //                     eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey", matchedServiceName);
    //                 }
    //                 // ----------------------------------------------------------------
    //             }
    //             // oController.getManifestHeaderForCharges();
    //         },
    //         error: function (oError) {
    //             oController.onCloseBusyDialog();
    //             console.error("âŒ Error in GetDeliveryDataModel:", oError);
    //             var oResponse = JSON.parse(oError.responseText);
    //             var sMessage = oResponse.error.message.value || "Unknown error";
    //             sap.m.MessageBox.error(sMessage);
    //         }
    //     });
    // },

//    packParcelProducts: function () {
//     var oController = this;

//     return new Promise((resolve, reject) => {

//         oController.onOpenBusyDialog();

//         var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
//         var oTable = oController.byId("idShipNowPackTable");
//         var oModel = oController.getOwnerComponent().getModel("OutBoundDeliveryModel");
//         var GetDeliveryData = eshipjetModel.getProperty("/GetDeliveryData");

//         var aRows = oTable.getBinding("rows").getContexts().map(c => c.getObject());
//         var aRowsToPack = aRows.filter(r => r.BalanceQty > 0);

//         if (!aRowsToPack.length) {
//             oController.onCloseBusyDialog();
//             resolve();
//             return;
//         }

//         oModel.setUseBatch(true);
//         oModel.setDeferredGroups(["parcelPackBatch"]);

//         oModel.refreshSecurityToken(() => {

//             aRowsToPack.forEach(oRow => {

//                 for (let i = 0; i < oRow.BalanceQty; i++) {

//                     // 1ï¸âƒ£ HU HEADER
//                     oModel.create("/A_HandlingUnitHeaderDelivery", {
//                         HandlingUnitExternalId: "$1",
//                         PackagingMaterial: "CARTON BOX", // âœ… VALID
//                         DeliveryDocument: GetDeliveryData.DeliveryDocument
//                     }, { groupId: "parcelPackBatch" });

//                     // 2ï¸âƒ£ HU ITEM
//                     oModel.create("/A_HandlingUnitItemDelivery", {
//                         HandlingUnitExternalId: "$1",
//                         HandlingUnitTypeOfContent: "1",
//                         DeliveryDocument: GetDeliveryData.DeliveryDocument,
//                         DeliveryDocumentItem: oRow.DeliveryDocumentItem,
//                         HandlingUnitQuantity: 1,
//                         HandlingUnitQuantityUnit: oRow.BaseUnit || "PC",
//                         Material: oRow.Material
//                     }, { groupId: "parcelPackBatch" });
//                 }
//             });

//             oModel.submitChanges({
//                 groupId: "parcelPackBatch",
//                 success: async () => {
//                     await oController.readHUData();
//                     oController.onCloseBusyDialog();
//                     sap.m.MessageToast.show("Parcel auto packing completed");
//                     resolve();
//                 },
//                 error: oError => {
//                     oController.onCloseBusyDialog();
//                     oController._showODataError(oError);
//                     reject(oError);
//                 }
//             });

//         }, err => {
//             oController.onCloseBusyDialog();
//             sap.m.MessageBox.error("CSRF token fetch failed");
//             reject(err);
//         });
//     });
// },


packParcelProductsWithEWM: async function(){
    const oController = this;
    oController.onOpenBusyDialog();

    const eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
    const CreateHUSrvModel = oController.getOwnerComponent().getModel("CreateHUSrvModel");

    const sapDeliveryNumber = eshipjetModel.getProperty("/commonValues/sapDeliveryNumber");
    const selectedPackageMat = eshipjetModel.getProperty("/selectedPackageMat");

    const oTable = oController.byId("idShipNowPackTable");
    const aRows = oTable.getBinding("rows").getContexts().map(c => c.getObject());
    const aRowsToPack = aRows.filter(r => r.BalanceQty > 0);

    if (!selectedPackageMat) {
        oController.onCloseBusyDialog();
        return MessageBox.warning("Please Select Package Material");
    }

    if (!aRowsToPack.length) {
        oController.onCloseBusyDialog();
        return MessageBox.warning("No remaining quantity to pack");
    }

    try {
        for (const oRow of aRowsToPack) {

            for (let i = 0; i < oRow.BalanceQty; i++) {

                await new Promise((resolve, reject) => {
                    CreateHUSrvModel.create("/HUHEADERSet", {
                        Pacmatnr: selectedPackageMat,
                        Delivery: sapDeliveryNumber,
                        Qty: "1",
                        Itemno: oRow.DeliveryDocumentItem
                    }, {
                        success: () => {
                            // micro commit window for EWM
                            setTimeout(resolve, 120);
                        },
                        error: reject
                    });
                });
            }
        }

        oController.getHandlingUnit(sapDeliveryNumber);
        sap.m.MessageToast.show("Auto parcel packing completed");

    } catch (e) {
        oController._showODataError(e);
    }

    oController.onCloseBusyDialog();
},


packParcelProducts: function () {
    var oController = this;

    return new Promise((resolve, reject) => {

        oController.onOpenBusyDialog();

        var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
        var oTable = oController.byId("idShipNowPackTable");
        var oModel = oController.getOwnerComponent().getModel("OutBoundDeliveryModel");
        var GetDeliveryData = eshipjetModel.getProperty("/GetDeliveryData");

        var aRows = oTable.getBinding("rows").getContexts().map(c => c.getObject());
        var aRowsToPack = aRows.filter(r => r.BalanceQty > 0);

        if (!aRowsToPack.length) {
            oController.onCloseBusyDialog();
            resolve();
            return;
        }

        oModel.setUseBatch(true);
        oModel.setDeferredGroups(["parcelPackBatch"]);

        oModel.refreshSecurityToken(() => {

            let huCounter = 1; // ðŸ”‘ UNIQUE HU COUNTER

            aRowsToPack.forEach(oRow => {

                for (let i = 0; i < oRow.BalanceQty; i++) {

                    let sHURef = "$" + huCounter; // ðŸ”‘ UNIQUE per HU

                    // 1ï¸âƒ£ HU HEADER
                    oModel.create("/A_HandlingUnitHeaderDelivery", {
                        HandlingUnitExternalId: sHURef,
                        PackagingMaterial: "CARTON BOX",
                        DeliveryDocument: GetDeliveryData.DeliveryDocument
                    }, { groupId: "parcelPackBatch" });

                    // 2ï¸âƒ£ HU ITEM (1 qty per HU)
                    oModel.create("/A_HandlingUnitItemDelivery", {
                        HandlingUnitExternalId: sHURef,
                        HandlingUnitTypeOfContent: "1",
                        DeliveryDocument: GetDeliveryData.DeliveryDocument,
                        DeliveryDocumentItem: oRow.DeliveryDocumentItem,
                        HandlingUnitQuantity: "1",
                        HandlingUnitQuantityUnit: oRow.BaseUnit || "PC",
                        Material: oRow.Material
                    }, { groupId: "parcelPackBatch" });

                    huCounter++; // ðŸ”‘ increment for next HU
                }
            });

            oModel.submitChanges({
                groupId: "parcelPackBatch",
                success: async () => {
                    await oController.readHUData();
                    oController.onCloseBusyDialog();
                    sap.m.MessageToast.show("Parcel auto packing completed");
                    resolve();
                },
                error: oError => {
                    oController.onCloseBusyDialog();
                    oController._showODataError(oError);
                    reject(oError);
                }
            });

        }, err => {
            oController.onCloseBusyDialog();
            sap.m.MessageBox.error("CSRF token fetch failed");
            reject(err);
        });
    });
},




   onPackAllPress: function () {
            var oController = this;
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            var oModel = this.getOwnerComponent().getModel("OutBoundDeliveryModel");

            var selectedPackageMat = eshipjetModel.getProperty("/selectedPackageMat");

            if (!selectedPackageMat) {
                MessageBox.warning("Please select Package Material");
                return;
            }

            var GetDeliveryData = eshipjetModel.getProperty("/GetDeliveryData");
            var packItems = eshipjetModel.getProperty("/to_DeliveryDocumentItem");

            // Filter only items with remaining qty
            var validItems = packItems.filter(item =>
                item.BalanceQty && parseFloat(item.BalanceQty) > 0
            );

            if (validItems.length === 0) {
                MessageBox.warning("No items available to pack.");
                return;
            }

            oController.onOpenBusyDialog();

            // Batch setup
            oModel.setUseBatch(true);
            oModel.setDeferredGroups(["PackAllBatch"]);

            oModel.refreshSecurityToken(() => {

                // 1ï¸âƒ£ Create HU header
                var headerObj = {
                    HandlingUnitExternalId: "$1",
                    PackagingMaterial: selectedPackageMat,
                    DeliveryDocument: GetDeliveryData.DeliveryDocument
                };

                oModel.create("/A_HandlingUnitHeaderDelivery", headerObj, {
                    groupId: "PackAllBatch"
                });

                // 2ï¸âƒ£ Create HU items for all rows
                validItems.forEach(item => {
                    var huItem = {
                        HandlingUnitExternalId: "$1",
                        HandlingUnitTypeOfContent: "1",
                        DeliveryDocument: GetDeliveryData.DeliveryDocument,
                        DeliveryDocumentItem: item.DeliveryDocumentItem,
                        HandlingUnitQuantity: item.BalanceQty.toString(),
                        HandlingUnitQuantityUnit: item.BaseUnit || "PC",
                        Material: item.Material
                    };

                    oModel.create("/A_HandlingUnitItemDelivery", huItem, {
                        groupId: "PackAllBatch"
                    });
                });

                // 3ï¸âƒ£ Submit batch
                oModel.submitChanges({
                    groupId: "PackAllBatch",
                    success: function () {
                        oController.readHUData();
                        oController.onCloseBusyDialog();
                        MessageToast.show("All items packed successfully.");
                    },
                    error: function (err) {
                        oController.onCloseBusyDialog();
                        oController._showODataError(err);
                    }
                });

            }, function (err) {
                oController.onCloseBusyDialog();
                MessageBox.error("CSRF Token Failed");
            });
},


        onHUItemsCreatePress: function () {
            var GetDeliveryData = eshipjetModel.getProperty("/GetDeliveryData");
            if(GetDeliveryData.Warehouse === ""){
                oController.onPackItemsWithOutEWM();
            }else{
                oController.onPackItemsWithEWM();
            }
        },

        onPackItemsWithEWM:function(){
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            var Notes = eshipjetModel.getProperty("/Notes")
            Notes.push({
                "date": new Date(),
                "name": eshipjetModel.getProperty("/userName"),
                "notes": "Items are packed sucessfully"
            });

            var productTable = this.byId("idShipNowPackTable");
            var selectedItems = productTable.getSelectedIndices();
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var selectedPackageMat = eshipjetModel.getProperty("/selectedPackageMat");

            var packAddProductTable = eshipjetModel.getProperty("/to_DeliveryDocumentItem");
            var tableCount = 0;

            packAddProductTable.forEach(function(item) {
                if (item.Material) {
                    tableCount += 1;
                }
            });
            if(selectedPackageMat === ""){
                MessageBox.warning("Please Select Package Material");
            }else if(selectedItems.length !== 0 && tableCount !== 1){
                MessageBox.warning("Please Select atleast one record from Product Table");
            }else{
                var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
                var totalWeight = 0;
                var ItemsInfo = [];
                for (var i = 0; i < 1; i++) {
                    var currentObj = productTable.getContextByIndex(i).getObject();
                    if(currentObj.partialQty === "" || currentObj.partialQty === undefined){
                        MessageBox.warning("Please add partial quantity for at least one valid product.");
                    }else{
                        oController.onOpenBusyDialog();
                        var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
                        var sapDeliveryNumber = eshipjetModel.getProperty("/commonValues/sapDeliveryNumber");
                        var partialQty = eshipjetModel.getProperty("/partialQty");
                        var Material = eshipjetModel.getProperty("/Material");
                        var pkgMaterial = eshipjetModel.getProperty("/selectedPackageMat")

                        var oPayload = {
                            "Pacmatnr": "EWMS4-WBTRO00",
                            "Delivery": sapDeliveryNumber,
                            "Qty": currentObj.partialQty,
                            "Itemno": "10"
                        };
                        
                        var CreateHUSrvModel = oController.getOwnerComponent().getModel("CreateHUSrvModel");
                        CreateHUSrvModel.create("/HUHEADERSet", oPayload, {
                            success: function (oData) {
                                // oController.readHUDataSet(sapDeliveryNumber);
                                MessageToast.show("Handling Unit Created Successfully");
                                currentObj.partialQty = "";
                                eshipjetModel.updateBindings(true);
                                oController.getHandlingUnit(sapDeliveryNumber);
                                // oController.onCloseBusyDialog();
                            },
                            error: function (oError) {
                                // var errMsg = JSON.parse(oError.responseText).error.message.value;
                                var errMsg = new DOMParser().parseFromString(oError.responseText, "text/xml").getElementsByTagName("message")[0].textContent;
                                sap.m.MessageBox.error(errMsg);
                                oController.onCloseBusyDialog();
                            }
                        });
                    }
                }
            }
        },

        onPackItemsWithOutEWM: function () {
            oController.onOpenBusyDialog();
            var oTable = this.byId("idShipNowPackTable");
            var aSelectedIndices = oTable.getSelectedIndices();
            var aRows = oTable.getBinding("rows").getContexts().map(c => c.getObject());
            var oModel = this.getOwnerComponent().getModel("OutBoundDeliveryModel");
            var GetDeliveryData = eshipjetModel.getProperty("/GetDeliveryData");

            if (aRows.length === 1) {
                if (!aRows[0].partialQty || parseFloat(aRows[0].partialQty) <= 0) {
                    sap.m.MessageBox.error("Please enter Partial Qty for the item.");
                    return;
                // }else if (!aRows[0].partialQty || parseFloat(aRows[0].partialQty) > 0 && aRows[0].isSerialSelected === true) {
                //     oController.onCloseBusyDialog();
                //     oController.onOpenSerialNumberDialog(aRows[0].partialQty);
                //     return;
                }
                aSelectedIndices = [0];
            } else {
                if (aSelectedIndices.length === 0) {
                    sap.m.MessageBox.error("Please select at least one row.");
                    return;
                }
                for (let i of aSelectedIndices) {
                    let oRow = aRows[i];
                    if (!oRow.partialQty || parseFloat(oRow.partialQty) <= 0) {
                        sap.m.MessageBox.error("Please enter Partial Qty for all selected items.");
                        return;
                    }
                }
            }
            oModel.setUseBatch(true);
            oModel.setDeferredGroups(["isProjectUploadBatch"]);
            oModel.refreshSecurityToken(function () {
                var headerDataObj = {
                    HandlingUnitExternalId: "$1",
                    PackagingMaterial: "CARTON BOX",
                    DeliveryDocument: GetDeliveryData.DeliveryDocument
                };
                oModel.create("/A_HandlingUnitHeaderDelivery", headerDataObj, {
                    groupId: "isProjectUploadBatch"
                });

                aSelectedIndices.forEach(i => {
                    let oRow = aRows[i];
                    let oItem = {
                        HandlingUnitExternalId: "$1",
                        HandlingUnitTypeOfContent: "1",
                        DeliveryDocument: GetDeliveryData.DeliveryDocument,
                        DeliveryDocumentItem: oRow.DeliveryDocumentItem,
                        HandlingUnitQuantity: oRow.partialQty,
                        HandlingUnitQuantityUnit: oRow.BaseUnit || "PC",
                        Material: oRow.Material
                    };
                    oModel.create("/A_HandlingUnitItemDelivery", oItem, {
                        groupId: "isProjectUploadBatch"
                    });
                });

                oModel.submitChanges({
                    groupId: "isProjectUploadBatch",
                    success: function (oData) {
                        oController.readHUData()
                        // oController.readTodayHUData();
                        // .then(function () {
                        //     return oController.onCreateHuItems(oData);
                        // })
                        // .catch(function (err) {
                        //     sap.m.MessageBox.error("Error while refreshing HU data");
                        // });
                        console.log("HU Header queued for batch:", oData);
                    }.bind(this),
                    error: function (oError) {
                        this._showODataError(oError);
                    }.bind(this)
                });

            }, function (err) {
                console.error("CSRF token refresh failed:", err);
                sap.m.MessageBox.error("Could not fetch CSRF token!");
            });
        },
      



        _showODataError: function (oError) {
            oController.onCloseBusyDialog();
            let sErrorMsg = "";
            if (oError && oError.responseText) {
                try {
                    let oParser = new DOMParser();
                    let oXmlDoc = oParser.parseFromString(oError.responseText, "text/xml");
                    let oMessageNode = oXmlDoc.getElementsByTagName("message")[0];
                    if (oMessageNode) {
                        sErrorMsg = oMessageNode.textContent;
                    }
                } catch (e) { }
            }
            if (!sErrorMsg) {
                sErrorMsg = (oError && oError.message) || "Unknown error occurred";
            }
            sap.m.MessageBox.error(sErrorMsg);
        },


        onGetCarrierNamesDataForDropDown: function (carrierName) {
            var oController = this;
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var ShippingPoint = eshipjetModel.getProperty("/commonValues/plant");
            var oMainModel = oController.getOwnerComponent().getModel("CARRIERS_SRV");
            
            oMainModel.read("/carrierSet", {
                success: function (oData, response) {
                    const aFiltered = (oData.results || []).filter(item =>
                        item.LocationId === ShippingPoint &&
                        item.IsActive === true
                    );
                    for(var i=0; i<aFiltered.length; i++){
                        if(aFiltered[i].CarrierCode === carrierName){
                            eshipjetModel.setProperty("/selectedCarrierAccountsData", aFiltered[i]);
                            eshipjetModel.setProperty("/accountNumber", aFiltered[i].AcntNmbr);
                        }
                    };
                    eshipjetModel.setProperty("/carrierNamesDropDownData", aFiltered);
                    
                    eshipjetModel.setProperty("/commonValues/ShipNowShipMethodSelectedKey", carrierName);

                                // ðŸ”¹ Filter by CarrierCode (UPS / FedEx / SAIA)
                    const oSelectedCarrierData = aFiltered.find(item =>
                        item.CarrierCode === carrierName
                    );

                    // ðŸ”¹ Set dropdown data
                    eshipjetModel.setProperty("/oSelectedCarrierData", oSelectedCarrierData);

                },
                error: function (oError) {
                    console.error("âŒ Error loading carrier catalog:", oError);
                    var sErrorMsg = "Failed to load carrier catalog";
                    if (oError.responseText) {
                        try {
                            var oErrorResponse = JSON.parse(oError.responseText);
                            sErrorMsg = oErrorResponse.error.message.value || sErrorMsg;
                        } catch (e) {
                            console.error("Could not parse error response");
                        }
                    }
                    sap.m.MessageToast.show(sErrorMsg);
                }
            });
        },

        onGetCarrierServicesDataForDropDown: function (carrierName, ShippingType) {
            var oController = this;
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var oMainModel = oController.getOwnerComponent().getModel("CARRIERS_SRV");
            var ShippingPoint = eshipjetModel.getProperty("/commonValues/plant");
            oMainModel.read("/carrier_srvSet", {
                success: function (oData, response) {
                    const aFiltered = (oData.results || []).filter(item =>
                        item.ServLoc === ShippingPoint &&
                        item.CarrierCode === carrierName &&
                        item.IsActive === true
                    );
                    
                    for(var i=0; i<aFiltered.length; i++){
                        if(aFiltered[i].ErpServId === ShippingType){
                            eshipjetModel.setProperty("/selectedServiceNamesData", aFiltered[i]);
                        }
                    };
                    eshipjetModel.setProperty("/carrierServicesDropDownData", aFiltered);
                    eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey", ShippingType);
                    // eshipjetModel.setProperty("/SHIP_METHOD", aFiltered[i].ServCode);
                },
                error: function (oError) {
                    console.error("âŒ Error loading carrier catalog:", oError);

                    var sErrorMsg = "Failed to load carrier catalog";
                    if (oError.responseText) {
                        try {
                            var oErrorResponse = JSON.parse(oError.responseText);
                            sErrorMsg = oErrorResponse.error.message.value || sErrorMsg;
                        } catch (e) {
                            console.error("Could not parse error response");
                        }
                    }
                    sap.m.MessageToast.show(sErrorMsg);
                }
            });
        },

        
     onGetCarrierCatalogData: function () {
        var oController = this;
        var oMainModel = oController.getOwnerComponent().getModel("CARRIERS_SRV");
        var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");

        oMainModel.read("/carrier_srvSet", {
            // urlParameters: {
            //     "$expand": "to_CarrierServices"
            // },
            success: function (oData, response) {
                  eshipjetModel.setProperty("/uniqueCarriersCatalogData", uniqueCarriersList);
                oController.onCloseBusyDialog();
                var aData = oData.results;
                eshipjetModel.setProperty("/carriersCatalogData", aData);
                eshipjetModel.setProperty("/carrierServicesList", aData);
                eshipjetModel.setProperty("/totalCarriersCatalogCount", aData.length);
                
                var uniqueCarriersList = [];
                var seen = new Set();

                var activeCarriersCatalogCount = 0;
                var inActiveCarriersCatalogCount = 0;
                aData.forEach(function (item) {
                    if(item.IsActive === true){
                        activeCarriersCatalogCount += 1;
                    }else if(item.IsActive === false){
                        inActiveCarriersCatalogCount += 1;
                    }
                    var key = item.CarrierCode + "_" + item.ServLoc;
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueCarriersList.push(item);
                    }
                });
                eshipjetModel.setProperty("/uniqueCarriersCatalogData", uniqueCarriersList);
                eshipjetModel.setProperty("/activeCarriersCatalogCount", activeCarriersCatalogCount);
                eshipjetModel.setProperty("/inActiveCarriersCatalogCount", inActiveCarriersCatalogCount);

               
                console.log("Read success:", oData.results);
                oController._mergeCarrierCatalogAndAccounts();

            },
            error: function (oError) {
                console.error("âŒ Error loading carrier catalog:", oError);

                var sErrorMsg = "Failed to load carrier catalog";
                if (oError.responseText) {
                    try {
                        var oErrorResponse = JSON.parse(oError.responseText);
                        sErrorMsg = oErrorResponse.error.message.value || sErrorMsg;
                    } catch (e) {
                        console.error("Could not parse error response");
                    }
                }
                sap.m.MessageToast.show(sErrorMsg);
            }
        });
    },

    _mergeCarrierCatalogAndAccounts: function () {
        var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
        var aCatalog = eshipjetModel.getProperty("/uniqueCarriersCatalogData") || [];
        var aAccounts = eshipjetModel.getProperty("/uniqueCarriersAcccountsData") || [];

        // if either list empty, skip
        if (!aCatalog.length || !aAccounts.length) return;

        // Merge CarrierType and ConnectionType
        aCatalog.forEach(function (catalogItem) {
            var match = aAccounts.find(function (acc) {
                return acc.CarrierCode === catalogItem.CarrierCode &&
                    acc.LocationId === catalogItem.ServLoc;
            });

            if (match) {
                catalogItem.CarrierType = match.CarrierType || "";
                catalogItem.ConnectionType = match.ConnectionType || "";
            } else {
                catalogItem.CarrierType = catalogItem.CarrierType || "";
                catalogItem.ConnectionType = catalogItem.ConnectionType || "";
            }
        });

        eshipjetModel.setProperty("/uniqueCarriersCatalogData", aCatalog);
    },


 AddCarrierCatalogSaveDialog: function () {
        var oController = this;
        var oMainModel = oController.getOwnerComponent().getModel("CARRIERS_SRV");
        var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");

        oController.onOpenBusyDialog();

        // âœ… Main Carrier Catalog Values
        var sLocationId = eshipjetModel.getProperty("/CarrierCatalogLocations");
        var sCarrierId = eshipjetModel.getProperty("/carrierId");
        var sErpCarrierId = eshipjetModel.getProperty("/erpCarrierId");
        var sCarrierName = eshipjetModel.getProperty("/CarrierName");
        var sCarrierCoverage = eshipjetModel.getProperty("/ServiceCoverage");
        var sStatus = eshipjetModel.getProperty("/IS_ACTIVE");

        // âœ… Child Service Items
        var aServiceItems = eshipjetModel.getProperty("/addCrrierDialogItems") || [];

        if (!sLocationId || !sCarrierName) {
            sap.m.MessageBox.error("Please fill in all mandatory fields: Location ID and Carrier Code.");
            oController.onCloseBusyDialog();
            return;
        }

        // âœ… Enable batch mode
        oMainModel.setUseBatch(true);
        oMainModel.setDeferredGroups(["batchGroup1"]);

        // Create entries in deferred group
        for (var j = 0; j < aServiceItems.length; j++) {
            var oItem = aServiceItems[j];

            var oPayload = {
                "CreatedBy": "",
                "CreatedOn": "",
                "CarrierCode": sCarrierId,
                "ServCode": oItem.ServCode,
                "ServLoc": sLocationId,
                "ServDesc": oItem.ServDesc,
                "ErpServId": oItem.ErpServId,
                "ServiceCoverage": oItem.ServiceCoverage,
                "IsActive": oItem.IsActive
            };

            oMainModel.create("/carrier_srvSet", oPayload, {
                groupId: "batchGroup1",
                changeSetId: "changeset1" // important!
            });
        }

        // âœ… Submit the batch group
        oMainModel.submitChanges({
            groupId: "batchGroup1",
            success: function (oData, oResponse) {
                sap.m.MessageToast.show("âœ… Carrier Catalog created successfully!");
                oController.byId("idAddCarrierDialog").close();
                oController.onCloseBusyDialog();
                oController.onGetCarrierCatalogData();
            },
            error: function (oError) {
                oController.onCloseBusyDialog();

                var sErrorMsg = "Error while creating carrier.";
                try {
                    if (oError && oError.responseText) {
                        var oErrorXML = new window.DOMParser().parseFromString(oError.responseText, "text/xml");
                        var sMsgNode = oErrorXML.getElementsByTagName("message")[0];
                        if (sMsgNode) {
                            sErrorMsg = sMsgNode.textContent;
                        }
                    }
                } catch (e) {
                    console.error("Error parsing response:", e);
                }

                sap.m.MessageBox.error(sErrorMsg);
            }
        });
    },

onEditCarrierCatalogPress: function (oEvent) {
    var oController = this;
    var oMainModel = oController.getOwnerComponent().getModel("CARRIERS_SRV");
    var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
    eshipjetModel.setProperty("/showCarrierCatalogSaveBtn", false);
    eshipjetModel.setProperty("/showCarrierCatalogUpdateBtn", true);

    // âœ… 1ï¸âƒ£ Get selected row from table
    var oCurrentObj = oEvent.getSource().getBindingContext("eshipjetModel").getObject();
    var sLocationId = oCurrentObj.ServLoc || oCurrentObj.Plant;
    var sCarrierCode = oCurrentObj.CarrierCode;

    if (!sLocationId || !sCarrierCode) {
        sap.m.MessageToast.show("Missing Location ID or Carrier Code for edit.");
        return;
    }

    oController.onOpenBusyDialog();

    oMainModel.read("/carrier_srvSet", {
    success: function (oData) {
        oController.onCloseBusyDialog();

        var aResults = oData.results || [];
        var aFiltered = aResults.filter(function (oItem) {
            return (
                oItem.ServLoc === sLocationId &&
                oItem.CarrierCode === sCarrierCode
            );
        });
        eshipjetModel.setProperty("/addCrrierDialogItems", aFiltered);
        if (aFiltered.length === 0) {
            sap.m.MessageToast.show("No carrier data found for selected record.");
            return;
        }

        var oCarrierData = aFiltered[0];
        console.log("âœ… Matched Carrier:", oCarrierData);

        // -------------------------------
        // Header binding
        // -------------------------------
        eshipjetModel.setProperty("/CarrierCatalogLocations", oCarrierData.ServLoc);
        eshipjetModel.setProperty("/carrierId", oCarrierData.CarrierCode);
        eshipjetModel.setProperty("/CarrierName", oCarrierData.CarrierCode || "");
        eshipjetModel.setProperty("/erpCarrierId", oCarrierData.CarrierCode || "");
        eshipjetModel.setProperty("/CarrierType", oCarrierData.CarrierType || "");
        eshipjetModel.setProperty("/ServiceCoverage", oCarrierData.ServiceCoverage || "");
        eshipjetModel.setProperty("/connectionType1", oCarrierData.ConnectionType || "");
        // eshipjetModel.setProperty("/IS_ACTIVE", oCarrierData.IsActive === true || oCarrierData.IsActive === "X");
        eshipjetModel.setProperty("/carrierColorCode", oCarrierData.ColorCode || "#808080");
        eshipjetModel.setProperty("/isEisAddCarrierEditModeditMode", true);
        eshipjetModel.setProperty("/selectedCarrierKey", oCarrierData.CarrierCode);
        eshipjetModel.setProperty("/IS_ACTIVE", oCarrierData.IsActive === true);

        // -------------------------------
        // Open dialog
        // -------------------------------
        oController.AddCarrierDialog(oEvent);
    },
    error: function (oError) {
        oController.onCloseBusyDialog();
        console.error("âŒ Error reading carrier details:", oError);
        sap.m.MessageBox.error("Failed to load carrier data for edit.");
    }
});
},



AddCarrierCatalogupdateDialog: function () {
    var oController = this;
    var oMainModel = oController.getOwnerComponent().getModel("CARRIERS_SRV");
    var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");

    oController.onOpenBusyDialog();

    // âœ… Header-level data
    var sLocationId = eshipjetModel.getProperty("/CarrierCatalogLocations");
    var sCarrierId = eshipjetModel.getProperty("/carrierId");
    var sErpCarrierId = eshipjetModel.getProperty("/erpCarrierId");
    var sCarrierName = eshipjetModel.getProperty("/CarrierName");
    var sCarrierCoverage = eshipjetModel.getProperty("/ServiceCoverage");
    var sStatus = eshipjetModel.getProperty("/IS_ACTIVE");
    var sCarrierType = eshipjetModel.getProperty("/CarrierType");
    var sConnectionType = eshipjetModel.getProperty("/connectionType1");
    var sColorCode = eshipjetModel.getProperty("/carrierColorCode");

    // âœ… Child service line items
    var aServiceItems = eshipjetModel.getProperty("/addCrrierDialogItems") || [];

    // âœ… Enable batch processing
    oMainModel.setUseBatch(true);
    oMainModel.setDeferredGroups(["batchGroup1"]);

    // âœ… Add update operations to the batch
    for (var i = 0; i < aServiceItems.length; i++) {
        var oItem = aServiceItems[i];

        // Build payload for each line item
        var oPayload = {
            "ServLoc": sLocationId,
            "CarrierCode": sCarrierId,
            "ServCode": oItem.ServCode,
            "ServDesc": oItem.ServDesc || "",
            "ErpServId": oItem.ErpServId || "",
            "ServiceCoverage": oItem.ServiceCoverage || sCarrierCoverage || "",
            // "ConnectionType": oItem.ConnectionType || sConnectionType || "",
            "IsActive": oItem.IsActive
            // "CarrierType": sCarrierType || "",
            // "ColorCode": sColorCode || "#808080"

            // "CarrierCode": sCarrierId,
            //     "ServCode": oItem.ServCode,
            //     "ServLoc": sLocationId,
            //     "ServDesc": oItem.ServDesc,
            //     "ErpServId": oItem.ErpServId,
            //     "ServiceCoverage": oItem.ServiceCoverage,
            //     "IsActive": oItem.IsActive
        };

        // Construct entity key for update path (use key fields)
       var sPath = "/carrier_srvSet(CarrierCode='" + encodeURIComponent(sCarrierId) + "')";

        // Add update request to batch
        oMainModel.update(sPath, oPayload, {
            groupId: "batchGroup1",
            changeSetId: "changeset1"
        });
    }

    // âœ… Submit the batch request
    oMainModel.submitChanges({
        groupId: "batchGroup1",
        success: function (oData, oResponse) {
            oController.onCloseBusyDialog();
            sap.m.MessageToast.show("âœ… Carrier Catalog updated successfully!");
            oController.byId("idAddCarrierDialog").close();
            oController.onGetCarrierCatalogData();
        },
        error: function (oError) {
            oController.onCloseBusyDialog();

            var sErrorMsg = "Error while updating carrier catalog.";
            try {
                if (oError && oError.responseText) {
                    var oErrorXML = new window.DOMParser().parseFromString(oError.responseText, "text/xml");
                    var sMsgNode = oErrorXML.getElementsByTagName("message")[0];
                    if (sMsgNode) {
                        sErrorMsg = sMsgNode.textContent;
                    }
                }
            } catch (e) {
                console.error("Error parsing error response:", e);
            }

            sap.m.MessageBox.error(sErrorMsg);
        }
    });
},


AddCarrierCancelDialog: function() {
    // Reset all form fields in the model
    this.getView().getModel("eshipjetModel").setProperty("/CarrierCatalogLocations", "");
    this.getView().getModel("eshipjetModel").setProperty("/commonValues/ShipNowShipsrvNameSelectedKey", "");
    this.getView().getModel("eshipjetModel").setProperty("/carrierId", "");
    this.getView().getModel("eshipjetModel").setProperty("/erpCarrierId", "");
    this.getView().getModel("eshipjetModel").setProperty("/CarrierType", "");
    this.getView().getModel("eshipjetModel").setProperty("/ServiceCoverage", "");
    this.getView().getModel("eshipjetModel").setProperty("/connectionType1", "");
    this.getView().getModel("eshipjetModel").setProperty("/CarrierName", "");
    this.getView().getModel("eshipjetModel").setProperty("/addCrrierDialogItems", [{
            "ServDesc": "",
            "ErpServId": "",
            "ServCode": "",
            "ServiceCoverage": "",
            "IsActive": false
        }]);
    
    // Close the dialog
    this.byId("idAddCarrierDialog").close();
},







// carrieraccountmstart-----------------------------------------------------------------------------------------------------------

 onGetCarrierAccoData: function () {
    var oController = this;
    var oMainModel = oController.getOwnerComponent().getModel("CARRIERS_SRV");
    var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");

    oMainModel.read("/carrierSet", {
        
        success: function (oData, response) {
            eshipjetModel.setProperty("/uniqueCarriersAcccountsData", uniqueCarriersAcccountsData);
            oController.onCloseBusyDialog();
            var aData = oData.results;
            eshipjetModel.setProperty("/carriersAcccountsData", aData);
            
            eshipjetModel.setProperty("/carriersList", aData);
            eshipjetModel.setProperty("/totalCarriersAcccountsCount", aData.length);
            
            var uniqueCarriersAcccountsData = [];
            var seen = new Set();

            var activeCarriersAcccountsCount = 0;
            var inActiveCarriersAcccountsCount = 0;
            aData.forEach(function (item) {
                if(item.IsActive === true){
                    activeCarriersAcccountsCount += 1;
                }else if(item.IsActive === false){
                    inActiveCarriersAcccountsCount += 1;
                }
                var key = item.CarrierCode + "_" + item.LocationId;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueCarriersAcccountsData.push(item);
                }
            });
            eshipjetModel.setProperty("/uniqueCarriersAcccountsData", uniqueCarriersAcccountsData);
            eshipjetModel.setProperty("/activeCarriersAcccountsCount", activeCarriersAcccountsCount);
            eshipjetModel.setProperty("/inActiveCarriersAcccountsCount", inActiveCarriersAcccountsCount);
            console.log("Read success:", oData.results);
            oController._mergeCarrierCatalogAndAccounts();

        },
        error: function (oError) {
            console.error("âŒ Error loading carrier catalog:", oError);

            var sErrorMsg = "Failed to load carrier catalog";
            if (oError.responseText) {
                try {
                    var oErrorResponse = JSON.parse(oError.responseText);
                    sErrorMsg = oErrorResponse.error.message.value || sErrorMsg;
                } catch (e) {
                    console.error("Could not parse error response");
                }
            }
            sap.m.MessageToast.show(sErrorMsg);
                }
            });
        },

      AddCarrierConfigurationSaveDialog: function () {
            var oController = this;
            // âœ… Get models
            var oMainModel = oController.getOwnerComponent().getModel("CARRIERS_SRV");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");

            oController.onOpenBusyDialog();

            // âœ… Collect all values from the eshipjetModel
            var sLocationId = eshipjetModel.getProperty("/carrierAccountsLocationId");
            var sCarrierCode = eshipjetModel.getProperty("/carrierAccountsCarrierName");
            var sCarrierType = eshipjetModel.getProperty("/carrierAccountsCarrierType");
            var sShipFrmCntry = eshipjetModel.getProperty("/carrierAccountsShipFromCountryName");
            var sShipToCntry = eshipjetModel.getProperty("/carrierAccountsShipToCountryName");
            var sAcntNmbr = eshipjetModel.getProperty("/carrierAccountsAccountNumber");
            var sUserId = eshipjetModel.getProperty("/carrierAccountsUserId");
            var sPassword = eshipjetModel.getProperty("/carrierAccountsPassword");
            var sAccessKey = eshipjetModel.getProperty("/carrierAccountsAccessKey");
            var sMeterId = eshipjetModel.getProperty("/carrierAccountsMeterId");
            var sHubId = eshipjetModel.getProperty("/carrierAccountsHubId");
            var sConnectionType = eshipjetModel.getProperty("/carrierAccountsConnectionType");

            var sLabelType = eshipjetModel.getProperty("/carrierAcntsLabelType");
            var sRateUrl = eshipjetModel.getProperty("/carrierAcntsRateUrl");
            var sShipUrl = eshipjetModel.getProperty("/carrierAcntsShipUrl");
            var sTrackUrl = eshipjetModel.getProperty("/carrierAcntsTrackUrl");
            var sVoidUrl = eshipjetModel.getProperty("/carrierAcntsVoidUrl");
            var sPodUrl = eshipjetModel.getProperty("/carrierAcntsPodUrl");
            var sTokenUrl = eshipjetModel.getProperty("/carrierAcntsTokenUrl");
            var sRateQuote = eshipjetModel.getProperty("/carrierAcntsRateQuote");
            var sFreightQuote = eshipjetModel.getProperty("/carrierAcntsFreightQuote");
            var sEndOfDay = eshipjetModel.getProperty("/carrierAcntsEndOfDay");
            var sManualRates = eshipjetModel.getProperty("/carrierAcntsManualRates");
            var sAutomateProNumber = eshipjetModel.getProperty("/carrierAcntsAutomaticProNum");

            var sacsrvnametable = eshipjetModel.getProperty("/carrierAcntTblSrvName");
            var carrierAcntTblErpSrvName = eshipjetModel.getProperty("/carrierAcntTblErpSrvName");
            var carrierAcntTblSrvCode = eshipjetModel.getProperty("/carrierAcntTblSrvCode");
            var carrierAcntTblSrvCoverage = eshipjetModel.getProperty("/carrierAcntTblSrvCoverage");
            var carrierAcntTblStatus = eshipjetModel.getProperty("/carrierAcntTblStatus");

            // âœ… Service details (child table data)
            var aServiceItems = eshipjetModel.getProperty("/carrierAccountsTableItems") || [];

            // âœ… Validation for mandatory fields
            if (!sLocationId || !sCarrierCode) {
                sap.m.MessageBox.error("Please fill in all mandatory fields: Location ID and Carrier Code.");
                oController.onCloseBusyDialog();
                return; // stop execution, don't continue to save
            }
            // âœ… Build OData Payload for Carrier
            var oPayload = {
                "LocationId": sLocationId || "",
                "CarrierCode": sCarrierCode || "",
                "CarrierDescription": "",
                "CarrierType": sCarrierType || "",
                "ShipFrmCntry": sShipFrmCntry || "",
                "ShipToCntry": sShipToCntry || "",
                "AcntNmbr": sAcntNmbr || "",
                "UserId": sUserId || "",
                "Password": sPassword || "",
                "AccessKey": sAccessKey || "",
                "MeterId": sMeterId || "",
                "HubId": sHubId || "",
                "ConnectionType": sConnectionType || "",
                "LabelType": sLabelType || "",
                "RateUrl": sRateUrl || "",
                "ShipUrl": sShipUrl || "",
                "TrackUrl": sTrackUrl || "",
                "VoidUrl": sVoidUrl || "",
                "PodUrl": sPodUrl || "",
                "TokenUrl": sTokenUrl || "",
                "RateQuote": sRateQuote  === true ? "X" : "",
                "FreightQuote": sFreightQuote  === true ? "X" : "",
                "EndOfDay": sEndOfDay  === true ? "X" : "",
                "ManualRates": sManualRates  === true ? "X" : "",
                "AutomateProNumber": sAutomateProNumber  === true ? "X" : "",
                "CreatedOn": new Date().toISOString(),
                "CreatedBy": "VINAY", // optional - replace dynamically if needed
                "LastChangedOn": new Date().toISOString(),
                "LastChangedBy": "VINAY",
                "IsActive": true,
                
            };

    // âœ… Perform OData POST for Carrier
    oMainModel.create("/carrierSet", oPayload, {
        success: function (oData) {
            sap.m.MessageToast.show("Carrier configuration created successfully!");
            oController.byId("idAddCarrierConfigurationDialog").close();
            oController.onCloseBusyDialog();
            oController.onGetCarrierAccoData(); // Refresh table
        },
        error: function (oError) {
            console.error("âŒ Error creating carrier:", oError);
            oController.onCloseBusyDialog();
            sap.m.MessageBox.error("Failed to create carrier configuration.");
        }
    });
},


    AddCarrierConfigurationUpdateDialog: function () {
        var oController = this;

        // âœ… Get models
        var oMainModel = oController.getOwnerComponent().getModel("CARRIERS_SRV");
        var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");

        oController.onOpenBusyDialog();

        // âœ… Collect all values from the eshipjetModel
        var sLocationId = eshipjetModel.getProperty("/carrierAccountsLocationId");
        var sCarrierCode = eshipjetModel.getProperty("/carrierAccountsCarrierName");
        var sCarrierType = eshipjetModel.getProperty("/carrierAccountsCarrierType");
        var sShipFrmCntry = eshipjetModel.getProperty("/carrierAccountsShipFromCountryName");
        var sShipToCntry = eshipjetModel.getProperty("/carrierAccountsShipToCountryName");
        var sAcntNmbr = eshipjetModel.getProperty("/carrierAccountsAccountNumber");
        var sUserId = eshipjetModel.getProperty("/carrierAccountsUserId");
        var sPassword = eshipjetModel.getProperty("/carrierAccountsPassword");
        var sAccessKey = eshipjetModel.getProperty("/carrierAccountsAccessKey");
        var sMeterId = eshipjetModel.getProperty("/carrierAccountsMeterId");
        var sHubId = eshipjetModel.getProperty("/carrierAccountsHubId");
        var sConnectionType = eshipjetModel.getProperty("/carrierAccountsConnectionType");

        var sLabelType = eshipjetModel.getProperty("/carrierAcntsLabelType");
        var sRateUrl = eshipjetModel.getProperty("/carrierAcntsRateUrl");
        var sShipUrl = eshipjetModel.getProperty("/carrierAcntsShipUrl");
        var sTrackUrl = eshipjetModel.getProperty("/carrierAcntsTrackUrl");
        var sVoidUrl = eshipjetModel.getProperty("/carrierAcntsVoidUrl");
        var sPodUrl = eshipjetModel.getProperty("/carrierAcntsPodUrl");
        var sTokenUrl = eshipjetModel.getProperty("/carrierAcntsTokenUrl");
        var sRateQuote = eshipjetModel.getProperty("/carrierAcntsRateQuote");
        var sFreightQuote = eshipjetModel.getProperty("/carrierAcntsFreightQuote");
        var sEndOfDay = eshipjetModel.getProperty("/carrierAcntsEndOfDay");
        var sManualRates = eshipjetModel.getProperty("/carrierAcntsManualRates");
        var sAutomateProNumber = eshipjetModel.getProperty("/carrierAcntsAutomaticProNum");

        var sacsrvnametable = eshipjetModel.getProperty("/carrierAcntTblSrvName");
        var carrierAcntTblErpSrvName = eshipjetModel.getProperty("/carrierAcntTblErpSrvName");
        var carrierAcntTblSrvCode = eshipjetModel.getProperty("/carrierAcntTblSrvCode");
        var carrierAcntTblSrvCoverage = eshipjetModel.getProperty("/carrierAcntTblSrvCoverage");
        var carrierAcntTblStatus = eshipjetModel.getProperty("/carrierAcntTblStatus");

        // âœ… Service details (child table data)
        var aServiceItems = eshipjetModel.getProperty("/carrierAccountsTableItems") || [];

        // âœ… Build OData Payload for Carrier
        var oPayload = {
            "LocationId": sLocationId || "",
            "CarrierCode": sCarrierCode || "",
            "CarrierDescription": sCarrierCode,
            "CarrierType": sCarrierType || "",
            "ShipFrmCntry": sShipFrmCntry || "",
            "ShipToCntry": sShipToCntry || "",
            "AcntNmbr": sAcntNmbr || "",
            "UserId": sUserId || "",
            "Password": sPassword || "",
            "AccessKey": sAccessKey || "",
            "MeterId": sMeterId || "",
            "HubId": sHubId || "",
            "ConnectionType": sConnectionType || "",
            "LabelType": sLabelType || "",
            "RateUrl": sRateUrl || "",
            "ShipUrl": sShipUrl || "",
            "TrackUrl": sTrackUrl || "",
            "VoidUrl": sVoidUrl || "",
            "PodUrl": sPodUrl || "",
            "TokenUrl": sTokenUrl || "",
            "RateQuote": sRateQuote === true ? "X" : "",
            "FreightQuote": sFreightQuote === true ? "X" : "",
            "EndOfDay": sEndOfDay === true ? "X" : "",
            "ManualRates": sManualRates === true ? "X" : "",
            "AutomateProNumber": sAutomateProNumber === true ? "X" : "",
            "CreatedOn": new Date().toISOString(),
            "CreatedBy": "VINAY", // optional - replace dynamically if needed
            "LastChangedOn": new Date().toISOString(),
            "LastChangedBy": "VINAY",
            "IsActive": true,

        };
        var sPath = "/carrierSet('" + sCarrierCode + "')";
        oController.onOpenBusyDialog();

        // Force refresh of CSRF token safely
        oMainModel.refreshSecurityToken(); // ensures fresh X-CSRF token
        oMainModel.update(sPath, oPayload, {
            headers: {
                "X-CSRF-Token": oMainModel.getHeaders()["x-csrf-token"]
            },
            method: "PATCH",
            success: function() { 
                sap.m.MessageToast.show("Carrier configuration updated successfully!");
                    oController.byId("idAddCarrierConfigurationDialog").close();
                    oController.onCloseBusyDialog();
                oController.onGetCarrierAccoData(); // Refresh table
                },
            error: function(oError) { 
                console.error("âŒ Error updating carrier:", oError);
                    oController.onCloseBusyDialog();
                    sap.m.MessageBox.error("Failed to update carrier configuration.");}
        });
    },



    onEditCarrierAccountPress: function (oEvent) {
            var oController = this;
            var oMainModel = oController.getOwnerComponent().getModel("CARRIERS_SRV");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            eshipjetModel.setProperty("/showCarrierAccountSaveBtn", false);
            eshipjetModel.setProperty("/showCarrierAccountUpdateBtn", true);
            

            // âœ… Get selected table row data
            var oCurrentObj = oEvent.getSource().getBindingContext("eshipjetModel").getObject();
            var sLocationId = oCurrentObj.LocationId || oCurrentObj.Plant;
            var sCarrierCode = oCurrentObj.CarrierCode;
            oController.onOpenBusyDialog();

            oMainModel.read("/carrier_srvSet", {
                success: function (oData) {
                    oController.onCloseBusyDialog();

                    var aResults = oData.results || [];
                    var aFiltered = aResults.filter(function (oItem) {
                        return (
                            oItem.ServLoc === sLocationId &&
                        oItem.CarrierCode === sCarrierCode
                        );
                    });
                    eshipjetModel.setProperty("/carrierAccountsTableItems", aFiltered);
                if (aFiltered.length === 0) {
                    sap.m.MessageToast.show("No carrier data found for selected record.");
                    aFiltered = [oCurrentObj];
                
                }

                    var oCarrierData = oCurrentObj;
                    console.log("âœ… Matched Carrier Account:", oCarrierData);

                    // âœ… Fill all carrier account fields
                    eshipjetModel.setProperty("/carrierAccountsLocationId", oCarrierData.LocationId);
                    eshipjetModel.setProperty("/carrierAccountsCarrierName", oCarrierData.CarrierCode);
                    eshipjetModel.setProperty("/carrierAccountsCarrierType", oCarrierData.CarrierType || "");
                    eshipjetModel.setProperty("/carrierAccountsShipFromCountryName", oCarrierData.ShipFrmCntry || "");
                    eshipjetModel.setProperty("/carrierAccountsShipToCountryName", oCarrierData.ShipToCntry || "");
                    eshipjetModel.setProperty("/carrierAccountsAccountNumber", oCarrierData.AcntNmbr || "");
                    eshipjetModel.setProperty("/carrierAccountsUserId", oCarrierData.UserId || "");
                    eshipjetModel.setProperty("/carrierAccountsPassword", oCarrierData.Password || "");
                    eshipjetModel.setProperty("/carrierAccountsAccessKey", oCarrierData.AccessKey || "");
                    eshipjetModel.setProperty("/carrierAccountsMeterId", oCarrierData.MeterId || "");
                    eshipjetModel.setProperty("/carrierAccountsHubId", oCarrierData.HubId || "");
                    eshipjetModel.setProperty("/carrierAccountsConnectionType", oCarrierData.ConnectionType || "");
                    eshipjetModel.setProperty("/carrierAcntsRateUrl", oCarrierData.RateUrl || "");
                    eshipjetModel.setProperty("/carrierAcntsShipUrl", oCarrierData.ShipUrl || "");
                    eshipjetModel.setProperty("/carrierAcntsVoidUrl", oCarrierData.VoidUrl || "");
                    eshipjetModel.setProperty("/carrierAcntsTrackUrl", oCarrierData.TrackUrl || "");

                    eshipjetModel.setProperty("/selectedCarrierKey", oCarrierData.CarrierCode);

                    // âœ… Finally, open the dialog
                    oController.AddCarrierConfigurationDialogPress(oEvent);
                },
                error: function (oError) {
                    oController.onCloseBusyDialog();
                    console.error("âŒ Error loading carrier account data:", oError);
                    sap.m.MessageBox.error("Failed to load carrier account details for edit.");
                }
            });
        },

    oncarrieraccountsvaluehelpSearchDialog: function () {
            var oView = this.getView();
            oController.ShipNowSearchDlg = oController.byId("idCarrierAccountsValueHelpDialog");
            if (!oController.ShipNowSearchDlg) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.carrieraccountsvaluehelp",
                    controller: this
                }).then(function (oShipNowSearchDialog) {
                    oView.addDependent(oShipNowSearchDialog);
                    oShipNowSearchDialog.open();
                });
            } else {
                oController.ShipNowSearchDlg.open();
            }
        },

        onCarrieraccountSearchDialogClosePress: function () {
            oController.byId("idCarrierAccountsValueHelpDialog").close();
        },

        onCarrierSearch: function(oEvent) {
            var sQuery = oEvent.getParameter("newValue");
            var oTable = this.byId("carrierTable");
            var oBinding = oTable.getBinding("items");
            var oFilter = new sap.ui.model.Filter("CarrierName", sap.ui.model.FilterOperator.Contains, sQuery);
            oBinding.filter(oFilter);
        },

    onCarrierItemPress: function (oEvent) {
            var oController = this;
            var oMainModel = oController.getOwnerComponent().getModel("CARRIERS_SRV");
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");

            // Get selected carrier info
            var oSelectedData = oEvent.getSource().getBindingContext("eshipjetModel").getObject();
            var sLocationId = oSelectedData.ServLoc;
            var sCarrierCode = oSelectedData.CarrierCode;

            // Set basic selected values immediately
            eshipjetModel.setProperty("/carrierAccountsLocationId", sLocationId);
            eshipjetModel.setProperty("/carrierAccountsCarrierName", sCarrierCode);
            // âœ… Fetch carrier account details
            oMainModel.read("/carrier_srvSet", {
            success: function (oData) {
            var aResults = oData.results || [];

            // âœ… Filter all matching records
            var resultsArray = aResults.filter(function (obj) {
                return obj.ServLoc === sLocationId && obj.CarrierCode === sCarrierCode;
            });

            if (resultsArray.length > 0) {
                // Get the first (main) record for header details
                var oFiltered = resultsArray[0];

                console.log("âœ… Existing carrier account found:", resultsArray);

                // Fill all fields from backend (using first record)
                eshipjetModel.setProperty("/carrierAccountsCarrierType", oFiltered.CarrierType);
                eshipjetModel.setProperty("/carrierAccountsShipFromCountryName", oFiltered.ShipFrmCntry);
                eshipjetModel.setProperty("/carrierAccountsShipToCountryName", oFiltered.ShipToCntry);
                eshipjetModel.setProperty("/carrierAccountsAccountNumber", oFiltered.AcntNmbr);
                eshipjetModel.setProperty("/carrierAccountsUserId", oFiltered.UserId);
                eshipjetModel.setProperty("/carrierAccountsPassword", oFiltered.Password);
                eshipjetModel.setProperty("/carrierAccountsAccessKey", oFiltered.AccessKey);
                eshipjetModel.setProperty("/carrierAccountsMeterId", oFiltered.MeterId);
                eshipjetModel.setProperty("/carrierAccountsHubId", oFiltered.HubId);
                eshipjetModel.setProperty("/carrierAccountsConnectionType", oFiltered.ConnectionType);

                // âœ… Bind all matching child rows to table
                eshipjetModel.setProperty("/carrierAccountsTableItems", resultsArray);
            } else {
                console.log("â„¹ï¸ No existing carrier account found, new record will be created.");
                eshipjetModel.setProperty("/carrierAccountsTableItems", []);
            }

            // Close dialog after selection
            oController.onCarrieraccountSearchDialogClosePress();
        },

                error: function (oError) {
                    console.error("âŒ Error loading carrier account:", oError);
                    sap.m.MessageBox.error("Failed to load carrier account data.");
                }
            });
        },



    onCarrierSelect: function() {
            var oSelectedCarrier = this.getView().byId("carrierTable").getSelectedItem();
            if (oSelectedCarrier) {
                var oCarrierData = oSelectedCarrier.getBindingContext().getObject();
                // Do something with the selected carrier (e.g., update fields, etc.)
            }
            this.onCarrierDialogClose();
        },

    onGetCarrierAccountValueHelpData: function () {
        var oController = this;
        var oMainModel = oController.getOwnerComponent().getModel("CARRIERS_SRV");
        var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
        var carrierAccountsLocationId = eshipjetModel.getProperty("/carrierAccountsLocationId");

        oMainModel.read("/carrier_srvSet", {
            success: function (oData) {
                console.log("âœ… Carrier data loaded:", oData);
                  var aResults = oData.results || [];

            // âœ… Filter all matching records
                var resultsArray = aResults.filter(function (obj) {
                    return obj.ServLoc === carrierAccountsLocationId;
                });
                var uniqueCarriersAcccountsValueHelpData = [];
                var seen = new Set();
                resultsArray.forEach(function (item) {
                    var key = item.CarrierCode;
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueCarriersAcccountsValueHelpData.push(item);
                    }
                });
                eshipjetModel.setProperty("/uniqueCarriersAcccountsValueHelpData", uniqueCarriersAcccountsValueHelpData);
                oController.oncarrieraccountsvaluehelpSearchDialog();
            },
            error: function (oError) {
                console.error("âŒ Error loading carrier catalog:", oError);

                var sErrorMsg = "Failed to load carrier catalog";
                try {
                    if (oError.responseText) {
                        var oErrorResponse = JSON.parse(oError.responseText);
                        sErrorMsg = oErrorResponse.error?.message?.value || sErrorMsg;
                    }
                } catch (e) {
                    console.error("Could not parse error response");
                }

                sap.m.MessageToast.show(sErrorMsg);
            }
        });
    },

// Method to clear all carrier configuration fields
    _clearCarrierConfigurationFields: function() {
        var oModel = this.getView().getModel("eshipjetModel");
        
        // Clear all carrier account fields
        oModel.setProperty("/carrierAccountsLocationId", "");
        oModel.setProperty("/carrierAccountsCarrierName", "");
        oModel.setProperty("/carrierAccountsCarrierType", "");
        oModel.setProperty("/carrierAccountsShipFromCountryName", "");
        oModel.setProperty("/carrierAccountsShipToCountryName", "");
        oModel.setProperty("/carrierAccountsCostCentre", "");
        oModel.setProperty("/carrierAccountsEnvironment", "");
        oModel.setProperty("/carrierAccountsAccountNumber", "");
        oModel.setProperty("/carrierAccountsUserId", "");
        oModel.setProperty("/carrierAccountsPassword", "");
        oModel.setProperty("/carrierAccountsAccessKey", "");
        oModel.setProperty("/carrierAccountsMeterId", "");
        oModel.setProperty("/carrierAccountsHubId", "");
        oModel.setProperty("/carrierAccountsConnectionType", "");
        oModel.setProperty("/carrierAcntsRateUrl", "");
        oModel.setProperty("/carrierAcntsShipUrl", "");
        oModel.setProperty("/carrierAcntsVoidUrl", "");
        oModel.setProperty("/carrierAcntsTrackUrl", "");
        oModel.setProperty("/carrierAcntsPodUrl", "");
        oModel.setProperty("/carrierAcntsTokenUrl", "");
        oModel.setProperty("/carrierAcntsRateQuote", false);
        oModel.setProperty("/carrierAcntsFreightQuote", false);
        oModel.setProperty("/carrierAcntsEndOfDay", false);
        oModel.setProperty("/carrierAcntsManualRates", false);
        oModel.setProperty("/carrierAcntsAutomaticProNum", false);

        
        // Clear the table items
        oModel.setProperty("/carrierAccountsTableItems", []);
        
        // Optional: Reset to default empty row if needed
        // oModel.setProperty("/carrierAccountsTableItems", [{
        //     ServDesc: "",
        //     ErpServId: "",
        //     CarrierCode: "",
        //     ServiceCoverage: "",
        //     IsActive: false
        // }]);
    },

    // Update your close dialog handler
    AddCarrierConfigurationCloseDialog: function() {
        var oDialog = this.byId("idAddCarrierConfigurationDialog");
        if (oDialog) {
            oDialog.close();
            // Clear all fields when dialog is closed
            this._clearCarrierConfigurationFields();
        }
    },




     onShipNowGetPress: async function () {

    var oController = this;
    var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
    var sDeveliveryNumber = eshipjetModel.getProperty("/commonValues/sapDeliveryNumber");

    // *** IMPORTANT CHANGE FOR ON-PREMISE ***
    var GetDeliveryDataModel = oController.getOwnerComponent().getModel("OutBoundDeliveryModel");

    // Basic validations
    if (!sDeveliveryNumber) {
        MessageBox.error("Delivery number is missing.");
        throw new Error("No delivery number found in model");
    }

    if (sDeveliveryNumber.length !== 8) {
        MessageBox.error("Please enter a valid 8-digit Delivery number.");
        throw new Error("Invalid delivery number length");
    }

    try {
        oController.onOpenBusyDialog();

        // Reset old data
        eshipjetModel.setProperty("/to_HandlingUnitHeaderDelivery/results", []);
        eshipjetModel.setProperty("/to_DeliveryDocumentItem", []);

        // -------------------------
        // MANIFEST CHECK
        // -------------------------
        var manifestExists = await oController._checkManifestAvailability(sDeveliveryNumber);

        if (manifestExists) {
            await oController.getManifestHeaderForCharges(sDeveliveryNumber);
            oController.onCloseBusyDialog();
            return;  // <<< STOP HERE
        }

    } catch (e) {
        oController.onCloseBusyDialog();
        MessageBox.error("Error checking manifest availability.");
        return;
    }

    // -------------------------
    // OLD LOGIC (Runs only when no manifest exists)
    // -------------------------

    function readDeliveryData() {
        return new Promise(function (resolve, reject) {

            GetDeliveryDataModel.read("/A_OutbDeliveryHeader", {
                filters: [
                    new sap.ui.model.Filter("DeliveryDocument", sap.ui.model.FilterOperator.EQ, sDeveliveryNumber)
                ],
                urlParameters: {
                    "$expand": [
                        "to_DeliveryDocumentItem",
                        "to_DeliveryDocumentPartner",
                        "to_DeliveryDocumentPartner/to_Address2",
                        "to_DeliveryDocumentPartner/to_Address",
                        "to_HandlingUnitHeaderDelivery",
                        "to_HandlingUnitHeaderDelivery/to_HandlingUnitItemDelivery",
                        "to_DeliveryDocumentItem/to_HandlingUnitItemDelivery"
                    ].join(",")
                },

                success: function (oData) {

                    if (!oData.results.length) {
                        MessageBox.error("Please enter a valid Delivery number.");
                        reject("Invalid delivery number");
                        return;
                    }

                    var firstRow = oData.results[0];

                    // Set plant
                    if (firstRow.ShippingPoint) {
                        eshipjetModel.setProperty("/commonValues/plant", firstRow.ShippingPoint);
                        eshipjetModel.setProperty("/commonValues/showPlant", true);
                    }

                    eshipjetModel.setProperty("/selectPaymentType", "Sender");

                    eshipjetModel.setProperty("/to_HandlingUnitHeaderDelivery/results",
                        firstRow.to_HandlingUnitHeaderDelivery);

                    var firstRow = oData.results[0];

                    eshipjetModel.setProperty("/to_DeliveryDocumentItem", firstRow.to_DeliveryDocumentItem.results);

                    // ----------------------------------------------------------
                    // ----------------------------------------------------------
                    // 1ï¸âƒ£ Extract carrier from PartnerFunction 'CR'
                    // ----------------------------------------------------------
                    var carrierPartner = firstRow.to_DeliveryDocumentPartner.results.find(
                        p => p.PartnerFunction === "CR"
                    );

                    var carrierName = carrierPartner ? carrierPartner.Supplier : "";  // e.g. "UPS"
                    var shippingType = firstRow.ShippingType;  // e.g. "UG"

                    // ----------------------------------------------------------
                    // 2ï¸âƒ£ Load Carrier Names Dropdown
                    // ----------------------------------------------------------
                    oController.onGetCarrierNamesDataForDropDown(carrierName);

                    // ----------------------------------------------------------
                    // 3ï¸âƒ£ Load Carrier Services Dropdown
                    // ----------------------------------------------------------
                    oController.onGetCarrierServicesDataForDropDown(carrierName, shippingType);

                    // ----------------------------------------------------------
                    // 4ï¸âƒ£ Set Selected Values for View Bindings
                    // ----------------------------------------------------------
                    eshipjetModel.setProperty("/commonValues/ShipNowShipMethodSelectedKey", carrierName);
                    eshipjetModel.setProperty("/commonValues/ShipNowShipsrvNameSelectedKey", shippingType);


                    resolve(firstRow);
                },

                error: function (oError) {
                    reject(oError);
                }
            });

        });
    }

    try {
        // Load delivery data
        var GetDeliveryData = await readDeliveryData();

        // Movement status
        if (GetDeliveryData.OverallGoodsMovementStatus !== undefined) {
            eshipjetModel.setProperty("/commonValues/OverallGoodsMovementStatus", GetDeliveryData.OverallGoodsMovementStatus);
        }

        // ---------------------------------
        // Business Partner Mapping
        // ---------------------------------
        var BusinessPartners = GetDeliveryData.to_DeliveryDocumentPartner.results
            .map(function (partner) {

                var addr = partner.to_Address2;

                var base = {
                    PartnerID: partner.Customer || partner.Supplier,
                    CompanyName: addr.BusinessPartnerName1,
                    ContactName: addr.BusinessPartnerName1,
                    AddressLine1: addr.StreetName,
                    City: addr.CityName,
                    State: addr.Region,
                    PostalCode: addr.PostalCode,
                    Country: addr.Country,
                    PhoneNumber: addr.PhoneNumber,
                    EmailAddress: addr.EmailAddress
                };

                if (partner.PartnerFunction === "SH") {
                    eshipjetModel.setProperty("/ShipToAddress", addr);
                    return { PartnerType: "Ship-to Party", ...base };
                } 

                if (partner.PartnerFunction === "CR") {
                    eshipjetModel.setProperty("/commonValues/ShipNowShipMethodSelectedKey", addr.BusinessPartnerName1);
                    return { PartnerType: "Forwarding Agent", ...base };
                }

                if (partner.PartnerFunction === "SP") {
                    return { PartnerType: "Sold-to Party", ...base };
                }
            })
            .filter(Boolean);

        eshipjetModel.setProperty("/GetDeliveryData", GetDeliveryData);
        eshipjetModel.setProperty("/BusinessPartners", BusinessPartners);
        
        if(GetDeliveryData.Warehouse !== ""){
            oController.getHandlingUnit(GetDeliveryData.DeliveryDocument);
        }

        

        // Store shipping type
        oController.ShippingType = GetDeliveryData.ShippingType;

        // Fetch ShipFrom, HU data, carrier list
        await oController.onGetShipFromData(GetDeliveryData.ShippingPoint);
        await oController.readHUData();
        await oController.readProductPlant();
        // await oController.onGetCarriersDropDownData();

          



        return true;

    } catch (oError) {

        var oResponse = JSON.parse(oError.responseText || "{}");
        var sMessage = oResponse?.error?.message?.value || "Error reading delivery data";

        MessageBox.error(sMessage);
        throw oError;

    } finally {
        oController.onCloseBusyDialog();
    }
},



  _checkManifestAvailability: function (sDeliveryNumber) {
        var oController = this;
        var ManifestSrvModel = oController.getOwnerComponent().getModel("ManifestModel");

        // normalize (remove leading zeros)
        var cleanVbeln = String(Number(sDeliveryNumber));

        return new Promise(function (resolve, reject) {
            ManifestSrvModel.read("/Manifest_detSet", {
                filters: [
                    new sap.ui.model.Filter("Vbeln", sap.ui.model.FilterOperator.EQ, cleanVbeln)
                ],
                success: function (response) {

                    var results = response?.results || [];

                    // ðŸ” Local UI filtering because CDS filter is not applied at backend
                    var filtered = results.filter(function (row) {
                        return (
                            row.Vbeln === cleanVbeln ||     // check field Vbeln
                            row.VBELN_VL === cleanVbeln     // fallback check
                        );
                    });

                    // Store only filtered rows for the UI
                    oController.getOwnerComponent()
                        .getModel("eshipjetModel")
                        .setProperty("/getManifestHeader", filtered);

                    // ðŸ‘‰ Manifest exists only if filtered has rows
                    var exists = filtered.length > 0;

                    resolve(exists);   // âœ” FIXED
                },
                error: function (err) {
                    reject(err);
                }
            });
        });
    },



//   _checkManifestAvailability: function (sDeliveryNumber) {
//         var oController = this;
//         var ManifestSrvModel = oController.getOwnerComponent().getModel("ManifestModel");

//         // normalize (remove leading zeros)
//         var cleanVbeln = String(Number(sDeliveryNumber));

//         return new Promise(function (resolve, reject) {
//             ManifestSrvModel.read("/Manifest_detSet", {
//                 filters: [
//                     new sap.ui.model.Filter("Vbeln", sap.ui.model.FilterOperator.EQ, cleanVbeln)
//                 ],
//                 success: function (response) {

//                     var results = response?.results || [];

//                     // ðŸ” Local UI filtering because CDS filter is not applied at backend
//                     var filtered = results.filter(function (row) {
//                         return (
//                             row.Vbeln === cleanVbeln ||     // check field Vbeln
//                             row.VBELN_VL === cleanVbeln     // fallback check
//                         );
//                     });

//                     console.log("ðŸ“¦ Manifest: total rows returned =", results.length);
//                     console.log("ðŸ” Filtered matching rows =", filtered.length);
//                     console.log("ðŸ” Delivery checked =", cleanVbeln);

//                     // Store only filtered rows for the UI
//                     oController.getOwnerComponent()
//                         .getModel("eshipjetModel")
//                         .setProperty("/getManifestHeader", filtered);

//                     // ðŸ‘‰ Manifest exists only if filtered has rows
//                     var exists = filtered.length > 0;

//                     resolve(exists);   // âœ” FIXED
//                 },
//                 error: function (err) {
//                     reject(err);
//                 }
//             });
//         });
//     },

// readProductPlant: function (sPlant, sMaterial) {
//     var oModel = this.getOwnerComponent().getModel("API_PRODUCT_SRV");
//     var sPath =
//         "/A_ProductPlant(Product='" + sMaterial + "',Plant='" + sPlant + "')";

//     return new Promise(function (resolve, reject) {
//         oModel.read(sPath, {
//             success: function (oResult) {

//       if (
//             oResult.SerialNumberProfile !== "" &&
//             oResult.SerialNumberProfile !== undefined
//         ) {
//             row.isSerialSelected = true;
//             row._isSerialMandatory = true;
//         } else {
//             row.isSerialSelected = false;
//             row._isSerialMandatory = false;
//         }

//         eshipjetModel.refresh(true);
//                 resolve(oData);
//             },
//             error: function (oError) {
//                 reject(oError);
//             }
//         });
//     });
// },


readProductPlant: function () {
    var APIProductSrvModel = this.getOwnerComponent().getModel("API_PRODUCT_SRV");
    var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");

    var aItems = eshipjetModel.getProperty("/to_DeliveryDocumentItem") || [];
    var Plant = eshipjetModel.getProperty("/commonValues/plant");

    aItems.forEach(function (row) {

        if (row.Material !== "" && row.Material !== undefined) {
            APIProductSrvModel.read(
                "/A_ProductPlant(Product='" + row.Material + "',Plant='" + Plant + "')",
                {
                    success: function (oResult) {

                        // âœ… FIX: use AND instead of OR
                        if (
                            oResult.SerialNumberProfile !== "" &&
                            oResult.SerialNumberProfile !== undefined
                        ) {
                            row.isSerialSelected = true;
                            row._isSerialMandatory = true;
                        } else {
                            row.isSerialSelected = false;
                            row._isSerialMandatory = false;
                        }

                        eshipjetModel.refresh(true);
                    },
                    error: function (oError) {
                        // optional
                    }
                }
            );
        }
    });
},




  onGetShipFromData: function (sPlant) {
    var oController = this;

    var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
    var oPlantModel   = oController.getOwnerComponent().getModel("PLANT_CDS");

    if (!sPlant) {
        sap.m.MessageBox.error("Plant is missing");
        return;
    }

    if (oController.onOpenBusyDialog) {
        oController.onOpenBusyDialog();
    }

    var aFilters = [
        new sap.ui.model.Filter("Plant", sap.ui.model.FilterOperator.EQ, sPlant)
    ];

    oPlantModel.read("/xESHIPJETxPLANT", {
        filters: aFilters,
        success: function (oData) {

            if (oData.results && oData.results.length > 0) {
                var p = oData.results[0];

                // âœ… MAP EXACTLY TO XML BINDINGS
                eshipjetModel.setProperty("/ShipFromAddress", {
                    ShipFromCONTACT: p.ContactName || "",
                    ShipFromCOMPANY: p.CompanyName || "",
                    ShipFromADDRESS_LINE1: p.AddressLine1 || "",
                    ShipFromADDRESS_LINE2: p.AddressLine2 || "",
                    ShipFromCITY: p.City || "",
                    ShipFromSTATE: p.State || "",
                    ShipFromZIPCODE: p.PostalCode || "",
                    ShipFromCOUNTRY: p.Country || "",
                    ShipFromEMAIL: p.EmailAddress || "",
                    ShipFromPHONE: "",          // not provided by PLANT_CDS
                    LocationType: "PLANT"
                });

            } else {
                sap.m.MessageBox.warning("No Ship From data found for Plant : " + sPlant);
                eshipjetModel.setProperty("/ShipFromAddress", {});
            }

            oController.onCloseBusyDialog && oController.onCloseBusyDialog();
        },
        error: function (oError) {
            oController.onCloseBusyDialog && oController.onCloseBusyDialog();

            var sMessage = "Failed to fetch Plant data";
            try {
                var oResponse = JSON.parse(oError.responseText);
                sMessage = oResponse?.error?.message?.value || sMessage;
            } catch (e) {}

            sap.m.MessageBox.error(sMessage);
        }
    });
},




     readHUData: function () {
            var GetDeliveryDataModel = oController.getOwnerComponent().getModel("OutBoundDeliveryModel");
            // var GetDeliveryDataModel = new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/API_OUTBOUND_DELIVERY_SRV;v=0002/", {
            //     useBatch: true,
            //     withCredentials: true
            // });
            var sDeveliveryNumber = eshipjetModel.getProperty("/commonValues/sapDeliveryNumber");

            return new Promise(function (resolve, reject) {
                GetDeliveryDataModel.read("/A_OutbDeliveryHeader('" + sDeveliveryNumber + "')", {
                    urlParameters: {
                        "$expand": "to_DeliveryDocumentItem,to_HandlingUnitHeaderDelivery,to_HandlingUnitHeaderDelivery/to_HandlingUnitItemDelivery,to_DeliveryDocumentItem/to_HandlingUnitItemDelivery"
                    },
                    success: function (oData) {
                        const huData = oData.to_HandlingUnitHeaderDelivery.results;
                        const deliveryData = oData.to_DeliveryDocumentItem.results;

                        // 1. Aggregate HU quantities by Material
                        const huTotals = {};
                        huData.forEach(hu => {
                            hu.to_HandlingUnitItemDelivery.results.forEach(item => {
                                const mat = item.Material;
                                const qty = Number(item.HandlingUnitQuantity);
                                if (!huTotals[mat]) {
                                    huTotals[mat] = 0;
                                }
                                huTotals[mat] += qty;
                            });
                        });

                        // 2. Match with Delivery Items and calculate BalanceQty
                        deliveryData.forEach(delItem => {
                            const mat = delItem.Material;
                            const actualQty = Number(delItem.ActualDeliveryQuantity);
                            const packedQty = huTotals[mat] || 0;
                            delItem.PackedQty = packedQty;
                            delItem.BalanceQty = actualQty - packedQty;
                            delItem.actualQty = actualQty;
                            if (delItem.BalanceQty <= 0) {
                                Object.keys(delItem).forEach(key => delete delItem[key]);
                            }
                        });

                        eshipjetModel.setProperty("/to_HandlingUnitHeaderDelivery", { results: [] });
                        eshipjetModel.setProperty("/to_HandlingUnitHeaderDelivery/results", oData.to_HandlingUnitHeaderDelivery.results);
                        // eshipjetModel.setProperty("/to_HandlingUnitHeaderDelivery/results", oData.to_HandlingUnitHeaderDelivery);
                        eshipjetModel.setProperty("/to_DeliveryDocumentItem", deliveryData);

                        eshipjetModel.setProperty("/HandlingUnitsLength", oData.to_HandlingUnitHeaderDelivery.results.length);

                        oController.onCloseBusyDialog();
                        resolve(oData);
                    },
                    error: function (oError) {
                        oController.onCloseBusyDialog();
                        console.error("Error while reading Delivery Items:", oError);
                        reject(oError);
                    }
                });
            });
        },


        ApiOutboundDeliverySrvData: function (response) {
            var oController = this;
            oController.onOpenBusyDialog();
            var BillOfLading = response?.Packages?.[0]?.TrackingNumber || "";
            var DocumentNumber = response?.HeaderInfo?.DocumentNumber;

            if (!DocumentNumber || !BillOfLading) {
                sap.m.MessageBox.error("Delivery number or Bill Of Lading missing.");
                oController.onCloseBusyDialog();
                return;
            }
            var cleanDelivery = String(Number(DocumentNumber));
            var oModel = oController.getOwnerComponent().getModel("OutBoundDeliveryModel");
            oModel.refreshSecurityToken(function () {
                var sToken = oModel.getSecurityToken();
                if (!sToken) {
                    sap.m.MessageBox.error("CSRF token missing");
                    oController.onCloseBusyDialog();
                    return;
                }
                oModel.read(
                    "/A_OutbDeliveryHeader(DeliveryDocument='" + cleanDelivery + "')",
                    {
                        success: function (oData, oResponse) {

                            var sETag = oResponse?.headers?.etag;
                            if (!sETag) {
                                sap.m.MessageBox.error("ETag not found in response headers");
                                oController.onCloseBusyDialog();
                                return;
                            }
                            var oPayload = {
                                BillOfLading: BillOfLading
                            };

                            oController.updateBillOfLading(cleanDelivery, sETag, sToken, oPayload);
                            
                        },
                        error: function () {
                            sap.m.MessageBox.error("Failed to read delivery for ETag");
                            oController.onCloseBusyDialog();
                        }
                    }
                );
            });
        },


            updateBillOfLading: function (cleanDelivery, sETag, sToken, oPayload) {
                var oController = this;
                var oModel = oController.getOwnerComponent().getModel("OutBoundDeliveryModel");

                oModel.update(
                    "/A_OutbDeliveryHeader(DeliveryDocument='" + cleanDelivery + "')",
                    oPayload,
                    {
                        method: "PATCH",
                        headers: {
                            "X-CSRF-Token": sToken,
                            "If-Match": sETag,
                            "Content-Type": "application/json"
                        },

                        errorHandler: false,
                        success: function () {
                            sap.m.MessageToast.show("Bill Of Lading updated successfully");
                            oController.onCloseBusyDialog();
                        },
                        error: function (oError) {
                            console.warn("BOL Update failed:", jQuery.parseXML(oError.responseText).getElementsByTagName("message")[0].textContent);
                            oController.onCloseBusyDialog();
                        }
                    }
                );
            },


            updateSerialProgress: function () {
                var oModel = this.getOwnerComponent().getModel("eshipjetModel");

                var total = oModel.getProperty("/serialStatus/total");
                var aSerials = oModel.getProperty("/serialNumbersArray") || [];

                var entered = aSerials.filter(function (oItem) {
                    return oItem.serialNumber && oItem.serialNumber.trim() !== "";
                }).length;

                var percentage = total > 0 ? Math.floor((entered / total) * 100) : 0;

                oModel.setProperty("/serialStatus/entered", entered);
                oModel.setProperty("/serialStatus/remaining", total - entered);
                oModel.setProperty("/serialStatus/percentage", percentage);
                oModel.setProperty("/serialStatus/displayText", entered + " / " + total);
            },







//   onCreateHuItems: function () {
//             var oController = this;
//             oController.onOpenBusyDialog();

//             var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
//             var oModel = this.getOwnerComponent().getModel("OutBoundDeliveryModel");

//             var oTable = this.byId("idShipNowPackTable");
//             var aSelectedIndices = oTable.getSelectedIndices();

//             var aRows = oTable.getBinding("rows").getContexts().map(c => c.getObject());

//             // âœ” Get Delivery Document
//             var GetDeliveryData = eshipjetModel.getProperty("/GetDeliveryData");

//             // VALIDATION
//             // if (aSelectedIndices.length === 0) {
//             //     MessageBox.error("Please select at least one row.");
//             //     oController.onCloseBusyDialog();
//             //     return;
//             // }

//             for (let idx of aSelectedIndices) {
//                 let row = aRows[idx];
//                 if (!row.partialQty || parseFloat(row.partialQty) <= 0) {
//                     MessageBox.error("Please enter Partial Qty for all selected items.");
//                     oController.onCloseBusyDialog();
//                     return;
//                 }
//             }

//             // ðŸ”¥ BATCH MODE
//             oModel.setUseBatch(true);
//             oModel.setDeferredGroups(["PackBatch"]);

//             oModel.refreshSecurityToken(() => {

//                 // 1ï¸âƒ£ HU HEADER
//                 var headerObj = {
//                     HandlingUnitExternalId: "$1",
//                     PackagingMaterial: eshipjetModel.getProperty("/selectedPackageMat") || "CARTON BOX",
//                     DeliveryDocument: GetDeliveryData.DeliveryDocument
//                 };

//                 oModel.create("/A_HandlingUnitHeaderDelivery", headerObj, {
//                     groupId: "PackBatch"
//                 });

//                 // 2ï¸âƒ£ HU ITEMS
//                 aSelectedIndices.forEach(idx => {
//                     var row = aRows[idx];

//                     var itemObj = {
//                         HandlingUnitExternalId: "$1",
//                         HandlingUnitTypeOfContent: "1",
//                         DeliveryDocument: GetDeliveryData.DeliveryDocument,
//                         DeliveryDocumentItem: row.DeliveryDocumentItem,
//                         HandlingUnitQuantity: row.partialQty.toString(),
//                         HandlingUnitQuantityUnit: row.BaseUnit || "PC",
//                         Material: row.Material
//                     };

//                     oModel.create("/A_HandlingUnitItemDelivery", itemObj, {
//                         groupId: "PackBatch"
//                     });
//                 });

//                 // 3ï¸âƒ£ SUBMIT
//                 oModel.submitChanges({
//                     groupId: "PackBatch",
//                     success: function () {
//                         oController.readHUData();
//                         oController.onCloseBusyDialog();
//                         MessageToast.show("Selected items packed successfully.");
//                     },
//                     error: function (err) {
//                         oController.onCloseBusyDialog();
//                         oController._showODataError(err);
//                     }
//                 });

//             }, function (err) {
//                 oController.onCloseBusyDialog();
//                 MessageBox.error("CSRF Token Failed");
//             });
//         },



  onOrdersToggleExpand: function () {
            var eshipjetModel = this.getOwnerComponent().getModel("eshipjetModel");
            var bExpanded = eshipjetModel.getProperty("/isExpandOrdersToolBar");
            const oTable = this.byId("idOrdersTable");
            if( bExpanded === true ){
                oTable.setVisibleRowCount(15);
            }else if( bExpanded === false ){
                oTable.setVisibleRowCount(12);
            }
            eshipjetModel.setProperty("/isExpandOrdersToolBar", !bExpanded);
        },
  onPackSectionEmptyRows: function () {
            var eshipjetModel = oController.getOwnerComponent().getModel("eshipjetModel");
            var aHandlingUnits = eshipjetModel.getProperty("/to_HandlingUnitHeaderDelivery/results") || [];
            var aPackAddProductTable = eshipjetModel.getProperty("/to_DeliveryDocumentItem") || [];
            var aBusinessPartnersTable = eshipjetModel.getProperty("/BusinessPartners") || [];

            // If HandlingUnits has less than 6 items, add empty rows
            while (aPackAddProductTable.length < 4) {
                aPackAddProductTable.push({ SerialNo: "" });
            }

            while (aHandlingUnits.length < 6) {
                aHandlingUnits.push(
                    { SerialNumber: "", HandlingUnitExternalId: "" }
                );
            }

            // while (aBusinessPartnersTable.length < 5) {
            //     aBusinessPartnersTable.push(
            //         { PartnerType: "Ship From", "FullName": "Eshipjet Software Inc.", "BusinessPartnerName1":"Steve Marsh", "StreetName":"5717 Legacy", "HouseNumber":"Suite 250", "Region":"Plano", "CityName":"TX", "PostalCode":"75024", "Country":"US", "PhoneNumber":"(888) 464-2360", "email":"info@eshipjet.ai" },
            //         { PartnerType: "Shipper", "FullName": "Eshipjet Software Inc.", "BusinessPartnerName1":"Steve Marsh", "StreetName":"5717 Legacy", "HouseNumber":"Suite 250", "Region":"Plano", "CityName":"TX", "PostalCode":"75024", "Country":"US", "PhoneNumber":"(888) 464-2360", "email":"info@eshipjet.ai" },
            //         { PartnerType: "Freight Forwarder", "FullName": "", "BusinessPartnerName1":"", "StreetName":"", "HouseNumber":"", "Region":"", "CityName":"", "PostalCode":"", "Country":"", "PhoneNumber":"", "email":""  },
            //         { PartnerType: "Importer", "FullName": "", "BusinessPartnerName1":"", "StreetName":"", "HouseNumber":"", "Region":"", "CityName":"", "PostalCode":"", "Country":"", "PhoneNumber":"", "email":""  },
            //         { PartnerType: "Third Party", "FullName": "", "BusinessPartnerName1":"", "StreetName":"", "HouseNumber":"", "Region":"", "CityName":"", "PostalCode":"", "Country":"", "PhoneNumber":"", "email":""  }
            //     );
            // }

            // eshipjetModel.setProperty("/BusinessPartners", aBusinessPartnersTable);

            eshipjetModel.setProperty("/to_DeliveryDocumentItem", aPackAddProductTable);
            eshipjetModel.setProperty("/to_HandlingUnitHeaderDelivery", {results: []});
            eshipjetModel.setProperty("/to_HandlingUnitHeaderDelivery/results", aHandlingUnits);

            // var HandlingUnits = eshipjetModel.getProperty("/to_HandlingUnitHeaderDelivery/results");
            // var HandlingUnitsLength = 0;
            // for (var i = 0; i < HandlingUnits.length; i++) {
            //     if (HandlingUnits[i].SAPHUID !== "") {
            //         HandlingUnitsLength += 1
            //     }
            // };
            // eshipjetModel.setProperty("/HandlingUnitsLength", HandlingUnitsLength);
        },


          onOpenSerialNumberDialog:function(qty){
            var oView = this.getView();
            if (!this.byId("_IDGenEditSerialNumberDialog")) {
                Fragment.load({
                    id: oView.getId(),
                    name: "com.eshipjetcopy.zeshipjetcopy.view.fragments.ShipNow.EditSerialNumberDialog",
                    controller: this
                }).then(function (oSerialNumberDialog) {
                    oView.addDependent(oSerialNumberDialog);
                    oSerialNumberDialog.open();
                });
            } else {
                this.byId("_IDGenEditSerialNumberDialog").open();
            }

            var serialNumbersArray = [];
            for(var i=0; i<qty; i++){
                serialNumbersArray.push({"rowCount": i+1, "serialNumber": ""});
            };
            eshipjetModel.setProperty("/serialNumbersArray", serialNumbersArray);
        },

        onCloseEditSerialDialog: function () {
            this.byId("_IDGenEditSerialNumberDialog").close();
        },

        














    });
});
